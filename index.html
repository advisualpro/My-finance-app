<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MyCosts Simple</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<style>
    body{font-family:sans-serif;background:#000;color:#fff;margin:0;padding:20px;padding-bottom:100px}
    .card{background:#1c1c1e;border-radius:16px;padding:20px;margin-bottom:15px}
    .btn{width:100%;padding:15px;border-radius:12px;border:none;font-weight:bold;background:#0a84ff;color:#fff;margin-top:10px}
    .input{width:100%;padding:15px;background:#2c2c2e;border:none;border-radius:12px;color:#fff;margin-bottom:10px;box-sizing:border-box}
    .flex{display:flex;justify-content:space-between;align-items:center}
    .nav{position:fixed;bottom:0;left:0;width:100%;background:#1c1c1e;display:flex;justify-content:space-around;padding:15px;border-top:1px solid #333}
    .nav i{font-size:24px;color:#666} .nav i.active{color:#0a84ff}
    .hidden{display:none}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:999;display:none;padding:20px}
</style>
</head>
<body>

    <!-- ЗАГОЛОВОК -->
    <div class="flex" style="margin-bottom:20px">
        <h2 id="head-title">Мой Кошелек</h2>
        <div style="font-size:12px;color:#666" id="sync-status">OFFLINE</div>
    </div>

    <!-- ГЛАВНАЯ -->
    <div id="view-home">
        <!-- Месяц -->
        <div class="card flex" style="justify-content:center;gap:20px">
            <button onclick="changeMonth(-1)" style="background:none;border:none;color:#fff;font-size:20px"><</button>
            <b id="month-label">...</b>
            <button onclick="changeMonth(1)" style="background:none;border:none;color:#fff;font-size:20px">></button>
        </div>

        <div class="card" style="text-align:center">
            <div style="color:#888;font-size:12px">Баланс</div>
            <div style="font-size:32px;font-weight:bold;margin:10px 0" id="total-bal">0 ₽</div>
            <div class="flex" style="gap:10px">
                <button class="btn" style="background:#ff453a" onclick="openTx('expense')">Расход</button>
                <button class="btn" style="background:#30d158" onclick="openTx('income')">Доход</button>
            </div>
        </div>

        <div class="card">
            <div class="flex"><span>Доходы (Мес)</span><span style="color:#30d158" id="inc-month">0</span></div>
            <div class="flex" style="margin-top:10px"><span>Расходы (Мес)</span><span style="color:#ff453a" id="exp-month">0</span></div>
        </div>

        <h3>История</h3>
        <div id="tx-list"></div>
    </div>

    <!-- АНАЛИТИКА -->
    <div id="view-stats" class="hidden">
        <h2>Аналитика</h2>
        <div class="card"><canvas id="chart"></canvas></div>
    </div>

    <!-- КОШЕЛЕК -->
    <div id="view-wallet" class="hidden">
        <h2>Настройки</h2>
        <div class="card" id="acc-list"></div>
        <button class="btn" onclick="addAccount()">+ Счет</button>
        <button class="btn" style="background:#333;margin-top:20px" onclick="resetApp()">Сброс</button>
    </div>

    <!-- НАВИГАЦИЯ -->
    <div class="nav">
        <i class="ri-home-5-fill active" onclick="nav('home',this)"></i>
        <i class="ri-pie-chart-2-fill" onclick="nav('stats',this)"></i>
        <i class="ri-wallet-3-fill" onclick="nav('wallet',this)"></i>
    </div>

    <!-- МОДАЛКА ТРАНЗАКЦИИ -->
    <div id="modal-tx" class="modal">
        <h2 id="tx-title">...</h2>
        <input type="number" id="tx-sum" class="input" placeholder="Сумма">
        <input type="text" id="tx-cat" class="input" placeholder="Категория (Еда, Такси...)">
        <select id="tx-acc" class="input"></select>
        <button class="btn" onclick="saveTx()">Сохранить</button>
        <button class="btn" style="background:#333" onclick="closeModal()">Отмена</button>
    </div>

<script>
// !!! ССЫЛКА !!!
const API_URL = 'https://script.google.com/macros/s/AKfycby_ES9U2-4VYmPhMLbDtNNv_ESnbUEI9nlw0euEHsxZ6eJqu340_LpF_A1pSxyUvRxG/exec';

// DATA
let DB = { accounts:[{id:'a1',name:'Карта',bal:0}], transactions:[] };
let CUR_MONTH = new Date();
let TEMP_TYPE = 'expense';
let USER_ID = localStorage.getItem('uid') || 'u_'+Date.now(); localStorage.setItem('uid',USER_ID);

// INIT
window.onload = () => {
    const local = localStorage.getItem('db_simple');
    if(local) {
        try { DB = JSON.parse(local); if(!DB.accounts.length) throw 1; } catch(e){ initDB(); }
    } else { initDB(); }
    
    render();
    syncPull();
};

function initDB() {
    DB = { accounts:[{id:'a1',name:'Карта',bal:0}], transactions:[] };
    save();
}

// LOGIC
function save() {
    localStorage.setItem('db_simple', JSON.stringify(DB));
    render();
}

function changeMonth(d) {
    CUR_MONTH.setMonth(CUR_MONTH.getMonth() + d);
    render();
}

function openTx(type) {
    TEMP_TYPE = type;
    document.getElementById('tx-title').innerText = type=='expense'?'Расход':'Доход';
    document.getElementById('modal-tx').style.display = 'block';
    
    // Fill Accounts
    const sel = document.getElementById('tx-acc');
    sel.innerHTML = DB.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
}

function saveTx() {
    const sum = parseFloat(document.getElementById('tx-sum').value);
    const cat = document.getElementById('tx-cat').value;
    const accId = document.getElementById('tx-acc').value;
    
    if(!sum || !cat) return alert('Заполни все!');
    
    DB.transactions.push({
        id: Date.now(),
        date: new Date().toISOString(), // Сохраняем всегда точную дату
        amount: sum,
        type: TEMP_TYPE,
        cat: cat,
        acc: accId
    });
    
    // Update Balance
    const acc = DB.accounts.find(a => a.id == accId);
    if(acc) TEMP_TYPE=='income' ? acc.bal+=sum : acc.bal-=sum;
    
    save(); closeModal(); syncPush();
}

function addAccount() {
    const name = prompt('Название счета:');
    if(name) {
        DB.accounts.push({id:'a'+Date.now(), name, bal:0});
        save(); syncPush();
    }
}

// RENDER
function render() {
    // Date Header
    const m = ['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
    const mKey = CUR_MONTH.toISOString().slice(0,7); // 2023-10
    document.getElementById('month-label').innerText = m[CUR_MONTH.getMonth()] + ' ' + CUR_MONTH.getFullYear();

    // Total Balance (Global)
    const total = DB.accounts.reduce((s,a)=>s+a.bal, 0);
    document.getElementById('total-bal').innerText = total + ' ₽';

    // Monthly Stats
    let inc=0, exp=0;
    const monthTx = DB.transactions.filter(t => t.date.startsWith(mKey));
    
    monthTx.forEach(t => {
        if(t.type=='income') inc+=t.amount; else exp+=t.amount;
    });
    document.getElementById('inc-month').innerText = '+'+inc;
    document.getElementById('exp-month').innerText = '-'+exp;

    // List
    document.getElementById('tx-list').innerHTML = monthTx.reverse().map(t => 
        `<div class="card flex">
            <div><b>${t.cat}</b><br><small>${new Date(t.date).toLocaleDateString()}</small></div>
            <b style="color:${t.type=='expense'?'red':'green'}">${t.amount}</b>
        </div>`
    ).join('');

    // Wallet List
    document.getElementById('acc-list').innerHTML = DB.accounts.map(a => 
        `<div class="flex" style="padding:10px;border-bottom:1px solid #333"><b>${a.name}</b><span>${a.bal}</span></div>`
    ).join('');
    
    // Chart
    renderChart(monthTx);
}

function renderChart(txs) {
    const ctx = document.getElementById('chart');
    const data = {};
    txs.filter(t=>t.type=='expense').forEach(t => data[t.cat] = (data[t.cat]||0)+t.amount);
    
    if(window.myChart) window.myChart.destroy();
    window.myChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: Object.keys(data), datasets:[{data:Object.values(data), backgroundColor:['red','blue','green','yellow']}] }
    });
}

// SYNC
async function syncPush() {
    document.getElementById('sync-status').innerText = 'SAVING...';
    try {
        await fetch(API_URL+'?action=sync_all', {method:'POST', mode:'no-cors', body:JSON.stringify({user_id:USER_ID, ...DB})});
        document.getElementById('sync-status').innerText = 'ONLINE';
    } catch(e){ document.getElementById('sync-status').innerText = 'ERR'; }
}

async function syncPull() {
    try {
        const res = await fetch(`${API_URL}?action=load&user_id=${USER_ID}&t=${Date.now()}`);
        const json = await res.json();
        if(json.status=='success' && json.data.accounts) {
            DB.accounts = json.data.accounts;
            DB.transactions = json.data.transactions || [];
            save();
            document.getElementById('sync-status').innerText = 'ONLINE';
        }
    } catch(e){}
}

// UTILS
function closeModal() { document.getElementById('modal-tx').style.display='none'; document.getElementById('tx-sum').value=''; }
function nav(scr, el) { 
    ['home','stats','wallet'].forEach(s => document.getElementById('view-'+s).classList.add('hidden'));
    document.getElementById('view-'+scr).classList.remove('hidden');
    document.querySelectorAll('.nav i').forEach(i=>i.classList.remove('active'));
    el.classList.add('active');
}
function resetApp() { localStorage.clear(); location.reload(); }

</script>
</body>
</html>
