<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>MyCosts Titanium</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0A0A0F;
  --bg2: #12121A;
  --card: rgba(255,255,255,0.04);
  --card-border: rgba(255,255,255,0.06);
  --card-hover: rgba(255,255,255,0.07);
  --text: #F8FAFC;
  --text2: #94A3B8;
  --text3: #475569;
  --accent: #8B5CF6;
  --accent2: #6366F1;
  --orange: #F97316;
  --green: #10B981;
  --red: #EF4444;
  --glass: rgba(255,255,255,0.05);
  --glass-border: rgba(255,255,255,0.08);
  --blur: blur(20px);
  --radius-xl: 24px;
  --radius-l: 20px;
  --radius-m: 16px;
  --radius-s: 12px;
  --radius-pill: 100px;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
  --gradient: linear-gradient(135deg, #8B5CF6, #6366F1);
  --gradient-orange: linear-gradient(135deg, #F97316, #FB923C);
  --gradient-card: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(99,102,241,0.05));
  --font: 'Inter', -apple-system, sans-serif;
  --nav-h: 64px;
  --top-safe: env(safe-area-inset-top, 0px);
  --bot-safe: env(safe-area-inset-bottom, 0px);
}
.light {
  --bg: #F8FAFC;
  --bg2: #F1F5F9;
  --card: rgba(255,255,255,0.8);
  --card-border: rgba(0,0,0,0.06);
  --card-hover: rgba(255,255,255,0.95);
  --text: #0F172A;
  --text2: #64748B;
  --text3: #94A3B8;
  --glass: rgba(255,255,255,0.7);
  --glass-border: rgba(0,0,0,0.08);
  --shadow: 0 4px 24px rgba(0,0,0,0.08);
  --gradient-card: linear-gradient(135deg, rgba(139,92,246,0.08), rgba(99,102,241,0.03));
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  transition: background .3s, color .3s;
}
.app {
  max-width: 480px;
  margin: 0 auto;
  padding-bottom: calc(var(--nav-h) + var(--bot-safe) + 16px);
  min-height: 100vh;
  position: relative;
}

/* ===== GLOW BACKGROUND ===== */
.glow-bg {
  position: fixed;
  top: -120px;
  left: 50%;
  transform: translateX(-50%);
  width: 400px;
  height: 400px;
  background: radial-gradient(circle, rgba(139,92,246,0.12) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}
.light .glow-bg { opacity: 0.4; }

/* ===== SCREENS ===== */
.screen { display:none; padding:16px; position:relative; z-index:1; }
.screen.active { display:block; animation: fadeUp .3s ease; }
@keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

/* ===== BALANCE CARD (GLASSMORPHISM) ===== */
.bal-card {
  background: var(--gradient-card);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-xl);
  padding: 28px 24px 24px;
  margin-bottom: 16px;
  position: relative;
  overflow: hidden;
}
.bal-card::before {
  content: '';
  position: absolute;
  top: -1px; left: -1px; right: -1px; bottom: -1px;
  border-radius: var(--radius-xl);
  padding: 1px;
  background: linear-gradient(135deg, rgba(139,92,246,0.3), rgba(99,102,241,0.1), transparent);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
}
.bal-label { font-size:13px; color:var(--text2); font-weight:500; margin-bottom:4px; }
.bal-amount { font-size:36px; font-weight:800; letter-spacing:-1px; margin-bottom:16px; }
.bal-row { display:flex; gap:8px; }
.bal-item {
  flex:1;
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-m);
  padding: 12px;
  text-align: center;
}
.bal-item-label { font-size:11px; color:var(--text2); margin-bottom:4px; }
.bal-item-val { font-size:16px; font-weight:700; }
.bal-item-val.inc { color: var(--green); }
.bal-item-val.exp { color: var(--red); }
.bal-item-val.cf { color: var(--accent); }

/* ===== MONTH SELECTOR ===== */
.month-sel {
  display:flex; align-items:center; justify-content:center; gap:16px;
  margin-bottom:16px; padding:8px 0;
}
.month-sel .arr {
  width:36px; height:36px; border-radius:50%;
  background: var(--card); border:1px solid var(--card-border);
  display:flex; align-items:center; justify-content:center;
  color:var(--text); font-size:18px; cursor:pointer;
  transition: background .2s;
}
.month-sel .arr:active { background:var(--card-hover); }
.month-sel .m-label { font-size:15px; font-weight:600; min-width:140px; text-align:center; }

/* ===== SECTION ===== */
.sec { margin-bottom:20px; }
.sec-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
.sec-title { font-size:17px; font-weight:700; }
.sec-link { font-size:13px; color:var(--accent); font-weight:500; cursor:pointer; }

/* ===== CARDS ===== */
.card {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-l);
  padding: 16px;
  margin-bottom: 10px;
  transition: background .2s;
}
.card:active { background: var(--card-hover); }

/* ===== CASHFLOW PANEL ===== */
.cf-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.cf-card {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-m);
  padding: 14px;
}
.cf-card.full { grid-column: 1 / -1; }
.cf-icon { font-size:20px; margin-bottom:6px; }
.cf-label { font-size:11px; color:var(--text2); font-weight:500; margin-bottom:2px; }
.cf-val { font-size:18px; font-weight:700; }
.cf-val.pos { color:var(--green); }
.cf-val.neg { color:var(--red); }

/* ===== PROGRESS BAR ===== */
.prog-wrap { margin-top:8px; }
.prog-bar {
  height:6px; background:var(--card-border); border-radius:3px; overflow:hidden;
}
.prog-fill {
  height:100%; border-radius:3px;
  background: var(--gradient);
  transition: width .5s ease;
}
.prog-labels { display:flex; justify-content:space-between; margin-top:4px; }
.prog-labels span { font-size:11px; color:var(--text2); }

/* ===== BUTTONS ===== */
.btn {
  display:inline-flex; align-items:center; justify-content:center; gap:6px;
  border:none; cursor:pointer; font-family:var(--font); font-weight:600;
  transition: all .2s; outline:none;
}
.btn-main {
  background: var(--gradient);
  color:#fff; border-radius:var(--radius-pill);
  padding:14px 28px; font-size:15px;
  width:100%;
}
.btn-main:active { transform:scale(0.97); opacity:0.9; }
.btn-sec {
  background:transparent; color:var(--accent);
  border:1.5px solid var(--accent);
  border-radius:var(--radius-pill);
  padding:12px 24px; font-size:14px;
  width:100%;
}
.btn-sec:active { background:rgba(139,92,246,0.1); }
.btn-ghost {
  background:var(--card); color:var(--text);
  border:1px solid var(--card-border);
  border-radius:var(--radius-pill);
  padding:10px 20px; font-size:13px;
}
.btn-sm {
  padding:8px 16px; font-size:12px; border-radius:var(--radius-pill);
}
.btn-danger {
  background:rgba(239,68,68,0.1); color:var(--red);
  border:1px solid rgba(239,68,68,0.2);
  border-radius:var(--radius-pill);
  padding:10px 20px; font-size:13px; width:100%;
}

/* ===== FAB ===== */
.fab {
  position:fixed; bottom:calc(var(--nav-h) + var(--bot-safe) + 16px);
  right:calc(50% - 220px); width:56px; height:56px;
  background:var(--gradient); border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  color:#fff; font-size:28px; box-shadow:0 4px 20px rgba(139,92,246,0.4);
  cursor:pointer; z-index:100; border:none;
  transition: transform .2s;
}
.fab:active { transform:scale(0.9); }
@media(max-width:480px){ .fab { right:20px; } }

/* ===== BOTTOM NAV ===== */
.nav {
  position:fixed; bottom:0; left:50%; transform:translateX(-50%);
  width:100%; max-width:480px;
  background: var(--glass);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  border-top:1px solid var(--card-border);
  height:var(--nav-h);
  padding-bottom:var(--bot-safe);
  display:flex; z-index:200;
}
.nav-item {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:2px; cursor:pointer; color:var(--text3);
  transition: color .2s;
  border:none; background:none; font-family:var(--font);
}
.nav-item.active { color:var(--accent); }
.nav-item i { font-size:22px; }
.nav-item span { font-size:10px; font-weight:500; }

/* ===== MODAL ===== */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.6);
  backdrop-filter:blur(4px); z-index:500; display:none;
  align-items:flex-end; justify-content:center;
}
.modal-overlay.show { display:flex; }
.modal {
  background:var(--bg2); border-radius:var(--radius-xl) var(--radius-xl) 0 0;
  width:100%; max-width:480px; max-height:85vh; overflow-y:auto;
  padding:24px 20px calc(20px + var(--bot-safe));
  animation: slideUp .3s ease;
}
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
.modal-handle {
  width:40px; height:4px; background:var(--text3); border-radius:2px;
  margin:0 auto 20px; opacity:0.5;
}
.modal-title { font-size:18px; font-weight:700; margin-bottom:20px; text-align:center; }

/* ===== FORM ELEMENTS ===== */
.field { margin-bottom:16px; }
.field label { display:block; font-size:12px; color:var(--text2); font-weight:500; margin-bottom:6px; }
.field input, .field select, .field textarea {
  width:100%; background:var(--card); border:1px solid var(--card-border);
  border-radius:var(--radius-s); padding:14px 16px;
  color:var(--text); font-size:15px; font-family:var(--font);
  outline:none; transition: border-color .2s;
}
.field input:focus, .field select:focus, .field textarea:focus {
  border-color:var(--accent);
}
.field select { appearance:none; cursor:pointer; }

/* ===== SEGMENTS (TABS) ===== */
.seg {
  display:flex; background:var(--card); border-radius:var(--radius-s);
  padding:3px; margin-bottom:16px;
}
.seg-btn {
  flex:1; padding:10px; text-align:center; border-radius:var(--radius-s);
  font-size:13px; font-weight:600; cursor:pointer;
  color:var(--text2); transition:all .2s;
  border:none; background:none; font-family:var(--font);
}
.seg-btn.active {
  background:var(--gradient); color:#fff;
}

/* ===== SWITCH/TOGGLE ===== */
.toggle-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:12px 0;
}
.toggle-label { font-size:14px; font-weight:500; }
.toggle-sub { font-size:11px; color:var(--text2); margin-top:2px; }
.toggle {
  width:48px; height:28px; border-radius:14px;
  background:var(--card-border); position:relative; cursor:pointer;
  transition: background .2s;
}
.toggle.on { background:var(--accent); }
.toggle::after {
  content:''; position:absolute; top:3px; left:3px;
  width:22px; height:22px; border-radius:50%;
  background:#fff; transition:transform .2s;
}
.toggle.on::after { transform:translateX(20px); }

/* ===== TX LIST ===== */
.tx-item {
  display:flex; align-items:center; gap:12px; padding:12px 0;
  border-bottom:1px solid var(--card-border);
}
.tx-item:last-child { border-bottom:none; }
.tx-icon {
  width:40px; height:40px; border-radius:var(--radius-s);
  background:var(--gradient-card);
  display:flex; align-items:center; justify-content:center;
  font-size:18px; flex-shrink:0;
}
.tx-info { flex:1; min-width:0; }
.tx-name { font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.tx-cat { font-size:12px; color:var(--text2); }
.tx-amount { font-size:15px; font-weight:700; text-align:right; }
.tx-amount.inc { color:var(--green); }
.tx-amount.exp { color:var(--red); }
.tx-date { font-size:11px; color:var(--text3); text-align:right; }

/* ===== ACCOUNT / GOAL / DEBT CARDS ===== */
.acc-card, .goal-card, .debt-card {
  background:var(--card); border:1px solid var(--card-border);
  border-radius:var(--radius-l); padding:16px; margin-bottom:10px;
}
.acc-row { display:flex; justify-content:space-between; align-items:center; }
.acc-name { font-size:14px; font-weight:600; }
.acc-type { font-size:11px; color:var(--text2); }
.acc-bal { font-size:18px; font-weight:700; }

/* ===== DEBT SPECIAL ===== */
.debt-card { border-left:3px solid var(--red); }
.debt-card.paid { border-left-color:var(--green); opacity:0.7; }
.debt-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
.debt-name { font-size:15px; font-weight:700; }
.debt-badge {
  font-size:11px; padding:3px 10px; border-radius:var(--radius-pill);
  background:rgba(239,68,68,0.1); color:var(--red); font-weight:600;
}
.debt-badge.done { background:rgba(16,185,129,0.1); color:var(--green); }
.debt-stat { font-size:12px; color:var(--text2); line-height:1.6; }
.debt-actions { display:flex; gap:8px; margin-top:12px; }

/* ===== PROFILE ===== */
.profile-avatar {
  width:72px; height:72px; border-radius:50%;
  background:var(--gradient);
  display:flex; align-items:center; justify-content:center;
  font-size:28px; font-weight:800; color:#fff;
  margin:0 auto 12px;
}
.profile-name { text-align:center; font-size:18px; font-weight:700; margin-bottom:4px; }
.profile-sub { text-align:center; font-size:12px; color:var(--text2); margin-bottom:24px; }

.profile-section { margin-bottom:20px; }
.profile-section-title { font-size:12px; color:var(--text2); font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; padding-left:4px; }
.profile-card {
  background:var(--card); border:1px solid var(--card-border);
  border-radius:var(--radius-l); overflow:hidden;
}
.profile-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:14px 16px; cursor:pointer; transition:background .2s;
}
.profile-row:active { background:var(--card-hover); }
.profile-row + .profile-row { border-top:1px solid var(--card-border); }
.profile-row-left { display:flex; align-items:center; gap:12px; }
.profile-row-left i { font-size:20px; color:var(--accent); }
.profile-row-label { font-size:14px; font-weight:500; }
.profile-row-right { color:var(--text3); font-size:18px; }

/* ===== CHART CONTAINER ===== */
.chart-box {
  background:var(--card); border:1px solid var(--card-border);
  border-radius:var(--radius-l); padding:16px; margin-bottom:12px;
}
.chart-box canvas { max-height:200px; }

/* ===== TOAST ===== */
.toast {
  position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-80px);
  background:var(--bg2); border:1px solid var(--card-border);
  border-radius:var(--radius-pill); padding:12px 24px;
  font-size:13px; font-weight:500; color:var(--text);
  z-index:9999; transition:transform .3s ease; white-space:nowrap;
  box-shadow:var(--shadow);
}
.toast.show { transform:translateX(-50%) translateY(0); }

/* ===== INSIGHT CARD ===== */
.insight {
  background:var(--gradient-card); border:1px solid var(--glass-border);
  border-radius:var(--radius-m); padding:14px 16px;
  margin-bottom:10px; display:flex; gap:10px; align-items:flex-start;
}
.insight i { font-size:18px; color:var(--orange); flex-shrink:0; margin-top:2px; }
.insight p { font-size:13px; color:var(--text2); line-height:1.5; }

/* ===== ONBOARDING ===== */
.onb { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; padding:32px 24px; text-align:center; }
.onb-icon { font-size:64px; margin-bottom:24px; }
.onb h1 { font-size:28px; font-weight:800; margin-bottom:12px; letter-spacing:-0.5px; }
.onb p { font-size:15px; color:var(--text2); margin-bottom:32px; line-height:1.6; }
.onb .field { width:100%; text-align:left; }

/* ===== EMPTY STATE ===== */
.empty { text-align:center; padding:40px 20px; color:var(--text3); }
.empty i { font-size:48px; margin-bottom:12px; opacity:0.3; }
.empty p { font-size:14px; }

/* ===== SCROLL ===== */
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--card-border); border-radius:2px; }

/* ===== CATEGORY GRID ===== */
.cat-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
.cat-opt {
  display:flex; flex-direction:column; align-items:center; gap:4px;
  padding:12px 4px; border-radius:var(--radius-m);
  background:var(--card); border:2px solid transparent;
  cursor:pointer; transition:all .2s;
}
.cat-opt.active { border-color:var(--accent); background:rgba(139,92,246,0.1); }
.cat-opt i { font-size:22px; }
.cat-opt span { font-size:10px; color:var(--text2); text-align:center; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; width:100%; }

/* ===== WEEKDAY CHART ===== */
.wd-bar-row { display:flex; align-items:flex-end; gap:4px; height:80px; margin:12px 0; }
.wd-bar {
  flex:1; background:var(--gradient); border-radius:4px 4px 0 0;
  min-height:4px; transition:height .5s ease; position:relative;
}
.wd-labels { display:flex; gap:4px; }
.wd-labels span { flex:1; text-align:center; font-size:10px; color:var(--text3); }

</style>
</head>
<body>
<div class="app" id="app">
  <div class="glow-bg"></div>

  <!-- ===== ONBOARDING ===== -->
  <div class="screen" id="scr-onb">
    <div class="onb">
      <i class="ri-money-dollar-circle-line" style="font-size:64px;color:var(--accent)"></i>
      <h1>MyCosts Titanium</h1>
      <p>–í–∞—à —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä. –ë—é–¥–∂–µ—Ç, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –¥–æ–ª–≥–∏, –∫—ç—à—Ñ–ª–æ—É ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.</p>
      <div class="field">
        <label>–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?</label>
        <input type="text" id="onb-name" placeholder="–ò–º—è">
      </div>
      <div class="field">
        <label>–ú–µ—Å—è—á–Ω—ã–π –±—é–¥–∂–µ—Ç (‚ÇΩ)</label>
        <input type="number" id="onb-limit" placeholder="50000">
      </div>
      <button class="btn btn-main" onclick="finishOnb()">–ù–∞—á–∞—Ç—å</button>
    </div>
  </div>

  <!-- ===== HOME ===== -->
  <div class="screen" id="scr-home">
    <div class="month-sel">
      <div class="arr" onclick="changeMonth(-1)"><i class="ri-arrow-left-s-line"></i></div>
      <div class="m-label" id="home-month"></div>
      <div class="arr" onclick="changeMonth(1)"><i class="ri-arrow-right-s-line"></i></div>
    </div>
    <div class="bal-card">
      <div class="bal-label">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
      <div class="bal-amount" id="home-balance">0 ‚ÇΩ</div>
      <div class="bal-row">
        <div class="bal-item"><div class="bal-item-label">–î–æ—Ö–æ–¥</div><div class="bal-item-val inc" id="home-inc">0 ‚ÇΩ</div></div>
        <div class="bal-item"><div class="bal-item-label">–†–∞—Å—Ö–æ–¥</div><div class="bal-item-val exp" id="home-exp">0 ‚ÇΩ</div></div>
        <div class="bal-item"><div class="bal-item-label">–ö—ç—à—Ñ–ª–æ—É</div><div class="bal-item-val cf" id="home-cf">0 ‚ÇΩ</div></div>
      </div>
    </div>

    <!-- Budget progress -->
    <div class="card" id="budget-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <span style="font-size:13px;font-weight:600;">–ë—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü</span>
        <span style="font-size:13px;color:var(--text2)" id="budget-text">0 / 0 ‚ÇΩ</span>
      </div>
      <div class="prog-bar"><div class="prog-fill" id="budget-fill" style="width:0%"></div></div>
    </div>

    <!-- Cashflow -->
    <div class="sec">
      <div class="sec-head"><span class="sec-title">–ö—ç—à—Ñ–ª–æ—É</span></div>
      <div class="cf-grid">
        <div class="cf-card"><div class="cf-label">–ê–∫—Ç–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</div><div class="cf-val pos" id="cf-active">0 ‚ÇΩ</div></div>
        <div class="cf-card"><div class="cf-label">–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</div><div class="cf-val pos" id="cf-passive">0 ‚ÇΩ</div></div>
        <div class="cf-card"><div class="cf-label">–†–∞—Å—Ö–æ–¥—ã</div><div class="cf-val neg" id="cf-expenses">0 ‚ÇΩ</div></div>
        <div class="cf-card"><div class="cf-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–ª–≥–æ–≤</div><div class="cf-val neg" id="cf-debts">0 ‚ÇΩ</div></div>
        <div class="cf-card full">
          <div class="cf-label">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–±–æ–¥–∞</div>
          <div class="cf-val" id="cf-freedom" style="color:var(--accent)">0%</div>
          <div class="prog-wrap"><div class="prog-bar"><div class="prog-fill" id="cf-freedom-fill" style="width:0%"></div></div></div>
        </div>
      </div>
    </div>

    <!-- Recent transactions -->
    <div class="sec">
      <div class="sec-head"><span class="sec-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</span><span class="sec-link" onclick="go('analytics')">–í—Å–µ</span></div>
      <div class="card" id="home-tx-list">
        <div class="empty"><i class="ri-inbox-line"></i><p>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p></div>
      </div>
    </div>
  </div>

  <!-- ===== WALLET ===== -->
  <div class="screen" id="scr-wallet">
    <h2 style="font-size:22px;font-weight:800;margin-bottom:16px;">–ö–æ—à–µ–ª—ë–∫</h2>

    <div class="seg" id="wallet-seg">
      <button class="seg-btn active" onclick="setWalletTab('accounts')">–°—á–µ—Ç–∞</button>
      <button class="seg-btn" onclick="setWalletTab('goals')">–¶–µ–ª–∏</button>
      <button class="seg-btn" onclick="setWalletTab('debts')">–î–æ–ª–≥–∏</button>
    </div>

    <div id="wallet-accounts"></div>
    <div id="wallet-goals" style="display:none"></div>
    <div id="wallet-debts" style="display:none"></div>

    <button class="btn btn-sec" style="margin-top:12px" id="wallet-add-btn" onclick="openWalletAdd()">
      <i class="ri-add-line"></i> –î–æ–±–∞–≤–∏—Ç—å
    </button>
  </div>

  <!-- ===== ANALYTICS ===== -->
  <div class="screen" id="scr-analytics">
    <h2 style="font-size:22px;font-weight:800;margin-bottom:16px;">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>

    <div class="month-sel">
      <div class="arr" onclick="changeMonth(-1)"><i class="ri-arrow-left-s-line"></i></div>
      <div class="m-label" id="stats-month"></div>
      <div class="arr" onclick="changeMonth(1)"><i class="ri-arrow-right-s-line"></i></div>
    </div>

    <div class="seg">
      <button class="seg-btn active" onclick="setStatsType('expense')">–†–∞—Å—Ö–æ–¥—ã</button>
      <button class="seg-btn" onclick="setStatsType('income')">–î–æ—Ö–æ–¥—ã</button>
    </div>

    <div class="chart-box"><canvas id="chart-pie"></canvas></div>

    <div id="stats-cats"></div>

    <!-- Weekday analysis -->
    <div class="sec" style="margin-top:20px">
      <div class="sec-head"><span class="sec-title">–ü–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</span></div>
      <div class="card">
        <div class="wd-bar-row" id="wd-bars"></div>
        <div class="wd-labels" id="wd-labels"></div>
      </div>
    </div>

    <!-- Insights -->
    <div class="sec" style="margin-top:16px">
      <div class="sec-head"><span class="sec-title">–ò–Ω—Å–∞–π—Ç—ã</span></div>
      <div id="insights-list"></div>
    </div>

    <!-- All transactions -->
    <div class="sec" style="margin-top:16px">
      <div class="sec-head"><span class="sec-title">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</span></div>
      <div id="all-tx-list"></div>
    </div>
  </div>

  <!-- ===== INVESTMENTS ===== -->
  <div class="screen" id="scr-invest">
    <h2 style="font-size:22px;font-weight:800;margin-bottom:16px;">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h2>
    <div class="chart-box"><canvas id="chart-inv"></canvas></div>
    <div id="inv-list"></div>
    <button class="btn btn-sec" style="margin-top:12px" onclick="openAddAccount('invest')"><i class="ri-add-line"></i> –ù–æ–≤–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è</button>
  </div>

  <!-- ===== PROFILE ===== -->
  <div class="screen" id="scr-profile">
    <div class="profile-avatar" id="prof-avatar">–ö</div>
    <div class="profile-name" id="prof-name">‚Äî</div>
    <div class="profile-sub" id="prof-sub">MyCosts Titanium v16.0</div>

    <div class="profile-section">
      <div class="profile-section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <div class="profile-card">
        <div class="profile-row" onclick="toggleTheme()">
          <div class="profile-row-left"><i class="ri-moon-line" id="theme-icon"></i><span class="profile-row-label">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span></div>
          <div class="toggle" id="theme-toggle"><span></span></div>
        </div>
        <div class="profile-row" onclick="openEditLimit()">
          <div class="profile-row-left"><i class="ri-wallet-3-line"></i><span class="profile-row-label">–õ–∏–º–∏—Ç –±—é–¥–∂–µ—Ç–∞</span></div>
          <span class="profile-row-right" id="prof-limit" style="font-size:14px;color:var(--text2)">0 ‚ÇΩ</span>
        </div>
      </div>
    </div>

    <div class="profile-section">
      <div class="profile-section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
      <div class="profile-card">
        <div class="profile-row" onclick="manageCategories()">
          <div class="profile-row-left"><i class="ri-price-tag-3-line"></i><span class="profile-row-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span></div>
          <div class="profile-row-right"><i class="ri-arrow-right-s-line"></i></div>
        </div>
        <div class="profile-row" onclick="syncNow()">
          <div class="profile-row-left"><i class="ri-refresh-line"></i><span class="profile-row-label">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</span></div>
          <div class="profile-row-right"><i class="ri-arrow-right-s-line"></i></div>
        </div>
        <div class="profile-row" onclick="exportData()">
          <div class="profile-row-left"><i class="ri-download-2-line"></i><span class="profile-row-label">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</span></div>
          <div class="profile-row-right"><i class="ri-arrow-right-s-line"></i></div>
        </div>
      </div>
    </div>

    <div class="profile-section">
      <button class="btn btn-danger" onclick="resetApp()"><i class="ri-delete-bin-line"></i> –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫</button>
    </div>
  </div>
</div>

<!-- ===== FAB ===== -->
<button class="fab" id="fab" onclick="openAddTx()"><i class="ri-add-line"></i></button>

<!-- ===== BOTTOM NAV ===== -->
<nav class="nav">
  <button class="nav-item active" onclick="go('home')"><i class="ri-home-5-line"></i><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
  <button class="nav-item" onclick="go('wallet')"><i class="ri-wallet-3-line"></i><span>–ö–æ—à–µ–ª—ë–∫</span></button>
  <button class="nav-item" onclick="go('analytics')"><i class="ri-pie-chart-line"></i><span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span></button>
  <button class="nav-item" onclick="go('invest')"><i class="ri-line-chart-line"></i><span>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</span></button>
  <button class="nav-item" onclick="go('profile')"><i class="ri-user-3-line"></i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
</nav>

<!-- ===== MODAL: ADD TRANSACTION ===== -->
<div class="modal-overlay" id="modal-tx">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</div>
    <div class="seg">
      <button class="seg-btn active" onclick="setTxType('expense')">–†–∞—Å—Ö–æ–¥</button>
      <button class="seg-btn" onclick="setTxType('income')">–î–æ—Ö–æ–¥</button>
    </div>
    <div class="field"><label>–°—É–º–º–∞</label><input type="number" id="tx-amount" placeholder="0" inputmode="decimal"></div>
    <div class="field" id="tx-income-type-wrap" style="display:none">
      <label>–¢–∏–ø –¥–æ—Ö–æ–¥–∞</label>
      <select id="tx-income-type"><option value="active">–ê–∫—Ç–∏–≤–Ω—ã–π</option><option value="passive">–ü–∞—Å—Å–∏–≤–Ω—ã–π</option></select>
    </div>
    <div class="field"><label>–°—á—ë—Ç</label><select id="tx-account"></select></div>
    <div class="field"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><div class="cat-grid" id="tx-cats"></div></div>
    <div class="field"><label>–î–∞—Ç–∞</label><input type="date" id="tx-date"></div>
    <div class="field"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input type="text" id="tx-comment" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"></div>
    <button class="btn btn-main" onclick="saveTx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="closeModal('modal-tx')">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- ===== MODAL: ADD ACCOUNT ===== -->
<div class="modal-overlay" id="modal-acc">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="acc-modal-title">–ù–æ–≤—ã–π —Å—á—ë—Ç</div>
    <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="acc-name" placeholder="–ö–∞—Ä—Ç–∞, –ù–∞–ª–∏—á–Ω—ã–µ..."></div>
    <div class="field"><label>–¢–∏–ø</label>
      <select id="acc-type">
        <option value="card">–ö–∞—Ä—Ç–∞</option>
        <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
        <option value="invest">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è</option>
        <option value="jar">–ö–æ–ø–∏–ª–∫–∞</option>
      </select>
    </div>
    <div class="field"><label>–ë–∞–ª–∞–Ω—Å</label><input type="number" id="acc-balance" placeholder="0"></div>
    <div class="field" id="acc-percent-wrap"><label>–ì–æ–¥–æ–≤–æ–π % (–µ—Å–ª–∏ –µ—Å—Ç—å)</label><input type="number" id="acc-percent" placeholder="0" step="0.1"></div>
    <div class="field" id="acc-divday-wrap" style="display:none"><label>–î–∞—Ç–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤ (—á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞)</label><input type="number" id="acc-divday" placeholder="15" min="1" max="31"></div>
    <div class="field" id="acc-goal-wrap" style="display:none"><label>–¶–µ–ª—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</label><input type="number" id="acc-goal" placeholder="0"></div>
    <div class="toggle-row" id="acc-income-row" style="display:none">
      <div><div class="toggle-label">–°—á–∏—Ç–∞—Ç—å –∫–∞–∫ –¥–æ—Ö–æ–¥</div><div class="toggle-sub">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç—Ä–∞–∑—è—Ç—Å—è –≤ –∫—ç—à—Ñ–ª–æ—É</div></div>
      <div class="toggle" id="acc-as-income" onclick="this.classList.toggle('on')"></div>
    </div>
    <button class="btn btn-main" onclick="saveAccount()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="closeModal('modal-acc')">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- ===== MODAL: ADD GOAL ===== -->
<div class="modal-overlay" id="modal-goal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–ù–æ–≤–∞—è —Ü–µ–ª—å</div>
    <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="goal-name" placeholder="–ú–∞—à–∏–Ω–∞, –û—Ç–ø—É—Å–∫..."></div>
    <div class="field"><label>–°—É–º–º–∞ —Ü–µ–ª–∏</label><input type="number" id="goal-target" placeholder="100000"></div>
    <div class="field"><label>–£–∂–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ</label><input type="number" id="goal-current" placeholder="0"></div>
    <div class="field"><label>–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ —Å—á—ë—Ç—É</label><select id="goal-account"><option value="">–ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏</option></select></div>
    <button class="btn btn-main" onclick="saveGoal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="closeModal('modal-goal')">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- ===== MODAL: ADD DEBT ===== -->
<div class="modal-overlay" id="modal-debt">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–ù–æ–≤—ã–π –¥–æ–ª–≥</div>
    <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="debt-name" placeholder="–ö—Ä–µ–¥–∏—Ç–∫–∞, –†–∞—Å—Å—Ä–æ—á–∫–∞..."></div>
    <div class="field"><label>–°—É–º–º–∞ –¥–æ–ª–≥–∞</label><input type="number" id="debt-amount" placeholder="50000"></div>
    <div class="field"><label>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂</label><input type="number" id="debt-monthly" placeholder="5000"></div>
    <div class="field"><label>–ì–æ–¥–æ–≤–æ–π % (0 –µ—Å–ª–∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∞)</label><input type="number" id="debt-percent" placeholder="0" step="0.1"></div>
    <div class="field"><label>–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ (—á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞)</label><input type="number" id="debt-duedate" placeholder="15" min="1" max="31"></div>
    <div class="toggle-row">
      <div><div class="toggle-label">–£—á–∏—Ç—ã–≤–∞—Ç—å % –≤ –∫—ç—à—Ñ–ª–æ—É</div><div class="toggle-sub">–ü—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ –¥–æ–ª–≥—É –≤—ã—á—Ç—É—Ç—Å—è –∏–∑ –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞</div></div>
      <div class="toggle" id="debt-affects-cf" onclick="this.classList.toggle('on')"></div>
    </div>
    <button class="btn btn-main" onclick="saveDebt()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="closeModal('modal-debt')">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- ===== MODAL: DEBT PAYMENT ===== -->
<div class="modal-overlay" id="modal-debt-pay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="debt-pay-title">–í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç—ë–∂</div>
    <div class="field"><label>–°—É–º–º–∞</label><input type="number" id="debt-pay-amount" placeholder="0"></div>
    <div class="field"><label>–°–æ —Å—á—ë—Ç–∞</label><select id="debt-pay-account"></select></div>
    <div class="seg">
      <button class="seg-btn active" onclick="setDebtPayType('regular')">–ü–ª–∞—Ç—ë–∂ –ø–æ –≥—Ä–∞—Ñ–∏–∫—É</button>
      <button class="seg-btn" onclick="setDebtPayType('early')">–î–æ—Å—Ä–æ—á–Ω—ã–π</button>
    </div>
    <button class="btn btn-main" onclick="payDebt()">–í–Ω–µ—Å—Ç–∏</button>
    <button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="closeModal('modal-debt-pay')">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- ===== MODAL: CATEGORIES ===== -->
<div class="modal-overlay" id="modal-cats">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
    <div class="seg">
      <button class="seg-btn active" onclick="setCatManageType('expense')">–†–∞—Å—Ö–æ–¥—ã</button>
      <button class="seg-btn" onclick="setCatManageType('income')">–î–æ—Ö–æ–¥—ã</button>
    </div>
    <div id="cat-manage-list"></div>
    <button class="btn btn-sec" style="margin-top:12px" onclick="openAddCat()"><i class="ri-add-line"></i> –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</button>
    <button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="closeModal('modal-cats')">–ì–æ—Ç–æ–≤–æ</button>
  </div>
</div>

<!-- ===== MODAL: ADD CATEGORY ===== -->
<div class="modal-overlay" id="modal-add-cat">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
    <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="new-cat-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"></div>
    <div class="field"><label>–¢–∏–ø</label>
      <select id="new-cat-type"><option value="expense">–†–∞—Å—Ö–æ–¥</option><option value="income">–î–æ—Ö–æ–¥</option></select>
    </div>
    <div class="field"><label>–ò–∫–æ–Ω–∫–∞</label>
      <div class="cat-grid" id="icon-picker"></div>
    </div>
    <button class="btn btn-main" onclick="saveCat()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="closeModal('modal-add-cat')">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- ===== MODAL: EDIT LIMIT ===== -->
<div class="modal-overlay" id="modal-limit">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–õ–∏–º–∏—Ç –±—é–¥–∂–µ—Ç–∞</div>
    <div class="field"><label>–ú–µ—Å—è—á–Ω—ã–π –ª–∏–º–∏—Ç (‚ÇΩ)</label><input type="number" id="edit-limit" placeholder="50000"></div>
    <button class="btn btn-main" onclick="saveLimit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="closeModal('modal-limit')">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- ===== MODAL: TRANSFER ===== -->
<div class="modal-overlay" id="modal-transfer">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏</div>
    <div class="field"><label>–û—Ç–∫—É–¥–∞</label><select id="tr-from"></select></div>
    <div class="field"><label>–ö—É–¥–∞</label><select id="tr-to"></select></div>
    <div class="field"><label>–°—É–º–º–∞</label><input type="number" id="tr-amount" placeholder="0"></div>
    <button class="btn btn-main" onclick="doTransfer()">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
    <button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="closeModal('modal-transfer')">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- ===== TOAST ===== -->
<div class="toast" id="toast"></div>

<script>
/* ============================================================
   MyCosts Titanium v16.0
   ============================================================ */

const API_URL='https://script.google.com/macros/s/AKfycbzo_iK3lLdLb6VZtGgkrM6IDZiMuW2sMK6FnjjMl4EsqrZMfH3CPJ_frANSEdv-Wiob/exec';
const DB_KEY='onyx_db';
const ICONS=[
  'ri-shopping-bag-line','ri-restaurant-line','ri-car-line','ri-bus-line',
  'ri-home-4-line','ri-heart-pulse-line','ri-gamepad-line','ri-movie-2-line',
  'ri-book-open-line','ri-t-shirt-line','ri-smartphone-line','ri-gift-line',
  'ri-briefcase-line','ri-computer-line','ri-code-s-slash-line','ri-bank-line',
  'ri-money-dollar-circle-line','ri-hand-coin-line','ri-stock-line','ri-funds-line',
  'ri-percent-line','ri-building-2-line','ri-service-line','ri-truck-line',
  'ri-drop-line','ri-flashlight-line','ri-wifi-line','ri-music-2-line',
  'ri-cup-line','ri-scissors-line','ri-palette-line','ri-plane-line'
];
const COLORS=['#8B5CF6','#6366F1','#F97316','#10B981','#EF4444','#3B82F6','#EC4899','#14B8A6','#F59E0B','#6B7280','#A855F7','#22D3EE'];
const MONTHS_RU=['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
const WEEKDAYS_RU=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
const MOTIVATIONAL=['–¢—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è! üí™','–ö–∞–∂–¥—ã–π –ø–ª–∞—Ç—ë–∂ ‚Äî —à–∞–≥ –∫ —Å–≤–æ–±–æ–¥–µ!','–î–æ–ª–≥–∏ –Ω–µ –≤–µ—á–Ω—ã, —Ç—ã ‚Äî –¥–∞!','–§–∏–Ω–∏—à –±–ª–∏–∑–∫–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–π!'];

let db, curMonth=new Date().getMonth(), curYear=new Date().getFullYear();
let curTxType='expense', curStatsType='expense', curWalletTab='accounts', curCatManageType='expense';
let curDebtPayType='regular', payingDebtId=null, selectedCatId=null, selectedIcon=null;
let chartPie=null, chartInv=null;

// ===== DB =====
function defaultDB(){
  const uid=getUserId();
  return {
    user:{id:uid,name:'',limit:50000,joined_at:new Date().toISOString()},
    accounts:[],categories:[],transactions:[],goals:[],debts:[]
  };
}
function getUserId(){
  try{ if(window.Telegram?.WebApp?.initDataUnsafe?.user?.id) return 'tg_'+window.Telegram.WebApp.initDataUnsafe.user.id; }catch(e){}
  let id=localStorage.getItem('onyx_uid');
  if(!id){id='u_'+Date.now()+'_'+Math.random().toString(36).slice(2,8);localStorage.setItem('onyx_uid',id);}
  return id;
}
function loadDB(){
  try{const d=JSON.parse(localStorage.getItem(DB_KEY));if(d&&d.user){db=d;migrate();return;}}catch(e){}
  db=defaultDB();
}
function saveDB(){localStorage.setItem(DB_KEY,JSON.stringify(db));}
function migrate(){
  if(!db.goals)db.goals=[];
  if(!db.debts)db.debts=[];
  if(!db.user.limit)db.user.limit=50000;
  db.accounts.forEach(a=>{if(!a.divDay)a.divDay='';if(!a.currency)a.currency='RUB';});
  db.categories.forEach(c=>{if(!c.color)c.color=COLORS[Math.floor(Math.random()*COLORS.length)];});
  db.transactions.forEach(t=>{if(!t.incomeType)t.incomeType='active';t.amount=Number(t.amount)||0;});
  db.debts.forEach(d=>{if(!d.payments)d.payments='[]';if(d.affectsCashflow===undefined)d.affectsCashflow=false;});
}

// ===== INIT =====
function init(){
  loadDB();
  initTheme();
  if(!db.user.name||db.accounts.length===0){showScreen('onb');return;}
  go('home');
  loadFromServer();
}

// ===== ONBOARDING =====
function finishOnb(){
  const name=document.getElementById('onb-name').value.trim();
  const limit=Number(document.getElementById('onb-limit').value)||50000;
  if(!name){toast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');return;}
  db.user.name=name; db.user.limit=limit;
  // Default categories
  const defCats=[
    {name:'–ï–¥–∞',type:'expense',icon:'ri-restaurant-line'},
    {name:'–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',type:'expense',icon:'ri-car-line'},
    {name:'–î–æ–º',type:'expense',icon:'ri-home-4-line'},
    {name:'–ó–¥–æ—Ä–æ–≤—å–µ',type:'expense',icon:'ri-heart-pulse-line'},
    {name:'–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è',type:'expense',icon:'ri-gamepad-line'},
    {name:'–û–¥–µ–∂–¥–∞',type:'expense',icon:'ri-t-shirt-line'},
    {name:'–°–≤—è–∑—å',type:'expense',icon:'ri-wifi-line'},
    {name:'–ü—Ä–æ—á–µ–µ',type:'expense',icon:'ri-more-line'},
    {name:'–ó–∞—Ä–ø–ª–∞—Ç–∞',type:'income',icon:'ri-briefcase-line'},
    {name:'–§—Ä–∏–ª–∞–Ω—Å',type:'income',icon:'ri-computer-line'},
    {name:'–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏',type:'income',icon:'ri-funds-line'},
    {name:'–ü–æ–¥–∞—Ä–∫–∏',type:'income',icon:'ri-gift-line'},
    {name:'–ü—Ä–æ—á–µ–µ',type:'income',icon:'ri-hand-coin-line'},
  ];
  defCats.forEach((c,i)=>{
    db.categories.push({id:'c'+(i+1),user_id:db.user.id,name:c.name,type:c.type,icon:c.icon,color:COLORS[i%COLORS.length]});
  });
  // Default accounts
  db.accounts.push({id:'a1',user_id:db.user.id,name:'–ö–∞—Ä—Ç–∞',type:'card',balance:0,goal:'',percent:0,divDay:'',currency:'RUB'});
  db.accounts.push({id:'a2',user_id:db.user.id,name:'–ù–∞–ª–∏—á–Ω—ã–µ',type:'cash',balance:0,goal:'',percent:0,divDay:'',currency:'RUB'});
  saveDB(); pushData();
  go('home');
  toast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, '+name+'!');
}

// ===== NAVIGATION =====
function go(screen){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('scr-'+screen).classList.add('active');
  document.querySelectorAll('.nav-item').forEach((n,i)=>{
    const tabs=['home','wallet','analytics','invest','profile'];
    n.classList.toggle('active',tabs[i]===screen);
  });
  document.getElementById('fab').style.display=(screen==='profile'||screen==='onb')?'none':'flex';
  if(screen==='home')renderHome();
  if(screen==='wallet')renderWallet();
  if(screen==='analytics')renderAnalytics();
  if(screen==='invest')renderInvest();
  if(screen==='profile')renderProfile();
}
function showScreen(s){
  document.querySelectorAll('.screen').forEach(el=>el.classList.remove('active'));
  document.getElementById('scr-'+s).classList.add('active');
  if(s==='onb')document.getElementById('fab').style.display='none';
}

// ===== MONTH =====
function changeMonth(d){
  curMonth+=d;
  if(curMonth>11){curMonth=0;curYear++;}
  if(curMonth<0){curMonth=11;curYear--;}
  renderMonthLabels();
  const scr=document.querySelector('.screen.active');
  if(scr.id==='scr-home')renderHome();
  if(scr.id==='scr-analytics')renderAnalytics();
}
function renderMonthLabels(){
  const label=MONTHS_RU[curMonth]+' '+curYear;
  const el1=document.getElementById('home-month');
  const el2=document.getElementById('stats-month');
  if(el1)el1.textContent=label;
  if(el2)el2.textContent=label;
}
function txInMonth(t){
  if(!t.date)return false;
  const d=new Date(t.date);
  return d.getMonth()===curMonth&&d.getFullYear()===curYear;
}

// ===== FORMATTING =====
function fmt(n){return Number(n||0).toLocaleString('ru-RU')+' ‚ÇΩ';}
function fmtDate(d){if(!d)return '';const dt=new Date(d);return dt.toLocaleDateString('ru-RU',{day:'numeric',month:'short'});}

// ===== RENDER HOME =====
function renderHome(){
  renderMonthLabels();
  const txs=db.transactions.filter(txInMonth);
  let totalBal=0; db.accounts.forEach(a=>totalBal+=Number(a.balance)||0);
  let inc=0,exp=0,actInc=0,pasInc=0;
  txs.forEach(t=>{
    const a=Number(t.amount)||0;
    if(t.type==='income'){inc+=a;if(t.incomeType==='passive')pasInc+=a;else actInc+=a;}
    else exp+=a;
  });
  const cf=inc-exp;
  document.getElementById('home-balance').textContent=fmt(totalBal);
  document.getElementById('home-inc').textContent=fmt(inc);
  document.getElementById('home-exp').textContent=fmt(exp);
  document.getElementById('home-cf').textContent=fmt(cf);
  document.getElementById('home-cf').className='bal-item-val '+(cf>=0?'pos':'neg');

  // Budget
  const limit=Number(db.user.limit)||1;
  const pct=Math.min(100,Math.round(exp/limit*100));
  document.getElementById('budget-text').textContent=fmt(exp)+' / '+fmt(limit);
  document.getElementById('budget-fill').style.width=pct+'%';
  document.getElementById('budget-fill').style.background=pct>90?'var(--red)':pct>70?'var(--orange)':'var(--gradient)';

  // Cashflow
  let debtCost=0;
  db.debts.forEach(d=>{
    if(d.affectsCashflow){
      const remaining=Number(d.amount)-Number(d.paid||0);
      if(remaining>0) debtCost+=remaining*(Number(d.percent)||0)/100/12;
    }
  });
  document.getElementById('cf-active').textContent=fmt(actInc);
  document.getElementById('cf-passive').textContent=fmt(pasInc);
  document.getElementById('cf-expenses').textContent=fmt(exp);
  document.getElementById('cf-debts').textContent=fmt(Math.round(debtCost));
  const netPassive=pasInc-debtCost;
  const freedom=exp>0?Math.round((netPassive/exp)*100):0;
  document.getElementById('cf-freedom').textContent=freedom+'%';
  document.getElementById('cf-freedom').style.color=freedom>=100?'var(--green)':freedom>=0?'var(--accent)':'var(--red)';
  document.getElementById('cf-freedom-fill').style.width=Math.max(0,Math.min(100,freedom))+'%';

  // Recent TXs
  const recent=txs.sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
  const el=document.getElementById('home-tx-list');
  if(recent.length===0){el.innerHTML='<div class="empty"><i class="ri-inbox-line"></i><p>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p></div>';return;}
  el.innerHTML=recent.map(t=>{
    const cat=db.categories.find(c=>c.id===t.category_id)||{icon:'ri-question-line',name:'‚Äî'};
    return `<div class="tx-item">
      <div class="tx-icon"><i class="${cat.icon}"></i></div>
      <div class="tx-info"><div class="tx-name">${cat.name}</div><div class="tx-cat">${fmtDate(t.date)}${t.comment?' ¬∑ '+t.comment:''}</div></div>
      <div><div class="tx-amount ${t.type==='income'?'inc':'exp'}">${t.type==='income'?'+':'‚àí'}${fmt(Math.abs(t.amount))}</div></div>
    </div>`;
  }).join('');
}

// ===== RENDER WALLET =====
function renderWallet(){
  setWalletTab(curWalletTab);
}
function setWalletTab(tab){
  curWalletTab=tab;
  document.querySelectorAll('#wallet-seg .seg-btn').forEach((b,i)=>{
    const tabs=['accounts','goals','debts'];
    b.classList.toggle('active',tabs[i]===tab);
  });
  document.getElementById('wallet-accounts').style.display=tab==='accounts'?'block':'none';
  document.getElementById('wallet-goals').style.display=tab==='goals'?'block':'none';
  document.getElementById('wallet-debts').style.display=tab==='debts'?'block':'none';
  if(tab==='accounts')renderAccounts();
  if(tab==='goals')renderGoals();
  if(tab==='debts')renderDebts();
}
function renderAccounts(){
  const el=document.getElementById('wallet-accounts');
  if(db.accounts.length===0){el.innerHTML='<div class="empty"><i class="ri-wallet-3-line"></i><p>–ù–µ—Ç —Å—á–µ—Ç–æ–≤</p></div>';return;}
  const types={card:'–ö–∞—Ä—Ç–∞',cash:'–ù–∞–ª–∏—á–Ω—ã–µ',invest:'–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è',jar:'–ö–æ–ø–∏–ª–∫–∞'};
  el.innerHTML=db.accounts.filter(a=>a.type!=='invest').map(a=>`
    <div class="acc-card">
      <div class="acc-row"><div><div class="acc-name">${a.name}</div><div class="acc-type">${types[a.type]||a.type}${a.percent?' ¬∑ '+a.percent+'%':''}</div></div>
      <div class="acc-bal">${fmt(a.balance)}</div></div>
      ${a.type==='jar'&&a.goal?`<div class="prog-wrap"><div class="prog-bar"><div class="prog-fill" style="width:${Math.min(100,Math.round(a.balance/a.goal*100))}%"></div></div><div class="prog-labels"><span>${fmt(a.balance)}</span><span>${fmt(a.goal)}</span></div></div>`:''}
    </div>`).join('');
  // Transfer button
  if(db.accounts.length>1){
    el.innerHTML+=`<button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="openTransfer()"><i class="ri-arrow-left-right-line"></i> –ü–µ—Ä–µ–≤–æ–¥</button>`;
  }
}
function renderGoals(){
  const el=document.getElementById('wallet-goals');
  if(db.goals.length===0){el.innerHTML='<div class="empty"><i class="ri-flag-line"></i><p>–ù–µ—Ç —Ü–µ–ª–µ–π</p></div>';return;}
  el.innerHTML=db.goals.map(g=>{
    const pct=Number(g.target)>0?Math.min(100,Math.round(Number(g.current)/Number(g.target)*100)):0;
    return `<div class="goal-card card"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-weight:600">${g.name}</span><span style="font-size:13px;color:var(--text2)">${pct}%</span></div>
    <div class="prog-bar"><div class="prog-fill" style="width:${pct}%"></div></div>
    <div class="prog-labels"><span>${fmt(g.current)}</span><span>${fmt(g.target)}</span></div></div>`;
  }).join('');
}
function renderDebts(){
  const el=document.getElementById('wallet-debts');
  if(db.debts.length===0){el.innerHTML='<div class="empty"><i class="ri-bank-line"></i><p>–ù–µ—Ç –¥–æ–ª–≥–æ–≤ ‚Äî –∏ —ç—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ!</p></div>';return;}
  el.innerHTML=db.debts.map(d=>{
    const remaining=Number(d.amount)-Number(d.paid||0);
    const isPaid=remaining<=0;
    const monthsLeft=Number(d.monthlyPayment)>0?Math.ceil(remaining/Number(d.monthlyPayment)):0;
    const monthlyCost=d.affectsCashflow&&Number(d.percent)>0?Math.round(remaining*Number(d.percent)/100/12):0;
    return `<div class="debt-card${isPaid?' paid':''}">
      <div class="debt-top"><div class="debt-name">${d.name}</div><div class="debt-badge${isPaid?' done':''}">${isPaid?'–ó–∞–∫—Ä—ã—Ç':'–ê–∫—Ç–∏–≤–µ–Ω'}</div></div>
      <div class="debt-stat">
        –û—Å—Ç–∞–ª–æ—Å—å: <strong>${fmt(remaining)}</strong> –∏–∑ ${fmt(d.amount)}<br>
        ${d.percent?'–°—Ç–∞–≤–∫–∞: '+d.percent+'% –≥–æ–¥–æ–≤—ã—Ö<br>':''}
        ${d.monthlyPayment?'–ü–ª–∞—Ç—ë–∂: '+fmt(d.monthlyPayment)+'/–º–µ—Å<br>':''}
        ${monthlyCost?'–°—Ç–æ–∏—Ç –≤–∞–º: <strong style="color:var(--red)">'+fmt(monthlyCost)+'/–º–µ—Å</strong><br>':''}
        ${monthsLeft>0?'‚âà '+monthsLeft+' –º–µ—Å –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è':''}
      </div>
      <div class="prog-wrap"><div class="prog-bar"><div class="prog-fill" style="width:${Number(d.amount)>0?Math.round(Number(d.paid||0)/Number(d.amount)*100):0}%;background:var(--green)"></div></div></div>
      ${!isPaid?`<div class="debt-actions">
        <button class="btn btn-ghost btn-sm" onclick="openDebtPay('${d.id}')"><i class="ri-money-dollar-circle-line"></i> –í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç—ë–∂</button>
      </div>
      <p style="font-size:11px;color:var(--text3);margin-top:8px;font-style:italic">${MOTIVATIONAL[Math.floor(Math.random()*MOTIVATIONAL.length)]}</p>`:''}
    </div>`;
  }).join('');
}

// ===== RENDER ANALYTICS =====
function renderAnalytics(){
  renderMonthLabels();
  const txs=db.transactions.filter(txInMonth);
  renderPieChart(txs);
  renderCatBreakdown(txs);
  renderWeekdays(txs);
  renderInsights(txs);
  renderAllTx(txs);
}
function setStatsType(type){
  curStatsType=type;
  document.querySelectorAll('#scr-analytics .seg .seg-btn').forEach((b,i)=>{
    b.classList.toggle('active',i===(type==='expense'?0:1));
  });
  renderAnalytics();
}
function renderPieChart(txs){
  const filtered=txs.filter(t=>t.type===curStatsType);
  const catMap={};
  filtered.forEach(t=>{
    const cid=t.category_id||'unknown';
    catMap[cid]=(catMap[cid]||0)+Number(t.amount);
  });
  const labels=[],data=[],colors=[];
  Object.keys(catMap).forEach(cid=>{
    const cat=db.categories.find(c=>c.id===cid)||{name:'–ü—Ä–æ—á–µ–µ',color:'#6B7280'};
    labels.push(cat.name);data.push(catMap[cid]);colors.push(cat.color||'#6B7280');
  });
  const ctx=document.getElementById('chart-pie');
  if(chartPie)chartPie.destroy();
  if(data.length===0){ctx.style.display='none';return;}
  ctx.style.display='block';
  chartPie=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:colors,borderWidth:0}]},options:{responsive:true,maintainAspectRatio:true,cutout:'65%',plugins:{legend:{display:false}}}});
}
function renderCatBreakdown(txs){
  const filtered=txs.filter(t=>t.type===curStatsType);
  const catMap={};
  filtered.forEach(t=>{const cid=t.category_id||'unknown';catMap[cid]=(catMap[cid]||0)+Number(t.amount);});
  const total=filtered.reduce((s,t)=>s+Number(t.amount),0)||1;
  const sorted=Object.entries(catMap).sort((a,b)=>b[1]-a[1]);
  const el=document.getElementById('stats-cats');
  if(sorted.length===0){el.innerHTML='<div class="empty"><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p></div>';return;}
  el.innerHTML=sorted.map(([cid,amount])=>{
    const cat=db.categories.find(c=>c.id===cid)||{name:'–ü—Ä–æ—á–µ–µ',icon:'ri-question-line',color:'#6B7280'};
    const pct=Math.round(amount/total*100);
    return `<div class="card" style="display:flex;align-items:center;gap:12px;padding:12px 16px;">
      <div class="tx-icon" style="background:${cat.color}22"><i class="${cat.icon}" style="color:${cat.color}"></i></div>
      <div style="flex:1"><div style="font-size:13px;font-weight:600">${cat.name}</div>
      <div class="prog-bar" style="margin-top:4px"><div class="prog-fill" style="width:${pct}%;background:${cat.color}"></div></div></div>
      <div style="text-align:right"><div style="font-size:14px;font-weight:700">${fmt(amount)}</div><div style="font-size:11px;color:var(--text3)">${pct}%</div></div>
    </div>`;
  }).join('');
}
function renderWeekdays(txs){
  const filtered=txs.filter(t=>t.type===curStatsType);
  const days=[0,0,0,0,0,0,0];
  filtered.forEach(t=>{
    if(!t.date)return;
    let wd=new Date(t.date).getDay();
    wd=wd===0?6:wd-1;// Mon=0
    days[wd]+=Number(t.amount);
  });
  const max=Math.max(...days,1);
  document.getElementById('wd-bars').innerHTML=days.map((v,i)=>`<div class="wd-bar" style="height:${Math.max(5,v/max*100)}%"></div>`).join('');
  document.getElementById('wd-labels').innerHTML=WEEKDAYS_RU.map(d=>`<span>${d}</span>`).join('');
}
function renderInsights(txs){
  const el=document.getElementById('insights-list');
  const insights=[];
  // Top category
  const expTxs=txs.filter(t=>t.type==='expense');
  if(expTxs.length>0){
    const catMap={};expTxs.forEach(t=>{const cid=t.category_id;catMap[cid]=(catMap[cid]||0)+Number(t.amount);});
    const topCid=Object.entries(catMap).sort((a,b)=>b[1]-a[1])[0];
    if(topCid){const cat=db.categories.find(c=>c.id===topCid[0]);if(cat)insights.push(`–ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤: <strong>${cat.name}</strong> ‚Äî ${fmt(topCid[1])}`);}
  }
  // Top income source
  const incTxs=txs.filter(t=>t.type==='income');
  if(incTxs.length>0){
    const catMap={};incTxs.forEach(t=>{const cid=t.category_id;catMap[cid]=(catMap[cid]||0)+Number(t.amount);});
    const topCid=Object.entries(catMap).sort((a,b)=>b[1]-a[1])[0];
    if(topCid){const cat=db.categories.find(c=>c.id===topCid[0]);if(cat)insights.push(`–ì–ª–∞–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞: <strong>${cat.name}</strong> ‚Äî ${fmt(topCid[1])}`);}
  }
  // Weekday insight
  if(expTxs.length>3){
    const days=[0,0,0,0,0,0,0];
    expTxs.forEach(t=>{if(!t.date)return;let wd=new Date(t.date).getDay();wd=wd===0?6:wd-1;days[wd]+=Number(t.amount);});
    const maxDay=days.indexOf(Math.max(...days));
    insights.push(`–°–∞–º—ã–π –∑–∞—Ç—Ä–∞—Ç–Ω—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏: <strong>${WEEKDAYS_RU[maxDay]}</strong> ‚Äî ${fmt(Math.round(days[maxDay]))}`);
  }
  if(insights.length===0){el.innerHTML='';return;}
  el.innerHTML=insights.map(txt=>`<div class="insight"><i class="ri-lightbulb-line"></i><p>${txt}</p></div>`).join('');
}
function renderAllTx(txs){
  const el=document.getElementById('all-tx-list');
  const sorted=[...txs].sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(sorted.length===0){el.innerHTML='<div class="empty"><i class="ri-inbox-line"></i><p>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p></div>';return;}
  el.innerHTML=sorted.map(t=>{
    const cat=db.categories.find(c=>c.id===t.category_id)||{icon:'ri-question-line',name:'‚Äî'};
    const acc=db.accounts.find(a=>a.id===t.account_id)||{name:'‚Äî'};
    return `<div class="tx-item">
      <div class="tx-icon"><i class="${cat.icon}"></i></div>
      <div class="tx-info"><div class="tx-name">${cat.name}</div><div class="tx-cat">${acc.name} ¬∑ ${fmtDate(t.date)}${t.comment?' ¬∑ '+t.comment:''}</div></div>
      <div><div class="tx-amount ${t.type==='income'?'inc':'exp'}">${t.type==='income'?'+':'‚àí'}${fmt(Math.abs(t.amount))}</div></div>
    </div>`;
  }).join('');
}

// ===== RENDER INVEST =====
function renderInvest(){
  const invAccs=db.accounts.filter(a=>a.type==='invest');
  const el=document.getElementById('inv-list');
  if(invAccs.length===0){el.innerHTML='<div class="empty"><i class="ri-line-chart-line"></i><p>–ù–µ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π</p></div>';return;}
  el.innerHTML=invAccs.map(a=>{
    const growth=Number(a.percent)>0?Math.round(Number(a.balance)*Number(a.percent)/100/12):0;
    return `<div class="acc-card">
      <div class="acc-row"><div><div class="acc-name">${a.name}</div><div class="acc-type">${a.percent?a.percent+'% –≥–æ–¥–æ–≤—ã—Ö':'–ë–µ–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤'}${a.divDay?' ¬∑ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ '+a.divDay+'-–≥–æ':''}</div></div>
      <div class="acc-bal">${fmt(a.balance)}</div></div>
      ${growth?`<div style="font-size:12px;color:var(--green);margin-top:4px">‚âà +${fmt(growth)}/–º–µ—Å</div>`:''}
    </div>`;
  }).join('');
  // Chart
  renderInvChart(invAccs);
}
function renderInvChart(accs){
  const ctx=document.getElementById('chart-inv');
  if(chartInv)chartInv.destroy();
  if(accs.length===0){ctx.style.display='none';return;}
  ctx.style.display='block';
  // Simple projection: 12 months compound
  const labels=[];const datasets=[];
  accs.forEach((a,idx)=>{
    const data=[];let bal=Number(a.balance);
    for(let m=0;m<=12;m++){
      if(m===0)labels.push('–°–µ–π—á–∞—Å');else if(m<=12&&labels.length<=m)labels.push(m+' –º–µ—Å');
      data.push(Math.round(bal));
      bal+=bal*(Number(a.percent)||0)/100/12;
    }
    datasets.push({label:a.name,data,borderColor:COLORS[idx%COLORS.length],backgroundColor:COLORS[idx%COLORS.length]+'22',fill:true,tension:0.4,borderWidth:2,pointRadius:0});
  });
  chartInv=new Chart(ctx,{type:'line',data:{labels,datasets},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:accs.length>1,labels:{color:'#94A3B8',font:{size:11}}}},scales:{x:{ticks:{color:'#475569',font:{size:10}},grid:{display:false}},y:{ticks:{color:'#475569',font:{size:10},callback:v=>fmt(v)},grid:{color:'rgba(255,255,255,0.04)'}}}}});
}

// ===== RENDER PROFILE =====
function renderProfile(){
  document.getElementById('prof-avatar').textContent=(db.user.name||'?')[0].toUpperCase();
  document.getElementById('prof-name').textContent=db.user.name||'‚Äî';
  document.getElementById('prof-limit').textContent=fmt(db.user.limit);
  const isDark=!document.body.classList.contains('light');
  document.getElementById('theme-toggle').classList.toggle('on',isDark);
  document.getElementById('theme-icon').className=isDark?'ri-moon-line':'ri-sun-line';
}

// ===== THEME =====
function initTheme(){
  const saved=localStorage.getItem('onyx_theme');
  if(saved==='light')document.body.classList.add('light');
}
function toggleTheme(){
  document.body.classList.toggle('light');
  localStorage.setItem('onyx_theme',document.body.classList.contains('light')?'light':'dark');
  renderProfile();
}

// ===== MODALS =====
function openModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}
// Close on overlay click
document.querySelectorAll('.modal-overlay').forEach(m=>{
  m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('show');});
});

// ===== ADD TRANSACTION =====
function openAddTx(){
  document.getElementById('tx-amount').value='';
  document.getElementById('tx-comment').value='';
  document.getElementById('tx-date').value=new Date().toISOString().split('T')[0];
  setTxType('expense');
  populateTxAccounts();
  populateTxCats();
  openModal('modal-tx');
}
function setTxType(type){
  curTxType=type;
  document.querySelectorAll('#modal-tx .seg .seg-btn').forEach((b,i)=>b.classList.toggle('active',i===(type==='expense'?0:1)));
  document.getElementById('tx-income-type-wrap').style.display=type==='income'?'block':'none';
  populateTxCats();
}
function populateTxAccounts(){
  const sel=document.getElementById('tx-account');
  sel.innerHTML=db.accounts.map(a=>`<option value="${a.id}">${a.name} (${fmt(a.balance)})</option>`).join('');
}
function populateTxCats(){
  const cats=db.categories.filter(c=>c.type===curTxType);
  const el=document.getElementById('tx-cats');
  selectedCatId=cats.length>0?cats[0].id:null;
  el.innerHTML=cats.map(c=>`<div class="cat-opt${c.id===selectedCatId?' active':''}" onclick="selectTxCat('${c.id}')"><i class="${c.icon}" style="color:${c.color}"></i><span>${c.name}</span></div>`).join('');
}
function selectTxCat(id){
  selectedCatId=id;
  document.querySelectorAll('#tx-cats .cat-opt').forEach(el=>el.classList.toggle('active',el.querySelector('i')&&el.onclick.toString().includes(id)));
  populateTxCats();// Re-render to update active state
}
function saveTx(){
  const amount=Number(document.getElementById('tx-amount').value);
  const accId=document.getElementById('tx-account').value;
  const date=document.getElementById('tx-date').value;
  const comment=document.getElementById('tx-comment').value.trim();
  const incomeType=document.getElementById('tx-income-type').value;
  if(!amount||amount<=0){toast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');return;}
  if(!accId){toast('–í—ã–±–µ—Ä–∏—Ç–µ —Å—á—ë—Ç');return;}
  if(!selectedCatId){toast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');return;}
  const tx={
    id:'tx_'+Date.now(),user_id:db.user.id,
    date:date||new Date().toISOString().split('T')[0],
    amount,type:curTxType,
    account_id:accId,category_id:selectedCatId,
    comment,is_waste:'',incomeType:curTxType==='income'?incomeType:'',
  };
  db.transactions.push(tx);
  // Update account balance
  const acc=db.accounts.find(a=>a.id===accId);
  if(acc){acc.balance=Number(acc.balance)+(curTxType==='income'?amount:-amount);}
  saveDB();pushData();
  closeModal('modal-tx');
  toast(curTxType==='income'?'–î–æ—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω':'–†–∞—Å—Ö–æ–¥ –∑–∞–ø–∏—Å–∞–Ω');
  const scr=document.querySelector('.screen.active');
  if(scr)go(scr.id.replace('scr-',''));
}

// ===== ACCOUNTS =====
function openWalletAdd(){
  if(curWalletTab==='accounts')openAddAccount('card');
  if(curWalletTab==='goals')openModal('modal-goal');
  if(curWalletTab==='debts')openModal('modal-debt');
}
function openAddAccount(type){
  document.getElementById('acc-name').value='';
  document.getElementById('acc-balance').value='';
  document.getElementById('acc-percent').value='';
  document.getElementById('acc-divday').value='';
  document.getElementById('acc-goal').value='';
  document.getElementById('acc-type').value=type||'card';
  updateAccForm();
  openModal('modal-acc');
}
function updateAccForm(){
  const type=document.getElementById('acc-type').value;
  document.getElementById('acc-divday-wrap').style.display=type==='invest'?'block':'none';
  document.getElementById('acc-goal-wrap').style.display=(type==='jar'||type==='invest')?'block':'none';
  document.getElementById('acc-income-row').style.display=type==='invest'?'flex':'none';
  document.getElementById('acc-modal-title').textContent=type==='invest'?'–ù–æ–≤–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è':type==='jar'?'–ù–æ–≤–∞—è –∫–æ–ø–∏–ª–∫–∞':'–ù–æ–≤—ã–π —Å—á—ë—Ç';
}
document.getElementById('acc-type').addEventListener('change',updateAccForm);
function saveAccount(){
  const name=document.getElementById('acc-name').value.trim();
  const type=document.getElementById('acc-type').value;
  const balance=Number(document.getElementById('acc-balance').value)||0;
  const percent=Number(document.getElementById('acc-percent').value)||0;
  const divDay=document.getElementById('acc-divday').value||'';
  const goal=document.getElementById('acc-goal').value||'';
  if(!name){toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}
  db.accounts.push({id:'a_'+Date.now(),user_id:db.user.id,name,type,balance,goal,percent,divDay,currency:'RUB'});
  saveDB();pushData();
  closeModal('modal-acc');
  toast('–°—á—ë—Ç —Å–æ–∑–¥–∞–Ω');
  renderWallet();
}

// ===== GOALS =====
function saveGoal(){
  const name=document.getElementById('goal-name').value.trim();
  const target=Number(document.getElementById('goal-target').value)||0;
  const current=Number(document.getElementById('goal-current').value)||0;
  const accountId=document.getElementById('goal-account').value||'';
  if(!name||!target){toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—É–º–º—É');return;}
  db.goals.push({id:'g_'+Date.now(),user_id:db.user.id,name,target,current,color:COLORS[db.goals.length%COLORS.length],accountId});
  saveDB();pushData();
  closeModal('modal-goal');
  toast('–¶–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞');
  renderWallet();
}

// ===== DEBTS =====
function saveDebt(){
  const name=document.getElementById('debt-name').value.trim();
  const amount=Number(document.getElementById('debt-amount').value)||0;
  const monthly=Number(document.getElementById('debt-monthly').value)||0;
  const percent=Number(document.getElementById('debt-percent').value)||0;
  const dueDate=document.getElementById('debt-duedate').value||'';
  const affects=document.getElementById('debt-affects-cf').classList.contains('on');
  if(!name||!amount){toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—É–º–º—É');return;}
  db.debts.push({id:'d_'+Date.now(),user_id:db.user.id,name,amount,percent,dueDate,paid:0,monthlyPayment:monthly,payments:'[]',affectsCashflow:affects});
  saveDB();pushData();
  closeModal('modal-debt');
  toast('–î–æ–ª–≥ –¥–æ–±–∞–≤–ª–µ–Ω');
  renderWallet();
}

// ===== DEBT PAYMENT =====
function openDebtPay(debtId){
  payingDebtId=debtId;
  const debt=db.debts.find(d=>d.id===debtId);
  if(!debt)return;
  document.getElementById('debt-pay-title').textContent='–ü–ª–∞—Ç—ë–∂: '+debt.name;
  document.getElementById('debt-pay-amount').value=debt.monthlyPayment||'';
  const sel=document.getElementById('debt-pay-account');
  sel.innerHTML=db.accounts.filter(a=>a.type!=='invest').map(a=>`<option value="${a.id}">${a.name} (${fmt(a.balance)})</option>`).join('');
  curDebtPayType='regular';
  document.querySelectorAll('#modal-debt-pay .seg-btn').forEach((b,i)=>b.classList.toggle('active',i===0));
  openModal('modal-debt-pay');
}
function setDebtPayType(type){
  curDebtPayType=type;
  document.querySelectorAll('#modal-debt-pay .seg-btn').forEach((b,i)=>b.classList.toggle('active',(type==='regular'?0:1)===i));
}
function payDebt(){
  const debt=db.debts.find(d=>d.id===payingDebtId);
  if(!debt){toast('–î–æ–ª–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω');return;}
  const amount=Number(document.getElementById('debt-pay-amount').value)||0;
  const accId=document.getElementById('debt-pay-account').value;
  if(!amount||amount<=0){toast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');return;}
  if(!accId){toast('–í—ã–±–µ—Ä–∏—Ç–µ —Å—á—ë—Ç');return;}
  const acc=db.accounts.find(a=>a.id===accId);
  if(!acc){toast('–°—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');return;}
  // Deduct from account
  acc.balance=Number(acc.balance)-amount;
  // Add to debt paid
  debt.paid=Number(debt.paid||0)+amount;
  // Record payment
  let payments=[];try{payments=JSON.parse(debt.payments||'[]');}catch(e){}
  payments.push({date:new Date().toISOString(),amount,type:curDebtPayType});
  debt.payments=JSON.stringify(payments);
  // Create expense transaction
  let debtCat=db.categories.find(c=>c.name==='–ü–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞'&&c.type==='expense');
  if(!debtCat){
    debtCat={id:'c_debt_'+Date.now(),user_id:db.user.id,name:'–ü–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞',type:'expense',icon:'ri-bank-line',color:'#EF4444'};
    db.categories.push(debtCat);
  }
  db.transactions.push({
    id:'tx_'+Date.now(),user_id:db.user.id,
    date:new Date().toISOString().split('T')[0],
    amount,type:'expense',
    account_id:accId,category_id:debtCat.id,
    comment:(curDebtPayType==='early'?'–î–æ—Å—Ä–æ—á–Ω—ã–π: ':'')+debt.name,
    is_waste:'',incomeType:''
  });
  // Recalculate if early payment (reduce principal for interest calc ‚Äî simple approach)
  if(curDebtPayType==='early'&&Number(debt.percent)>0){
    toast('–î–æ—Å—Ä–æ—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂ –≤–Ω–µ—Å—ë–Ω! –ü—Ä–æ—Ü–µ–Ω—Ç—ã –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã.');
  } else {
    toast('–ü–ª–∞—Ç—ë–∂ –≤–Ω–µ—Å—ë–Ω: '+fmt(amount));
  }
  saveDB();pushData();
  closeModal('modal-debt-pay');
  renderWallet();
}

// ===== CATEGORIES =====
function manageCategories(){
  curCatManageType='expense';
  renderCatManage();
  openModal('modal-cats');
}
function setCatManageType(type){
  curCatManageType=type;
  document.querySelectorAll('#modal-cats .seg .seg-btn').forEach((b,i)=>b.classList.toggle('active',(type==='expense'?0:1)===i));
  renderCatManage();
}
function renderCatManage(){
  const cats=db.categories.filter(c=>c.type===curCatManageType);
  const el=document.getElementById('cat-manage-list');
  el.innerHTML=cats.map(c=>`<div class="card" style="display:flex;align-items:center;gap:12px;padding:12px 16px;">
    <div class="tx-icon" style="background:${c.color}22"><i class="${c.icon}" style="color:${c.color}"></i></div>
    <div style="flex:1;font-size:14px;font-weight:500">${c.name}</div>
    <i class="ri-delete-bin-line" style="color:var(--red);cursor:pointer;font-size:18px" onclick="deleteCat('${c.id}')"></i>
  </div>`).join('');
}
function deleteCat(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?'))return;
  db.categories=db.categories.filter(c=>c.id!==id);
  saveDB();pushData();renderCatManage();
}
function openAddCat(){
  document.getElementById('new-cat-name').value='';
  selectedIcon=ICONS[0];
  renderIconPicker();
  openModal('modal-add-cat');
}
function renderIconPicker(){
  document.getElementById('icon-picker').innerHTML=ICONS.map(ic=>`<div class="cat-opt${ic===selectedIcon?' active':''}" onclick="pickIcon('${ic}')"><i class="${ic}"></i></div>`).join('');
}
function pickIcon(ic){selectedIcon=ic;renderIconPicker();}
function saveCat(){
  const name=document.getElementById('new-cat-name').value.trim();
  const type=document.getElementById('new-cat-type').value;
  if(!name){toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}
  db.categories.push({id:'c_'+Date.now(),user_id:db.user.id,name,type,icon:selectedIcon||'ri-price-tag-3-line',color:COLORS[db.categories.length%COLORS.length]});
  saveDB();pushData();
  closeModal('modal-add-cat');
  toast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞');
  renderCatManage();
}

// ===== TRANSFER =====
function openTransfer(){
  const sel1=document.getElementById('tr-from');
  const sel2=document.getElementById('tr-to');
  const opts=db.accounts.map(a=>`<option value="${a.id}">${a.name} (${fmt(a.balance)})</option>`).join('');
  sel1.innerHTML=opts; sel2.innerHTML=opts;
  document.getElementById('tr-amount').value='';
  openModal('modal-transfer');
}
function doTransfer(){
  const fromId=document.getElementById('tr-from').value;
  const toId=document.getElementById('tr-to').value;
  const amount=Number(document.getElementById('tr-amount').value)||0;
  if(fromId===toId){toast('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–Ω—ã–µ —Å—á–µ—Ç–∞');return;}
  if(!amount||amount<=0){toast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');return;}
  const from=db.accounts.find(a=>a.id===fromId);
  const to=db.accounts.find(a=>a.id===toId);
  if(!from||!to)return;
  from.balance=Number(from.balance)-amount;
  to.balance=Number(to.balance)+amount;
  saveDB();pushData();
  closeModal('modal-transfer');
  toast('–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ '+fmt(amount));
  renderWallet();
}

// ===== EDIT LIMIT =====
function openEditLimit(){
  document.getElementById('edit-limit').value=db.user.limit||'';
  openModal('modal-limit');
}
function saveLimit(){
  db.user.limit=Number(document.getElementById('edit-limit').value)||0;
  saveDB();pushData();
  closeModal('modal-limit');
  toast('–õ–∏–º–∏—Ç –æ–±–Ω–æ–≤–ª—ë–Ω');
  renderProfile();
}

// ===== SYNC =====
async function pushData(){
  try{
    await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({action:'sync_all',user_id:db.user.id,user:db.user,
        accounts:db.accounts,categories:db.categories,transactions:db.transactions,
        goals:db.goals,debts:db.debts})
    });
  }catch(e){console.warn('Sync push error',e);}
}
async function loadFromServer(){
  try{
    const r=await fetch(API_URL+'?action=load&user_id='+encodeURIComponent(db.user.id));
    const d=await r.json();
    if(d.status==='success'){
      if(d.accounts&&d.accounts.length)db.accounts=d.accounts;
      if(d.categories&&d.categories.length)db.categories=d.categories;
      if(d.transactions&&d.transactions.length)db.transactions=d.transactions;
      if(d.goals&&d.goals.length)db.goals=d.goals;
      if(d.debts&&d.debts.length)db.debts=d.debts;
      if(d.user&&d.user.name){db.user.name=d.user.name;db.user.limit=d.user.limit||db.user.limit;}
      migrate();saveDB();
      const scr=document.querySelector('.screen.active');
      if(scr)go(scr.id.replace('scr-',''));
    }
  }catch(e){console.warn('Sync load error',e);}
}
function syncNow(){
  toast('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...');
  pushData().then(()=>loadFromServer()).then(()=>toast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã'));
}

// ===== EXPORT =====
function exportData(){
  const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='mycosts_export.json';a.click();
  URL.revokeObjectURL(url);
  toast('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
}

// ===== RESET =====
function resetApp(){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.'))return;
  localStorage.removeItem(DB_KEY);
  location.reload();
}

// ===== TOAST =====
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),2500);
}

// ===== GOAL MODAL: populate accounts =====
const goalAccSel=document.getElementById('goal-account');
function populateGoalAccounts(){
  goalAccSel.innerHTML='<option value="">–ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏</option>'+db.accounts.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
}
const origOpenGoalModal=openModal;
const _openModal=openModal;
// Override to populate on goal open
const origOpen=openModal;

// ===== TELEGRAM WEBAPP =====
try{
  if(window.Telegram?.WebApp){
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand();
    window.Telegram.WebApp.setHeaderColor('#0A0A0F');
    window.Telegram.WebApp.setBackgroundColor('#0A0A0F');
  }
}catch(e){}

// ===== START =====
document.addEventListener('DOMContentLoaded',()=>{
  init();
  // Populate goal accounts when opening goal modal
  const origGoalBtn=document.querySelector('[onclick="openModal(\'modal-goal\')"]');
});
init();
</script>
</body>
</html>
