<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyCosts Onyx X</title>
    
    <!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ë–ò–ë–õ–ò–û–¢–ï–ö -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- 1. –î–ò–ó–ê–ô–ù (CSS) --- */
        :root {
            /* –ü–∞–ª–∏—Ç—Ä–∞ Onyx */
            --bg: #09090b; 
            --card: #18181b; 
            --input: #27272a;
            --text: #ffffff; 
            --text-sec: #a1a1aa;
            --primary: #6366f1; /* Indigo */
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b;
            --font: 'Manrope', sans-serif;
            --radius: 24px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            font-family: var(--font); 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; padding: 0; 
            padding-bottom: 120px; 
            overflow-x: hidden; 
        }

        .container { padding: 20px; max-width: 480px; margin: 0 auto; min-height: 100vh; }

        /* –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò (–ó–∞—Å—Ç–∞–≤–∫–∞) */
        #splash-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        #splash-screen.fade-out { opacity: 0; pointer-events: none; }
        
        .logo-pulse {
            font-size: 60px; color: var(--primary);
            animation: pulse-logo 2s infinite;
        }
        @keyframes pulse-logo { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

        /* –ö–ê–†–¢–û–ß–ö–ò –ò –ë–õ–û–ö–ò */
        .card { 
            background: var(--card); border-radius: var(--radius); padding: 24px; margin-bottom: 16px; 
            border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
        }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-col { display: flex; flex-direction: column; gap: 5px; }

        /* –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê */
        h1 { font-size: 32px; font-weight: 800; margin: 0 0 10px 0; letter-spacing: -1px; }
        h2 { font-size: 24px; font-weight: 700; margin: 0; }
        .text-xs { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-sec); letter-spacing: 1px; margin-bottom: 8px; display: block; }
        .text-mono { font-family: monospace; letter-spacing: -0.5px; }

        /* –ö–ù–û–ü–ö–ò */
        .btn-main { 
            width: 100%; padding: 18px; border-radius: 20px; 
            background: var(--primary); color: white; border: none; 
            font-size: 16px; font-weight: 700; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        .btn-main:active { transform: scale(0.97); opacity: 0.9; }
        
        .btn-icon {
            width: 44px; height: 44px; border-radius: 50%; border: none;
            background: var(--input); color: var(--text); font-size: 20px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* –ü–û–õ–Ø –í–í–û–î–ê */
        .input-lg { 
            width: 100%; background: transparent; border: none; 
            font-size: 42px; font-weight: 800; color: white; 
            text-align: center; padding: 20px 0; 
        }
        .std-input { 
            width: 100%; padding: 16px; border-radius: 16px; 
            background: var(--input); border: 2px solid transparent; 
            color: white; font-size: 16px; margin-bottom: 12px; transition: 0.3s; 
        }
        .std-input:focus { border-color: var(--primary); background: #000; }

        /* –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ (NAVBAR) */
        .nav-bar { 
            position: fixed; bottom: 25px; left: 20px; right: 20px; margin: auto; max-width: 440px; 
            background: rgba(30,30,35,0.9); backdrop-filter: blur(20px); 
            border-radius: 30px; padding: 10px 25px; 
            display: flex; justify-content: space-between; 
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); z-index: 100; 
        }
        .nav-item { 
            border: none; background: none; color: var(--text-sec); 
            font-size: 26px; padding: 10px; transition: 0.3s; position: relative; 
        }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item.active::after { 
            content:''; position:absolute; bottom:5px; left:50%; transform:translateX(-50%); 
            width:4px; height:4px; border-radius:50%; background:var(--primary); 
        }

        /* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; 
            opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px); 
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        
        .sheet { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #1c1c1f; border-radius: 30px 30px 0 0; padding: 25px; 
            transform: translateY(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
            z-index: 1001; max-height: 90vh; overflow-y: auto; border-top: 1px solid rgba(255,255,255,0.1); 
        }
        .sheet.open { transform: translateY(0); }

        /* –≠–õ–ï–ú–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê */
        .hidden { display: none !important; }
        
        .status-pill { 
            padding: 6px 12px; background: rgba(255,255,255,0.05); border-radius: 20px; 
            font-size: 11px; font-weight: 700; display: flex; align-items: center; gap: 6px; 
        }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #666; transition:0.3s; }
        .dot.green { background: var(--success); }
        .dot.yellow { background: var(--warning); box-shadow: 0 0 10px var(--warning); }
        .dot.red { background: var(--danger); }

        .h-scroll { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 5px; margin: 0 -5px; padding: 0 5px; scrollbar-width: none; }
        .chip { 
            min-width: 140px; background: var(--card); border: 1px solid rgba(255,255,255,0.05); 
            padding: 15px; border-radius: 18px; transition: 0.2s; position: relative; flex-shrink: 0; 
        }
        .chip.active { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }

        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .icon-box { 
            aspect-ratio: 1; background: var(--input); border-radius: 14px; 
            display: flex; align-items: center; justify-content: center; font-size: 24px; 
            cursor: pointer; border: 2px solid transparent; 
        }
        .icon-box.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        
        .sw-group { display: flex; background: var(--input); padding: 4px; border-radius: 14px; }
        .sw-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-sec); border-radius: 10px; font-weight: 600; transition:0.2s; }
        .sw-btn.active { background: var(--card); color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù 0: –ó–ê–°–¢–ê–í–ö–ê (–§–æ–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞) -->
    <div id="splash-screen">
        <i class="ri-wallet-3-fill logo-pulse"></i>
        <div style="margin-top: 20px; font-weight: 600; opacity: 0.5;">MyCosts Onyx</div>
    </div>

    <!-- –≠–ö–†–ê–ù 1: –û–ù–ë–û–†–î–ò–ù–ì (–î–ª—è –Ω–æ–≤—ã—Ö) -->
    <div id="screen-onboarding" class="hidden container" style="text-align: center; padding-top: 100px;">
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
        <p class="text-sm" style="margin-bottom: 40px; opacity: 0.6;">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä –≤ —Ç–≤–æ–µ–º –∫–∞—Ä–º–∞–Ω–µ</p>
        
        <input type="text" id="ob-name" class="std-input" placeholder="–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?" style="text-align:center">
        
        <button class="btn-main" onclick="finishOnboarding()">
            –ù–∞—á–∞—Ç—å <i class="ri-arrow-right-line"></i>
        </button>
    </div>

    <!-- –≠–ö–†–ê–ù 2: –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <div id="screen-app" class="hidden container">
        
        <!-- –®–∞–ø–∫–∞ -->
        <header class="flex-between" style="margin-bottom: 24px;">
            <div class="status-pill">
                <div class="dot" id="sync-dot"></div>
                <span id="sync-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 800;" id="header-name">...</div>
            </div>
        </header>

        <!-- –í–ö–õ–ê–î–ö–ê: –ì–õ–ê–í–ù–ê–Ø -->
        <div id="view-home">
            <div class="card" style="text-align: center; padding: 32px 20px;">
                <div class="text-xs">–û–ë–©–ò–ô –ö–ê–ü–ò–¢–ê–õ</div>
                <div style="font-size: 46px; font-weight: 900; margin: 10px 0; letter-spacing: -1px;" id="total-bal">0 ‚ÇΩ</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px;">
                    <button class="btn-main" style="background: rgba(239,68,68,0.1); color: var(--danger);" onclick="openTxModal('expense')">
                        <i class="ri-arrow-down-line"></i> –†–∞—Å—Ö–æ–¥
                    </button>
                    <button class="btn-main" style="background: rgba(16,185,129,0.1); color: var(--success);" onclick="openTxModal('income')">
                        <i class="ri-arrow-up-line"></i> –î–æ—Ö–æ–¥
                    </button>
                </div>
            </div>

            <div class="flex-between"><h4>–°—á–µ—Ç–∞</h4> <span class="text-xs" style="color:var(--primary)" onclick="nav('wallet')">–í–°–ï</span></div>
            <div class="h-scroll" id="home-accs" style="margin-bottom: 20px;"></div>

            <div class="flex-between"><h4>–ò—Å—Ç–æ—Ä–∏—è</h4> <span class="text-xs" style="color:var(--primary)" onclick="nav('stats')">–ê–ù–ê–õ–ò–ó</span></div>
            <div id="tx-list"></div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê: –ò–ù–í–ï–°–¢–ò–¶–ò–ò -->
        <div id="view-invest" class="hidden">
            <h2>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h2>
            <p class="text-sm" style="margin-bottom:20px; opacity:0.6">–¢–≤–æ–π –ø—É—Ç—å –∫ —Å–≤–æ–±–æ–¥–µ</p>
            
            <div class="card">
                <div class="flex-between">
                    <span>–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –≥–æ–¥</span>
                    <span style="color:var(--success)" id="inv-growth">+0%</span>
                </div>
                <div style="height: 200px; margin-top:10px;"><canvas id="chart-invest"></canvas></div>
            </div>
            
            <h3>–ê–∫—Ç–∏–≤—ã</h3>
            <div id="invest-list" style="margin-top:10px"></div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê: –ê–ù–ê–õ–ò–¢–ò–ö–ê -->
        <div id="view-stats" class="hidden">
            <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            <br>
            <div class="sw-group" style="margin-bottom: 20px;">
                <button class="sw-btn active" onclick="setStatMode('expense', this)">–†–∞—Å—Ö–æ–¥—ã</button>
                <button class="sw-btn" onclick="setStatMode('income', this)">–î–æ—Ö–æ–¥—ã</button>
            </div>
            
            <div class="card">
                <div style="height: 250px; position: relative;"><canvas id="chart-pie"></canvas></div>
            </div>
            <div id="stats-list"></div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê: –ö–û–®–ï–õ–ï–ö -->
        <div id="view-wallet" class="hidden">
            <h2>–ö–æ—à–µ–ª–µ–∫</h2>
            <br>
            <div class="card">
                <div class="flex-between"><h3>–°—á–µ—Ç–∞</h3> <button class="btn-icon" style="width:30px; height:30px; font-size:16px;" onclick="openAccModal()">+</button></div>
                <div id="set-acc-list" style="margin-top: 15px;"></div>
            </div>
            <div class="card">
                <div class="flex-between"><h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3> <button class="btn-icon" style="width:30px; height:30px; font-size:16px;" onclick="openCatModal()">+</button></div>
                <div id="set-cat-list" style="margin-top: 15px;"></div>
            </div>
            <button class="btn-main" style="background: #27272a; margin-top: 30px;" onclick="forceSync()">
                <i class="ri-refresh-line"></i> –°–±—Ä–æ—Å / –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            </button>
        </div>

    </div>

    <!-- –ú–ï–ù–Æ –ù–ê–í–ò–ì–ê–¶–ò–ò -->
    <nav class="nav-bar">
        <button class="nav-item active" onclick="nav('home', this)"><i class="ri-home-5-fill"></i></button>
        <button class="nav-item" onclick="nav('invest', this)"><i class="ri-line-chart-fill"></i></button>
        <button class="nav-item" onclick="nav('stats', this)"><i class="ri-pie-chart-2-fill"></i></button>
        <button class="nav-item" onclick="nav('wallet', this)"><i class="ri-wallet-3-fill"></i></button>
    </nav>

    <!-- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê (–í–°–ü–õ–´–í–ê–®–ö–ò) -->
    <div class="modal-overlay" id="overlay" onclick="closeAll()"></div>
    
    <!-- 1. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è -->
    <div class="sheet" id="sheet-tx">
        <div class="flex-between"><h2 id="tx-title">–†–∞—Å—Ö–æ–¥</h2> <button class="btn-icon" onclick="closeAll()"><i class="ri-close-line"></i></button></div>
        
        <input type="text" id="tx-amt" class="input-lg" placeholder="0" inputmode="decimal">
        
        <div class="text-xs">–°–ß–ï–¢</div>
        <div class="h-scroll" id="tx-accs" style="margin-bottom: 20px;"></div>
        
        <div class="text-xs">–ö–ê–¢–ï–ì–û–†–ò–Ø</div>
        <div class="grid-4" id="tx-cats" style="margin-bottom: 20px;"></div>
        
        <div id="tx-waste-wrap" class="sw-group hidden" style="margin-bottom: 20px;">
            <button class="sw-btn active" id="btn-waste-no" onclick="setWaste(false)">–ü–æ–ª–µ–∑–Ω–æ–µ ‚úÖ</button>
            <button class="sw-btn" id="btn-waste-yes" style="color:var(--danger)" onclick="setWaste(true)">–•–æ—Ç–µ–ª–∫–∞ üóëÔ∏è</button>
        </div>

        <input type="text" id="tx-note" class="std-input" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
        <button class="btn-main" onclick="saveTx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="tx-del-btn" class="btn-main hidden" style="background:#27272a; color:var(--danger); margin-top:10px;" onclick="deleteTx()">–£–¥–∞–ª–∏—Ç—å</button>
    </div>

    <!-- 2. –°—á–µ—Ç -->
    <div class="sheet" id="sheet-acc">
        <div class="flex-between"><h2>–°—á–µ—Ç</h2> <button class="btn-icon" onclick="closeAll()"><i class="ri-close-line"></i></button></div>
        <br>
        <input type="text" id="acc-name" class="std-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        
        <div class="sw-group" style="margin-bottom: 15px;">
            <button class="sw-btn active" id="type-card" onclick="setAccType('card')">–ö–∞—Ä—Ç–∞</button>
            <button class="sw-btn" id="type-invest" onclick="setAccType('invest')">–ò–Ω–≤–µ—Å—Ç</button>
        </div>

        <div id="acc-invest-fields" class="hidden">
            <input type="number" id="acc-percent" class="std-input" placeholder="% –ì–æ–¥–æ–≤—ã—Ö">
        </div>

        <input type="number" id="acc-bal" class="std-input" placeholder="–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å">
        <button class="btn-main" onclick="saveAcc()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn-main" style="background:transparent; color:var(--danger); margin-top:10px" onclick="delAcc()">–£–¥–∞–ª–∏—Ç—å</button>
    </div>

    <!-- 3. –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
    <div class="sheet" id="sheet-cat">
        <div class="flex-between"><h2>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2> <button class="btn-icon" onclick="closeAll()"><i class="ri-close-line"></i></button></div>
        <br>
        <input type="text" id="cat-name" class="std-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        
        <div class="sw-group" style="margin-bottom: 15px;">
            <button class="sw-btn active" id="ctype-exp" onclick="setCatType('expense')">–†–∞—Å—Ö–æ–¥</button>
            <button class="sw-btn" id="ctype-inc" onclick="setCatType('income')">–î–æ—Ö–æ–¥</button>
        </div>

        <div class="grid-4" id="cat-icons"></div>
        <br>
        <button class="btn-main" onclick="saveCat()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn-main" style="background:transparent; color:var(--danger); margin-top:10px" onclick="delCat()">–£–¥–∞–ª–∏—Ç—å</button>
    </div>

    <!-- 2. –õ–û–ì–ò–ö–ê (JS) -->
    <script>
        // !!! –°–°–´–õ–ö–ê –ù–ê –¢–í–û–ô –°–ö–†–ò–ü–¢ !!!
        const API_URL = 'https://script.google.com/macros/s/AKfycby_ES9U2-4VYmPhMLbDtNNv_ESnbUEI9nlw0euEHsxZ6eJqu340_LpF_A1pSxyUvRxG/exec';

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        let db = { user: { name: '' }, accounts: [], categories: [], transactions: [] };
        let USER_ID = localStorage.getItem('onyx_uid');
        if(!USER_ID) {
            USER_ID = tg.initDataUnsafe?.user?.id ? 'tg_'+tg.initDataUnsafe.user.id : 'web_'+Date.now();
            localStorage.setItem('onyx_uid', USER_ID);
        }

        // --- –ì–õ–ê–í–ù–´–ô –ó–ê–ü–£–°–ö (ZERO DELAY) ---
        function initApp() {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const local = localStorage.getItem('onyx_db');
            let hasData = false;
            
            if (local) {
                try {
                    db = JSON.parse(local);
                    hasData = db.accounts && db.accounts.length > 0;
                } catch(e) { console.error('DB Error'); }
            }

            // 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞–º–∏ (–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ)
            setTimeout(() => {
                document.getElementById('splash-screen').classList.add('fade-out'); // –£–±–∏—Ä–∞–µ–º –∑–∞—Å—Ç–∞–≤–∫—É
                
                if (hasData) {
                    showScreen('app'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                    renderAll(); // –†–∏—Å—É–µ–º –¥–∞–Ω–Ω—ã–µ
                    syncBackground(); // –¢–∏—Ö–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å –æ–±–ª–∞–∫–∞
                } else {
                    showScreen('onboarding'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
                }
            }, 800); // 0.8 —Å–µ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
        }

        // --- –§–û–ù–û–í–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ---
        async function syncBackground() {
            setStatus('yellow', '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ (GET)
                const res = await fetch(`${API_URL}?action=load&user_id=${USER_ID}&t=${Date.now()}`);
                const json = await res.json();
                
                if (json.status === 'success') {
                    if (json.data.accounts.length > 0) {
                        // –ï—Å–ª–∏ –≤ –æ–±–ª–∞–∫–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ - –±–µ—Ä–µ–º –∏—Ö
                        db.accounts = json.data.accounts;
                        db.categories = json.data.categories;
                        db.transactions = json.data.transactions;
                        db.user.name = db.user.name || "User";
                        
                        // –ü–µ—Ä–µ—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –ø–æ –≤–∫–ª–∞–¥–∞–º
                        calcInterest();
                        
                        saveLocal(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                        setStatus('green', '–í —Å–µ—Ç–∏');
                    } else {
                        setStatus('green', '–õ–æ–∫–∞–ª—å–Ω–æ'); // –û–±–ª–∞–∫–æ –ø—É—Å—Ç–æ–µ, —Ä–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                    }
                }
            } catch (e) {
                console.log('Offline mode active');
                setStatus('red', '–û—Ñ—Ñ–ª–∞–π–Ω'); // –ù–µ —Å—Ç—Ä–∞—à–Ω–æ, —Ä–∞–±–æ—Ç–∞–µ–º –¥–∞–ª—å—à–µ
            }
        }

        async function pushData(force = false) {
            if(!force) setStatus('yellow', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º POST (no-cors) —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –¥–æ—à–ª–æ
                await fetch(API_URL + '?action=sync_all', {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        user_id: USER_ID,
                        accounts: db.accounts,
                        categories: db.categories,
                        transactions: db.transactions
                    })
                });
                if(!force) setStatus('green', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            } catch(e) {
                setStatus('red', '–ù–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            }
        }

        function saveLocal() {
            localStorage.setItem('onyx_db', JSON.stringify(db));
            renderAll();
        }

        // --- –õ–û–ì–ò–ö–ê ---
        function calcInterest() {
            let changed = false;
            const now = Date.now();
            db.accounts.forEach(acc => {
                if (acc.type === 'invest' && acc.percent > 0) {
                    const last = acc.lastCalc || now;
                    const days = (now - last) / (1000 * 60 * 60 * 24);
                    if (days >= 1) {
                        // –°–ª–æ–∂–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç: –ë–∞–ª–∞–Ω—Å * (% / 100 / 365) * –¥–Ω–µ–π
                        const profit = acc.balance * (acc.percent / 100 / 365) * days;
                        if (profit > 0.1) {
                            db.transactions.push({
                                id: 'sys_'+Date.now(),
                                date: new Date().toISOString(),
                                amount: profit,
                                type: 'income',
                                accountId: acc.id,
                                categoryId: 'sys_invest',
                                comment: '% –î–æ—Ö–æ–¥',
                                isWaste: false
                            });
                            acc.lastCalc = now;
                            changed = true;
                        }
                    }
                }
            });
            if(changed) saveLocal();
        }

        function finishOnboarding() {
            const name = document.getElementById('ob-name').value || '–ë–æ—Å—Å';
            db.user.name = name;
            
            // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä
            if(db.accounts.length === 0) db.accounts.push({id:'a1', name:'–ö–∞—Ä—Ç–∞', type:'card', balance:0, percent:0});
            if(db.categories.length === 0) {
                db.categories = [
                    {id:'c1', name:'–ï–¥–∞', icon:'üçî', type:'expense'},
                    {id:'c2', name:'–¢–∞–∫—Å–∏', icon:'üöï', type:'expense'},
                    {id:'c3', name:'–î–æ–º', icon:'üè†', type:'expense'},
                    {id:'c4', name:'–ó–∞—Ä–ø–ª–∞—Ç–∞', icon:'üí∞', type:'income'}
                ];
            }
            
            saveLocal();
            document.getElementById('screen-onboarding').classList.add('hidden');
            showScreen('app');
            pushData(); // –°—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ–±–ª–∞–∫–æ
        }

        // --- –†–ï–ù–î–ï–† (–û–¢–†–ò–°–û–í–ö–ê) ---
        function renderAll() {
            document.getElementById('header-name').innerText = db.user.name || '–ú–æ–π –∫–æ—à–µ–ª–µ–∫';
            
            // 1. –°—á–∏—Ç–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã (–°—Ç–∞—Ä—Ç + –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
            const bals = {};
            db.accounts.forEach(a => bals[a.id] = parseFloat(a.balance || 0)); // Start balance
            
            // –í v10 –º—ã —É–ø—Ä–æ—â–∞–µ–º: balance –≤ –ë–î —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å.
            // –ù–æ —á—Ç–æ–±—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–ª–∏—è–ª–∏, –º—ã –ø—Ä–æ–±–µ–≥–∞–µ–º –∏—Ö.
            // *–î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –º—ã —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ balance –≤ accounts - —ç—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å*
            // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –¥–µ–ª–∞–µ—Ç—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
            
            const total = db.accounts.reduce((s,a)=>s+parseFloat(a.balance), 0);
            document.getElementById('total-bal').innerText = Math.floor(total).toLocaleString() + ' ‚ÇΩ';

            // 2. –°–ø–∏—Å–∫–∏
            document.getElementById('home-accs').innerHTML = db.accounts.map(a => 
                `<div class="chip ${curTx.acc==a.id?'active':''}" onclick="curTx.acc='${a.id}'; renderSelectors()">
                    <b>${a.name}</b><br>
                    <span class="text-mono">${Math.floor(a.balance).toLocaleString()}</span>
                </div>`
            ).join('');

            const recent = db.transactions.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0, 10);
            document.getElementById('tx-list').innerHTML = recent.map(t => {
                const c = db.categories.find(x=>x.id==t.categoryId) || {name:'?', icon:'üîπ'};
                const acc = db.accounts.find(a=>a.id==t.accountId);
                return `<div class="card flex-between" onclick="editTx('${t.id}')" style="padding:16px;">
                    <div style="display:flex; gap:12px; align-items:center;">
                        <span style="font-size:24px">${c.icon}</span>
                        <div>
                            <b>${c.name}</b> ${t.isWaste?'üóëÔ∏è':''}
                            <div class="text-xs" style="margin:0; opacity:0.6">${acc?acc.name:'?'} ‚Ä¢ ${t.comment||''}</div>
                        </div>
                    </div>
                    <b style="font-size:16px; color:${t.type=='expense'?'var(--danger)':'var(--success)'}">
                        ${t.type=='expense'?'-':'+'}${Math.floor(t.amount)}
                    </b>
                </div>`;
            }).join('');

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            document.getElementById('set-acc-list').innerHTML = db.accounts.map(a => 
                `<div class="flex-between" style="padding:12px 0; border-bottom:1px solid #333" onclick="editAcc('${a.id}')">
                    <b>${a.name}</b> <span>${Math.floor(a.balance)}</span>
                </div>`
            ).join('');
            
            document.getElementById('set-cat-list').innerHTML = db.categories.map(c => 
                `<div class="flex-between" style="padding:12px 0; border-bottom:1px solid #333" onclick="editCat('${c.id}')">
                    <div style="display:flex; gap:10px"><span>${c.icon}</span> ${c.name}</div>
                </div>`
            ).join('');
            
            // –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
            const invAccs = db.accounts.filter(a => a.type === 'invest');
            document.getElementById('invest-list').innerHTML = invAccs.map(a => 
                `<div class="card flex-between">
                    <div><b>${a.name}</b><br><span style="color:var(--success)">${a.percent}% –≥–æ–¥–æ–≤—ã—Ö</span></div>
                    <b>${Math.floor(a.balance).toLocaleString()}</b>
                </div>`
            ).join('');
            
            renderCharts();
        }

        // --- –ì–†–ê–§–ò–ö–ò ---
        function renderCharts() {
            // PIE
            const ctxPie = document.getElementById('chart-pie');
            const txs = db.transactions.filter(t => t.type === statMode);
            const cats = {}; 
            txs.forEach(t => cats[t.categoryId] = (cats[t.categoryId]||0) + parseFloat(t.amount));
            
            if(window.pieChart) window.pieChart.destroy();
            window.pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats).map(id=>db.categories.find(c=>c.id==id)?.name),
                    datasets: [{ data: Object.values(cats), backgroundColor: ['#6366f1','#10b981','#f59e0b','#ef4444','#8b5cf6'], borderWidth:0 }]
                },
                options: { maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{color:'#fff', font:{size:10}}}} }
            });
            document.getElementById('stats-list').innerHTML = Object.entries(cats).sort((a,b)=>b[1]-a[1]).map(([id,v])=>{
                const c = db.categories.find(x=>x.id==id)||{name:'?',icon:''};
                return `<div class="flex-between" style="padding:10px 0; border-bottom:1px solid #333">
                    <div>${c.icon} ${c.name}</div> <b>${Math.floor(v)}</b>
                </div>`;
            }).join('');

            // INVEST LINE
            const ctxInv = document.getElementById('chart-invest');
            const invAccs = db.accounts.filter(a => a.type === 'invest');
            const totalInv = invAccs.reduce((s,a)=>s+parseFloat(a.balance), 0);
            const projected = totalInv * 1.15; // –ü—Ä–∏–º–µ—Ä–Ω–æ +15%
            document.getElementById('inv-growth').innerText = totalInv>0 ? `+${Math.floor(projected-totalInv).toLocaleString()} ‚ÇΩ` : '0 ‚ÇΩ';
            
            if(window.lineChart) window.lineChart.destroy();
            window.lineChart = new Chart(ctxInv, {
                type: 'line',
                data: {
                    labels: ['–°–µ–π—á–∞—Å', 'Q1', 'Q2', 'Q3', '–ì–æ–¥'],
                    datasets: [{ data: [totalInv, totalInv*1.03, totalInv*1.07, totalInv*1.11, projected], borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill:true }]
                },
                options: { maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}} }
            });
        }

        // --- –î–ï–ô–°–¢–í–ò–Ø (–¢–†–ê–ù–ó–ê–ö–¶–ò–ò) ---
        let curTx = { type:'expense', id:null, acc:'', cat:'' };
        
        function openTxModal(type) {
            curTx = { type, id:null, acc:db.accounts[0]?.id, cat:'', waste:false };
            document.getElementById('tx-title').innerText = type==='expense'?'–†–∞—Å—Ö–æ–¥':'–î–æ—Ö–æ–¥';
            document.getElementById('tx-amt').value = '';
            document.getElementById('tx-note').value = '';
            document.getElementById('tx-del-btn').classList.add('hidden');
            document.getElementById('tx-waste-wrap').classList.toggle('hidden', type!=='expense');
            
            openSheet('sheet-tx');
            renderSelectors();
        }

        function editTx(id) {
            const t = db.transactions.find(x=>x.id==id);
            if(!t) return;
            openTxModal(t.type);
            curTx.id = id;
            curTx.acc = t.accountId;
            curTx.cat = t.categoryId;
            curTx.waste = t.isWaste;
            document.getElementById('tx-amt').value = t.amount;
            document.getElementById('tx-note').value = t.comment;
            document.getElementById('tx-del-btn').classList.remove('hidden');
            renderSelectors();
        }

        function renderSelectors() {
            document.getElementById('tx-accs').innerHTML = db.accounts.map(a => 
                `<div class="chip ${curTx.acc==a.id?'active':''}" onclick="curTx.acc='${a.id}'; renderSelectors()"><b>${a.name}</b><br>${Math.floor(a.balance)}</div>`
            ).join('');
            
            const cats = db.categories.filter(c => c.type == curTx.type);
            document.getElementById('tx-cats').innerHTML = cats.map(c => 
                `<div class="icon-box ${curTx.cat==c.id?'selected':''}" onclick="curTx.cat='${c.id}'; renderSelectors()">${c.icon}</div>`
            ).join('');
            
            if(curTx.type==='expense') {
                document.getElementById('btn-waste-no').className = !curTx.waste ? 'sw-btn active' : 'sw-btn';
                document.getElementById('btn-waste-yes').className = curTx.waste ? 'sw-btn active' : 'sw-btn';
            }
        }

        function saveTx() {
            const amt = parseFloat(document.getElementById('tx-amt').value);
            if(!amt || !curTx.acc || !curTx.cat) return vibe('error');
            
            const oldTx = curTx.id ? db.transactions.find(t=>t.id==curTx.id) : null;
            
            // –û—Ç–∫–∞—Ç —Å—Ç–∞—Ä–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞
            if(oldTx) {
                const oldAcc = db.accounts.find(a=>a.id==oldTx.accountId);
                if(oldAcc) oldTx.type=='income' ? oldAcc.balance -= parseFloat(oldTx.amount) : oldAcc.balance += parseFloat(oldTx.amount);
            }

            const txData = {
                id: curTx.id || 'tx_'+Date.now(),
                date: oldTx ? oldTx.date : new Date().toISOString(),
                amount: amt,
                type: curTx.type,
                accountId: curTx.acc,
                categoryId: curTx.cat,
                comment: document.getElementById('tx-note').value,
                isWaste: curTx.waste
            };

            // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞
            const newAcc = db.accounts.find(a=>a.id==curTx.acc);
            if(newAcc) txData.type=='income' ? newAcc.balance += amt : newAcc.balance -= amt;

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            if(curTx.id) {
                const idx = db.transactions.findIndex(t=>t.id==curTx.id);
                db.transactions[idx] = txData;
            } else {
                db.transactions.push(txData);
            }
            
            saveLocal();
            closeAll();
            pushData(true); // –§–æ–Ω–æ–≤–π –ø—É—à
        }

        function deleteTx() {
            if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                const t = db.transactions.find(x=>x.id==curTx.id);
                const acc = db.accounts.find(a=>a.id==t.accountId);
                // –û—Ç–∫–∞—Ç
                if(acc) t.type=='income' ? acc.balance -= parseFloat(t.amount) : acc.balance += parseFloat(t.amount);
                
                db.transactions = db.transactions.filter(x=>x.id!=curTx.id);
                saveLocal(); closeAll(); pushData(true);
            }
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ß–ï–¢–ê–ú–ò –ò –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò ---
        let editId = null;
        let newAccType = 'card';
        let statMode = 'expense';

        function openAccModal() { editId=null; document.getElementById('acc-name').value=''; openSheet('sheet-acc'); }
        function editAcc(id) { 
            editId=id; const a=db.accounts.find(x=>x.id==id); 
            document.getElementById('acc-name').value=a.name; 
            document.getElementById('acc-bal').value=a.balance;
            setAccType(a.type);
            if(a.type==='invest') document.getElementById('acc-percent').value=a.percent;
            openSheet('sheet-acc');
        }
        function setAccType(t) { 
            newAccType=t; 
            document.getElementById('type-card').className = t=='card'?'sw-btn active':'sw-btn';
            document.getElementById('type-invest').className = t=='invest'?'sw-btn active':'sw-btn';
            document.getElementById('acc-invest-fields').className = t=='invest'?'':'hidden';
        }
        function saveAcc() {
            const name = document.getElementById('acc-name').value;
            if(!name) return;
            const acc = {
                id: editId || 'acc_'+Date.now(),
                name, 
                type: newAccType,
                balance: parseFloat(document.getElementById('acc-bal').value)||0,
                percent: parseFloat(document.getElementById('acc-percent').value)||0
            };
            if(editId) { const i=db.accounts.findIndex(x=>x.id==editId); db.accounts[i]=acc; }
            else db.accounts.push(acc);
            saveLocal(); closeAll(); pushData(true);
        }
        function delAcc() { if(editId && confirm('–£–¥–∞–ª–∏—Ç—å?')) { db.accounts=db.accounts.filter(x=>x.id!=editId); saveLocal(); closeAll(); pushData(true); } }

        function openCatModal() { editId=null; openSheet('sheet-cat'); renderIcons(); }
        function editCat(id) { editId=id; const c=db.categories.find(x=>x.id==id); document.getElementById('cat-name').value=c.name; openSheet('sheet-cat'); renderIcons(); }
        function renderIcons() {
            const icons = ['üçî','üöï','üè†','üíä','üõçÔ∏è','‚úàÔ∏è','üéÅ','‚öΩ','üí∞','üíº','üìà','üéì'];
            document.getElementById('cat-icons').innerHTML = icons.map(i=>`<div class="icon-box" onclick="document.getElementById('cat-icon').value='${i}'">${i}</div>`).join('');
        }
        function saveCat() {
            const name = document.getElementById('cat-name').value;
            if(!name) return;
            const cat = { id: editId||'cat_'+Date.now(), name, type: document.getElementById('ctype-exp').classList.contains('active')?'expense':'income', icon: document.getElementById('cat-icon').value||'üîπ' };
            if(editId) { const i=db.categories.findIndex(x=>x.id==editId); db.categories[i]=cat; }
            else db.categories.push(cat);
            saveLocal(); closeAll(); pushData(true);
        }
        function delCat() { if(editId && confirm('–£–¥–∞–ª–∏—Ç—å?')) { db.categories=db.categories.filter(x=>x.id!=editId); saveLocal(); closeAll(); pushData(true); } }
        function setCatType(t) { document.getElementById('ctype-exp').className=t=='expense'?'sw-btn active':'sw-btn'; document.getElementById('ctype-inc').className=t=='income'?'sw-btn active':'sw-btn'; }
        function setStatMode(m,el) { statMode=m; document.querySelectorAll('#view-stats .sw-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); renderCharts(); }
        function setWaste(w) { curTx.waste=w; document.getElementById('btn-waste-no').className=!w?'sw-btn active':'sw-btn'; document.getElementById('btn-waste-yes').className=w?'sw-btn active':'sw-btn'; }

        // --- UTILS ---
        function showScreen(id) {
            document.getElementById('splash-screen').classList.add('fade-out');
            document.getElementById('screen-onboarding').classList.add('hidden');
            document.getElementById('screen-app').classList.add('hidden');
            document.getElementById('screen-'+id).classList.remove('hidden');
        }
        function nav(scr, btn) {
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-invest').classList.add('hidden');
            document.getElementById('view-stats').classList.add('hidden');
            document.getElementById('view-wallet').classList.add('hidden');
            document.getElementById('view-'+scr).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(scr=='stats' || scr=='invest') renderCharts();
        }
        function openSheet(id) { document.getElementById('overlay').classList.add('open'); document.getElementById(id).classList.add('open'); vibe(); }
        function closeAll() { document.querySelectorAll('.sheet, .modal-overlay').forEach(e=>e.classList.remove('open')); }
        function setStatus(col, txt) { document.getElementById('sync-dot').className='dot '+col; document.getElementById('sync-text').innerText=txt; }
        function vibe(s='light') { try{ tg.HapticFeedback.impactOccurred(s); }catch(e){} }
        
        async function forceSync() {
            if(!confirm('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –æ–±–ª–∞–∫–æ?')) return;
            setStatus('yellow', '–í—ã–≥—Ä—É–∑–∫–∞...');
            await pushData(false);
        }

        // –ó–ê–ü–£–°–ö
        initApp();

    </script>
</body>
</html>
