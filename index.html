<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyCosts Titanium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #F0F2F5; --card: #FFFFFF; --text: #111827; --text-sec: #6B7280;
            --primary: #4F46E5; --primary-soft: rgba(79, 70, 229, 0.1);
            --success: #10B981; --danger: #EF4444; --warning: #F59E0B;
            --radius: 24px; --shadow: 0 8px 30px rgba(0,0,0,0.06);
            --font: 'Inter', sans-serif;
        }
        [data-theme="dark"] {
            --bg: #000000; --card: #1C1C1E; --text: #FFFFFF; --text-sec: #8E8E93;
            --primary: #5E5CE6; --primary-soft: rgba(94, 92, 230, 0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: var(--font); background: var(--bg); color: var(--text); margin: 0; padding-bottom: 120px; user-select: none; overflow-x: hidden; }
        
        .container { padding: 20px; max-width: 480px; margin: 0 auto; min-height: 100vh; }
        h1, h2, h4 { margin: 0; font-weight: 700; }
        .text-xs { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-sec); letter-spacing: 0.5px; margin-bottom: 5px; display: block; }
        .text-sm { font-size: 13px; color: var(--text-sec); }
        
        /* Cards */
        .card { background: var(--card); border-radius: var(--radius); padding: 20px; margin-bottom: 12px; box-shadow: var(--shadow); position: relative; transition: 0.1s; }
        .card:active { transform: scale(0.99); }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        
        /* Inputs & Buttons */
        .money-input { width: 100%; font-size: 40px; font-weight: 800; text-align: center; background: transparent; border: none; color: var(--text); padding: 20px 0; }
        .std-input { width: 100%; padding: 16px; border-radius: 16px; background: var(--bg); border: 1px solid transparent; color: var(--text); font-size: 16px; margin-bottom: 12px; transition: 0.3s; }
        .std-input:focus { background: var(--card); border-color: var(--primary); }

        .btn-main { width: 100%; padding: 16px; border-radius: 18px; background: var(--primary); color: white; border: none; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); }
        .btn-ghost { background: transparent; color: var(--primary); border: none; font-weight: 600; padding: 5px 10px; font-size: 14px; cursor: pointer; }
        
        /* Nav */
        .nav-bar { position: fixed; bottom: 25px; left: 20px; right: 20px; margin: auto; max-width: 440px; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); border-radius: 30px; padding: 12px 25px; display: flex; justify-content: space-between; box-shadow: 0 20px 50px rgba(0,0,0,0.2); z-index: 900; border: 1px solid rgba(255,255,255,0.1); }
        [data-theme="dark"] .nav-bar { background: rgba(28, 28, 30, 0.8); border-color: rgba(255,255,255,0.1); }
        .nav-item { border: none; background: none; color: var(--text-sec); font-size: 24px; padding: 5px; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        
        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 2000; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .sheet { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); border-radius: 28px 28px 0 0; padding: 25px; transform: translateY(100%); transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 2001; max-height: 92vh; overflow-y: auto; }
        .sheet.open { transform: translateY(0); }
        
        /* Toast Notification */
        #toast { position: fixed; top: 20px; left: 20px; right: 20px; background: var(--text); color: var(--bg); padding: 15px; border-radius: 16px; text-align: center; z-index: 5000; transform: translateY(-150%); transition: 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #toast.show { transform: translateY(0); }

        /* Screens */
        .screen { display: none; animation: fade 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fade { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        /* Chips & Grids */
        .h-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 5px 0 15px; scrollbar-width: none; }
        .acc-chip { min-width: 140px; background: var(--card); border: 1px solid rgba(0,0,0,0.05); padding: 15px; border-radius: 18px; transition: 0.2s; flex-shrink: 0; }
        .acc-chip.selected { border-color: var(--primary); background: var(--primary-soft); box-shadow: 0 0 0 2px var(--primary); }
        
        .icon-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .icon-box { aspect-ratio: 1; background: var(--bg); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; border: 2px solid transparent; }
        .icon-box.selected { background: var(--primary); color: white; }

        /* Progress Bar */
        .prog-bg { height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .prog-fill { height: 100%; background: var(--primary); width: 0%; transition: 1s; }

        /* Onboarding */
        #onboarding { position: fixed; inset: 0; background: var(--bg); z-index: 4000; padding: 30px; display: flex; flex-direction: column; justify-content: center; transition: 0.5s; }
        .sw-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-sec); font-weight: 600; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .sw-btn.active { background: var(--card); color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- TOAST -->
    <div id="toast">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! üöÄ</div>

    <!-- ONBOARDING -->
    <div id="onboarding" class="hidden">
        <div style="font-size: 60px; margin-bottom: 20px;">üíé</div>
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
        <p class="text-sm" style="margin-bottom: 40px; margin-top: 10px;">–§–∏–Ω–∞–Ω—Å—ã, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ —Ü–µ–ª–∏.<br>–ü—Ä–æ—Å—Ç–æ –∏ –∫—Ä–∞—Å–∏–≤–æ.</p>
        <input type="text" id="ob-name" class="std-input" placeholder="–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?">
        <p class="text-xs" style="margin-top:20px;">–í–∞–ª—é—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</p>
        <div class="card" style="padding: 5px; display: flex; background: var(--bg);">
            <button class="sw-btn active" onclick="setObCurr('‚ÇΩ', this)">‚ÇΩ</button>
            <button class="sw-btn" onclick="setObCurr('$', this)">$</button>
            <button class="sw-btn" onclick="setObCurr('‚Ç¨', this)">‚Ç¨</button>
        </div>
        <button class="btn-main" onclick="finishOnboarding()" style="margin-top: 20px;">–ù–∞—á–∞—Ç—å</button>
    </div>

    <!-- HEADER -->
    <div class="container">
        <header class="flex-between" style="margin-bottom: 20px; padding-top: 10px;">
            <div>
                <h2 id="head-name">...</h2>
                <div class="text-xs" id="head-id">ID: ...</div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-ghost" onclick="syncData()" style="font-size:24px;"><i class="ri-cloud-line" id="sync-icon"></i></button>
                <button class="btn-ghost" onclick="toggleTheme()" style="font-size:24px;"><i class="ri-contrast-line"></i></button>
            </div>
        </header>

        <!-- === 1. HOME === -->
        <div id="scr-home" class="screen active">
            <div class="card" style="text-align: center; padding: 35px 20px;">
                <div class="text-xs">–û–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª</div>
                <div style="font-size: 42px; font-weight: 800; margin: 10px 0; letter-spacing: -1px;" id="total-bal">0</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 25px;">
                    <button class="btn-main" style="background: var(--bg); color: var(--danger); box-shadow: none;" onclick="openTxModal('expense')">
                        <i class="ri-arrow-down-line"></i> –†–∞—Å—Ö–æ–¥
                    </button>
                    <button class="btn-main" style="background: var(--bg); color: var(--success); box-shadow: none;" onclick="openTxModal('income')">
                        <i class="ri-arrow-up-line"></i> –î–æ—Ö–æ–¥
                    </button>
                </div>
            </div>

            <div class="flex-between"><h4>–°—á–µ—Ç–∞</h4> <span class="text-xs" onclick="nav('wallet')">–í–°–ï</span></div>
            <div class="h-scroll" id="home-accs"></div>

            <div class="flex-between" style="margin-top:20px;"><h4>–ò—Å—Ç–æ—Ä–∏—è</h4> <span class="text-xs" onclick="nav('stats')">–ê–ù–ê–õ–ò–ó</span></div>
            <div id="home-txs"></div>
        </div>

        <!-- === 2. INVESTMENTS (GAMIFIED) === -->
        <div id="scr-invest" class="screen">
            <h2>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ & –¶–µ–ª–∏ üéØ</h2>
            <p class="text-sm" style="margin-bottom: 20px;">–¢–≤–æ–π –ø—É—Ç—å –∫ –±–æ–≥–∞—Ç—Å—Ç–≤—É</p>
            
            <div id="invest-list"></div>
            
            <div class="card" style="margin-top: 20px; border: 1px dashed var(--text-sec); background: transparent; text-align: center; cursor: pointer;" onclick="openAccModal('invest')">
                <div style="font-size: 24px; color: var(--text-sec);">+</div>
                <div class="text-sm">–î–æ–±–∞–≤–∏—Ç—å –¶–µ–ª—å –∏–ª–∏ –ê–∫—Ç–∏–≤</div>
            </div>
        </div>

        <!-- === 3. STATS === -->
        <div id="scr-stats" class="screen">
            <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            <br>
            <div class="card" style="padding: 5px; display: flex; background: var(--bg);">
                <button class="sw-btn active" onclick="setStatMode('expense', this)">–†–∞—Å—Ö–æ–¥—ã</button>
                <button class="sw-btn" onclick="setStatMode('income', this)">–î–æ—Ö–æ–¥—ã</button>
            </div>
            <div class="card">
                <div style="height: 250px; position: relative;"><canvas id="chart-pie"></canvas></div>
            </div>
            <div id="stats-list"></div>
        </div>

        <!-- === 4. WALLET === -->
        <div id="scr-wallet" class="screen">
            <h2>–ö–æ—à–µ–ª–µ–∫</h2>
            <br>
            <div class="card">
                <div class="flex-between"><h4>–°—á–µ—Ç–∞</h4> <button class="btn-ghost" onclick="openAccModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
                <div id="wallet-accs"></div>
            </div>
            <div class="card">
                <div class="flex-between"><h4>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h4> <button class="btn-ghost" onclick="openCatModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
                <div id="wallet-cats"></div>
            </div>
            
            <button class="btn-main" onclick="forceSync()" style="background: #333; margin-top: 30px;">‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
            <p class="text-sm" style="text-align: center; margin-top: 10px; opacity: 0.6;">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É</p>
        </div>
    </div>

    <!-- NAVBAR -->
    <nav class="nav-bar">
        <button class="nav-item active" onclick="nav('home', this)"><i class="ri-home-4-fill"></i></button>
        <button class="nav-item" onclick="nav('invest', this)"><i class="ri-rocket-fill"></i></button>
        <button class="nav-item" onclick="nav('stats', this)"><i class="ri-pie-chart-fill"></i></button>
        <button class="nav-item" onclick="nav('wallet', this)"><i class="ri-wallet-3-fill"></i></button>
    </nav>

    <!-- MODALS (SHEETS) -->
    <div class="modal-overlay" id="overlay" onclick="closeSheets()"></div>

    <!-- TX SHEET -->
    <div id="sheet-tx" class="sheet">
        <div class="flex-between"><h2 id="mtx-title">–†–∞—Å—Ö–æ–¥</h2> <button class="btn-ghost" onclick="closeSheets()">–ó–∞–∫—Ä—ã—Ç—å</button></div>
        <input type="number" id="mtx-amt" class="money-input" placeholder="0" inputmode="decimal">
        
        <div class="text-xs">–°—á–µ—Ç</div>
        <div class="h-scroll" id="mtx-accs" style="margin-bottom: 20px;"></div>
        
        <div class="text-xs">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
        <div class="icon-grid" id="mtx-cats"></div>
        
        <div id="mtx-waste-wrap" class="card" style="padding: 5px; display: flex; background: var(--bg); margin-top: 20px; display: none;">
            <button class="sw-btn active" onclick="setWaste(false)" id="bw-no">–ü–æ–ª–µ–∑–Ω–æ–µ ‚ú®</button>
            <button class="sw-btn" style="color:var(--danger)" onclick="setWaste(true)" id="bw-yes">–ò–º–ø—É–ª—å—Å–∏–≤–Ω–æ üóëÔ∏è</button>
        </div>

        <input type="text" id="mtx-note" class="std-input" placeholder="–ù–∞ —á—Ç–æ?" style="margin-top: 15px;">
        <button class="btn-main" onclick="saveTx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- ACC SHEET -->
    <div id="sheet-acc" class="sheet">
        <div class="flex-between"><h2>–°—á–µ—Ç</h2> <button class="btn-ghost" style="color:var(--danger)" onclick="delAcc()">–£–¥–∞–ª–∏—Ç—å</button></div>
        <br>
        <input type="text" id="macc-name" class="std-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –¢–∏–Ω—å–∫–æ—Ñ—Ñ)">
        
        <div class="text-xs">–¢–∏–ø —Å—á–µ—Ç–∞</div>
        <div class="card" style="padding: 5px; display: flex; background: var(--bg);">
            <button class="sw-btn active" onclick="setAccType('card')" id="bat-card">–ö–∞—Ä—Ç–∞</button>
            <button class="sw-btn" onclick="setAccType('deposit')" id="bat-dep">–í–∫–ª–∞–¥ %</button>
            <button class="sw-btn" onclick="setAccType('target')" id="bat-tar">–¶–µ–ª—å üéØ</button>
        </div>

        <div id="macc-extra" class="hidden">
            <div class="flex-between" style="gap:10px">
                <input type="number" id="macc-goal" class="std-input" placeholder="–¶–µ–ª—å (–°—É–º–º–∞)">
                <input type="number" id="macc-pct" class="std-input" placeholder="% –≥–æ–¥–æ–≤—ã—Ö">
            </div>
        </div>
        
        <div class="text-xs">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
        <input type="number" id="macc-bal" class="std-input" placeholder="0">
        <button class="btn-main" onclick="saveAcc()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- CAT SHEET -->
    <div id="sheet-cat" class="sheet">
        <div class="flex-between"><h2>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2> <button class="btn-ghost" style="color:var(--danger)" onclick="delCat()">–£–¥–∞–ª–∏—Ç—å</button></div>
        <br>
        <input type="text" id="mcat-name" class="std-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <div class="card" style="padding: 5px; display: flex; background: var(--bg);">
            <button class="sw-btn active" onclick="setCatType('expense')" id="bct-exp">–†–∞—Å—Ö–æ–¥</button>
            <button class="sw-btn" onclick="setCatType('income')" id="bct-inc">–î–æ—Ö–æ–¥</button>
        </div>
        <div class="icon-grid" id="mcat-icons"></div>
        <br>
        <button class="btn-main" onclick="saveCat()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <script>
        // === CONFIG ===
        const API_URL = 'https://script.google.com/macros/s/AKfycby_ES9U2-4VYmPhMLbDtNNv_ESnbUEI9nlw0euEHsxZ6eJqu340_LpF_A1pSxyUvRxG/exec';
        
        // === INIT ===
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let db = JSON.parse(localStorage.getItem('my_db_v9')) || { user: {name:'', curr:'‚ÇΩ'}, accounts: [], categories: [], transactions: [] };
        let uid = localStorage.getItem('my_uid');
        if(!uid) { uid = 'u'+Date.now(); localStorage.setItem('my_uid', uid); }

        // Mock Data if empty
        if(db.categories.length === 0) {
            db.categories = [
                {id:'c1', name:'–ï–¥–∞', type:'expense', icon:'ri-restaurant-line', color:'#F59E0B'},
                {id:'c2', name:'–¢–∞–∫—Å–∏', type:'expense', icon:'ri-taxi-line', color:'#3B82F6'},
                {id:'c3', name:'–ó–ü', type:'income', icon:'ri-briefcase-line', color:'#10B981'}
            ];
        }

        // Onboarding Check
        let obCurr = '‚ÇΩ';
        if(!db.user.name) document.getElementById('onboarding').classList.remove('hidden');
        else { updateHead(); syncData(); }

        function setObCurr(c, el) { 
            vibe(); obCurr=c; 
            document.querySelectorAll('#onboarding .sw-btn').forEach(b=>b.classList.remove('active')); 
            el.classList.add('active'); 
        }
        
        function finishOnboarding() {
            const name = document.getElementById('ob-name').value || '–ë–æ—Å—Å';
            db.user = { name, curr: obCurr };
            if(db.accounts.length===0) db.accounts.push({id:'a1', name:'–ù–∞–ª–∏—á–Ω—ã–µ', type:'card', balance:0, start:0});
            saveLocal();
            document.getElementById('onboarding').style.display='none';
            updateHead(); renderAll(); syncData();
        }

        // === CORE ===
        function saveLocal() { localStorage.setItem('my_db_v9', JSON.stringify(db)); renderAll(); }
        function vibe(t='light') { try{ tg.HapticFeedback.impactOccurred(t); }catch(e){} }
        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show'); vibe('success');
            setTimeout(()=>t.classList.remove('show'), 2500);
        }
        function updateHead() {
            document.getElementById('head-name').innerText = db.user.name;
            document.getElementById('head-id').innerText = db.user.curr;
        }
        function fmt(n) { return new Intl.NumberFormat('ru-RU').format(Math.floor(n)) + ' ' + db.user.curr; }

        // === RENDER ===
        function renderAll() {
            // Total
            const tot = db.accounts.reduce((s,a)=>s+a.balance,0);
            document.getElementById('total-bal').innerText = fmt(tot);

            // Home Accs
            document.getElementById('home-accs').innerHTML = db.accounts.map(a => `
                <div class="acc-chip" onclick="editAcc('${a.id}')">
                    <div class="flex-between"><b>${a.name}</b> <small>${a.type.toUpperCase().slice(0,3)}</small></div>
                    <div style="font-size:18px; font-weight:800; color:var(--primary); margin-top:5px;">${fmt(a.balance)}</div>
                </div>`).join('');

            // Home Txs
            const txs = db.transactions.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,8);
            document.getElementById('home-txs').innerHTML = txs.map(t => {
                const c = db.categories.find(x=>x.id==t.catId) || {name:'?', icon:'ri-question-line', color:'#999'};
                return `<div class="card flex-between" style="padding:15px; margin-bottom:8px;">
                    <div style="display:flex; gap:12px; align-items:center;">
                        <i class="${c.icon}" style="font-size:20px; color:${c.color}; background:${c.color}20; padding:8px; border-radius:10px;"></i>
                        <div><b>${c.name}</b> ${t.waste?'üóëÔ∏è':''}<br><small class="text-sm">${t.note||''}</small></div>
                    </div>
                    <b style="color:${t.type=='expense'?'var(--text)':'var(--success)'}">${t.type=='expense'?'-':'+'}${fmt(t.amount)}</b>
                </div>`;
            }).join('');

            // Invest Tab
            const targets = db.accounts.filter(a => a.type !== 'card');
            document.getElementById('invest-list').innerHTML = targets.map(a => {
                const pct = a.goal > 0 ? Math.min(100, (a.balance/a.goal)*100) : 0;
                return `<div class="card" onclick="editAcc('${a.id}')">
                    <div class="flex-between">
                        <div><b>${a.name}</b> ${a.type=='deposit'?'üè¶':'üéØ'}</div>
                        <b>${fmt(a.balance)}</b>
                    </div>
                    ${a.goal>0 ? `<div class="flex-between text-xs" style="margin-top:5px;"><span>–¶–µ–ª—å: ${fmt(a.goal)}</span> <span>${Math.floor(pct)}%</span></div>
                    <div class="prog-bg"><div class="prog-fill" style="width:${pct}%"></div></div>` : ''}
                    ${a.percent>0 ? `<div class="text-xs" style="color:var(--success); margin-top:5px;">+${a.percent}% –≥–æ–¥–æ–≤—ã—Ö</div>` : ''}
                </div>`;
            }).join('');

            // Wallet Lists
            document.getElementById('wallet-accs').innerHTML = db.accounts.map(a => `<div class="flex-between" style="padding:10px; border-bottom:1px solid #eee;" onclick="editAcc('${a.id}')"><b>${a.name}</b> <span>${fmt(a.balance)}</span></div>`).join('');
            document.getElementById('wallet-cats').innerHTML = db.categories.map(c => `<div class="flex-between" style="padding:10px; border-bottom:1px solid #eee;" onclick="editCat('${c.id}')"><div style="display:flex; align-items:center; gap:8px;"><i class="${c.icon}" style="color:${c.color}"></i> ${c.name}</div></div>`).join('');
            
            renderStats();
        }

        // === STATS ===
        let statType = 'expense';
        function setStatMode(t, el) { vibe(); statType=t; document.querySelectorAll('#scr-stats .sw-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); renderAll(); }
        
        function renderStats() {
            const ctx = document.getElementById('chart-pie');
            const relTxs = db.transactions.filter(t => t.type === statType);
            const cats = {}; relTxs.forEach(t => cats[t.catId] = (cats[t.catId]||0) + t.amount);
            
            if(window.pChart) window.pChart.destroy();
            window.pChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats).map(id => db.categories.find(c=>c.id==id)?.name),
                    datasets: [{ data: Object.values(cats), backgroundColor: Object.keys(cats).map(id => db.categories.find(c=>c.id==id)?.color), borderWidth:0 }]
                }, options: { maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{boxWidth:10}}} }
            });
            
            document.getElementById('stats-list').innerHTML = Object.entries(cats).sort((a,b)=>b[1]-a[1]).map(([id,v]) => {
                const c = db.categories.find(x=>x.id==id)||{name:'?',color:'#999'};
                return `<div class="flex-between" style="padding:10px; border-bottom:1px solid #eee;">
                    <div style="display:flex; gap:10px; align-items:center;"><div style="width:10px; height:10px; border-radius:50%; background:${c.color}"></div> ${c.name}</div>
                    <b>${fmt(v)}</b>
                </div>`;
            }).join('');
        }

        // === ACTIONS ===
        let curTx = {type:'expense', acc:'', cat:'', waste:false};
        
        function openTxModal(type) {
            vibe(); curTx = {type, acc:db.accounts[0]?.id, cat:'', waste:false};
            document.getElementById('mtx-title').innerText = type=='expense'?'–†–∞—Å—Ö–æ–¥':'–î–æ—Ö–æ–¥';
            document.getElementById('mtx-amt').value = ''; 
            document.getElementById('mtx-note').value = '';
            document.getElementById('mtx-waste-wrap').style.display = type=='expense'?'flex':'none';
            
            // Accs
            document.getElementById('mtx-accs').innerHTML = db.accounts.map(a => `
                <div class="acc-chip" onclick="curTx.acc='${a.id}'; hi(this,'acc-chip')">
                    <b>${a.name}</b><br><small>${Math.floor(a.balance)}</small>
                </div>`).join('');
            if(document.getElementById('mtx-accs').firstChild) document.getElementById('mtx-accs').firstChild.classList.add('selected');

            // Cats
            document.getElementById('mtx-cats').innerHTML = db.categories.filter(c=>c.type==type).map(c => `
                <div class="icon-box" style="color:${c.color}" onclick="curTx.cat='${c.id}'; hi(this,'icon-box')"><i class="${c.icon}"></i></div>`).join('');
            
            openSheet('sheet-tx');
        }

        function saveTx() {
            const amt = parseFloat(document.getElementById('mtx-amt').value);
            if(!amt || !curTx.acc || !curTx.cat) return vibe('error');
            
            const tx = {
                id: 'tx_'+Date.now(), date: new Date().toISOString(),
                amount: amt, type: curTx.type, accountId: curTx.acc, catId: curTx.cat,
                note: document.getElementById('mtx-note').value, waste: curTx.waste
            };
            db.transactions.push(tx);
            
            // Phrases
            const quotes = curTx.type=='expense' 
                ? (curTx.waste ? ["–ù—É –∏ –ª–∞–¥–Ω–æ, –æ–¥–∏–Ω —Ä–∞–∑ –∂–∏–≤–µ–º!", "–≠—Ö, –≥—É–ª—è–π —à–∞–ª—å–Ω–∞—è!"] : ["–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ —Å–µ–±—è!", "–ü–æ–ª–µ–∑–Ω–∞—è —Ç—Ä–∞—Ç–∞."])
                : ["–î–µ–Ω—å–≥–∏ –∫ –¥–µ–Ω—å–≥–∞–º! ü§ë", "–ë–æ–≥–∞—Ç–µ–µ–º!", "–ö—ç—à—Ñ–ª–æ—É —Ä–∞—Å—Ç–µ—Ç!"];
            
            recalc(); pushTx(tx); closeSheets();
            toast(quotes[Math.floor(Math.random()*quotes.length)]);
        }

        // === EDITING ===
        let editId = null; let newAT = 'card'; let newCT = 'expense';
        
        function openAccModal(t) { editId=null; setupAccModal(); if(t) setAccType(t); openSheet('sheet-acc'); }
        function editAcc(id) { editId=id; setupAccModal(db.accounts.find(a=>a.id==id)); openSheet('sheet-acc'); }
        
        function setupAccModal(a) {
            document.getElementById('macc-name').value = a ? a.name : '';
            document.getElementById('macc-bal').value = a ? a.start : '';
            document.getElementById('macc-goal').value = a ? a.goal : '';
            document.getElementById('macc-pct').value = a ? a.percent : '';
            setAccType(a ? a.type : 'card');
        }
        function setAccType(t) {
            vibe(); newAT=t;
            ['card','dep','tar'].forEach(x => document.getElementById('bat-'+x).classList.remove('active'));
            document.getElementById('bat-'+(t=='deposit'?'dep':(t=='target'?'tar':'card'))).classList.add('active');
            document.getElementById('macc-extra').classList.toggle('hidden', t=='card');
        }
        function saveAcc() {
            const name = document.getElementById('macc-name').value; if(!name) return;
            const data = {
                id: editId || 'a_'+Date.now(), name, type: newAT,
                start: parseFloat(document.getElementById('macc-bal').value)||0,
                goal: parseFloat(document.getElementById('macc-goal').value)||0,
                percent: parseFloat(document.getElementById('macc-pct').value)||0
            };
            if(editId) {
                const i = db.accounts.findIndex(a=>a.id==editId);
                data.balance = db.accounts[i].balance; // Keep calc logic
                if(data.start!=db.accounts[i].start) data.balance = data.start;
                db.accounts[i] = {...db.accounts[i], ...data};
            } else { data.balance = data.start; db.accounts.push(data); }
            recalc(); closeSheets(); toast('–°—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω ‚úÖ');
        }
        function delAcc() { if(editId && confirm('–£–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç?')) { db.accounts = db.accounts.filter(a=>a.id!=editId); recalc(); closeSheets(); } }

        // Cats
        function openCatModal() { editId=null; setupCatModal(); openSheet('sheet-cat'); }
        function editCat(id) { editId=id; setupCatModal(db.categories.find(c=>c.id==id)); openSheet('sheet-cat'); }
        
        function setupCatModal(c) {
            document.getElementById('mcat-name').value = c ? c.name : '';
            setCatType(c ? c.type : 'expense');
            const icons = ['ri-star-line','ri-home-4-line','ri-car-line','ri-shopping-cart-2-line','ri-gift-line','ri-heart-3-line','ri-plane-line','ri-book-open-line','ri-t-shirt-line','ri-cup-line','ri-gamepad-line','ri-scissors-cut-line','ri-briefcase-4-line'];
            document.getElementById('mcat-icons').innerHTML = icons.map(i => `<div class="icon-box" onclick="hi(this,'icon-box'); curTx.catIcon='${i}'"><i class="${i}"></i></div>`).join('');
        }
        function setCatType(t) { newCT=t; document.getElementById('bct-exp').classList.toggle('active', t=='expense'); document.getElementById('bct-inc').classList.toggle('active', t=='income'); }
        function saveCat() {
            const name = document.getElementById('mcat-name').value; if(!name) return;
            const data = { id: editId||'c_'+Date.now(), name, type: newCT, icon: curTx.catIcon||'ri-star-line', color: '#'+Math.floor(Math.random()*16777215).toString(16) };
            if(editId) { const i = db.categories.findIndex(c=>c.id==editId); db.categories[i] = data; }
            else db.categories.push(data);
            saveLocal(); closeSheets(); toast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –≥–æ—Ç–æ–≤–∞ üëç');
        }
        function delCat() { if(editId && confirm('–£–¥–∞–ª–∏—Ç—å?')) { db.categories = db.categories.filter(c=>c.id!=editId); saveLocal(); closeSheets(); } }

        // === SYNC & UTILS ===
        function recalc() {
            db.accounts.forEach(a => a.balance = parseFloat(a.start||0));
            db.transactions.forEach(t => {
                const acc = db.accounts.find(a=>a.id==t.accountId);
                if(acc) t.type=='income' ? acc.balance+=t.amount : acc.balance-=t.amount;
            });
            saveLocal();
        }

        async function syncData() {
            const icon = document.getElementById('sync-icon'); icon.className = 'ri-loader-4-line spin';
            try {
                const res = await fetch(`${API_URL}?action=load&user_id=${uid}`);
                const j = await res.json();
                if(j.status=='success' && j.data.accounts.length) {
                    db.accounts = j.data.accounts; db.categories = j.data.categories; db.transactions = j.data.transactions;
                    recalc(); toast('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞ ‚òÅÔ∏è');
                }
            } catch(e){} finally { icon.className = 'ri-cloud-line'; }
        }
        async function forceSync() {
            if(!confirm('–ó–∞–ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É?')) return;
            const icon = document.getElementById('sync-icon'); icon.className = 'ri-loader-4-line spin';
            try {
                await fetch(API_URL+'?action=sync_all', {method:'POST', mode:'no-cors', body:JSON.stringify({user_id:uid, accounts:db.accounts, categories:db.categories, transactions:db.transactions})});
                toast('–í—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ Google! ‚úÖ');
            } catch(e){ alert('–û—à–∏–±–∫–∞'); } finally { icon.className = 'ri-cloud-line'; }
        }
        async function pushTx(tx) { try { fetch(API_URL+'?action=add_tx', {method:'POST', mode:'no-cors', body:JSON.stringify({...tx, user_id:uid})}); } catch(e){} }

        function openSheet(id) { vibe(); document.getElementById('overlay').classList.add('open'); document.getElementById(id).classList.add('open'); }
        function closeSheets() { document.getElementById('overlay').classList.remove('open'); document.querySelectorAll('.sheet').forEach(s=>s.classList.remove('open')); }
        function nav(s,b) { vibe(); document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active')); document.getElementById('scr-'+s).classList.add('active'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); if(b) b.classList.add('active'); if(s=='stats') renderStats(); }
        function hi(el, cls) { document.querySelectorAll('.'+cls).forEach(x=>x.classList.remove('selected')); el.classList.add('selected'); }
        function setWaste(w) { curTx.waste=w; document.getElementById('bw-no').classList.toggle('active', !w); document.getElementById('bw-yes').classList.toggle('active', w); }
        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme')=='dark'?'light':'dark'); }

        renderAll();
    </script>
</body>
</html>
