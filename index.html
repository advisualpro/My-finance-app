<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyCosts Onyx Enterprise</title>
    
    <!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- –°–¢–ò–õ–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø -->
    <style>
        :root {
            /* === –¶–í–ï–¢–û–í–ê–Ø –ü–ê–õ–ò–¢–†–ê (ONYX DARK) === */
            --bg-root: #000000;       /* –ì–ª—É–±–æ–∫–∏–π —á–µ—Ä–Ω—ã–π */
            --bg-surface: #151517;    /* –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –∫–∞—Ä—Ç–æ—á–µ–∫ */
            --bg-elevated: #232325;   /* –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
            --bg-input: #2c2c2e;      /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
            
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --text-tertiary: #636366;
            
            --brand-primary: #0a84ff; /* iOS Blue */
            --brand-glow: rgba(10, 132, 255, 0.2);
            
            --color-success: #30d158; /* Green */
            --color-danger: #ff453a;  /* Red */
            --color-warning: #ffd60a; /* Yellow */
            
            --radius-l: 24px;
            --radius-m: 16px;
            --radius-s: 12px;
            
            --font-family: 'Inter', -apple-system, sans-serif;
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* –ë–ê–ó–û–í–´–ô –°–ë–†–û–° */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg-root);
            color: var(--text-primary);
            font-family: var(--font-family);
            margin: 0; padding: 0;
            padding-bottom: calc(100px + var(--safe-area-bottom));
            overflow-x: hidden;
            font-size: 16px;
            line-height: 1.5;
        }

        .container {
            padding: 16px;
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
        }

        /* === –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê === */
        h1 { font-size: 34px; font-weight: 800; letter-spacing: -0.5px; margin: 0 0 8px 0; }
        h2 { font-size: 22px; font-weight: 700; margin: 0; letter-spacing: -0.3px; }
        h3 { font-size: 17px; font-weight: 600; color: var(--text-secondary); margin: 0; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .text-huge { font-size: 42px; font-weight: 800; letter-spacing: -1px; line-height: 1; }
        .text-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 1px; display: block; margin-bottom: 6px; }
        .text-sm { font-size: 13px; color: var(--text-secondary); }

        /* === –ö–û–ú–ü–û–ù–ï–ù–¢–´ === */
        .card {
            background: var(--bg-surface);
            border-radius: var(--radius-l);
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.06);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .flex-row { display: flex; justify-content: space-between; align-items: center; }
        .flex-col { display: flex; flex-direction: column; gap: 4px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }

        /* –ö–ù–û–ü–ö–ò */
        .btn {
            width: 100%; padding: 16px; border-radius: var(--radius-m); border: none;
            font-size: 16px; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s, opacity 0.2s;
        }
        .btn:active { transform: scale(0.97); opacity: 0.8; }
        
        .btn-primary { background: var(--brand-primary); color: white; box-shadow: 0 4px 15px var(--brand-glow); }
        .btn-secondary { background: var(--bg-input); color: var(--text-primary); }
        
        .icon-btn {
            width: 44px; height: 44px; border-radius: 50%;
            background: var(--bg-input); color: var(--text-primary);
            border: none; font-size: 22px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* –ò–ù–ü–£–¢–´ */
        .input-hero {
            width: 100%; background: transparent; border: none;
            font-size: 48px; font-weight: 800; color: white; text-align: center;
            padding: 20px 0; outline: none;
        }
        .input-std {
            width: 100%; padding: 16px; background: var(--bg-input);
            border: 1px solid transparent; border-radius: var(--radius-m);
            color: white; font-size: 16px; margin-bottom: 12px; outline: none;
            transition: 0.2s;
        }
        .input-std:focus { border-color: var(--brand-primary); background: #323234; }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø –í–†–ï–ú–ï–ù–ò */
        .date-picker {
            display: flex; align-items: center; justify-content: center; gap: 16px;
            background: var(--bg-surface); padding: 8px; border-radius: 100px;
            border: 1px solid rgba(255,255,255,0.1); margin-bottom: 24px;
        }
        .date-arrow { font-size: 24px; color: var(--text-secondary); padding: 4px; cursor: pointer; }
        .date-value { font-weight: 700; font-size: 15px; min-width: 140px; text-align: center; }

        /* –ü–†–û–ì–†–ï–°–° –ë–ê–†–´ */
        .progress-container {
            width: 100%; height: 8px; background: var(--bg-input);
            border-radius: 4px; overflow: hidden; margin-top: 10px;
        }
        .progress-bar { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
        .bg-green { background: var(--color-success); }
        .bg-red { background: var(--color-danger); }

        /* –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ */
        .tab-bar {
            position: fixed; bottom: 24px; left: 20px; right: 20px;
            background: rgba(30, 30, 32, 0.9); backdrop-filter: blur(20px);
            border-radius: 32px; padding: 14px 28px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid rgba(255,255,255,0.1); z-index: 100;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            max-width: 460px; margin: 0 auto;
        }
        .tab-item { font-size: 26px; color: var(--text-secondary); transition: 0.2s; position: relative; }
        .tab-item.active { color: var(--text-primary); transform: translateY(-4px); }
        .tab-item.active::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; border-radius: 50%; background: var(--brand-primary);
        }

        /* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000;
            opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px);
        }
        .modal-backdrop.active { opacity: 1; pointer-events: all; }
        
        .modal-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-surface); border-radius: 32px 32px 0 0;
            padding: 24px; padding-bottom: 50px;
            transform: translateY(100%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 1001; max-height: 90vh; overflow-y: auto;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .modal-sheet.active { transform: translateY(0); }

        /* –£–¢–ò–õ–ò–¢–´ */
        .hidden { display: none !important; }
        
        .scroll-h { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .chip { 
            background: var(--bg-input); padding: 12px 16px; border-radius: 16px; 
            min-width: 120px; flex-shrink: 0; border: 1px solid transparent; 
        }
        .chip.active { border-color: var(--brand-primary); background: rgba(10,132,255,0.15); }

        /* –°–¢–ê–¢–£–° –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò */
        .status-pill {
            padding: 6px 12px; background: var(--bg-input); border-radius: 20px;
            display: flex; gap: 8px; align-items: center; font-size: 12px; font-weight: 700;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot-green { background: var(--color-success); box-shadow: 0 0 10px var(--color-success); }
        .dot-yellow { background: var(--color-warning); animation: pulse 1s infinite; }
        .dot-red { background: var(--color-danger); }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* –ü–ï–†–ï–•–í–ê–¢–ß–ò–ö –û–®–ò–ë–û–ö */
        #error-box {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #000; z-index: 9999; color: red; padding: 20px;
            display: none; font-family: monospace; white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <!-- –ë–õ–û–ö –ü–ï–†–ï–•–í–ê–¢–ß–ò–ö–ê –û–®–ò–ë–û–ö -->
    <div id="error-box"></div>
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-box').style.display = 'block';
            document.getElementById('error-box').innerHTML = `CRITICAL ERROR:\n${msg}\nLine: ${line}`;
            return false;
        };
    </script>
    <!-- ========================================== -->
    <!-- 1. –ó–ê–°–¢–ê–í–ö–ê (PRELOADER)                    -->
    <!-- ========================================== -->
    <div id="screen-splash" style="position:fixed; inset:0; background:#000; z-index:9000; display:flex; align-items:center; justify-content:center; transition:0.5s;">
        <div style="width:40px; height:40px; border:3px solid #333; border-top-color:var(--brand-primary); border-radius:50%; animation:spin 1s infinite;"></div>
        <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
    </div>

    <!-- ========================================== -->
    <!-- 2. –û–ù–ë–û–†–î–ò–ù–ì (–î–õ–Ø –ù–û–í–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô)     -->
    <!-- ========================================== -->
    <div id="screen-onboarding" class="container hidden" style="display:flex; flex-direction:column; justify-content:center; text-align:center;">
        <div style="font-size: 60px; margin-bottom: 20px;">üëã</div>
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
        <p class="text-sm" style="margin-bottom: 40px; font-size:15px; line-height:1.6;">
            MyCosts Onyx ‚Äî —ç—Ç–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π<br>–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–æ–º.
        </p>
        
        <div class="card" style="text-align:left;">
            <span class="text-label">–¢–í–û–ï –ò–ú–Ø</span>
            <input type="text" id="setup-name" class="input-std" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
            
            <span class="text-label">–ú–ï–°–Ø–ß–ù–´–ô –ë–Æ–î–ñ–ï–¢ (‚ÇΩ)</span>
            <input type="number" id="setup-limit" class="input-std" placeholder="100 000">
        </div>
        
        <button class="btn btn-primary" onclick="Core.finishOnboarding()">
            –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        </button>
    </div>

    <!-- ========================================== -->
    <!-- 3. –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï                     -->
    <!-- ========================================== -->
    <div id="screen-app" class="container hidden">
        
        <!-- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ -->
        <div class="flex-row" style="margin-bottom: 20px; padding-top: 10px;">
            <div class="status-pill" onclick="Sync.force()">
                <div class="status-dot" id="sync-dot"></div>
                <span id="sync-text">CONNECTING</span>
            </div>
            <div style="font-weight:700; font-size:16px;" id="user-display">User</div>
        </div>

        <!-- >>> –í–ö–õ–ê–î–ö–ê 1: –ì–õ–ê–í–ù–ê–Ø (DASHBOARD) <<< -->
        <div id="view-home">
            
            <!-- –ú–ê–®–ò–ù–ê –í–†–ï–ú–ï–ù–ò (–í–´–ë–û–† –ú–ï–°–Ø–¶–ê) -->
            <div class="date-picker">
                <i class="ri-arrow-left-s-line date-arrow" onclick="Time.prev()"></i>
                <div class="date-value" id="month-label">...</div>
                <i class="ri-arrow-right-s-line date-arrow" onclick="Time.next()"></i>
            </div>

            <!-- –ì–õ–ê–í–ù–´–ô –ë–ê–õ–ê–ù–° -->
            <div class="card" style="text-align:center; padding:32px 20px;">
                <span class="text-label">–û–ë–©–ò–ô –ö–ê–ü–ò–¢–ê–õ</span>
                <div class="input-money" style="font-size:42px; padding:10px 0;" id="val-total">0 ‚ÇΩ</div>
                
                <div class="grid-2" style="margin-top:24px;">
                    <button class="btn btn-secondary" style="color:var(--color-danger); background:rgba(255,69,58,0.1)" onclick="UI.openTx('expense')">
                        <i class="ri-arrow-down-line"></i> –†–∞—Å—Ö–æ–¥
                    </button>
                    <button class="btn btn-secondary" style="color:var(--color-success); background:rgba(48,209,88,0.1)" onclick="UI.openTx('income')">
                        <i class="ri-arrow-up-line"></i> –î–æ—Ö–æ–¥
                    </button>
                </div>
            </div>

            <!-- CASHFLOW & FREEDOM -->
            <div class="card">
                <div class="flex-row">
                    <span class="text-label" style="margin:0">–§–ò–ù–ê–ù–°–û–í–ê–Ø –°–í–û–ë–û–î–ê</span>
                    <span style="font-weight:800" id="val-freedom">0%</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar bg-green" id="bar-freedom" style="width:0%"></div>
                </div>
                <div class="flex-row" style="margin-top:12px;">
                    <div>
                        <span class="text-label" style="font-size:10px">–ü–ê–°–°–ò–í–ù–´–ô</span>
                        <div style="font-weight:700; color:var(--color-success)" id="val-passive">0 ‚ÇΩ</div>
                    </div>
                    <div style="text-align:right;">
                        <span class="text-label" style="font-size:10px">–†–ê–°–•–û–î–´ (–ú–ï–°)</span>
                        <div style="font-weight:700; color:var(--color-danger)" id="val-expense">0 ‚ÇΩ</div>
                    </div>
                </div>
            </div>

            <!-- –ë–Æ–î–ñ–ï–¢ -->
            <div class="card">
                <div class="flex-row">
                    <span class="text-label" style="margin:0">–û–°–¢–ê–¢–û–ö –ë–Æ–î–ñ–ï–¢–ê</span>
                    <span style="font-weight:700" id="val-budget">0 ‚ÇΩ</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar bg-red" id="bar-budget" style="width:0%"></div>
                </div>
            </div>

            <!-- –°–ß–ï–¢–ê -->
            <div class="flex-row" style="margin-bottom:12px;">
                <h3>–ú–æ–∏ –°—á–µ—Ç–∞</h3>
                <span class="text-label" style="color:var(--brand-primary); cursor:pointer;" onclick="UI.nav('wallet')">–í–°–ï</span>
            </div>
            <div class="scroll-h" id="list-acc-home"></div>

            <!-- –ò–°–¢–û–†–ò–Ø -->
            <div class="flex-row" style="margin-top:24px; margin-bottom:12px;">
                <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
                <span class="text-label" style="color:var(--brand-primary); cursor:pointer;" onclick="UI.nav('stats')">–ê–ù–ê–õ–ò–ó</span>
            </div>
            <div id="list-tx-home"></div>
        </div>

        <!-- >>> –í–ö–õ–ê–î–ö–ê 2: –ò–ù–í–ï–°–¢–ò–¶–ò–ò <<< -->
        <div id="view-invest" class="hidden">
            <h2>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h2>
            <p class="text-sm" style="margin-bottom:20px;">–†–æ—Å—Ç –∫–∞–ø–∏—Ç–∞–ª–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏</p>
            
            <div class="card">
                <div class="flex-row">
                    <span class="text-label">–ü–†–û–ì–ù–û–ó (1 –ì–û–î)</span>
                    <span style="color:var(--color-success); font-weight:700" id="val-forecast">+0 ‚ÇΩ</span>
                </div>
                <div style="height:220px; margin-top:15px;">
                    <canvas id="chart-invest"></canvas>
                </div>
            </div>
            <h3>–ü–æ—Ä—Ç—Ñ–µ–ª—å</h3>
            <div id="list-inv" style="margin-top:12px;"></div>
        </div>

        <!-- >>> –í–ö–õ–ê–î–ö–ê 3: –ê–ù–ê–õ–ò–¢–ò–ö–ê <<< -->
        <div id="view-stats" class="hidden">
            <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            <br>
            <div class="grid-2" style="margin-bottom:20px;">
                <button class="btn btn-secondary" onclick="UI.setStatMode('expense')">–†–∞—Å—Ö–æ–¥—ã</button>
                <button class="btn btn-secondary" onclick="UI.setStatMode('income')">–î–æ—Ö–æ–¥—ã</button>
            </div>
            <div class="card">
                <div style="height:260px; position:relative;">
                    <canvas id="chart-pie"></canvas>
                </div>
            </div>
            <div id="list-stats"></div>
        </div>

        <!-- >>> –í–ö–õ–ê–î–ö–ê 4: –ö–û–®–ï–õ–ï–ö (–£–ü–†–ê–í–õ–ï–ù–ò–ï) <<< -->
        <div id="view-wallet" class="hidden">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            <br>
            <div class="card">
                <div class="flex-row" style="margin-bottom:16px;">
                    <h3>–°—á–µ—Ç–∞</h3>
                    <button class="btn-icon" onclick="UI.openAcc()"><i class="ri-add-line"></i></button>
                </div>
                <div id="list-acc-manage"></div>
            </div>

            <div class="card">
                <div class="flex-row" style="margin-bottom:16px;">
                    <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                    <button class="btn-icon" onclick="UI.openCat()"><i class="ri-add-line"></i></button>
                </div>
                <div id="list-cat-manage"></div>
            </div>
            
            <button class="btn btn-secondary" style="margin-top:20px; color:var(--color-danger);" onclick="Core.reset()">
                <i class="ri-delete-bin-line"></i> –°–±—Ä–æ—Å –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
            </button>
        </div>

    </div>

    <!-- –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ -->
    <div class="tab-bar">
        <i class="ri-home-5-fill tab-item active" onclick="UI.nav('home', this)"></i>
        <i class="ri-line-chart-fill tab-item" onclick="UI.nav('invest', this)"></i>
        <i class="ri-pie-chart-2-fill tab-item" onclick="UI.nav('stats', this)"></i>
        <i class="ri-wallet-3-fill tab-item" onclick="UI.nav('wallet', this)"></i>
    </div>

    <!-- === –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê === -->
    <div class="modal-backdrop" id="backdrop" onclick="UI.closeAll()"></div>

    <!-- 1. –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø -->
    <div class="modal-sheet" id="sheet-tx">
        <div class="sheet-handle"></div>
        <div class="flex-row" style="margin-bottom:20px;">
            <h2 id="tx-title">–†–∞—Å—Ö–æ–¥</h2>
            <div class="btn-icon" onclick="UI.closeAll()"><i class="ri-close-line"></i></div>
        </div>
        
        <input type="number" id="tx-amount" class="input-money" placeholder="0" inputmode="decimal">
        
        <span class="text-label">–°–ß–ï–¢</span>
        <div class="scroll-h" id="tx-accs-list" style="margin-bottom:20px;"></div>
        
        <span class="text-label">–ö–ê–¢–ï–ì–û–†–ò–Ø</span>
        <div class="grid-4" id="tx-cats-list" style="margin-bottom:20px;"></div>
        
        <input type="text" id="tx-note" class="input-std" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
        
        <div class="grid-2">
            <button class="btn btn-primary" onclick="Actions.saveTx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary hidden" id="tx-del-btn" style="color:var(--color-danger)" onclick="Actions.delTx()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>

    <!-- 2. –°–ß–ï–¢ -->
    <div class="modal-sheet" id="sheet-acc">
        <div class="sheet-handle"></div>
        <div class="flex-row"><h2>–°—á–µ—Ç</h2> <div class="btn-icon" onclick="UI.closeAll()"><i class="ri-close-line"></i></div></div><br>
        
        <input type="text" id="acc-name" class="input-std" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞">
        
        <div class="grid-2" style="margin-bottom:16px;">
            <button class="btn btn-secondary" id="type-card" onclick="Actions.setType('card')">–ö–∞—Ä—Ç–∞</button>
            <button class="btn btn-secondary" id="type-invest" onclick="Actions.setType('invest')">–ò–Ω–≤–µ—Å—Ç</button>
        </div>
        
        <div id="acc-invest-opts" class="hidden">
            <input type="number" id="acc-percent" class="input-std" placeholder="% –î–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏">
        </div>
        
        <input type="number" id="acc-bal" class="input-std" placeholder="–ë–∞–ª–∞–Ω—Å">
        
        <div class="grid-2">
            <button class="btn btn-primary" onclick="Actions.saveAcc()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" style="color:var(--color-danger)" onclick="Actions.delAcc()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>

    <!-- 3. –ö–ê–¢–ï–ì–û–†–ò–Ø -->
    <div class="modal-sheet" id="sheet-cat">
        <div class="sheet-handle"></div>
        <div class="flex-row"><h2>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2> <div class="btn-icon" onclick="UI.closeAll()"><i class="ri-close-line"></i></div></div><br>
        
        <input type="text" id="cat-name" class="input-std" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        
        <div class="grid-2" style="margin-bottom:16px;">
            <button class="btn btn-secondary" id="ctype-exp" onclick="Actions.setCatType('expense')">–†–∞—Å—Ö–æ–¥</button>
            <button class="btn btn-secondary" id="ctype-inc" onclick="Actions.setCatType('income')">–î–æ—Ö–æ–¥</button>
        </div>
        
        <div class="grid-4" id="cat-icons-grid" style="margin-bottom:20px;"></div>
        
        <div class="grid-2">
            <button class="btn btn-primary" onclick="Actions.saveCat()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" style="color:var(--color-danger)" onclick="Actions.delCat()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
    <script>
        /**
         * ==========================================
         * MYCOSTS ONYX v15.0 - ENTERPRISE CORE
         * ==========================================
         */

        // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–ï–†–í–ï–†–ê
        // ------------------------------------------
        // !!! –í–°–¢–ê–í–¨ –°–í–û–Æ –°–°–´–õ–ö–£ –ù–ò–ñ–ï –í –ö–ê–í–´–ß–ö–ò !!!
        const API_URL = 'https://script.google.com/macros/s/AKfycby_ES9U2-4VYmPhMLbDtNNv_ESnbUEI9nlw0euEHsxZ6eJqu340_LpF_A1pSxyUvRxG/exec';

        // 2. –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï (STATE MANAGEMENT)
        // ------------------------------------------
        const State = {
            db: { 
                user: { name: '', limit: 100000 }, 
                accounts: [], 
                categories: [], 
                transactions: [] 
            },
            userId: null,
            viewDate: new Date(), // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            temp: { // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ä–º
                editId: null, 
                type: 'expense', 
                accId: null, 
                catId: null, 
                icon: null,
                statMode: 'expense'
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram SDK
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–∑ Telegram)
        let uid = localStorage.getItem('onyx_uid');
        if (!uid) {
            uid = tg.initDataUnsafe?.user?.id 
                ? 'tg_' + tg.initDataUnsafe.user.id 
                : 'web_' + Date.now().toString().slice(-8);
            localStorage.setItem('onyx_uid', uid);
        }
        State.userId = uid;

        // ==========================================
        // 3. –Ø–î–†–û –ó–ê–ü–£–°–ö–ê (BOOTSTRAP)
        // ==========================================
        const Core = {
            // –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
            init: () => {
                // 1. –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const local = localStorage.getItem('onyx_db');
                let hasData = false;
                
                if (local) {
                    try {
                        State.db = JSON.parse(local);
                        // –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –∏–∫–æ–Ω–æ–∫ (–∑–∞—â–∏—Ç–∞ –æ—Ç –±–∞–≥–æ–≤)
                        State.db.categories.forEach(c => {
                            if(c.icon.length > 4) c.icon = 'üîπ'; 
                        });
                        hasData = State.db.accounts.length > 0;
                    } catch(e) { console.error('DB Error:', e); }
                }

                // 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞–º–∏ –∑–∞–ø—É—Å–∫–∞
                setTimeout(() => {
                    const splash = document.getElementById('splash');
                    splash.style.opacity = '0';
                    
                    setTimeout(() => {
                        splash.style.display = 'none';
                        if (hasData) {
                            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                            document.getElementById('screen-app').classList.remove('hidden');
                            Render.all(); // –†–∏—Å—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                            Sync.pull(); // –§–æ–Ω–æ–≤–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å –æ–±–ª–∞–∫–∞
                        } else {
                            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                            document.getElementById('screen-onboarding').classList.remove('hidden');
                        }
                    }, 500);
                }, 800); // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
            },

            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            finishOnboarding: () => {
                const name = document.getElementById('setup-name').value || 'User';
                const limit = parseFloat(document.getElementById('setup-limit').value) || 100000;
                
                State.db.user.name = name;
                State.db.user.limit = limit;
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
                State.db.accounts = [{id: 'a1', name: '–ö–∞—Ä—Ç–∞', type: 'card', balance: 0, percent: 0}];
                State.db.categories = [
                    {id: 'c1', name: '–ï–¥–∞', icon: 'üçî', type: 'expense'},
                    {id: 'c2', name: '–î–æ–º', icon: 'üè†', type: 'expense'},
                    {id: 'c3', name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', icon: 'üöï', type: 'expense'},
                    {id: 'c4', name: '–ó–∞—Ä–ø–ª–∞—Ç–∞', icon: 'üí∞', type: 'income'}
                ];
                
                Core.save();
                
                // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                document.getElementById('screen-onboarding').classList.add('hidden');
                document.getElementById('screen-app').classList.remove('hidden');
                Render.all();
                Sync.push(true); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –æ–±–ª–∞–∫–æ
            },

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            save: () => {
                localStorage.setItem('onyx_db', JSON.stringify(State.db));
                Render.all(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            },

            // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å
            reset: () => {
                if(confirm('–°—Ç–µ—Ä–µ—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞?')) {
                    localStorage.removeItem('onyx_db');
                    location.reload();
                }
            }
        };

        // ==========================================
        // 4. –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (SYNC ENGINE)
        // ==========================================
        const Sync = {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞
            status: (color, text) => {
                const dot = document.getElementById('sync-dot');
                dot.className = 'status-dot dot-' + color; // green, yellow, red
                // document.getElementById('sync-text').innerText = text; // –£–±—Ä–∞–ª —Ç–µ–∫—Å—Ç –¥–ª—è –º–∏–Ω–∏–º–∞–ª–∏–∑–º–∞
            },

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ (Pull)
            pull: async () => {
                Sync.status('yellow', 'LOAD');
                try {
                    // –î–æ–±–∞–≤–ª—è–µ–º timestamp, —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞
                    const res = await fetch(`${API_URL}?action=load&user_id=${State.userId}&t=${Date.now()}`);
                    const json = await res.json();
                    
                    if(json.status === 'success' && json.data.accounts.length > 0) {
                        // –ü—Ä–∏—à–ª–∏ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ -> –û–±–Ω–æ–≤–ª—è–µ–º State
                        State.db.accounts = json.data.accounts;
                        State.db.categories = json.data.categories;
                        State.db.transactions = json.data.transactions;
                        if(json.data.user) State.db.user = json.data.user;
                        
                        Logic.calcInterest(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã
                        Core.save();
                        Sync.status('green', 'OK');
                    } else {
                        // –î–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–µ –Ω–µ—Ç, —Ä–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                        Sync.status('green', 'LOCAL');
                    }
                } catch(e) {
                    console.warn('Offline mode');
                    Sync.status('red', 'ERR');
                }
            },

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (Push)
            push: async (force = false) => {
                if(!force) Sync.status('yellow', '...');
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º POST no-cors –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                    await fetch(API_URL + '?action=sync_all', {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({
                            user_id: State.userId,
                            accounts: State.db.accounts,
                            categories: State.db.categories,
                            transactions: State.db.transactions,
                            user: State.db.user
                        })
                    });
                    if(!force) Sync.status('green', 'OK');
                } catch(e) {
                    Sync.status('red', 'ERR');
                }
            },
            
            force: async () => {
                if(confirm('–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞?')) await Sync.push(true);
            }
        };

        // ==========================================
        // 5. –ë–ò–ó–ù–ï–° –õ–û–ì–ò–ö–ê (MATH & TIME)
        // ==========================================
        const Time = {
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞
            next: () => {
                State.viewDate.setMonth(State.viewDate.getMonth() + 1);
                Render.all();
            },
            prev: () => {
                State.viewDate.setMonth(State.viewDate.getMonth() - 1);
                Render.all();
            },
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞ "YYYY-MM" –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            getKey: () => {
                const y = State.viewDate.getFullYear();
                const m = String(State.viewDate.getMonth() + 1).padStart(2, '0');
                return `${y}-${m}`;
            },
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
            getString: () => {
                const months = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
                return `${months[State.viewDate.getMonth()]} ${State.viewDate.getFullYear()}`;
            }
        };

        const Logic = {
            // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ (Daily Compound)
            calcInterest: () => {
                let changed = false;
                const now = Date.now();
                
                State.db.accounts.forEach(acc => {
                    if (acc.type === 'invest' && acc.percent > 0) {
                        const last = acc.lastCalc || now;
                        const days = (now - last) / (1000 * 60 * 60 * 24);
                        
                        if (days >= 1) {
                            // –§–æ—Ä–º—É–ª–∞: –ë–∞–ª–∞–Ω—Å * (% / 100 / 365) * –¥–Ω–µ–π
                            const profit = parseFloat(acc.balance) * (parseFloat(acc.percent)/100/365) * days;
                            
                            if (profit > 0.1) {
                                State.db.transactions.push({
                                    id: 'sys_' + Date.now(),
                                    date: new Date().toISOString(),
                                    amount: profit,
                                    type: 'income',
                                    accountId: acc.id,
                                    categoryId: 'sys', // –°–∏—Å—Ç–µ–º–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
                                    comment: '% –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ',
                                    isWaste: false
                                });
                                acc.lastCalc = now;
                                changed = true;
                            }
                        }
                    }
                });
                if(changed) Core.save();
            }
        };
        // ==========================================
        // 6. –û–¢–†–ò–°–û–í–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê (RENDER ENGINE)
        // ==========================================
        const Render = {
            all: () => {
                // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–ø–∫—É
                document.getElementById('user-name').innerText = State.db.user.name;
                document.getElementById('month-display').innerText = Time.getString();
                
                // –ö–ª—é—á —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "2025-10")
                const monthKey = Time.getKey();

                // 1. –†–ê–°–ß–ï–¢ –ë–ê–õ–ê–ù–°–û–í (–ì–ª–æ–±–∞–ª—å–Ω—ã–π –∏ –ú–µ—Å—è—á–Ω—ã–π)
                // ------------------------------------------
                const balances = {}; // –ë–∞–ª–∞–Ω—Å—ã —Å—á–µ—Ç–æ–≤
                let expenseMonth = 0; // –†–∞—Å—Ö–æ–¥—ã –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü
                let passiveMonth = 0; // –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ (—Ä–∞—Å—á–µ—Ç–Ω—ã–π)

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–ª–∞–Ω—Å—ã —Å—Ç–∞—Ä—Ç–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                State.db.accounts.forEach(a => balances[a.id] = parseFloat(a.balance || 0));
                
                // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –í–°–ï–ú —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞
                State.db.transactions.forEach(t => {
                    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç
                    if (balances[t.accountId] !== undefined) {
                        if (t.type === 'income') balances[t.accountId] += parseFloat(t.amount);
                        else balances[t.accountId] -= parseFloat(t.amount);
                    }
                    
                    // –ú–µ—Å—è—á–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
                    if (t.date.startsWith(monthKey)) {
                        if (t.type === 'expense') expenseMonth += parseFloat(t.amount);
                    }
                });

                // –†–∞—Å—á–µ—Ç –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞ (–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–ª–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π)
                State.db.accounts.filter(a => a.type === 'invest').forEach(a => {
                    // (–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å * % / 100) / 12 –º–µ—Å—è—Ü–µ–≤
                    passiveMonth += (balances[a.id] * (parseFloat(a.percent) / 100)) / 12;
                });

                // 2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê
                // ------------------------------------------
                // –û–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª
                const totalCapital = Object.values(balances).reduce((a, b) => a + b, 0);
                document.getElementById('total-balance').innerText = Math.floor(totalCapital).toLocaleString() + ' ‚ÇΩ';

                // Cashflow (–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–±–æ–¥–∞)
                const freedomRate = expenseMonth > 0 ? (passiveMonth / expenseMonth * 100) : 0;
                document.getElementById('cf-pct').innerText = freedomRate.toFixed(1) + '%';
                document.getElementById('cf-bar').style.width = Math.min(100, freedomRate) + '%';
                
                document.getElementById('cf-passive').innerText = '+' + Math.floor(passiveMonth).toLocaleString();
                document.getElementById('cf-expense').innerText = '-' + Math.floor(expenseMonth).toLocaleString();

                // –ë—é–¥–∂–µ—Ç
                const limit = State.db.user.limit || 100000;
                const budgetLeft = limit - expenseMonth;
                const budgetPct = Math.min(100, (expenseMonth / limit * 100));
                
                document.getElementById('bud-bar').style.width = budgetPct + '%';
                document.getElementById('bud-left').innerText = budgetLeft.toLocaleString() + ' ‚ÇΩ';

                // 3. –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–ü–ò–°–ö–û–í
                // ------------------------------------------
                
                // –°–ø–∏—Å–æ–∫ —Å—á–µ—Ç–æ–≤ (–ì–ª–∞–≤–Ω–∞—è)
                const accHTML = State.db.accounts.map(a => 
                    `<div class="chip ${State.temp.accId == a.id ? 'active' : ''}" onclick="Actions.setTxAcc('${a.id}', this)">
                        <div class="text-label" style="text-transform:none; margin-bottom:4px;">${a.name}</div>
                        <div style="font-weight:700; font-size:16px;">${Math.floor(balances[a.id]).toLocaleString()}</div>
                    </div>`
                ).join('');
                document.getElementById('list-accs-home').innerHTML = accHTML;
                document.getElementById('tx-accs-list').innerHTML = accHTML; // –î—É–±–ª–∏—Ä—É–µ–º –≤ –º–æ–¥–∞–ª–∫—É

                // –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–ò—Å—Ç–æ—Ä–∏—è –∑–∞ –º–µ—Å—è—Ü)
                const monthTxs = State.db.transactions
                    .filter(t => t.date.startsWith(monthKey))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                document.getElementById('list-tx-home').innerHTML = monthTxs.map(t => {
                    const cat = State.db.categories.find(x => x.id == t.categoryId) || {name:'?', icon:'üîπ'};
                    const acc = State.db.accounts.find(a => a.id == t.accountId);
                    
                    return `
                    <div class="card flex-between" onclick="Modal.editTx('${t.id}')" style="padding:16px; margin-bottom:10px; cursor:pointer;">
                        <div class="flex-center" style="gap:12px;">
                            <span style="font-size:24px">${cat.icon}</span>
                            <div>
                                <div style="font-weight:600">${cat.name}</div>
                                <div class="text-label" style="margin:0; opacity:0.6; text-transform:none;">${t.comment || new Date(t.date).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div style="font-weight:700; font-size:16px; color:${t.type == 'expense' ? 'var(--danger-color)' : 'var(--success-color)'}">
                            ${t.type == 'expense' ? '-' : '+'}${Math.floor(t.amount)}
                        </div>
                    </div>`;
                }).join('');

                // –°–ø–∏—Å–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ö–æ—à–µ–ª–µ–∫)
                document.getElementById('list-acc-manage').innerHTML = State.db.accounts.map(a => 
                    `<div class="flex-between" style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1); cursor:pointer;" onclick="Modal.openAcc('${a.id}')">
                        <b>${a.name}</b> <span class="text-sm">${Math.floor(balances[a.id])}</span>
                    </div>`
                ).join('');
                
                document.getElementById('list-cat-manage').innerHTML = State.db.categories.map(c => 
                    `<div class="flex-between" style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1); cursor:pointer;" onclick="Modal.openCat('${c.id}')">
                        <div style="display:flex; gap:10px; align-items:center;">${c.icon} ${c.name}</div> 
                        <i class="ri-arrow-right-s-line" style="color:#666"></i>
                    </div>`
                ).join('');

                // –°–ø–∏—Å–æ–∫ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
                document.getElementById('list-inv').innerHTML = State.db.accounts.filter(a => a.type === 'invest').map(a => 
                    `<div class="card flex-between">
                        <div>
                            <b>${a.name}</b><br>
                            <span style="color:var(--success-color); font-size:12px;">${a.percent}% –≥–æ–¥.</span>
                        </div>
                        <b>${Math.floor(balances[a.id]).toLocaleString()}</b>
                    </div>`
                ).join('');

                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                Render.charts(monthTxs, balances);
            },

            // 4. –û–¢–†–ò–°–û–í–ö–ê –ì–†–ê–§–ò–ö–û–í (CHART.JS)
            // ------------------------------------------
            charts: (txs, balances) => {
                // –ì—Ä–∞—Ñ–∏–∫ 1: –ü–æ–Ω—á–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤/–¥–æ—Ö–æ–¥–æ–≤
                const ctxPie = document.getElementById('chart-pie');
                const statMode = State.temp.statMode || 'expense';
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
                const dataTx = txs.filter(t => t.type === statMode);
                const catsAgg = {}; // –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                
                dataTx.forEach(t => {
                    catsAgg[t.categoryId] = (catsAgg[t.categoryId] || 0) + parseFloat(t.amount);
                });
                
                // –†–∏—Å—É–µ–º Chart.js
                if (window.pieChart) window.pieChart.destroy();
                window.pieChart = new Chart(ctxPie, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(catsAgg).map(id => State.db.categories.find(c => c.id == id)?.name),
                        datasets: [{
                            data: Object.values(catsAgg),
                            backgroundColor: ['#0a84ff', '#30d158', '#ffd60a', '#ff453a', '#bf5af2', '#64d2ff'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { color: '#fff', font: { size: 11, family: 'Manrope' } } }
                        }
                    }
                });
                
                // –¢–µ–∫—Å—Ç–æ–≤–∞—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–º
                document.getElementById('list-stats').innerHTML = Object.entries(catsAgg)
                    .sort((a, b) => b[1] - a[1]) // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
                    .map(([id, val]) => {
                        const c = State.db.categories.find(x => x.id == id) || {name:'?', icon:''};
                        return `<div class="flex-between" style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1)">
                            <div style="display:flex; gap:10px; align-items:center;">${c.icon} ${c.name}</div>
                            <b>${Math.floor(val).toLocaleString()}</b>
                        </div>`;
                    }).join('');

                // –ì—Ä–∞—Ñ–∏–∫ 2: –ü—Ä–æ–≥–Ω–æ–∑ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
                const ctxInv = document.getElementById('chart-inv');
                const invAccs = State.db.accounts.filter(a => a.type === 'invest');
                const currentSum = invAccs.reduce((s, a) => s + (balances[a.id] || 0), 0);
                const projectedSum = currentSum * 1.15; // +15% –≤ –≥–æ–¥ (—Å—Ä–µ–¥–Ω–µ–µ)
                
                document.getElementById('inv-growth').innerText = `+${Math.floor(projectedSum - currentSum).toLocaleString()} ‚ÇΩ`;
                
                if (window.lineChart) window.lineChart.destroy();
                window.lineChart = new Chart(ctxInv, {
                    type: 'line',
                    data: {
                        labels: ['–°–µ–π—á–∞—Å', '3 –º–µ—Å', '6 –º–µ—Å', '9 –º–µ—Å', '1 –≥–æ–¥'],
                        datasets: [{
                            data: [currentSum, currentSum * 1.04, currentSum * 1.08, currentSum * 1.12, projectedSum],
                            borderColor: '#30d158',
                            backgroundColor: 'rgba(48, 209, 88, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { display: false }, y: { display: false } },
                        elements: { point: { radius: 0 } }
                    }
                });
            }
        };

        // ==========================================
        // 7. –î–ï–ô–°–¢–í–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (ACTIONS)
        // ==========================================
        const Actions = {
            // –¢–†–ê–ù–ó–ê–ö–¶–ò–ò
            setTxAcc: (id, el) => {
                State.temp.accId = id;
                document.querySelectorAll('#tx-accs-list .chip').forEach(c => c.classList.remove('active'));
                if (el) el.classList.add('active');
            },
            
            saveTx: () => {
                const amt = parseFloat(document.getElementById('tx-amt').value);
                if (!amt || !State.temp.accId || !State.temp.catId) return; // –í–∞–ª–∏–¥–∞—Ü–∏—è
                
                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                const tx = {
                    id: State.temp.editId || 'tx_' + Date.now(),
                    // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º - –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é –¥–∞—Ç—É, –∏–Ω–∞—á–µ - —Å–µ–≥–æ–¥–Ω—è
                    date: State.temp.editId ? State.db.transactions.find(t => t.id == State.temp.editId).date : new Date().toISOString(),
                    amount: amt,
                    type: State.temp.type,
                    accountId: State.temp.accId,
                    categoryId: State.temp.catId,
                    comment: document.getElementById('tx-note').value,
                    isWaste: false
                };

                // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤
                if (State.temp.editId) {
                    const idx = State.db.transactions.findIndex(t => t.id == State.temp.editId);
                    State.db.transactions[idx] = tx;
                } else {
                    State.db.transactions.push(tx);
                }
                
                Core.save();
                Modal.closeAll();
                Sync.push(true); // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –æ–±–ª–∞–∫–æ
            },
            
            deleteTx: () => {
                if (confirm('–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é?')) {
                    State.db.transactions = State.db.transactions.filter(t => t.id != State.temp.editId);
                    Core.save();
                    Modal.closeAll();
                    Sync.push(true);
                }
            },

            // –°–ß–ï–¢–ê
            setAccType: (t) => {
                State.temp.type = t;
                document.getElementById('type-card').className = t === 'card' ? 'btn btn-primary' : 'btn btn-secondary';
                document.getElementById('type-invest').className = t === 'invest' ? 'btn btn-primary' : 'btn btn-secondary';
                document.getElementById('acc-invest-opts').classList.toggle('hidden', t !== 'invest');
            },
            
            saveAcc: () => {
                const name = document.getElementById('acc-name').value;
                if (!name) return;
                
                const acc = {
                    id: State.temp.editId || 'acc_' + Date.now(),
                    name: name,
                    type: State.temp.type,
                    balance: parseFloat(document.getElementById('acc-bal').value) || 0,
                    percent: parseFloat(document.getElementById('acc-percent').value) || 0
                };
                
                if (State.temp.editId) {
                    const idx = State.db.accounts.findIndex(a => a.id == State.temp.editId);
                    State.db.accounts[idx] = acc;
                } else {
                    State.db.accounts.push(acc);
                }
                Core.save(); Modal.closeAll(); Sync.push(true);
            },
            
            delAcc: () => {
                if (State.temp.editId && confirm('–£–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç?')) {
                    State.db.accounts = State.db.accounts.filter(a => a.id != State.temp.editId);
                    Core.save(); Modal.closeAll(); Sync.push(true);
                }
            },

            // –ö–ê–¢–ï–ì–û–†–ò–ò
            setCatType: (t) => {
                State.temp.type = t;
                document.getElementById('ctype-exp').className = t === 'expense' ? 'btn btn-primary' : 'btn btn-secondary';
                document.getElementById('ctype-inc').className = t === 'income' ? 'btn btn-primary' : 'btn btn-secondary';
            },
            
            saveCat: () => {
                const name = document.getElementById('cat-name').value;
                if (!name) return;
                
                const cat = {
                    id: State.temp.editId || 'cat_' + Date.now(),
                    name: name,
                    type: State.temp.type,
                    icon: State.temp.icon || 'üîπ'
                };
                
                if (State.temp.editId) {
                    const idx = State.db.categories.findIndex(c => c.id == State.temp.editId);
                    State.db.categories[idx] = cat;
                } else {
                    State.db.categories.push(cat);
                }
                Core.save(); Modal.closeAll(); Sync.push(true);
            },
            
            delCat: () => {
                if (State.temp.editId && confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) {
                    State.db.categories = State.db.categories.filter(c => c.id != State.temp.editId);
                    Core.save(); Modal.closeAll(); Sync.push(true);
                }
            }
        };

        // ==========================================
        // 8. –£–ü–†–ê–í–õ–ï–ù–ò–ï –û–ö–ù–ê–ú–ò (MODALS)
        // ==========================================
        const Modal = {
            openTx: (type) => {
                State.temp = { type, accId: State.db.accounts[0]?.id, catId: null, editId: null };
                
                document.getElementById('tx-title').innerText = type === 'expense' ? '–†–∞—Å—Ö–æ–¥' : '–î–æ—Ö–æ–¥';
                document.getElementById('tx-amt').value = '';
                document.getElementById('tx-note').value = '';
                document.getElementById('tx-del-btn').classList.add('hidden');
                
                // –†–µ–Ω–¥–µ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –∏–∫–æ–Ω–∫–∞–º–∏
                document.getElementById('tx-cats-list').innerHTML = State.db.categories
                    .filter(c => c.type == type)
                    .map(c => 
                        `<div class="icon-box" onclick="State.temp.catId='${c.id}'; Modal.highlight(this)">${c.icon}</div>`
                    ).join('');
                
                Modal.open('sheet-tx');
                Actions.setTxAcc(State.temp.accId);
            },

            editTx: (id) => {
                const t = State.db.transactions.find(x => x.id == id);
                if (!t) return;
                
                Modal.openTx(t.type);
                State.temp.editId = id;
                State.temp.accId = t.accountId;
                State.temp.catId = t.categoryId;
                
                document.getElementById('tx-amt').value = t.amount;
                document.getElementById('tx-note').value = t.comment;
                document.getElementById('tx-del-btn').classList.remove('hidden');
            },

            openAcc: (id = null) => {
                State.temp.editId = id;
                document.getElementById('acc-name').value = '';
                document.getElementById('acc-bal').value = '';
                Actions.setAccType('card');
                
                if (id) {
                    const a = State.db.accounts.find(x => x.id == id);
                    document.getElementById('acc-name').value = a.name;
                    document.getElementById('acc-bal').value = a.balance;
                    Actions.setAccType(a.type);
                    if (a.type == 'invest') document.getElementById('acc-percent').value = a.percent;
                }
                Modal.open('sheet-acc');
            },

            openCat: (id = null) => {
                State.temp.editId = id;
                State.temp.icon = 'üçî';
                document.getElementById('cat-name').value = '';
                Actions.setCatType('expense');
                
                // –°–µ—Ç–∫–∞ –∏–∫–æ–Ω–æ–∫
                const icons = ['üçî','üöï','üè†','üíä','üõçÔ∏è','‚úàÔ∏è','üéÅ','‚öΩ','üí∞','üíº','üìà','üéì','üõí','üíÖ','üê∂'];
                document.getElementById('cat-icons-grid').innerHTML = icons.map(i => 
                    `<div class="icon-box" onclick="State.temp.icon='${i}'; Modal.highlight(this)">${i}</div>`
                ).join('');
                
                if (id) {
                    const c = State.db.categories.find(x => x.id == id);
                    document.getElementById('cat-name').value = c.name;
                    Actions.setCatType(c.type);
                }
                Modal.open('sheet-cat');
            },

            highlight: (el) => {
                el.parentElement.querySelectorAll('.icon-box').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
            },

            open: (id) => {
                document.getElementById('overlay').classList.add('open');
                document.getElementById(id).classList.add('open');
            },
            
            closeAll: () => {
                document.querySelectorAll('.sheet, .overlay').forEach(e => e.classList.remove('open'));
            }
        };

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–∞–±–∞–º
        const Nav = {
            to: (scr, btn) => {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
                document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π
                document.getElementById('view-' + scr).classList.remove('hidden');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                if (btn) btn.classList.add('active');
                
                // –ï—Å–ª–∏ –ø–µ—Ä–µ—à–ª–∏ –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏–ª–∏ –∏–Ω–≤–µ—Å—Ç - –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                if (scr == 'stats' || scr == 'invest' || scr == 'home') Render.all();
            }
        };
        
        const Stats = {
            setMode: (m) => {
                State.temp.statMode = m;
                Render.all();
            }
        };

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        Core.init();

    </script>
</body>
</html>
