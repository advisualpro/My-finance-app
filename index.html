<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyCosts Onyx Enterprise</title>
    
    <!-- === –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –Ø–î–†–ê === -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* ========================================= */
        /* 1. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï (THEME ENGINE)   */
        /* ========================================= */
        :root {
            /* –û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ (Onyx Dark) */
            --bg-root: #000000;
            --bg-layer-1: #1c1c1e; /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
            --bg-layer-2: #2c2c2e; /* –ú–æ–¥–∞–ª–∫–∏, –∏–Ω–ø—É—Ç—ã */
            --bg-layer-3: #3a3a3c; /* –ê–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
            
            /* –¢–µ–∫—Å—Ç */
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --text-tertiary: #48484a;
            
            /* –ë—Ä–µ–Ω–¥–∏–Ω–≥ (Indigo Blue) */
            --brand-primary: #5e5ce6; 
            --brand-glow: rgba(94, 92, 230, 0.25);
            
            /* –§–∏–Ω–∞–Ω—Å—ã */
            --color-income: #30d158; /* Apple Green */
            --color-expense: #ff453a; /* Apple Red */
            --color-warning: #ffd60a;
            
            /* –†–∞–∑–º–µ—Ä—ã */
            --radius-xl: 28px;
            --radius-l: 20px;
            --radius-m: 14px;
            
            /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ========================================= */
        /* 2. –ë–ê–ó–û–í–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê (RESET)              */
        /* ========================================= */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            user-select: none;
        }

        body {
            background-color: var(--bg-root);
            color: var(--text-primary);
            font-family: 'Manrope', -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            padding-bottom: 140px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ –º–µ–Ω—é */
            overflow-x: hidden;
            font-size: 16px;
        }

        .container {
            padding: 16px;
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
        }

        /* ========================================= */
        /* 3. –ö–û–ú–ü–û–ù–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê (UI KIT)         */
        /* ========================================= */

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º —Å—Ç–µ–∫–ª–∞ */
        .card {
            background: var(--bg-layer-1);
            border-radius: var(--radius-l);
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
            transition: transform 0.1s var(--ease-smooth);
        }
        .card:active { transform: scale(0.99); }

        /* –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
        h1 { font-size: 32px; font-weight: 800; letter-spacing: -0.5px; margin: 0; }
        h2 { font-size: 24px; font-weight: 700; margin: 0; }
        h3 { font-size: 18px; font-weight: 700; margin: 0; }
        
        .label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        .balance-huge {
            font-size: 42px;
            font-weight: 800;
            letter-spacing: -1px;
            background: linear-gradient(180deg, #fff, #a1a1aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            width: 100%;
            padding: 18px;
            border-radius: var(--radius-m);
            border: none;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s var(--ease-smooth);
        }
        
        .btn-primary {
            background: var(--brand-primary);
            color: white;
            box-shadow: 0 8px 25px var(--brand-glow);
        }
        .btn-primary:active { transform: scale(0.96); opacity: 0.9; }

        .btn-secondary {
            background: var(--bg-layer-2);
            color: var(--text-primary);
        }
        .btn-secondary:active { background: var(--bg-layer-3); transform: scale(0.96); }

        .btn-icon {
            width: 44px; height: 44px;
            border-radius: 50%;
            background: var(--bg-layer-2);
            color: var(--text-primary);
            border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        .input-money {
            width: 100%;
            background: transparent;
            border: none;
            font-size: 48px;
            font-weight: 800;
            color: var(--text-primary);
            text-align: center;
            padding: 20px 0;
        }
        
        .input-text {
            width: 100%;
            background: var(--bg-layer-2);
            border: 2px solid transparent;
            padding: 16px;
            border-radius: var(--radius-m);
            color: var(--text-primary);
            font-size: 16px;
            margin-bottom: 12px;
            transition: 0.3s;
        }
        .input-text:focus { border-color: var(--brand-primary); background: #000; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º (Time Machine) */
        .month-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-layer-1);
            padding: 8px 12px;
            border-radius: 100px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 24px;
        }
        .month-label { font-weight: 700; font-size: 15px; min-width: 140px; text-align: center; }

        /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é (Dock) */
        .navbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 440px;
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 32px;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .nav-item {
            color: var(--text-secondary);
            font-size: 26px;
            padding: 10px;
            transition: 0.3s;
            position: relative;
        }
        .nav-item.active { color: var(--text-primary); transform: translateY(-4px); }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; border-radius: 50%; background: var(--brand-primary);
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã */
        .progress-track {
            width: 100%; height: 8px;
            background: var(--bg-layer-3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 1s var(--ease-spring); }
        .bg-green { background: var(--color-income); }
        .bg-red { background: var(--color-expense); }
        .bg-brand { background: var(--brand-primary); }

        /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª (–ß–∏–ø—Å—ã) */
        .scroll-row {
            display: flex; gap: 12px; overflow-x: auto;
            padding: 4px 4px 16px 4px;
            margin: 0 -4px;
            scrollbar-width: none;
        }
        .chip {
            min-width: 140px;
            background: var(--bg-layer-2);
            padding: 16px;
            border-radius: var(--radius-m);
            border: 1px solid transparent;
            transition: 0.2s;
            flex-shrink: 0;
        }
        .chip.active { border-color: var(--brand-primary); background: rgba(94, 92, 230, 0.1); }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (Bottom Sheets) */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
            opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        
        .sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-layer-1);
            border-radius: 32px 32px 0 0;
            padding: 24px; padding-bottom: 40px;
            transform: translateY(100%);
            transition: transform 0.4s var(--ease-spring);
            z-index: 2001;
            max-height: 90vh;
            overflow-y: auto;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .sheet.open { transform: translateY(0); }

        /* –£—Ç–∏–ª–∏—Ç—ã */
        .hidden { display: none !important; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-icons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .icon-select { 
            aspect-ratio: 1; background: var(--bg-layer-2); border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            border: 2px solid transparent;
        }
        .icon-select.selected { border-color: var(--brand-primary); background: rgba(94, 92, 230, 0.1); }

        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        #splash { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loader-ring { width: 50px; height: 50px; border: 4px solid #333; border-top-color: var(--brand-primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- 0. –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò -->
    <div id="splash">
        <div class="loader-ring"></div>
    </div>

    <!-- 1. –û–ù–ë–û–†–î–ò–ù–ì (–î–õ–Ø –ù–û–í–´–•) -->
    <div id="view-onboarding" class="container hidden" style="text-align: center; padding-top: 80px;">
        <div style="font-size: 80px; margin-bottom: 20px;">üíé</div>
        <h1>MyCosts Onyx</h1>
        <p style="color: var(--text-secondary); margin-bottom: 40px;">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —É—á–µ—Ç –ø—Ä–µ–º–∏—É–º –∫–ª–∞—Å—Å–∞.<br>–ù–∞—á–Ω–µ–º?</p>
        
        <div class="card" style="text-align: left;">
            <span class="label">–¢–í–û–ï –ò–ú–Ø</span>
            <input type="text" id="setup-name" class="input-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
            
            <span class="label">–ë–Æ–î–ñ–ï–¢ –ù–ê –ú–ï–°–Ø–¶ (‚ÇΩ)</span>
            <input type="number" id="setup-limit" class="input-text" placeholder="100 000">
        </div>
        
        <button class="btn btn-primary" onclick="App.finishOnboarding()">
            –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        </button>
    </div>

    <!-- 2. –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
    <div id="view-app" class="container hidden">
        
        <!-- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ -->
        <div class="flex-between" style="margin-bottom: 24px;">
            <div style="display: flex; gap: 8px; align-items: center;">
                <div id="sync-indicator" style="width: 8px; height: 8px; background: #333; border-radius: 50%;"></div>
                <span class="label" style="margin:0" id="user-name-display">User</span>
            </div>
            <button class="icon-btn" onclick="App.forceSync()"><i class="ri-refresh-line"></i></button>
        </div>

        <!-- >>> –≠–ö–†–ê–ù: –ì–õ–ê–í–ù–ê–Ø (HOME) <<< -->
        <div id="tab-home">
            
            <!-- –ú–ê–®–ò–ù–ê –í–†–ï–ú–ï–ù–ò -->
            <div class="month-selector">
                <button class="icon-btn" style="width:32px; height:32px; background:transparent" onclick="TimeMachine.prev()">
                    <i class="ri-arrow-left-s-line"></i>
                </button>
                <div class="month-label" id="month-display">–û–∫—Ç—è–±—Ä—å 2025</div>
                <button class="icon-btn" style="width:32px; height:32px; background:transparent" onclick="TimeMachine.next()">
                    <i class="ri-arrow-right-s-line"></i>
                </button>
            </div>

            <!-- –ì–õ–ê–í–ù–´–ô –ë–ê–õ–ê–ù–° -->
            <div class="card" style="text-align: center; padding: 40px 20px;">
                <span class="label">–û–ë–©–ò–ô –ö–ê–ü–ò–¢–ê–õ</span>
                <div class="balance-huge" id="total-capital">0 ‚ÇΩ</div>
                
                <div class="grid-2" style="margin-top: 30px;">
                    <button class="btn btn-secondary" style="color: var(--color-expense); background: rgba(255, 69, 58, 0.1);" onclick="Modal.openTx('expense')">
                        <i class="ri-arrow-down-circle-fill"></i> –†–∞—Å—Ö–æ–¥
                    </button>
                    <button class="btn btn-secondary" style="color: var(--color-income); background: rgba(48, 209, 88, 0.1);" onclick="Modal.openTx('income')">
                        <i class="ri-arrow-up-circle-fill"></i> –î–æ—Ö–æ–¥
                    </button>
                </div>
            </div>

            <!-- CASHFLOW & FREEDOM -->
            <div class="card">
                <div class="flex-between">
                    <span class="label" style="margin:0">–§–ò–ù–ê–ù–°–û–í–ê–Ø –°–í–û–ë–û–î–ê</span>
                    <span style="font-weight: 800; font-size: 18px;" id="freedom-rate">0%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill bg-green" id="freedom-bar" style="width: 0%"></div>
                </div>
                
                <div class="flex-between" style="margin-top: 15px;">
                    <div>
                        <span class="label">–ü–ê–°–°–ò–í–ù–´–ô (–ú–ï–°)</span>
                        <div style="color: var(--color-income); font-weight: 700;" id="val-passive">0 ‚ÇΩ</div>
                    </div>
                    <div style="text-align: right;">
                        <span class="label">–†–ê–°–•–û–î–´ (–ú–ï–°)</span>
                        <div style="color: var(--color-expense); font-weight: 700;" id="val-expense">0 ‚ÇΩ</div>
                    </div>
                </div>
            </div>

            <!-- –ë–Æ–î–ñ–ï–¢ -->
            <div class="card">
                <div class="flex-between">
                    <span class="label" style="margin:0">–ë–Æ–î–ñ–ï–¢</span>
                    <span style="font-weight: 700;" id="budget-left">0 ‚ÇΩ</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill bg-red" id="budget-bar" style="width: 0%"></div>
                </div>
            </div>

            <!-- –°–ß–ï–¢–ê (–ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–û) -->
            <div class="flex-between" style="margin-bottom: 12px;">
                <h3>–°—á–µ—Ç–∞</h3>
                <span class="label" style="color: var(--brand-primary); cursor: pointer;" onclick="Nav.to('wallet')">–í–°–ï</span>
            </div>
            <div class="scroll-row" id="list-accs-home"></div>

            <!-- –ò–°–¢–û–†–ò–Ø -->
            <div class="flex-between" style="margin-top: 24px; margin-bottom: 12px;">
                <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
                <span class="label" style="color: var(--brand-primary); cursor: pointer;" onclick="Nav.to('stats')">–ê–ù–ê–õ–ò–ó</span>
            </div>
            <div id="list-tx-home"></div>
        </div>

        <!-- >>> –≠–ö–†–ê–ù: –ò–ù–í–ï–°–¢–ò–¶–ò–ò <<< -->
        <div id="tab-invest" class="hidden">
            <h2>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h2>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">–†–æ—Å—Ç –∫–∞–ø–∏—Ç–∞–ª–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏</p>
            
            <div class="card">
                <div class="flex-between">
                    <span class="label">–ü–†–û–ì–ù–û–ó (1 –ì–û–î)</span>
                    <span style="color: var(--success); font-weight: 700;" id="invest-forecast">+0 ‚ÇΩ</span>
                </div>
                <div style="height: 220px; margin-top: 20px;">
                    <canvas id="chart-invest"></canvas>
                </div>
            </div>
            
            <h3>–ü–æ—Ä—Ç—Ñ–µ–ª—å</h3>
            <div id="list-invest" style="margin-top: 12px;"></div>
        </div>

        <!-- >>> –≠–ö–†–ê–ù: –ê–ù–ê–õ–ò–¢–ò–ö–ê <<< -->
        <div id="tab-stats" class="hidden">
            <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            <br>
            <!-- –§–∏–ª—å—Ç—Ä -->
            <div style="background: var(--bg-layer-2); padding: 4px; border-radius: 12px; display: flex; margin-bottom: 20px;">
                <button class="btn btn-secondary" style="flex:1; padding: 10px;" id="stats-exp-btn" onclick="Stats.setMode('expense')">–†–∞—Å—Ö–æ–¥—ã</button>
                <button class="btn btn-secondary" style="flex:1; padding: 10px; background: transparent;" id="stats-inc-btn" onclick="Stats.setMode('income')">–î–æ—Ö–æ–¥—ã</button>
            </div>
            
            <div class="card">
                <div style="height: 260px; position: relative;">
                    <canvas id="chart-pie"></canvas>
                </div>
            </div>
            
            <div id="list-stats"></div>
        </div>

        <!-- >>> –≠–ö–†–ê–ù: –ö–û–®–ï–õ–ï–ö <<< -->
        <div id="tab-wallet" class="hidden">
            <h2>–ö–æ—à–µ–ª–µ–∫</h2>
            <br>
            
            <div class="card">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h3>–°—á–µ—Ç–∞</h3>
                    <button class="icon-btn" onclick="Modal.openAcc()"><i class="ri-add-line"></i></button>
                </div>
                <div id="list-acc-manage"></div>
            </div>

            <div class="card">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                    <button class="icon-btn" onclick="Modal.openCat()"><i class="ri-add-line"></i></button>
                </div>
                <div id="list-cat-manage"></div>
            </div>
            
            <button class="btn btn-secondary" style="margin-top: 30px; color: var(--danger);" onclick="App.reset()">
                <i class="ri-delete-bin-line"></i> –°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö
            </button>
        </div>

    </div>

    <!-- –ú–ï–ù–Æ -->
    <div class="navbar">
        <i class="ri-home-5-fill nav-item active" onclick="Nav.to('home', this)"></i>
        <i class="ri-line-chart-fill nav-item" onclick="Nav.to('invest', this)"></i>
        <i class="ri-pie-chart-2-fill nav-item" onclick="Nav.to('stats', this)"></i>
        <i class="ri-wallet-3-fill nav-item" onclick="Nav.to('wallet', this)"></i>
    </div>

    <!-- === –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê === -->
    <div class="modal-overlay" id="overlay" onclick="Modal.closeAll()"></div>

    <!-- TX SHEET -->
    <div class="sheet" id="sheet-tx">
        <div class="sheet-handle"></div>
        <div class="flex-between">
            <h2 id="tx-title">–†–∞—Å—Ö–æ–¥</h2>
            <div class="icon-btn" onclick="Modal.closeAll()"><i class="ri-close-line"></i></div>
        </div>
        
        <input type="text" id="tx-amount" class="input-money" placeholder="0" inputmode="decimal">
        
        <span class="label">–°–ß–ï–¢</span>
        <div class="scroll-row" id="tx-accs-list" style="margin-bottom: 20px;"></div>
        
        <span class="label">–ö–ê–¢–ï–ì–û–†–ò–Ø</span>
        <div class="grid-icons" id="tx-cats-list" style="margin-bottom: 20px;"></div>
        
        <input type="text" id="tx-note" class="input-text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
        
        <div class="grid-2">
            <button class="btn btn-primary" onclick="Actions.saveTx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary hidden" id="tx-del-btn" style="color:var(--danger)" onclick="Actions.deleteTx()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>

    <!-- ACC SHEET -->
    <div class="sheet" id="sheet-acc">
        <div class="sheet-handle"></div>
        <div class="flex-between"><h2>–°—á–µ—Ç</h2> <div class="icon-btn" onclick="Modal.closeAll()"><i class="ri-close-line"></i></div></div><br>
        
        <input type="text" id="acc-name" class="input-text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        
        <div style="display:flex; gap:10px; margin-bottom:16px;">
            <button class="btn btn-secondary" id="type-card" onclick="Actions.setAccType('card')">–ö–∞—Ä—Ç–∞</button>
            <button class="btn btn-secondary" id="type-invest" onclick="Actions.setAccType('invest')">–ò–Ω–≤–µ—Å—Ç</button>
        </div>
        
        <div id="acc-invest-block" class="hidden">
            <span class="label">% –ì–û–î–û–í–´–•</span>
            <input type="number" id="acc-percent" class="input-text" placeholder="15">
        </div>
        
        <span class="label">–ë–ê–õ–ê–ù–°</span>
        <input type="number" id="acc-bal" class="input-text" placeholder="0">
        
        <div class="grid-2">
            <button class="btn btn-primary" onclick="Actions.saveAcc()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" style="color:var(--danger)" onclick="Actions.delAcc()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>

    <!-- CAT SHEET -->
    <div class="sheet" id="sheet-cat">
        <div class="sheet-handle"></div>
        <div class="flex-between"><h2>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2> <div class="icon-btn" onclick="Modal.closeAll()"><i class="ri-close-line"></i></div></div><br>
        
        <input type="text" id="cat-name" class="input-text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        
        <div style="display:flex; gap:10px; margin-bottom:16px;">
            <button class="btn btn-secondary" id="cat-type-exp" onclick="Actions.setCatType('expense')">–†–∞—Å—Ö–æ–¥</button>
            <button class="btn btn-secondary" id="cat-type-inc" onclick="Actions.setCatType('income')">–î–æ—Ö–æ–¥</button>
        </div>
        
        <span class="label">–ò–ö–û–ù–ö–ê</span>
        <div class="grid-icons" id="cat-icons-grid" style="margin-bottom: 20px;"></div>
        
        <div class="grid-2">
            <button class="btn btn-primary" onclick="Actions.saveCat()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" style="color:var(--danger)" onclick="Actions.delCat()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
    <script>
        /**
         * ==========================================
         * MYCOSTS ONYX v13 - ENTERPRISE CORE
         * ==========================================
         */

        // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        // ------------------------------------------
        // !!! –°–Æ–î–ê –í–°–¢–ê–í–¨ –°–°–´–õ–ö–£ !!!
        const API_URL = 'https://script.google.com/macros/s/AKfycby_ES9U2-4VYmPhMLbDtNNv_ESnbUEI9nlw0euEHsxZ6eJqu340_LpF_A1pSxyUvRxG/exec';

        // 2. –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï (STATE)
        // ------------------------------------------
        const State = {
            db: { user: {name:'', limit:100000}, accounts:[], categories:[], transactions:[] },
            userId: null,
            currentDate: new Date(), // –ú–∞—à–∏–Ω–∞ –≤—Ä–µ–º–µ–Ω–∏
            temp: { editId: null, type: 'expense', acc: null, cat: null, icon: null } // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ä–º
        };

        const tg = window.Telegram.WebApp;
        tg.expand();

        // 3. –Ø–î–†–û –ó–ê–ü–£–°–ö–ê (BOOTSTRAP)
        // ------------------------------------------
        const App = {
            init: async () => {
                // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                let uid = localStorage.getItem('onyx_uid');
                if(!uid) {
                    uid = tg.initDataUnsafe?.user?.id ? 'tg_'+tg.initDataUnsafe.user.id : 'web_'+Date.now();
                    localStorage.setItem('onyx_uid', uid);
                }
                State.userId = uid;

                // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const local = localStorage.getItem('onyx_db');
                let hasData = false;
                if(local) {
                    try {
                        State.db = JSON.parse(local);
                        hasData = State.db.accounts.length > 0;
                    } catch(e) { console.error(e); }
                }

                // UI –°—Ç–∞—Ä—Ç
                setTimeout(() => {
                    document.getElementById('splash').style.opacity = 0;
                    setTimeout(() => document.getElementById('splash').style.display = 'none', 500);
                    
                    if(hasData) {
                        document.getElementById('screen-app').classList.remove('hidden');
                        Render.all();
                        Sync.pull(); // –§–æ–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
                    } else {
                        document.getElementById('view-onboarding').classList.remove('hidden');
                    }
                }, 800);
            },

            finishOnboarding: () => {
                State.db.user.name = document.getElementById('setup-name').value || 'User';
                State.db.user.limit = parseFloat(document.getElementById('setup-limit').value) || 100000;
                
                // –°—Ç–∞—Ä—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                State.db.accounts = [{id:'a1', name:'–ö–∞—Ä—Ç–∞', type:'card', balance:0, percent:0}];
                State.db.categories = [
                    {id:'c1', name:'–ï–¥–∞', icon:'üçî', type:'expense'},
                    {id:'c2', name:'–î–æ–º', icon:'üè†', type:'expense'},
                    {id:'c3', name:'–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', icon:'üöï', type:'expense'},
                    {id:'c4', name:'–ó–∞—Ä–ø–ª–∞—Ç–∞', icon:'üí∞', type:'income'}
                ];
                
                App.save();
                document.getElementById('view-onboarding').classList.add('hidden');
                document.getElementById('screen-app').classList.remove('hidden');
                Sync.push(true); // –§–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
            },

            save: () => {
                localStorage.setItem('onyx_db', JSON.stringify(State.db));
                Render.all();
            },

            reset: () => {
                if(confirm('–°—Ç–µ—Ä–µ—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) {
                    localStorage.removeItem('onyx_db');
                    location.reload();
                }
            },
            
            forceSync: async () => {
                if(confirm('–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞?')) await Sync.push(true);
            }
        };

        // 4. –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (SYNC ENGINE)
        // ------------------------------------------
        const Sync = {
            setStatus: (color) => {
                const dot = document.getElementById('sync-indicator');
                dot.style.background = color === 'green' ? '#30d158' : (color === 'red' ? '#ff453a' : '#ffd60a');
                dot.style.boxShadow = color === 'green' ? '0 0 8px #30d158' : 'none';
            },

            pull: async () => {
                Sync.setStatus('yellow');
                try {
                    const res = await fetch(`${API_URL}?action=load&user_id=${State.userId}&t=${Date.now()}`);
                    const json = await res.json();
                    
                    if(json.status === 'success' && json.data.accounts.length > 0) {
                        State.db.accounts = json.data.accounts;
                        State.db.categories = json.data.categories;
                        State.db.transactions = json.data.transactions;
                        if(json.data.user) State.db.user = json.data.user;
                        
                        Logic.calcInterest(); // –ü—Ä–æ—Ü–µ–Ω—Ç—ã
                        App.save();
                        Sync.setStatus('green');
                    } else {
                        Sync.setStatus('green'); // –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –Ω–æ —ç—Ç–æ –Ω–æ—Ä–º
                    }
                } catch(e) {
                    Sync.setStatus('red');
                }
            },

            push: async (force = false) => {
                if(!force) Sync.setStatus('yellow');
                try {
                    await fetch(API_URL + '?action=sync_all', {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({
                            user_id: State.userId,
                            accounts: State.db.accounts,
                            categories: State.db.categories,
                            transactions: State.db.transactions,
                            user: State.db.user
                        })
                    });
                    if(!force) Sync.setStatus('green');
                } catch(e) {
                    Sync.setStatus('red');
                }
            }
        };

        // 5. –ë–ò–ó–ù–ï–° –õ–û–ì–ò–ö–ê (TIME & MATH)
        // ------------------------------------------
        const TimeMachine = {
            next: () => {
                State.currentDate.setMonth(State.currentDate.getMonth() + 1);
                Render.all();
            },
            prev: () => {
                State.currentDate.setMonth(State.currentDate.getMonth() - 1);
                Render.all();
            },
            getKey: () => State.currentDate.toISOString().slice(0, 7), // "2023-10"
            getString: () => {
                const m = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
                return `${m[State.currentDate.getMonth()]} ${State.currentDate.getFullYear()}`;
            }
        };

        const Logic = {
            calcInterest: () => {
                let changed = false;
                const now = Date.now();
                State.db.accounts.forEach(acc => {
                    if(acc.type === 'invest' && acc.percent > 0) {
                        const last = acc.lastCalc || now;
                        const days = (now - last) / 86400000;
                        if(days >= 1) {
                            const profit = parseFloat(acc.balance) * (parseFloat(acc.percent)/100/365) * days;
                            if(profit > 0.1) {
                                State.db.transactions.push({
                                    id: 'sys_'+Date.now(), date: new Date().toISOString(),
                                    amount: profit, type: 'income', accountId: acc.id, categoryId: 'sys',
                                    comment: '% –î–æ—Ö–æ–¥', isWaste: false
                                });
                                acc.lastCalc = now; changed = true;
                            }
                        }
                    }
                });
                if(changed) App.save();
            }
        };

        // 6. –û–¢–†–ò–°–û–í–ö–ê (RENDER)
        // ------------------------------------------
        const Render = {
            all: () => {
                document.getElementById('user-name-display').innerText = State.db.user.name;
                document.getElementById('month-display').innerText = TimeMachine.getString();
                
                const monthKey = TimeMachine.getKey();
                
                // 1. –°—á–∏—Ç–∞–µ–º –ë–∞–ª–∞–Ω—Å—ã (–ì–ª–æ–±–∞–ª—å–Ω–æ)
                const bals = {};
                State.db.accounts.forEach(a => bals[a.id] = parseFloat(a.balance));
                
                State.db.transactions.forEach(t => {
                    if(bals[t.accountId] !== undefined) {
                        t.type === 'income' ? bals[t.accountId] += parseFloat(t.amount) : bals[t.accountId] -= parseFloat(t.amount);
                    }
                });

                // 2. –°—á–∏—Ç–∞–µ–º –ú–µ—Å—è—á–Ω—É—é –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                let expM = 0, passM = 0;
                State.db.transactions.filter(t => t.date.startsWith(monthKey)).forEach(t => {
                    if(t.type === 'expense') expM += parseFloat(t.amount);
                });

                // –ü–∞—Å—Å–∏–≤–Ω—ã–π (–ø—Ä–æ–≥–Ω–æ–∑)
                State.db.accounts.filter(a => a.type === 'invest').forEach(a => {
                    passM += (bals[a.id] * (parseFloat(a.percent)/100)) / 12;
                });

                // 3. –û–±–Ω–æ–≤–ª—è–µ–º –ì–ª–∞–≤–Ω—ã–π –≠–∫—Ä–∞–Ω
                const totalCap = Object.values(bals).reduce((a,b)=>a+b,0);
                document.getElementById('total-capital').innerText = Math.floor(totalCap).toLocaleString() + ' ‚ÇΩ';
                
                // Cashflow Bar
                const ff = expM > 0 ? (passM / expM * 100) : 0;
                document.getElementById('freedom-rate').innerText = ff.toFixed(1) + '%';
                document.getElementById('cf-bar').style.width = Math.min(100, ff) + '%';
                document.getElementById('val-passive').innerText = '+' + Math.floor(passM).toLocaleString();
                document.getElementById('val-expense').innerText = '-' + Math.floor(expM).toLocaleString();

                // Budget Bar
                const limit = State.db.user.limit;
                const budPct = Math.min(100, (expM / limit * 100));
                document.getElementById('budget-bar').style.width = budPct + '%';
                document.getElementById('budget-left').innerText = (limit - expM).toLocaleString() + ' ‚ÇΩ';

                // –°–ø–∏—Å–∫–∏
                Render.accounts(bals);
                Render.history(monthKey);
                Render.invest(bals);
                Render.charts(monthKey);
                Render.manageLists(bals);
            },

            accounts: (bals) => {
                const html = State.db.accounts.map(a => `
                    <div class="chip ${State.temp.acc==a.id?'active':''}" onclick="Actions.setTxAcc('${a.id}', this)">
                        <div class="text-sm" style="margin-bottom:4px;">${a.name}</div>
                        <div style="font-weight:700; font-size:16px;">${Math.floor(bals[a.id]).toLocaleString()}</div>
                    </div>
                `).join('');
                document.getElementById('list-accs-home').innerHTML = html;
                document.getElementById('tx-accs-list').innerHTML = html;
            },

            history: (monthKey) => {
                const txs = State.db.transactions.filter(t => t.date.startsWith(monthKey))
                    .sort((a,b) => new Date(b.date) - new Date(a.date));
                
                document.getElementById('list-tx-home').innerHTML = txs.map(t => {
                    const c = State.db.categories.find(x=>x.id==t.categoryId) || {name:'?', icon:'üîπ'};
                    return `
                    <div class="card flex-between" onclick="Modal.editTx('${t.id}')" style="padding:16px; margin-bottom:10px; cursor:pointer;">
                        <div style="display:flex; gap:12px; align-items:center;">
                            <span style="font-size:24px">${c.icon}</span>
                            <div>
                                <div style="font-weight:600">${c.name}</div>
                                <div class="text-sm">${t.comment || new Date(t.date).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div style="font-weight:700; font-size:16px; color:${t.type=='expense'?'var(--danger)':'var(--success)'}">
                            ${t.type=='expense'?'-':'+'}${Math.floor(t.amount)}
                        </div>
                    </div>`;
                }).join('');
            },

            invest: (bals) => {
                const inv = State.db.accounts.filter(a => a.type === 'invest');
                const total = inv.reduce((s,a)=>s+bals[a.id], 0);
                const projected = total * 1.15;
                
                document.getElementById('invest-forecast').innerText = `+${Math.floor(projected-total).toLocaleString()} ‚ÇΩ`;
                document.getElementById('list-invest').innerHTML = inv.map(a => `
                    <div class="card flex-between">
                        <div><b>${a.name}</b><br><span style="color:var(--success); font-size:12px;">${a.percent}% –≥–æ–¥.</span></div>
                        <b>${Math.floor(bals[a.id]).toLocaleString()}</b>
                    </div>
                `).join('');
                
                // Simple Chart for Invest
                if(window.invChart) window.invChart.destroy();
                window.invChart = new Chart(document.getElementById('chart-invest'), {
                    type: 'line',
                    data: {
                        labels: ['Q1','Q2','Q3','Q4'],
                        datasets: [{ data: [total, total*1.04, total*1.08, projected], borderColor: '#30d158', backgroundColor:'rgba(48,209,88,0.1)', fill:true, tension:0.4 }]
                    },
                    options: { plugins: { legend: { display:false } }, scales: { x:{display:false}, y:{display:false} }, maintainAspectRatio:false }
                });
            },

            charts: (monthKey) => {
                const ctx = document.getElementById('chart-pie');
                const txs = State.db.transactions.filter(t => t.date.startsWith(monthKey) && t.type === (State.temp.statMode || 'expense'));
                const cats = {};
                txs.forEach(t => cats[t.categoryId] = (cats[t.categoryId]||0) + parseFloat(t.amount));
                
                if(window.pieChart) window.pieChart.destroy();
                window.pieChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(cats).map(id=>State.db.categories.find(c=>c.id==id)?.name),
                        datasets: [{ data: Object.values(cats), backgroundColor: ['#0a84ff','#30d158','#ffd60a','#ff453a','#bf5af2'], borderWidth:0 }]
                    },
                    options: { plugins: { legend: { position:'right', labels:{color:'#fff'} } }, maintainAspectRatio:false }
                });
                
                document.getElementById('list-stats').innerHTML = Object.entries(cats).sort((a,b)=>b[1]-a[1]).map(([id,v])=>{
                    const c = State.db.categories.find(x=>x.id==id)||{name:'?',icon:''};
                    return `<div class="flex-between" style="padding:12px 0; border-bottom:1px solid #333">
                        <div style="display:flex; gap:10px; align-items:center;">${c.icon} ${c.name}</div>
                        <b>${Math.floor(v).toLocaleString()}</b>
                    </div>`
                }).join('');
            },

            manageLists: (bals) => {
                document.getElementById('list-acc-manage').innerHTML = State.db.accounts.map(a => `
                    <div class="flex-between" style="padding:12px 0; border-bottom:1px solid #333; cursor:pointer;" onclick="Modal.openAcc('${a.id}')">
                        <b>${a.name}</b> <span>${Math.floor(bals[a.id])}</span>
                    </div>`).join('');
                document.getElementById('list-cat-manage').innerHTML = State.db.categories.map(c => `
                    <div class="flex-between" style="padding:12px 0; border-bottom:1px solid #333; cursor:pointer;" onclick="Modal.openCat('${c.id}')">
                        <div>${c.icon} ${c.name}</div>
                    </div>`).join('');
            }
        };

        // 7. –î–ï–ô–°–¢–í–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (ACTIONS)
        // ------------------------------------------
        const Actions = {
            setTxAcc: (id, el) => {
                State.temp.acc = id;
                document.querySelectorAll('#tx-accs-list .chip').forEach(c => c.classList.remove('active'));
                if(el) el.classList.add('active');
                else Render.all(); // Re-render if called without element
            },

            saveTx: () => {
                const amt = parseFloat(document.getElementById('tx-amount').value);
                if(!amt || !State.temp.acc || !State.temp.cat) return tg.HapticFeedback.notificationOccurred('error');
                
                const tx = {
                    id: State.temp.editId || 'tx_'+Date.now(),
                    date: State.temp.editId ? State.db.transactions.find(t=>t.id==State.temp.editId).date : new Date().toISOString(),
                    amount: amt,
                    type: State.temp.type,
                    accountId: State.temp.acc,
                    categoryId: State.temp.cat,
                    comment: document.getElementById('tx-note').value,
                    isWaste: false
                };

                if(State.temp.editId) {
                    const idx = State.db.transactions.findIndex(t=>t.id==State.temp.editId);
                    State.db.transactions[idx] = tx;
                } else {
                    State.db.transactions.push(tx);
                }
                
                App.save();
                Modal.closeAll();
                Sync.push(true);
            },

            deleteTx: () => {
                if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                    State.db.transactions = State.db.transactions.filter(t => t.id !== State.temp.editId);
                    App.save();
                    Modal.closeAll();
                    Sync.push(true);
                }
            },

            setAccType: (t) => {
                State.temp.type = t;
                document.getElementById('type-card').className = t=='card'?'btn btn-primary':'btn btn-secondary';
                document.getElementById('type-invest').className = t=='invest'?'btn btn-primary':'btn btn-secondary';
                document.getElementById('acc-invest-block').classList.toggle('hidden', t!=='invest');
            },

            saveAcc: () => {
                const name = document.getElementById('acc-name').value;
                if(!name) return;
                const d = {
                    id: State.temp.editId || 'acc_'+Date.now(),
                    name, type: State.temp.type,
                    balance: parseFloat(document.getElementById('acc-bal').value)||0,
                    percent: parseFloat(document.getElementById('acc-percent').value)||0
                };
                if(State.temp.editId) {
                    const i = State.db.accounts.findIndex(x=>x.id==State.temp.editId);
                    State.db.accounts[i] = d;
                } else State.db.accounts.push(d);
                App.save(); Modal.closeAll(); Sync.push(true);
            },
            
            delAcc: () => { if(State.temp.editId && confirm('–£–¥–∞–ª–∏—Ç—å?')) { State.db.accounts = State.db.accounts.filter(x=>x.id!==State.temp.editId); App.save(); Modal.closeAll(); Sync.push(true); } },

            setCatType: (t) => {
                State.temp.type = t;
                document.getElementById('cat-type-exp').className = t=='expense'?'btn btn-primary':'btn btn-secondary';
                document.getElementById('cat-type-inc').className = t=='income'?'btn btn-primary':'btn btn-secondary';
            },

            saveCat: () => {
                const name = document.getElementById('cat-name').value;
                if(!name) return;
                const d = {
                    id: State.temp.editId || 'cat_'+Date.now(),
                    name, type: State.temp.type,
                    icon: State.temp.icon || 'üîπ'
                };
                if(State.temp.editId) {
                    const i = State.db.categories.findIndex(x=>x.id==State.temp.editId);
                    State.db.categories[i] = d;
                } else State.db.categories.push(d);
                App.save(); Modal.closeAll(); Sync.push(true);
            },
            
            delCat: () => { if(State.temp.editId && confirm('–£–¥–∞–ª–∏—Ç—å?')) { State.db.categories = State.db.categories.filter(x=>x.id!==State.temp.editId); App.save(); Modal.closeAll(); Sync.push(true); } }
        };

        // 8. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–û–î–ê–õ–ö–ê–ú–ò
        // ------------------------------------------
        const Modal = {
            openTx: (type) => {
                State.temp = { type, acc: State.db.accounts[0]?.id, cat: null, editId: null };
                document.getElementById('tx-title').innerText = type==='expense'?'–†–∞—Å—Ö–æ–¥':'–î–æ—Ö–æ–¥';
                document.getElementById('tx-amt').value = '';
                document.getElementById('tx-note').value = '';
                document.getElementById('tx-del-btn').classList.add('hidden');
                
                // –†–µ–Ω–¥–µ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                document.getElementById('tx-cats-list').innerHTML = State.db.categories.filter(c=>c.type==type).map(c => 
                    `<div class="icon-select" onclick="State.temp.cat='${c.id}'; Modal.highlight(this)">${c.icon}</div>`
                ).join('');
                
                Modal.open('sheet-tx');
                Actions.setTxAcc(State.temp.acc);
            },

            editTx: (id) => {
                const t = State.db.transactions.find(x=>x.id==id);
                if(!t) return;
                Modal.openTx(t.type);
                State.temp.editId = id; State.temp.acc = t.accountId; State.temp.cat = t.categoryId;
                document.getElementById('tx-amt').value = t.amount;
                document.getElementById('tx-note').value = t.comment;
                document.getElementById('tx-del-btn').classList.remove('hidden');
            },

            openAcc: (id=null) => {
                State.temp.editId = id;
                document.getElementById('acc-name').value = '';
                document.getElementById('acc-bal').value = '';
                Actions.setAccType('card');
                if(id) {
                    const a = State.db.accounts.find(x=>x.id==id);
                    document.getElementById('acc-name').value = a.name;
                    document.getElementById('acc-bal').value = a.balance; // Only editing start balance here for simplicity
                    Actions.setAccType(a.type);
                    if(a.type=='invest') document.getElementById('acc-percent').value = a.percent;
                }
                Modal.open('sheet-acc');
            },

            openCat: (id=null) => {
                State.temp.editId = id; State.temp.icon = 'üçî';
                document.getElementById('cat-name').value = '';
                Actions.setCatType('expense');
                
                const icons = ['üçî','üöï','üè†','üíä','üõçÔ∏è','‚úàÔ∏è','üéÅ','‚öΩ','üí∞','üíº','üìà','üéì','üõí','üíÖ','üê∂'];
                document.getElementById('cat-icons-grid').innerHTML = icons.map(i => 
                    `<div class="icon-select" onclick="State.temp.icon='${i}'; Modal.highlight(this)">${i}</div>`
                ).join('');
                
                if(id) {
                    const c = State.db.categories.find(x=>x.id==id);
                    document.getElementById('cat-name').value = c.name;
                    Actions.setCatType(c.type);
                }
                Modal.open('sheet-cat');
            },

            highlight: (el) => {
                el.parentElement.querySelectorAll('.icon-select').forEach(e=>e.classList.remove('selected'));
                el.classList.add('selected');
            },

            open: (id) => { document.getElementById('overlay').classList.add('open'); document.getElementById(id).classList.add('open'); tg.HapticFeedback.impactOccurred('light'); },
            closeAll: () => { document.querySelectorAll('.sheet, .overlay').forEach(e=>e.classList.remove('open')); }
        };

        const Nav = {
            to: (scr, btn) => {
                document.querySelectorAll('[id^="view-"]').forEach(v=>v.classList.add('hidden'));
                document.getElementById('view-'+scr).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
                if(btn) btn.classList.add('active');
                if(scr=='stats' || scr=='invest' || scr=='home') Render.all();
                tg.HapticFeedback.selectionChanged();
            }
        };
        
        const Stats = {
            setMode: (m) => { State.temp.statMode = m; Render.charts(TimeMachine.getKey()); } // Simplified trigger
        };

        // –ó–ê–ü–£–°–ö
        App.init();

    </script>
</body>
</html>
