<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>MyCosts Titanium</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
--bg:#0A0A0F;--bg2:#12121A;
--card:rgba(255,255,255,0.04);--card-border:rgba(255,255,255,0.06);--card-hover:rgba(255,255,255,0.07);
--text:#F8FAFC;--text2:#94A3B8;--text3:#475569;
--accent:#8B5CF6;--accent2:#6366F1;--orange:#F97316;--green:#10B981;--red:#EF4444;
--glass:rgba(255,255,255,0.05);--glass-border:rgba(255,255,255,0.08);
--blur:blur(20px);
--radius-xl:24px;--radius-l:20px;--radius-m:16px;--radius-s:12px;--radius-pill:100px;
--shadow:0 4px 24px rgba(0,0,0,0.3);
--gradient:linear-gradient(135deg,#8B5CF6,#6366F1);
--gradient-card:linear-gradient(135deg,rgba(139,92,246,0.1),rgba(99,102,241,0.05));
--font:'Inter',-apple-system,sans-serif;
--nav-h:68px;
--safe-top:env(safe-area-inset-top,0px);
--safe-bot:env(safe-area-inset-bottom,0px);
}
.light{
--bg:#F8FAFC;--bg2:#F1F5F9;
--card:rgba(255,255,255,0.8);--card-border:rgba(0,0,0,0.06);--card-hover:rgba(255,255,255,0.95);
--text:#0F172A;--text2:#64748B;--text3:#94A3B8;
--glass:rgba(255,255,255,0.7);--glass-border:rgba(0,0,0,0.08);
--shadow:0 4px 24px rgba(0,0,0,0.08);
--gradient-card:linear-gradient(135deg,rgba(139,92,246,0.08),rgba(99,102,241,0.03));
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;transition:background .3s,color .3s}
.app{max-width:480px;margin:0 auto;padding-top:var(--safe-top);padding-bottom:calc(var(--nav-h)+var(--safe-bot)+20px);min-height:100vh;position:relative}
.glow-bg{position:fixed;top:-120px;left:50%;transform:translateX(-50%);width:400px;height:400px;background:radial-gradient(circle,rgba(139,92,246,0.12) 0%,transparent 70%);pointer-events:none;z-index:0}
.light .glow-bg{opacity:.4}
.screen{display:none;padding:16px;position:relative;z-index:1}
.screen.active{display:block;animation:fadeUp .3s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* === ONBOARDING === */
.onb-wrap{min-height:100vh;display:flex;flex-direction:column;padding:24px 20px calc(24px + var(--safe-bot));position:relative;z-index:1}
.onb-progress{display:flex;gap:6px;margin-bottom:32px;padding-top:8px}
.onb-dot{flex:1;height:3px;border-radius:2px;background:var(--card-border);transition:background .3s}
.onb-dot.done{background:var(--accent)}
.onb-dot.active{background:var(--gradient)}
.onb-step{display:none;flex:1;flex-direction:column}
.onb-step.active{display:flex;animation:fadeUp .35s ease}
.onb-emoji{font-size:48px;margin-bottom:16px}
.onb-h{font-size:26px;font-weight:800;letter-spacing:-.5px;line-height:1.2;margin-bottom:8px}
.onb-p{font-size:15px;color:var(--text2);line-height:1.5;margin-bottom:28px}
.onb-spacer{flex:1}
.onb-btns{display:flex;gap:10px;margin-top:20px}
.onb-btns .btn{flex:1}

/* Goal cards */
.goal-grid{display:flex;flex-direction:column;gap:10px}
.goal-opt{display:flex;align-items:center;gap:14px;padding:16px;background:var(--card);border:2px solid var(--card-border);border-radius:var(--radius-m);cursor:pointer;transition:all .2s}
.goal-opt.sel{border-color:var(--accent);background:rgba(139,92,246,0.1)}
.goal-opt-icon{width:44px;height:44px;border-radius:var(--radius-s);background:var(--gradient-card);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.goal-opt-text{font-size:14px;font-weight:600}
.goal-opt-sub{font-size:12px;color:var(--text2);margin-top:2px}
.goal-opt .check{width:22px;height:22px;border-radius:50%;border:2px solid var(--card-border);margin-left:auto;display:flex;align-items:center;justify-content:center;font-size:14px;color:transparent;transition:all .2s;flex-shrink:0}
.goal-opt.sel .check{border-color:var(--accent);background:var(--accent);color:#fff}

/* Budget quick picks */
.budget-picks{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
.budget-pick{padding:12px;text-align:center;background:var(--card);border:2px solid var(--card-border);border-radius:var(--radius-s);font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
.budget-pick.sel{border-color:var(--accent);background:rgba(139,92,246,0.1)}

/* Account toggles */
.acc-toggle{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius-m);margin-bottom:8px}
.acc-toggle-icon{width:40px;height:40px;border-radius:var(--radius-s);background:var(--gradient-card);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.acc-toggle-info{flex:1}
.acc-toggle-name{font-size:14px;font-weight:600}
.acc-toggle-desc{font-size:11px;color:var(--text2);margin-top:1px}

/* Done screen */
.onb-done{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;flex:1}
.onb-done-icon{width:80px;height:80px;border-radius:50%;background:var(--gradient);display:flex;align-items:center;justify-content:center;font-size:36px;color:#fff;margin-bottom:20px;animation:popIn .5s ease}
@keyframes popIn{0%{transform:scale(0)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
.onb-done h2{font-size:24px;font-weight:800;margin-bottom:8px}
.onb-done p{font-size:14px;color:var(--text2);line-height:1.5}

/* === BALANCE CARD === */
.bal-card{background:var(--gradient-card);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:1px solid var(--glass-border);border-radius:var(--radius-xl);padding:28px 24px 24px;margin-bottom:16px;position:relative;overflow:hidden}
.bal-card::before{content:'';position:absolute;inset:-1px;border-radius:var(--radius-xl);padding:1px;background:linear-gradient(135deg,rgba(139,92,246,0.3),rgba(99,102,241,0.1),transparent);-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
.bal-label{font-size:13px;color:var(--text2);font-weight:500;margin-bottom:4px}
.bal-amount{font-size:36px;font-weight:800;letter-spacing:-1px;margin-bottom:16px}
.bal-row{display:flex;gap:8px}
.bal-item{flex:1;background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius-m);padding:12px;text-align:center}
.bal-item-label{font-size:11px;color:var(--text2);margin-bottom:4px}
.bal-item-val{font-size:16px;font-weight:700}
.bal-item-val.inc{color:var(--green)}.bal-item-val.exp{color:var(--red)}.bal-item-val.cf{color:var(--accent)}

.month-sel{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:16px;padding:8px 0}
.month-sel .arr{width:36px;height:36px;border-radius:50%;background:var(--card);border:1px solid var(--card-border);display:flex;align-items:center;justify-content:center;color:var(--text);font-size:18px;cursor:pointer;transition:background .2s}
.month-sel .arr:active{background:var(--card-hover)}
.month-sel .m-label{font-size:15px;font-weight:600;min-width:140px;text-align:center}

.sec{margin-bottom:20px}.sec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.sec-title{font-size:17px;font-weight:700}.sec-link{font-size:13px;color:var(--accent);font-weight:500;cursor:pointer}
.card{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius-l);padding:16px;margin-bottom:10px;transition:background .2s}

.cf-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.cf-card{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius-m);padding:14px}
.cf-card.full{grid-column:1/-1}
.cf-label{font-size:11px;color:var(--text2);font-weight:500;margin-bottom:2px}
.cf-val{font-size:18px;font-weight:700}.cf-val.pos{color:var(--green)}.cf-val.neg{color:var(--red)}

.prog-wrap{margin-top:8px}
.prog-bar{height:6px;background:var(--card-border);border-radius:3px;overflow:hidden}
.prog-fill{height:100%;border-radius:3px;background:var(--gradient);transition:width .5s ease}
.prog-labels{display:flex;justify-content:space-between;margin-top:4px}.prog-labels span{font-size:11px;color:var(--text2)}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border:none;cursor:pointer;font-family:var(--font);font-weight:600;transition:all .2s;outline:none}
.btn-main{background:var(--gradient);color:#fff;border-radius:var(--radius-pill);padding:14px 28px;font-size:15px;width:100%}
.btn-main:active{transform:scale(.97);opacity:.9}
.btn-sec{background:transparent;color:var(--accent);border:1.5px solid var(--accent);border-radius:var(--radius-pill);padding:12px 24px;font-size:14px;width:100%}
.btn-sec:active{background:rgba(139,92,246,0.1)}
.btn-ghost{background:var(--card);color:var(--text);border:1px solid var(--card-border);border-radius:var(--radius-pill);padding:10px 20px;font-size:13px}
.btn-sm{padding:8px 16px;font-size:12px;border-radius:var(--radius-pill)}
.btn-danger{background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.2);border-radius:var(--radius-pill);padding:10px 20px;font-size:13px;width:100%}
.btn-icon{background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;padding:4px}
.btn-skip{background:none;border:none;color:var(--text3);font-size:14px;font-weight:500;cursor:pointer;padding:12px 24px;font-family:var(--font)}

.fab{position:fixed;bottom:calc(var(--nav-h)+var(--safe-bot)+20px);right:calc(50% - 220px);width:56px;height:56px;background:var(--gradient);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:28px;box-shadow:0 4px 20px rgba(139,92,246,0.4);cursor:pointer;z-index:100;border:none;transition:transform .2s}
.fab:active{transform:scale(.9)}
@media(max-width:480px){.fab{right:20px}}

.nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-top:1px solid var(--card-border);height:calc(var(--nav-h)+var(--safe-bot));padding-bottom:var(--safe-bot);display:flex;z-index:200}
.nav.hidden{display:none}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;cursor:pointer;color:var(--text3);transition:color .2s;border:none;background:none;font-family:var(--font)}
.nav-item.active{color:var(--accent)}
.nav-item i{font-size:22px}.nav-item span{font-size:10px;font-weight:500}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);z-index:500;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--bg2);border-radius:var(--radius-xl) var(--radius-xl) 0 0;width:100%;max-width:480px;max-height:85vh;overflow-y:auto;padding:12px 20px calc(20px+var(--safe-bot));animation:slideUp .3s ease;position:relative}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:40px;height:4px;background:var(--text3);border-radius:2px;margin:0 auto 16px;opacity:.5}
.modal-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.modal-title{font-size:18px;font-weight:700;text-align:center;flex:1}
.modal-close{width:32px;height:32px;border-radius:50%;background:var(--card);border:1px solid var(--card-border);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text2);font-size:18px;flex-shrink:0}
.modal-close:active{background:var(--card-hover)}

.field{margin-bottom:16px}
.field label{display:block;font-size:12px;color:var(--text2);font-weight:500;margin-bottom:6px}
.field .hint{font-size:11px;color:var(--text3);margin-top:4px}
.field input,.field select,.field textarea{width:100%;background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius-s);padding:14px 16px;color:var(--text);font-size:15px;font-family:var(--font);outline:none;transition:border-color .2s}
.field input:focus,.field select:focus{border-color:var(--accent)}
.field select{appearance:none;cursor:pointer}

.seg{display:flex;background:var(--card);border-radius:var(--radius-s);padding:3px;margin-bottom:16px}
.seg-btn{flex:1;padding:10px;text-align:center;border-radius:var(--radius-s);font-size:13px;font-weight:600;cursor:pointer;color:var(--text2);transition:all .2s;border:none;background:none;font-family:var(--font)}
.seg-btn.active{background:var(--gradient);color:#fff}

.toggle-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
.toggle-label{font-size:14px;font-weight:500}
.toggle-sub{font-size:11px;color:var(--text2);margin-top:2px}
.toggle{width:48px;height:28px;border-radius:14px;background:var(--card-border);position:relative;cursor:pointer;transition:background .2s;flex-shrink:0}
.toggle.on{background:var(--accent)}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:#fff;transition:transform .2s}
.toggle.on::after{transform:translateX(20px)}

.tx-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--card-border)}
.tx-item:last-child{border-bottom:none}
.tx-icon{width:40px;height:40px;border-radius:var(--radius-s);background:var(--gradient-card);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.tx-info{flex:1;min-width:0}.tx-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.tx-cat{font-size:12px;color:var(--text2)}
.tx-amount{font-size:15px;font-weight:700;text-align:right}.tx-amount.inc{color:var(--green)}.tx-amount.exp{color:var(--red)}

.acc-card,.goal-card,.debt-card{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius-l);padding:16px;margin-bottom:10px}
.acc-row{display:flex;justify-content:space-between;align-items:center}
.acc-name{font-size:14px;font-weight:600}.acc-type{font-size:11px;color:var(--text2)}.acc-bal{font-size:18px;font-weight:700}
.card-actions{display:flex;gap:4px;margin-top:8px;justify-content:flex-end}

.debt-card{border-left:3px solid var(--red)}.debt-card.paid{border-left-color:var(--green);opacity:.7}
.debt-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.debt-name{font-size:15px;font-weight:700}
.debt-badge{font-size:11px;padding:3px 10px;border-radius:var(--radius-pill);background:rgba(239,68,68,0.1);color:var(--red);font-weight:600}
.debt-badge.done{background:rgba(16,185,129,0.1);color:var(--green)}
.debt-stat{font-size:12px;color:var(--text2);line-height:1.6}
.debt-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

.profile-avatar{width:72px;height:72px;border-radius:50%;background:var(--gradient);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:800;color:#fff;margin:0 auto 12px}
.profile-name{text-align:center;font-size:18px;font-weight:700;margin-bottom:4px}
.profile-sub{text-align:center;font-size:12px;color:var(--text2);margin-bottom:24px}
.profile-section{margin-bottom:20px}
.profile-section-title{font-size:12px;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-left:4px}
.profile-card{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius-l);overflow:hidden}
.profile-row{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;cursor:pointer;transition:background .2s}
.profile-row:active{background:var(--card-hover)}
.profile-row+.profile-row{border-top:1px solid var(--card-border)}
.profile-row-left{display:flex;align-items:center;gap:12px}
.profile-row-left i{font-size:20px;color:var(--accent)}
.profile-row-label{font-size:14px;font-weight:500}
.profile-row-right{color:var(--text3);font-size:18px}

.chart-box{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius-l);padding:16px;margin-bottom:12px}
.chart-box canvas{max-height:200px}

.toast{position:fixed;top:calc(12px+var(--safe-top));left:50%;transform:translateX(-50%) translateY(-80px);background:var(--bg2);border:1px solid var(--card-border);border-radius:var(--radius-pill);padding:12px 24px;font-size:13px;font-weight:500;color:var(--text);z-index:9999;transition:transform .3s ease;white-space:nowrap;box-shadow:var(--shadow)}
.toast.show{transform:translateX(-50%) translateY(0)}

.insight{background:var(--gradient-card);border:1px solid var(--glass-border);border-radius:var(--radius-m);padding:14px 16px;margin-bottom:10px;display:flex;gap:10px;align-items:flex-start}
.insight i{font-size:18px;color:var(--orange);flex-shrink:0;margin-top:2px}
.insight p{font-size:13px;color:var(--text2);line-height:1.5}

.empty{text-align:center;padding:40px 20px;color:var(--text3)}
.empty i{font-size:48px;margin-bottom:12px;opacity:.3;display:block}
.empty p{font-size:14px}

.cat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.cat-opt{display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 4px;border-radius:var(--radius-m);background:var(--card);border:2px solid transparent;cursor:pointer;transition:all .2s}
.cat-opt.sel{border-color:var(--accent);background:rgba(139,92,246,0.15)}
.cat-opt i{font-size:22px}
.cat-opt span{font-size:10px;color:var(--text2);text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%}

.wd-bar-row{display:flex;align-items:flex-end;gap:4px;height:80px;margin:12px 0}
.wd-bar{flex:1;background:var(--gradient);border-radius:4px 4px 0 0;min-height:4px;transition:height .5s ease}
.wd-labels{display:flex;gap:4px}.wd-labels span{flex:1;text-align:center;font-size:10px;color:var(--text3)}

/* Money input formatting */
.money-input{position:relative}
.money-input input{font-variant-numeric:tabular-nums}

::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--card-border);border-radius:2px}
</style>
</head>
<body>
<div class="app" id="app">
<div class="glow-bg"></div>

<!-- ===== ONBOARDING ===== -->
<div class="screen" id="scr-onb">
<div class="onb-wrap">
<div class="onb-progress" id="onb-progress"></div>

<!-- Step 1: Name -->
<div class="onb-step active" data-step="1">
<div class="onb-emoji">üëã</div>
<div class="onb-h">–ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –≤–∞—à —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫</div>
<div class="onb-p">–ü–æ–º–æ–≥—É –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥—ã, –∫–æ–ø–∏—Ç—å –Ω–∞ —Ü–µ–ª–∏ –∏ –≤–∏–¥–µ—Ç—å –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –≤–∞—à–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤. –î–∞–≤–∞–π—Ç–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è.</div>
<div class="field"><label>–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?</label><input type="text" id="onb-name" placeholder="–ò–º—è" autocomplete="off"></div>
<div class="onb-spacer"></div>
<button class="btn btn-main" onclick="onbNext()">–î–∞–ª—å—à–µ</button>
</div>

<!-- Step 2: Goals -->
<div class="onb-step" data-step="2">
<div class="onb-emoji">üéØ</div>
<div class="onb-h">–ß—Ç–æ –¥–ª—è –≤–∞—Å —Å–µ–π—á–∞—Å –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ?</div>
<div class="onb-p">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ–¥ –≤–∞—à–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã.</div>
<div class="goal-grid" id="onb-goals">
<div class="goal-opt" data-goal="control" onclick="toggleOnbGoal(this)">
<div class="goal-opt-icon"><i class="ri-eye-line"></i></div>
<div><div class="goal-opt-text">–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥—ã</div><div class="goal-opt-sub">–í–∏–¥–µ—Ç—å, –∫—É–¥–∞ —É—Ö–æ–¥—è—Ç –¥–µ–Ω—å–≥–∏</div></div>
<div class="check"><i class="ri-check-line"></i></div>
</div>
<div class="goal-opt" data-goal="save" onclick="toggleOnbGoal(this)">
<div class="goal-opt-icon"><i class="ri-safe-2-line"></i></div>
<div><div class="goal-opt-text">–ö–æ–ø–∏—Ç—å –Ω–∞ —Ü–µ–ª—å</div><div class="goal-opt-sub">–ö–≤–∞—Ä—Ç–∏—Ä–∞, –º–∞—à–∏–Ω–∞, –æ—Ç–ø—É—Å–∫</div></div>
<div class="check"><i class="ri-check-line"></i></div>
</div>
<div class="goal-opt" data-goal="debts" onclick="toggleOnbGoal(this)">
<div class="goal-opt-icon"><i class="ri-bank-line"></i></div>
<div><div class="goal-opt-text">–†–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –¥–æ–ª–≥–∞–º–∏</div><div class="goal-opt-sub">–ö—Ä–µ–¥–∏—Ç—ã, —Ä–∞—Å—Å—Ä–æ—á–∫–∏, –∑–∞–π–º—ã</div></div>
<div class="check"><i class="ri-check-line"></i></div>
</div>
<div class="goal-opt" data-goal="passive" onclick="toggleOnbGoal(this)">
<div class="goal-opt-icon"><i class="ri-line-chart-line"></i></div>
<div><div class="goal-opt-text">–†–∞—Å—Ç–∏—Ç—å –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</div><div class="goal-opt-sub">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –¥–∏–≤–∏–¥–µ–Ω–¥—ã, %</div></div>
<div class="check"><i class="ri-check-line"></i></div>
</div>
<div class="goal-opt" data-goal="track" onclick="toggleOnbGoal(this)">
<div class="goal-opt-icon"><i class="ri-file-list-3-line"></i></div>
<div><div class="goal-opt-text">–ü—Ä–æ—Å—Ç–æ –≤–µ—Å—Ç–∏ —É—á—ë—Ç</div><div class="goal-opt-sub">–ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –¥–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã</div></div>
<div class="check"><i class="ri-check-line"></i></div>
</div>
</div>
<div class="onb-spacer"></div>
<div class="onb-btns">
<button class="btn-skip" onclick="onbBack()">–ù–∞–∑–∞–¥</button>
<button class="btn btn-main" onclick="onbNext()">–î–∞–ª—å—à–µ</button>
</div>
</div>

<!-- Step 3: Budget -->
<div class="onb-step" data-step="3">
<div class="onb-emoji">üí∞</div>
<div class="onb-h">–°–∫–æ–ª—å–∫–æ –≤—ã –≥–æ—Ç–æ–≤—ã —Ç—Ä–∞—Ç–∏—Ç—å –≤ –º–µ—Å—è—Ü?</div>
<div class="onb-p">–≠—Ç–æ –ª–∏–º–∏—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ ‚Äî –º—ã –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏–º, –∫–æ–≥–¥–∞ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ—Å—å –∫ –Ω–µ–º—É.</div>
<div class="budget-picks" id="budget-picks">
<div class="budget-pick" onclick="pickBudget(this,30000)">30 000 ‚ÇΩ</div>
<div class="budget-pick" onclick="pickBudget(this,50000)">50 000 ‚ÇΩ</div>
<div class="budget-pick" onclick="pickBudget(this,80000)">80 000 ‚ÇΩ</div>
</div>
<div class="field"><label>–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é —Å—É–º–º—É</label><input type="text" id="onb-limit" placeholder="0 ‚ÇΩ" inputmode="numeric" oninput="formatMoney(this)"><div class="hint">–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö</div></div>
<div class="onb-spacer"></div>
<div class="onb-btns">
<button class="btn-skip" onclick="onbBack()">–ù–∞–∑–∞–¥</button>
<button class="btn btn-main" onclick="onbNext()">–î–∞–ª—å—à–µ</button>
</div>
</div>

<!-- Step 4: Accounts -->
<div class="onb-step" data-step="4">
<div class="onb-emoji">üí≥</div>
<div class="onb-h">–û—Ç–∫—É–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –∏ —É—Ö–æ–¥—è—Ç –¥–µ–Ω—å–≥–∏?</div>
<div class="onb-p">–í–∫–ª—é—á–∏—Ç–µ –Ω—É–∂–Ω—ã–µ —Å—á–µ—Ç–∞. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ –ø–æ–∑–∂–µ.</div>
<div id="onb-accounts">
<div class="acc-toggle" data-acc="card" data-on="true">
<div class="acc-toggle-icon"><i class="ri-bank-card-line"></i></div>
<div class="acc-toggle-info"><div class="acc-toggle-name">–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</div><div class="acc-toggle-desc">–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –±–∞–Ω–∫–∞</div></div>
<div class="toggle on" onclick="toggleOnbAcc(this)"></div>
</div>
<div class="acc-toggle" data-acc="cash" data-on="true">
<div class="acc-toggle-icon"><i class="ri-money-dollar-box-line"></i></div>
<div class="acc-toggle-info"><div class="acc-toggle-name">–ù–∞–ª–∏—á–Ω—ã–µ</div><div class="acc-toggle-desc">–ö—ç—à –≤ –∫–æ—à–µ–ª—å–∫–µ</div></div>
<div class="toggle on" onclick="toggleOnbAcc(this)"></div>
</div>
<div class="acc-toggle" data-acc="credit" data-on="false">
<div class="acc-toggle-icon"><i class="ri-bank-card-2-line"></i></div>
<div class="acc-toggle-info"><div class="acc-toggle-name">–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞</div><div class="acc-toggle-desc">–ï—Å–ª–∏ –ø–æ–ª—å–∑—É–µ—Ç–µ—Å—å –∫—Ä–µ–¥–∏—Ç–∫–æ–π</div></div>
<div class="toggle" onclick="toggleOnbAcc(this)"></div>
</div>
<div class="acc-toggle" data-acc="jar" data-on="false">
<div class="acc-toggle-icon"><i class="ri-safe-2-line"></i></div>
<div class="acc-toggle-info"><div class="acc-toggle-name">–ö–æ–ø–∏–ª–∫–∞</div><div class="acc-toggle-desc">–î–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π –Ω–∞ —Ü–µ–ª–∏</div></div>
<div class="toggle" onclick="toggleOnbAcc(this)"></div>
</div>
</div>
<div class="onb-spacer"></div>
<div class="onb-btns">
<button class="btn-skip" onclick="onbBack()">–ù–∞–∑–∞–¥</button>
<button class="btn btn-main" onclick="onbNext()">–î–∞–ª—å—à–µ</button>
</div>
</div>

<!-- Step 5: Done -->
<div class="onb-step" data-step="5">
<div class="onb-done">
<div class="onb-done-icon"><i class="ri-check-line"></i></div>
<h2 id="onb-done-name">–í—Å—ë –≥–æ—Ç–æ–≤–æ!</h2>
<p>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø–æ–¥ –≤–∞—à–∏ —Ü–µ–ª–∏.<br>–ù–∞–∂–º–∏—Ç–µ <strong>+</strong> —á—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é.</p>
</div>
<div class="onb-spacer"></div>
<button class="btn btn-main" onclick="finishOnb()">–ù–∞—á–∞—Ç—å</button>
</div>
</div>
</div>

<!-- ===== HOME ===== -->
<div class="screen" id="scr-home">
<div class="month-sel">
<div class="arr" onclick="changeMonth(-1)"><i class="ri-arrow-left-s-line"></i></div>
<div class="m-label" id="home-month"></div>
<div class="arr" onclick="changeMonth(1)"><i class="ri-arrow-right-s-line"></i></div>
</div>
<div class="bal-card">
<div class="bal-label">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
<div class="bal-amount" id="home-balance">0 ‚ÇΩ</div>
<div class="bal-row">
<div class="bal-item"><div class="bal-item-label">–î–æ—Ö–æ–¥</div><div class="bal-item-val inc" id="home-inc">0 ‚ÇΩ</div></div>
<div class="bal-item"><div class="bal-item-label">–†–∞—Å—Ö–æ–¥</div><div class="bal-item-val exp" id="home-exp">0 ‚ÇΩ</div></div>
<div class="bal-item"><div class="bal-item-label">–ö—ç—à—Ñ–ª–æ—É</div><div class="bal-item-val cf" id="home-cf">0 ‚ÇΩ</div></div>
</div>
</div>
<div class="card" id="budget-card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<span style="font-size:13px;font-weight:600">–õ–∏–º–∏—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</span>
<span style="font-size:13px;color:var(--text2)" id="budget-text">0 / 0 ‚ÇΩ</span>
</div>
<div class="prog-bar"><div class="prog-fill" id="budget-fill" style="width:0%"></div></div>
</div>
<div class="sec">
<div class="sec-head"><span class="sec-title">–ö—ç—à—Ñ–ª–æ—É</span></div>
<div class="cf-grid">
<div class="cf-card"><div class="cf-label">–ê–∫—Ç–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</div><div class="cf-val pos" id="cf-active">0 ‚ÇΩ</div></div>
<div class="cf-card"><div class="cf-label">–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</div><div class="cf-val pos" id="cf-passive">0 ‚ÇΩ</div></div>
<div class="cf-card"><div class="cf-label">–†–∞—Å—Ö–æ–¥—ã</div><div class="cf-val neg" id="cf-expenses">0 ‚ÇΩ</div></div>
<div class="cf-card"><div class="cf-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–ª–≥–æ–≤</div><div class="cf-val neg" id="cf-debts">0 ‚ÇΩ</div></div>
<div class="cf-card full"><div class="cf-label">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–±–æ–¥–∞</div><div class="cf-val" id="cf-freedom" style="color:var(--accent)">0%</div><div class="prog-wrap"><div class="prog-bar"><div class="prog-fill" id="cf-freedom-fill" style="width:0%"></div></div></div></div>
</div>
</div>
<div class="sec">
<div class="sec-head"><span class="sec-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</span><span class="sec-link" onclick="go('analytics')">–í—Å–µ</span></div>
<div class="card" id="home-tx-list"><div class="empty"><i class="ri-inbox-line"></i><p>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p></div></div>
</div>
</div>

<!-- ===== WALLET ===== -->
<div class="screen" id="scr-wallet">
<h2 style="font-size:22px;font-weight:800;margin-bottom:16px">–ö–æ—à–µ–ª—ë–∫</h2>
<div class="seg" id="wallet-seg"><button class="seg-btn active" onclick="setWalletTab('accounts')">–°—á–µ—Ç–∞</button><button class="seg-btn" onclick="setWalletTab('goals')">–¶–µ–ª–∏</button><button class="seg-btn" onclick="setWalletTab('debts')">–î–æ–ª–≥–∏</button></div>
<div id="wallet-accounts"></div><div id="wallet-goals" style="display:none"></div><div id="wallet-debts" style="display:none"></div>
<button class="btn btn-sec" style="margin-top:12px" onclick="openWalletAdd()"><i class="ri-add-line"></i> –î–æ–±–∞–≤–∏—Ç—å</button>
</div>

<!-- ===== ANALYTICS ===== -->
<div class="screen" id="scr-analytics">
<h2 style="font-size:22px;font-weight:800;margin-bottom:16px">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
<div class="month-sel"><div class="arr" onclick="changeMonth(-1)"><i class="ri-arrow-left-s-line"></i></div><div class="m-label" id="stats-month"></div><div class="arr" onclick="changeMonth(1)"><i class="ri-arrow-right-s-line"></i></div></div>
<div class="seg" id="stats-seg"><button class="seg-btn active" onclick="setStatsType('expense')">–†–∞—Å—Ö–æ–¥—ã</button><button class="seg-btn" onclick="setStatsType('income')">–î–æ—Ö–æ–¥—ã</button></div>
<div class="chart-box"><canvas id="chart-pie"></canvas></div>
<div id="stats-cats"></div>
<div class="sec" style="margin-top:20px"><div class="sec-head"><span class="sec-title">–ü–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</span></div><div class="card"><div class="wd-bar-row" id="wd-bars"></div><div class="wd-labels" id="wd-labels"></div></div></div>
<div class="sec" style="margin-top:16px"><div class="sec-head"><span class="sec-title">–ò–Ω—Å–∞–π—Ç—ã</span></div><div id="insights-list"></div></div>
<div class="sec" style="margin-top:16px"><div class="sec-head"><span class="sec-title">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</span></div><div id="all-tx-list"></div></div>
</div>

<!-- ===== INVESTMENTS ===== -->
<div class="screen" id="scr-invest">
<h2 style="font-size:22px;font-weight:800;margin-bottom:16px">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h2>
<div class="chart-box"><canvas id="chart-inv"></canvas></div>
<div id="inv-list"></div>
<button class="btn btn-sec" style="margin-top:12px" onclick="openAddAccount('invest')"><i class="ri-add-line"></i> –ù–æ–≤–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è</button>
</div>

<!-- ===== PROFILE ===== -->
<div class="screen" id="scr-profile">
<div class="profile-avatar" id="prof-avatar">–ö</div>
<div class="profile-name" id="prof-name">‚Äî</div>
<div class="profile-sub">MyCosts Titanium v17.0</div>
<div class="profile-section"><div class="profile-section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
<div class="profile-card">
<div class="profile-row" onclick="toggleTheme()"><div class="profile-row-left"><i class="ri-moon-line" id="theme-icon"></i><span class="profile-row-label">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span></div><div class="toggle" id="theme-toggle"></div></div>
<div class="profile-row" onclick="openEditLimit()"><div class="profile-row-left"><i class="ri-wallet-3-line"></i><span class="profile-row-label">–õ–∏–º–∏—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</span></div><span style="font-size:14px;color:var(--text2)" id="prof-limit">0 ‚ÇΩ</span></div>
</div></div>
<div class="profile-section"><div class="profile-section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
<div class="profile-card">
<div class="profile-row" onclick="manageCategories()"><div class="profile-row-left"><i class="ri-price-tag-3-line"></i><span class="profile-row-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span></div><div class="profile-row-right"><i class="ri-arrow-right-s-line"></i></div></div>
<div class="profile-row" onclick="syncNow()"><div class="profile-row-left"><i class="ri-refresh-line"></i><span class="profile-row-label">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</span></div><div class="profile-row-right"><i class="ri-arrow-right-s-line"></i></div></div>
<div class="profile-row" onclick="exportData()"><div class="profile-row-left"><i class="ri-download-2-line"></i><span class="profile-row-label">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</span></div><div class="profile-row-right"><i class="ri-arrow-right-s-line"></i></div></div>
</div></div>
<div class="profile-section"><button class="btn btn-danger" onclick="resetApp()"><i class="ri-delete-bin-line"></i> –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫</button></div>
</div>
</div>

<button class="fab" id="fab" onclick="openAddTx()"><i class="ri-add-line"></i></button>
<nav class="nav" id="main-nav">
<button class="nav-item active" onclick="go('home')"><i class="ri-home-5-line"></i><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
<button class="nav-item" onclick="go('wallet')"><i class="ri-wallet-3-line"></i><span>–ö–æ—à–µ–ª—ë–∫</span></button>
<button class="nav-item" onclick="go('analytics')"><i class="ri-pie-chart-line"></i><span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span></button>
<button class="nav-item" onclick="go('invest')"><i class="ri-line-chart-line"></i><span>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</span></button>
<button class="nav-item" onclick="go('profile')"><i class="ri-user-3-line"></i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
</nav>

<!-- MODALS -->
<div class="modal-overlay" id="modal-tx"><div class="modal"><div class="modal-handle"></div><div class="modal-top"><div style="width:32px"></div><div class="modal-title">–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</div><div class="modal-close" onclick="closeModal('modal-tx')"><i class="ri-close-line"></i></div></div>
<div class="seg" id="tx-seg"><button class="seg-btn active" onclick="setTxType('expense')">–†–∞—Å—Ö–æ–¥</button><button class="seg-btn" onclick="setTxType('income')">–î–æ—Ö–æ–¥</button></div>
<div class="field"><label>–°—É–º–º–∞</label><input type="text" id="tx-amount" placeholder="0 ‚ÇΩ" inputmode="numeric" oninput="formatMoney(this)"></div>
<div class="field" id="tx-income-type-wrap" style="display:none"><label>–¢–∏–ø –¥–æ—Ö–æ–¥–∞</label><select id="tx-income-type"><option value="active">–ê–∫—Ç–∏–≤–Ω—ã–π</option><option value="passive">–ü–∞—Å—Å–∏–≤–Ω—ã–π</option></select></div>
<div class="field"><label>–°—á—ë—Ç</label><select id="tx-account"></select></div>
<div class="field"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><div class="cat-grid" id="tx-cats"></div></div>
<div class="field"><label>–î–∞—Ç–∞</label><input type="date" id="tx-date"></div>
<div class="field"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input type="text" id="tx-comment" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"></div>
<button class="btn btn-main" onclick="saveTx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>

<div class="modal-overlay" id="modal-acc"><div class="modal"><div class="modal-handle"></div><div class="modal-top"><div style="width:32px"></div><div class="modal-title" id="acc-modal-title">–ù–æ–≤—ã–π —Å—á—ë—Ç</div><div class="modal-close" onclick="closeModal('modal-acc')"><i class="ri-close-line"></i></div></div>
<div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="acc-name" placeholder="–ö–∞—Ä—Ç–∞, –ù–∞–ª–∏—á–Ω—ã–µ..."></div>
<div class="field"><label>–¢–∏–ø</label><select id="acc-type" onchange="updateAccForm()"><option value="card">–ö–∞—Ä—Ç–∞</option><option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option><option value="invest">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è</option><option value="jar">–ö–æ–ø–∏–ª–∫–∞</option></select></div>
<div class="field"><label>–ë–∞–ª–∞–Ω—Å</label><input type="text" id="acc-balance" placeholder="0 ‚ÇΩ" inputmode="numeric" oninput="formatMoney(this)"></div>
<div class="field" id="acc-percent-wrap"><label>–ì–æ–¥–æ–≤–æ–π % (–µ—Å–ª–∏ –µ—Å—Ç—å)</label><input type="number" id="acc-percent" placeholder="0" step="0.1"></div>
<div class="field" id="acc-divday-wrap" style="display:none"><label>–î–∞—Ç–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è (—á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞)</label><input type="number" id="acc-divday" placeholder="15" min="1" max="31"></div>
<div class="field" id="acc-goal-wrap" style="display:none"><label>–¶–µ–ª—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</label><input type="text" id="acc-goal" placeholder="0 ‚ÇΩ" inputmode="numeric" oninput="formatMoney(this)"></div>
<div class="toggle-row" id="acc-income-row" style="display:none"><div><div class="toggle-label">–°—á–∏—Ç–∞—Ç—å –∫–∞–∫ –¥–æ—Ö–æ–¥</div><div class="toggle-sub">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç—Ä–∞–∑—è—Ç—Å—è –≤ –∫—ç—à—Ñ–ª–æ—É</div></div><div class="toggle" id="acc-as-income" onclick="this.classList.toggle('on')"></div></div>
<button class="btn btn-main" onclick="saveAccount()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>

<div class="modal-overlay" id="modal-goal"><div class="modal"><div class="modal-handle"></div><div class="modal-top"><div style="width:32px"></div><div class="modal-title">–ù–æ–≤–∞—è —Ü–µ–ª—å</div><div class="modal-close" onclick="closeModal('modal-goal')"><i class="ri-close-line"></i></div></div>
<div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="goal-name" placeholder="–ú–∞—à–∏–Ω–∞, –û—Ç–ø—É—Å–∫..."></div>
<div class="field"><label>–°—É–º–º–∞ —Ü–µ–ª–∏</label><input type="text" id="goal-target" placeholder="0 ‚ÇΩ" inputmode="numeric" oninput="formatMoney(this)"></div>
<div class="field"><label>–£–∂–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ</label><input type="text" id="goal-current" placeholder="0 ‚ÇΩ" inputmode="numeric" oninput="formatMoney(this)"></div>
<div class="field"><label>–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ —Å—á—ë—Ç—É</label><select id="goal-account"></select></div>
<button class="btn btn-main" onclick="saveGoal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>

<div class="modal-overlay" id="modal-debt"><div class="modal"><div class="modal-handle"></div><div class="modal-top"><div style="width:32px"></div><div class="modal-title" id="debt-modal-title">–ù–æ–≤—ã–π –¥–æ–ª–≥</div><div class="modal-close" onclick="closeModal('modal-debt')"><i class="ri-close-line"></i></div></div>
<div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="debt-name" placeholder="–ö—Ä–µ–¥–∏—Ç–∫–∞, –†–∞—Å—Å—Ä–æ—á–∫–∞..."></div>
<div class="field"><label>–°—É–º–º–∞ –¥–æ–ª–≥–∞</label><input type="text" id="debt-amount" placeholder="0 ‚ÇΩ" inputmode="numeric" oninput="formatMoney(this)"></div>
<div class="field"><label>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂</label><input type="text" id="debt-monthly" placeholder="0 ‚ÇΩ" inputmode="numeric" oninput="formatMoney(this)"></div>
<div class="field"><label>–ì–æ–¥–æ–≤–æ–π % (0 –µ—Å–ª–∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∞)</label><input type="number" id="debt-percent" placeholder="0" step="0.1"></div>
<div class="field"><label>–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ (—á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞)</label><input type="number" id="debt-duedate" placeholder="15" min="1" max="31"></div>
<div class="toggle-row"><div><div class="toggle-label">–£—á–∏—Ç—ã–≤–∞—Ç—å % –≤ –∫—ç—à—Ñ–ª–æ—É</div><div class="toggle-sub">–ü—Ä–æ—Ü–µ–Ω—Ç—ã –≤—ã—á—Ç—É—Ç—Å—è –∏–∑ –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞</div></div><div class="toggle" id="debt-affects-cf" onclick="this.classList.toggle('on')"></div></div>
<input type="hidden" id="debt-edit-id" value="">
<button class="btn btn-main" onclick="saveDebt()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>

<div class="modal-overlay" id="modal-debt-pay"><div class="modal"><div class="modal-handle"></div><div class="modal-top"><div style="width:32px"></div><div class="modal-title" id="debt-pay-title">–í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç—ë–∂</div><div class="modal-close" onclick="closeModal('modal-debt-pay')"><i class="ri-close-line"></i></div></div>
<div class="field"><label>–°—É–º–º–∞</label><input type="text" id="debt-pay-amount" placeholder="0 ‚ÇΩ" inputmode="numeric" oninput="formatMoney(this)"></div>
<div class="field"><label>–°–æ —Å—á—ë—Ç–∞</label><select id="debt-pay-account"></select></div>
<div class="seg" id="debt-pay-seg"><button class="seg-btn active" onclick="setDebtPayType('regular')">–ü–æ –≥—Ä–∞—Ñ–∏–∫—É</button><button class="seg-btn" onclick="setDebtPayType('early')">–î–æ—Å—Ä–æ—á–Ω—ã–π</button></div>
<button class="btn btn-main" onclick="payDebt()">–í–Ω–µ—Å—Ç–∏</button></div></div>

<div class="modal-overlay" id="modal-cats"><div class="modal"><div class="modal-handle"></div><div class="modal-top"><div style="width:32px"></div><div class="modal-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div><div class="modal-close" onclick="closeModal('modal-cats')"><i class="ri-close-line"></i></div></div>
<div class="seg" id="cat-manage-seg"><button class="seg-btn active" onclick="setCatManageType('expense')">–†–∞—Å—Ö–æ–¥—ã</button><button class="seg-btn" onclick="setCatManageType('income')">–î–æ—Ö–æ–¥—ã</button></div>
<div id="cat-manage-list"></div>
<button class="btn btn-sec" style="margin-top:12px" onclick="openAddCat()"><i class="ri-add-line"></i> –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</button></div></div>

<div class="modal-overlay" id="modal-add-cat"><div class="modal"><div class="modal-handle"></div><div class="modal-top"><div style="width:32px"></div><div class="modal-title">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div><div class="modal-close" onclick="closeModal('modal-add-cat')"><i class="ri-close-line"></i></div></div>
<div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="new-cat-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"></div>
<div class="field"><label>–¢–∏–ø</label><select id="new-cat-type"><option value="expense">–†–∞—Å—Ö–æ–¥</option><option value="income">–î–æ—Ö–æ–¥</option></select></div>
<div class="field"><label>–ò–∫–æ–Ω–∫–∞</label><div class="cat-grid" id="icon-picker"></div></div>
<button class="btn btn-main" onclick="saveCat()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>

<div class="modal-overlay" id="modal-limit"><div class="modal"><div class="modal-handle"></div><div class="modal-top"><div style="width:32px"></div><div class="modal-title">–õ–∏–º–∏—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</div><div class="modal-close" onclick="closeModal('modal-limit')"><i class="ri-close-line"></i></div></div>
<div class="field"><label>–ú–µ—Å—è—á–Ω—ã–π –ª–∏–º–∏—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</label><input type="text" id="edit-limit" placeholder="0 ‚ÇΩ" inputmode="numeric" oninput="formatMoney(this)"><div class="hint">–°–∫–æ–ª—å–∫–æ –≤—ã –≥–æ—Ç–æ–≤—ã —Ç—Ä–∞—Ç–∏—Ç—å –≤ –º–µ—Å—è—Ü</div></div>
<button class="btn btn-main" onclick="saveLimit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>

<div class="modal-overlay" id="modal-transfer"><div class="modal"><div class="modal-handle"></div><div class="modal-top"><div style="width:32px"></div><div class="modal-title">–ü–µ—Ä–µ–≤–æ–¥</div><div class="modal-close" onclick="closeModal('modal-transfer')"><i class="ri-close-line"></i></div></div>
<div class="field"><label>–û—Ç–∫—É–¥–∞</label><select id="tr-from"></select></div>
<div class="field"><label>–ö—É–¥–∞</label><select id="tr-to"></select></div>
<div class="field"><label>–°—É–º–º–∞</label><input type="text" id="tr-amount" placeholder="0 ‚ÇΩ" inputmode="numeric" oninput="formatMoney(this)"></div>
<button class="btn btn-main" onclick="doTransfer()">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button></div></div>

<div class="modal-overlay" id="modal-export"><div class="modal"><div class="modal-handle"></div><div class="modal-top"><div style="width:32px"></div><div class="modal-title">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div><div class="modal-close" onclick="closeModal('modal-export')"><i class="ri-close-line"></i></div></div>
<p style="font-size:13px;color:var(--text2);margin-bottom:12px">–î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.</p>
<textarea id="export-text" style="width:100%;height:200px;background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius-s);padding:12px;color:var(--text);font-size:11px;font-family:monospace;resize:none" readonly></textarea>
<button class="btn btn-main" style="margin-top:12px" onclick="copyExport()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div></div>

<div class="modal-overlay" id="modal-edit-acc"><div class="modal"><div class="modal-handle"></div><div class="modal-top"><div style="width:32px"></div><div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—á—ë—Ç</div><div class="modal-close" onclick="closeModal('modal-edit-acc')"><i class="ri-close-line"></i></div></div>
<div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="ea-name"></div>
<div class="field"><label>–ë–∞–ª–∞–Ω—Å</label><input type="text" id="ea-balance" inputmode="numeric" oninput="formatMoney(this)"></div>
<div class="field"><label>–ì–æ–¥–æ–≤–æ–π %</label><input type="number" id="ea-percent" step="0.1"></div>
<div class="field" id="ea-divday-wrap"><label>–î–∞—Ç–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</label><input type="number" id="ea-divday" min="1" max="31"></div>
<div class="field" id="ea-goal-wrap"><label>–¶–µ–ª—å</label><input type="text" id="ea-goal" inputmode="numeric" oninput="formatMoney(this)"></div>
<input type="hidden" id="ea-id">
<button class="btn btn-main" onclick="saveEditAccount()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
<button class="btn btn-danger" style="margin-top:8px" onclick="deleteAccount()"><i class="ri-delete-bin-line"></i> –£–¥–∞–ª–∏—Ç—å —Å—á—ë—Ç</button></div></div>

<div class="toast" id="toast"></div>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbzo_iK3lLdLb6VZtGgkrM6IDZiMuW2sMK6FnjjMl4EsqrZMfH3CPJ_frANSEdv-Wiob/exec';
const DB_KEY='onyx_db';
const ICONS=['ri-shopping-bag-line','ri-restaurant-line','ri-car-line','ri-bus-line','ri-home-4-line','ri-heart-pulse-line','ri-gamepad-line','ri-movie-2-line','ri-book-open-line','ri-t-shirt-line','ri-smartphone-line','ri-gift-line','ri-briefcase-line','ri-computer-line','ri-code-s-slash-line','ri-bank-line','ri-money-dollar-circle-line','ri-hand-coin-line','ri-stock-line','ri-funds-line','ri-percent-line','ri-building-2-line','ri-service-line','ri-truck-line','ri-drop-line','ri-flashlight-line','ri-wifi-line','ri-music-2-line','ri-cup-line','ri-scissors-line','ri-palette-line','ri-plane-line'];
const COLORS=['#8B5CF6','#6366F1','#F97316','#10B981','#EF4444','#3B82F6','#EC4899','#14B8A6','#F59E0B','#6B7280','#A855F7','#22D3EE'];
const MONTHS_RU=['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
const WEEKDAYS_RU=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
const MOTIV=['–¢—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è! üí™','–ö–∞–∂–¥—ã–π –ø–ª–∞—Ç—ë–∂ ‚Äî —à–∞–≥ –∫ —Å–≤–æ–±–æ–¥–µ!','–î–æ–ª–≥–∏ –Ω–µ –≤–µ—á–Ω—ã, —Ç—ã ‚Äî –¥–∞!','–§–∏–Ω–∏—à –±–ª–∏–∑–∫–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–π!'];

let db,curMonth=new Date().getMonth(),curYear=new Date().getFullYear();
let curTxType='expense',curStatsType='expense',curWalletTab='accounts',curCatManageType='expense';
let curDebtPayType='regular',payingDebtId=null,selectedCatId=null,selectedIcon=null;
let chartPie=null,chartInv=null,onbStep=1;
const ONB_TOTAL=5;
let onbGoals=new Set(),onbBudget=50000;

// === MONEY FORMAT ===
function formatMoney(el){
  let v=el.value.replace(/[^\d]/g,'');
  if(!v){el.value='';return}
  el.value=Number(v).toLocaleString('ru-RU');
}
function parseMoney(el){return Number((el.value||'0').replace(/[^\d]/g,''))||0}

// === DB ===
function defaultDB(){const uid=getUserId();return{user:{id:uid,name:'',limit:50000,joined_at:new Date().toISOString(),goals:[]},accounts:[],categories:[],transactions:[],goals:[],debts:[]}}
function getUserId(){try{if(window.Telegram?.WebApp?.initDataUnsafe?.user?.id)return'tg_'+window.Telegram.WebApp.initDataUnsafe.user.id}catch(e){}let id=localStorage.getItem('onyx_uid');if(!id){id='u_'+Date.now()+'_'+Math.random().toString(36).slice(2,8);localStorage.setItem('onyx_uid',id)}return id}
function loadDB(){try{const d=JSON.parse(localStorage.getItem(DB_KEY));if(d&&d.user){db=d;migrate();return}}catch(e){}db=defaultDB()}
function saveDB(){localStorage.setItem(DB_KEY,JSON.stringify(db))}
function migrate(){if(!db.goals)db.goals=[];if(!db.debts)db.debts=[];if(!db.user.limit)db.user.limit=50000;if(!db.user.goals)db.user.goals=[];db.accounts.forEach(a=>{if(!a.divDay)a.divDay='';if(!a.currency)a.currency='RUB'});db.categories.forEach(c=>{if(!c.color)c.color=COLORS[Math.floor(Math.random()*COLORS.length)]});db.transactions.forEach(t=>{if(!t.incomeType)t.incomeType='active';t.amount=Number(t.amount)||0});db.debts.forEach(d=>{if(!d.payments)d.payments='[]';if(d.affectsCashflow===undefined)d.affectsCashflow=false})}

// === INIT ===
function init(){loadDB();initTheme();if(!db.user.name||db.accounts.length===0){showScreen('onb');renderOnbProgress();return}go('home');loadFromServer()}

// === ONBOARDING ===
function renderOnbProgress(){
  const el=document.getElementById('onb-progress');
  el.innerHTML='';
  for(let i=1;i<=ONB_TOTAL;i++){const d=document.createElement('div');d.className='onb-dot'+(i<onbStep?' done':'')+(i===onbStep?' active':'');el.appendChild(d)}
}
function showOnbStep(n){
  onbStep=n;renderOnbProgress();
  document.querySelectorAll('.onb-step').forEach(s=>{s.classList.remove('active');if(Number(s.dataset.step)===n)s.classList.add('active')});
  if(n===5){const name=document.getElementById('onb-name').value.trim()||'–¥—Ä—É–≥';document.getElementById('onb-done-name').textContent=name+', –≤—Å—ë –≥–æ—Ç–æ–≤–æ!'}
}
function onbNext(){
  if(onbStep===1){const name=document.getElementById('onb-name').value.trim();if(!name){toast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');return}}
  if(onbStep===2&&onbGoals.size===0){toast('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ü–µ–ª—å');return}
  if(onbStep===3){const v=parseMoney(document.getElementById('onb-limit'));if(v>0)onbBudget=v}
  if(onbStep<ONB_TOTAL)showOnbStep(onbStep+1);
}
function onbBack(){if(onbStep>1)showOnbStep(onbStep-1)}
function toggleOnbGoal(el){el.classList.toggle('sel');const g=el.dataset.goal;if(onbGoals.has(g))onbGoals.delete(g);else onbGoals.add(g)}
function pickBudget(el,val){document.querySelectorAll('.budget-pick').forEach(b=>b.classList.remove('sel'));el.classList.add('sel');onbBudget=val;document.getElementById('onb-limit').value=val.toLocaleString('ru-RU')}
function toggleOnbAcc(toggle){toggle.classList.toggle('on');const row=toggle.closest('.acc-toggle');row.dataset.on=toggle.classList.contains('on')?'true':'false'}

function finishOnb(){
  const name=document.getElementById('onb-name').value.trim()||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
  db.user.name=name;db.user.limit=onbBudget;db.user.goals=Array.from(onbGoals);

  // Categories
  const defCats=[
    {n:'–ï–¥–∞',t:'expense',i:'ri-restaurant-line'},{n:'–î–æ–º',t:'expense',i:'ri-home-4-line'},
    {n:'–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',t:'expense',i:'ri-car-line'},{n:'–ü–æ–∫—É–ø–∫–∏',t:'expense',i:'ri-shopping-bag-line'},
    {n:'–ó–¥–æ—Ä–æ–≤—å–µ',t:'expense',i:'ri-heart-pulse-line'},{n:'–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è',t:'expense',i:'ri-gamepad-line'},
    {n:'–°–≤—è–∑—å',t:'expense',i:'ri-wifi-line'},{n:'–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',t:'expense',i:'ri-book-open-line'},
    {n:'–ó–∞—Ä–ø–ª–∞—Ç–∞',t:'income',i:'ri-briefcase-line'},{n:'–§—Ä–∏–ª–∞–Ω—Å',t:'income',i:'ri-computer-line'},
    {n:'–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏',t:'income',i:'ri-funds-line'},{n:'–ü–æ–¥–∞—Ä–∫–∏',t:'income',i:'ri-gift-line'},
    {n:'–ü–∞—Å—Å–∏–≤–Ω—ã–π %',t:'income',i:'ri-percent-line'}
  ];
  defCats.forEach((c,i)=>{db.categories.push({id:'c'+(i+1),user_id:db.user.id,name:c.n,type:c.t,icon:c.i,color:COLORS[i%COLORS.length]})});

  // Accounts from toggles
  const accMap={card:{name:'–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞',type:'card'},cash:{name:'–ù–∞–ª–∏—á–Ω—ã–µ',type:'cash'},credit:{name:'–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞',type:'card'},jar:{name:'–ö–æ–ø–∏–ª–∫–∞',type:'jar'}};
  let aidx=1;
  document.querySelectorAll('.acc-toggle').forEach(row=>{
    if(row.dataset.on==='true'){const key=row.dataset.acc;const m=accMap[key];db.accounts.push({id:'a'+(aidx++),user_id:db.user.id,name:m.name,type:m.type,balance:0,goal:'',percent:0,divDay:'',currency:'RUB'})}
  });
  if(db.accounts.length===0){db.accounts.push({id:'a1',user_id:db.user.id,name:'–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞',type:'card',balance:0,goal:'',percent:0,divDay:'',currency:'RUB'})}

  saveDB();pushData();go('home');toast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, '+name+'!');
}

// === NAV ===
function go(screen){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('scr-'+screen).classList.add('active');
  document.querySelectorAll('.nav-item').forEach((n,i)=>{const tabs=['home','wallet','analytics','invest','profile'];n.classList.toggle('active',tabs[i]===screen)});
  document.getElementById('fab').style.display=(screen==='profile'||screen==='onb')?'none':'flex';
  document.getElementById('main-nav').classList.remove('hidden');
  if(screen==='home')renderHome();if(screen==='wallet')renderWallet();if(screen==='analytics')renderAnalytics();if(screen==='invest')renderInvest();if(screen==='profile')renderProfile();
}
function showScreen(s){document.querySelectorAll('.screen').forEach(el=>el.classList.remove('active'));document.getElementById('scr-'+s).classList.add('active');if(s==='onb'){document.getElementById('fab').style.display='none';document.getElementById('main-nav').classList.add('hidden')}}

// === MONTH ===
function changeMonth(d){curMonth+=d;if(curMonth>11){curMonth=0;curYear++}if(curMonth<0){curMonth=11;curYear--}renderMonthLabels();const s=document.querySelector('.screen.active');if(s.id==='scr-home')renderHome();if(s.id==='scr-analytics')renderAnalytics()}
function renderMonthLabels(){const l=MONTHS_RU[curMonth]+' '+curYear;const e1=document.getElementById('home-month'),e2=document.getElementById('stats-month');if(e1)e1.textContent=l;if(e2)e2.textContent=l}
function txInMonth(t){if(!t.date)return false;const d=new Date(t.date);return d.getMonth()===curMonth&&d.getFullYear()===curYear}
function fmt(n){return Number(n||0).toLocaleString('ru-RU')+' ‚ÇΩ'}
function fmtDate(d){if(!d)return'';return new Date(d).toLocaleDateString('ru-RU',{day:'numeric',month:'short'})}

// === HOME ===
function renderHome(){
  renderMonthLabels();const txs=db.transactions.filter(txInMonth);
  let totalBal=0;db.accounts.forEach(a=>totalBal+=Number(a.balance)||0);
  let inc=0,exp=0,actInc=0,pasInc=0;
  txs.forEach(t=>{const a=Number(t.amount)||0;if(t.type==='income'){inc+=a;if(t.incomeType==='passive')pasInc+=a;else actInc+=a}else exp+=a});
  let invPassive=0;db.accounts.filter(a=>a.type==='invest'&&Number(a.percent)>0).forEach(a=>{invPassive+=Math.round(Number(a.balance)*Number(a.percent)/100/12)});
  pasInc+=invPassive;
  const cf=inc-exp;
  document.getElementById('home-balance').textContent=fmt(totalBal);
  document.getElementById('home-inc').textContent=fmt(inc);
  document.getElementById('home-exp').textContent=fmt(exp);
  document.getElementById('home-cf').textContent=fmt(cf);
  document.getElementById('home-cf').className='bal-item-val '+(cf>=0?'pos':'neg');
  const limit=Number(db.user.limit)||1;const pct=Math.min(100,Math.round(exp/limit*100));
  document.getElementById('budget-text').textContent=fmt(exp)+' / '+fmt(limit);
  document.getElementById('budget-fill').style.width=pct+'%';
  document.getElementById('budget-fill').style.background=pct>90?'var(--red)':pct>70?'var(--orange)':'var(--gradient)';
  let debtCost=0;db.debts.forEach(d=>{if(d.affectsCashflow){const rem=Number(d.amount)-Number(d.paid||0);if(rem>0)debtCost+=rem*(Number(d.percent)||0)/100/12}});
  document.getElementById('cf-active').textContent=fmt(actInc);document.getElementById('cf-passive').textContent=fmt(pasInc);
  document.getElementById('cf-expenses').textContent=fmt(exp);document.getElementById('cf-debts').textContent=fmt(Math.round(debtCost));
  const netP=pasInc-debtCost;const freedom=exp>0?Math.round((netP/exp)*100):0;
  document.getElementById('cf-freedom').textContent=freedom+'%';document.getElementById('cf-freedom').style.color=freedom>=100?'var(--green)':freedom>=0?'var(--accent)':'var(--red)';
  document.getElementById('cf-freedom-fill').style.width=Math.max(0,Math.min(100,freedom))+'%';
  const recent=[...txs].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);const el=document.getElementById('home-tx-list');
  if(!recent.length){el.innerHTML='<div class="empty"><i class="ri-inbox-line"></i><p>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p></div>';return}
  el.innerHTML=recent.map(t=>{const cat=db.categories.find(c=>c.id===t.category_id)||{icon:'ri-question-line',name:'‚Äî',color:'#6B7280'};return`<div class="tx-item"><div class="tx-icon" style="background:${cat.color}22"><i class="${cat.icon}" style="color:${cat.color}"></i></div><div class="tx-info"><div class="tx-name">${cat.name}</div><div class="tx-cat">${fmtDate(t.date)}${t.comment?' ¬∑ '+t.comment:''}</div></div><div><div class="tx-amount ${t.type==='income'?'inc':'exp'}">${t.type==='income'?'+':'‚àí'}${fmt(Math.abs(t.amount))}</div></div></div>`}).join('');
}

// === WALLET ===
function renderWallet(){setWalletTab(curWalletTab)}
function setWalletTab(tab){curWalletTab=tab;document.querySelectorAll('#wallet-seg .seg-btn').forEach((b,i)=>{const t=['accounts','goals','debts'];b.classList.toggle('active',t[i]===tab)});document.getElementById('wallet-accounts').style.display=tab==='accounts'?'block':'none';document.getElementById('wallet-goals').style.display=tab==='goals'?'block':'none';document.getElementById('wallet-debts').style.display=tab==='debts'?'block':'none';if(tab==='accounts')renderAccounts();if(tab==='goals')renderGoals();if(tab==='debts')renderDebts()}
function renderAccounts(){
  const el=document.getElementById('wallet-accounts');const types={card:'–ö–∞—Ä—Ç–∞',cash:'–ù–∞–ª–∏—á–Ω—ã–µ',invest:'–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è',jar:'–ö–æ–ø–∏–ª–∫–∞'};const accs=db.accounts.filter(a=>a.type!=='invest');
  if(!accs.length){el.innerHTML='<div class="empty"><i class="ri-wallet-3-line"></i><p>–ù–µ—Ç —Å—á–µ—Ç–æ–≤</p></div>';return}
  el.innerHTML=accs.map(a=>`<div class="acc-card"><div class="acc-row"><div><div class="acc-name">${a.name}</div><div class="acc-type">${types[a.type]||a.type}${a.percent?' ¬∑ '+a.percent+'%':''}</div></div><div class="acc-bal">${fmt(a.balance)}</div></div>${a.type==='jar'&&a.goal?`<div class="prog-wrap"><div class="prog-bar"><div class="prog-fill" style="width:${Math.min(100,Math.round(Number(a.balance)/Number(a.goal)*100))}%"></div></div><div class="prog-labels"><span>${fmt(a.balance)}</span><span>${fmt(a.goal)}</span></div></div>`:''}<div class="card-actions"><button class="btn-icon" onclick="editAccount('${a.id}')"><i class="ri-edit-line"></i></button>${a.type==='jar'?`<button class="btn-icon" onclick="openTransferTo('${a.id}')"><i class="ri-arrow-left-right-line"></i></button>`:''}</div></div>`).join('');
  if(db.accounts.length>1)el.innerHTML+=`<button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="openTransfer()"><i class="ri-arrow-left-right-line"></i> –ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏</button>`;
}
function renderGoals(){
  const el=document.getElementById('wallet-goals');const invGoals=db.accounts.filter(a=>a.type==='invest'&&Number(a.goal)>0).map(a=>({id:'inv_'+a.id,name:a.name+' (–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è)',target:Number(a.goal),current:Number(a.balance),color:COLORS[0],accountId:a.id,isInv:true}));
  const allGoals=[...db.goals,...invGoals];
  if(!allGoals.length){el.innerHTML='<div class="empty"><i class="ri-flag-line"></i><p>–ù–µ—Ç —Ü–µ–ª–µ–π</p></div>';return}
  el.innerHTML=allGoals.map(g=>{if(g.accountId&&!g.isInv){const acc=db.accounts.find(a=>a.id===g.accountId);if(acc)g.current=Number(acc.balance)}const p=Number(g.target)>0?Math.min(100,Math.round(Number(g.current)/Number(g.target)*100)):0;return`<div class="goal-card card"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-weight:600">${g.name}</span><span style="font-size:13px;color:var(--text2)">${p}%</span></div><div class="prog-bar"><div class="prog-fill" style="width:${p}%"></div></div><div class="prog-labels"><span>${fmt(g.current)}</span><span>${fmt(g.target)}</span></div>${!g.isInv?`<div class="card-actions"><button class="btn-icon" onclick="editGoal('${g.id}')"><i class="ri-edit-line"></i></button><button class="btn-icon" onclick="deleteGoal('${g.id}')"><i class="ri-delete-bin-line" style="color:var(--red)"></i></button></div>`:''}</div>`}).join('');
}
function renderDebts(){
  const el=document.getElementById('wallet-debts');if(!db.debts.length){el.innerHTML='<div class="empty"><i class="ri-bank-line"></i><p>–ù–µ—Ç –¥–æ–ª–≥–æ–≤ ‚Äî –∏ —ç—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ!</p></div>';return}
  el.innerHTML=db.debts.map(d=>{const rem=Number(d.amount)-Number(d.paid||0);const isPaid=rem<=0;const ml=Number(d.monthlyPayment)>0?Math.ceil(rem/Number(d.monthlyPayment)):0;const mc=d.affectsCashflow&&Number(d.percent)>0?Math.round(rem*Number(d.percent)/100/12):0;return`<div class="debt-card${isPaid?' paid':''}"><div class="debt-top"><div class="debt-name">${d.name}</div><div class="debt-badge${isPaid?' done':''}">${isPaid?'–ó–∞–∫—Ä—ã—Ç':'–ê–∫—Ç–∏–≤–µ–Ω'}</div></div><div class="debt-stat">–û—Å—Ç–∞–ª–æ—Å—å: <strong>${fmt(rem)}</strong> –∏–∑ ${fmt(d.amount)}<br>${d.percent?'–°—Ç–∞–≤–∫–∞: '+d.percent+'% –≥–æ–¥–æ–≤—ã—Ö<br>':''}${d.monthlyPayment?'–ü–ª–∞—Ç—ë–∂: '+fmt(d.monthlyPayment)+'/–º–µ—Å<br>':''}${mc?'–°—Ç–æ–∏—Ç –≤–∞–º: <strong style="color:var(--red)">'+fmt(mc)+'/–º–µ—Å</strong><br>':''}${ml>0?'‚âà '+ml+' –º–µ—Å –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è':''}</div><div class="prog-wrap"><div class="prog-bar"><div class="prog-fill" style="width:${Number(d.amount)>0?Math.round(Number(d.paid||0)/Number(d.amount)*100):0}%;background:var(--green)"></div></div></div><div class="debt-actions">${!isPaid?`<button class="btn btn-ghost btn-sm" onclick="openDebtPay('${d.id}')"><i class="ri-money-dollar-circle-line"></i> –í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç—ë–∂</button>`:''}<button class="btn btn-ghost btn-sm" onclick="editDebt('${d.id}')"><i class="ri-edit-line"></i> –ò–∑–º–µ–Ω–∏—Ç—å</button><button class="btn btn-ghost btn-sm" onclick="deleteDebt('${d.id}')" style="color:var(--red)"><i class="ri-delete-bin-line"></i></button></div>${!isPaid?`<p style="font-size:11px;color:var(--text3);margin-top:8px;font-style:italic">${MOTIV[Math.floor(Math.random()*MOTIV.length)]}</p>`:''}</div>`}).join('');
}

// === ANALYTICS ===
function renderAnalytics(){renderMonthLabels();const txs=db.transactions.filter(txInMonth);renderPieChart(txs);renderCatBreakdown(txs);renderWeekdays(txs);renderInsights(txs);renderAllTx(txs)}
function setStatsType(type){curStatsType=type;document.querySelectorAll('#stats-seg .seg-btn').forEach((b,i)=>b.classList.toggle('active',i===(type==='expense'?0:1)));renderAnalytics()}
function renderPieChart(txs){const f=txs.filter(t=>t.type===curStatsType);const m={};f.forEach(t=>{const c=t.category_id||'x';m[c]=(m[c]||0)+Number(t.amount)});const labels=[],data=[],colors=[];Object.keys(m).forEach(c=>{const cat=db.categories.find(x=>x.id===c)||{name:'–ü—Ä–æ—á–µ–µ',color:'#6B7280'};labels.push(cat.name);data.push(m[c]);colors.push(cat.color||'#6B7280')});const ctx=document.getElementById('chart-pie');if(chartPie)chartPie.destroy();if(!data.length){ctx.style.display='none';return}ctx.style.display='block';chartPie=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:colors,borderWidth:0}]},options:{responsive:true,maintainAspectRatio:true,cutout:'65%',plugins:{legend:{display:false}}}})}
function renderCatBreakdown(txs){const f=txs.filter(t=>t.type===curStatsType);const m={};f.forEach(t=>{const c=t.category_id||'x';m[c]=(m[c]||0)+Number(t.amount)});const total=f.reduce((s,t)=>s+Number(t.amount),0)||1;const sorted=Object.entries(m).sort((a,b)=>b[1]-a[1]);const el=document.getElementById('stats-cats');if(!sorted.length){el.innerHTML='<div class="empty"><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p></div>';return}el.innerHTML=sorted.map(([cid,amt])=>{const cat=db.categories.find(c=>c.id===cid)||{name:'–ü—Ä–æ—á–µ–µ',icon:'ri-question-line',color:'#6B7280'};const p=Math.round(amt/total*100);return`<div class="card" style="display:flex;align-items:center;gap:12px;padding:12px 16px"><div class="tx-icon" style="background:${cat.color}22"><i class="${cat.icon}" style="color:${cat.color}"></i></div><div style="flex:1"><div style="font-size:13px;font-weight:600">${cat.name}</div><div class="prog-bar" style="margin-top:4px"><div class="prog-fill" style="width:${p}%;background:${cat.color}"></div></div></div><div style="text-align:right"><div style="font-size:14px;font-weight:700">${fmt(amt)}</div><div style="font-size:11px;color:var(--text3)">${p}%</div></div></div>`}).join('')}
function renderWeekdays(txs){const f=txs.filter(t=>t.type===curStatsType);const days=[0,0,0,0,0,0,0];f.forEach(t=>{if(!t.date)return;let w=new Date(t.date).getDay();w=w===0?6:w-1;days[w]+=Number(t.amount)});const mx=Math.max(...days,1);document.getElementById('wd-bars').innerHTML=days.map(v=>`<div class="wd-bar" style="height:${Math.max(5,v/mx*100)}%"></div>`).join('');document.getElementById('wd-labels').innerHTML=WEEKDAYS_RU.map(d=>`<span>${d}</span>`).join('')}
function renderInsights(txs){const el=document.getElementById('insights-list');const ins=[];const et=txs.filter(t=>t.type==='expense');if(et.length){const m={};et.forEach(t=>{m[t.category_id]=(m[t.category_id]||0)+Number(t.amount)});const top=Object.entries(m).sort((a,b)=>b[1]-a[1])[0];if(top){const c=db.categories.find(x=>x.id===top[0]);if(c)ins.push(`–ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤: <strong>${c.name}</strong> ‚Äî ${fmt(top[1])}`)}}const it=txs.filter(t=>t.type==='income');if(it.length){const m={};it.forEach(t=>{m[t.category_id]=(m[t.category_id]||0)+Number(t.amount)});const top=Object.entries(m).sort((a,b)=>b[1]-a[1])[0];if(top){const c=db.categories.find(x=>x.id===top[0]);if(c)ins.push(`–ì–ª–∞–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞: <strong>${c.name}</strong> ‚Äî ${fmt(top[1])}`)}}if(et.length>3){const d=[0,0,0,0,0,0,0];et.forEach(t=>{if(!t.date)return;let w=new Date(t.date).getDay();w=w===0?6:w-1;d[w]+=Number(t.amount)});ins.push(`–°–∞–º—ã–π –∑–∞—Ç—Ä–∞—Ç–Ω—ã–π –¥–µ–Ω—å: <strong>${WEEKDAYS_RU[d.indexOf(Math.max(...d))]}</strong>`)}const invP=db.accounts.filter(a=>a.type==='invest'&&Number(a.percent)>0);if(invP.length){let t=0;invP.forEach(a=>t+=Math.round(Number(a.balance)*Number(a.percent)/100/12));ins.push(`–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ –æ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π: <strong>${fmt(t)}/–º–µ—Å</strong>`)}if(!ins.length){el.innerHTML='';return}el.innerHTML=ins.map(t=>`<div class="insight"><i class="ri-lightbulb-line"></i><p>${t}</p></div>`).join('')}
function renderAllTx(txs){const el=document.getElementById('all-tx-list');const s=[...txs].sort((a,b)=>new Date(b.date)-new Date(a.date));if(!s.length){el.innerHTML='<div class="empty"><i class="ri-inbox-line"></i><p>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p></div>';return}el.innerHTML=s.map(t=>{const cat=db.categories.find(c=>c.id===t.category_id)||{icon:'ri-question-line',name:'‚Äî',color:'#6B7280'};const acc=db.accounts.find(a=>a.id===t.account_id)||{name:'‚Äî'};return`<div class="tx-item"><div class="tx-icon" style="background:${cat.color}22"><i class="${cat.icon}" style="color:${cat.color}"></i></div><div class="tx-info"><div class="tx-name">${cat.name}</div><div class="tx-cat">${acc.name} ¬∑ ${fmtDate(t.date)}${t.comment?' ¬∑ '+t.comment:''}</div></div><div><div class="tx-amount ${t.type==='income'?'inc':'exp'}">${t.type==='income'?'+':'‚àí'}${fmt(Math.abs(t.amount))}</div></div></div>`}).join('')}

// === INVEST ===
function renderInvest(){const inv=db.accounts.filter(a=>a.type==='invest');const el=document.getElementById('inv-list');if(!inv.length){el.innerHTML='<div class="empty"><i class="ri-line-chart-line"></i><p>–ù–µ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π</p></div>';return}el.innerHTML=inv.map(a=>{const g=Number(a.percent)>0?Math.round(Number(a.balance)*Number(a.percent)/100/12):0;return`<div class="acc-card"><div class="acc-row"><div><div class="acc-name">${a.name}</div><div class="acc-type">${a.percent?a.percent+'% –≥–æ–¥–æ–≤—ã—Ö':'–ë–µ–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤'}${a.divDay?' ¬∑ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ '+a.divDay+'-–≥–æ':''}</div></div><div class="acc-bal">${fmt(a.balance)}</div></div>${g?`<div style="font-size:12px;color:var(--green);margin-top:4px">‚âà +${fmt(g)}/–º–µ—Å</div>`:''}<div class="card-actions"><button class="btn-icon" onclick="editAccount('${a.id}')"><i class="ri-edit-line"></i></button></div></div>`}).join('');renderInvChart(inv)}
function renderInvChart(accs){const ctx=document.getElementById('chart-inv');if(chartInv)chartInv.destroy();if(!accs.length){ctx.style.display='none';return}ctx.style.display='block';const labels=[];const datasets=[];accs.forEach((a,idx)=>{const data=[];let bal=Number(a.balance);for(let m=0;m<=12;m++){if(labels.length<=m)labels.push(m===0?'–°–µ–π—á–∞—Å':m+' –º–µ—Å');data.push(Math.round(bal));bal+=bal*(Number(a.percent)||0)/100/12}datasets.push({label:a.name,data,borderColor:COLORS[idx%COLORS.length],backgroundColor:COLORS[idx%COLORS.length]+'22',fill:true,tension:.4,borderWidth:2,pointRadius:0})});chartInv=new Chart(ctx,{type:'line',data:{labels,datasets},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:accs.length>1,labels:{color:'#94A3B8',font:{size:11}}}},scales:{x:{ticks:{color:'#475569',font:{size:10}},grid:{display:false}},y:{ticks:{color:'#475569',font:{size:10},callback:v=>fmt(v)},grid:{color:'rgba(255,255,255,0.04)'}}}}})}

// === PROFILE ===
function renderProfile(){document.getElementById('prof-avatar').textContent=(db.user.name||'?')[0].toUpperCase();document.getElementById('prof-name').textContent=db.user.name||'‚Äî';document.getElementById('prof-limit').textContent=fmt(db.user.limit);const isDark=!document.body.classList.contains('light');document.getElementById('theme-toggle').classList.toggle('on',isDark);document.getElementById('theme-icon').className=isDark?'ri-moon-line':'ri-sun-line'}

// === THEME ===
function initTheme(){if(localStorage.getItem('onyx_theme')==='light')document.body.classList.add('light')}
function toggleTheme(){document.body.classList.toggle('light');const isL=document.body.classList.contains('light');localStorage.setItem('onyx_theme',isL?'light':'dark');try{if(window.Telegram?.WebApp){const c=isL?'#F8FAFC':'#0A0A0F';window.Telegram.WebApp.setHeaderColor(c);window.Telegram.WebApp.setBackgroundColor(c)}}catch(e){}renderProfile()}

// === MODALS ===
function openModal(id){document.getElementById(id).classList.add('show')}
function closeModal(id){document.getElementById(id).classList.remove('show')}
document.querySelectorAll('.modal-overlay').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('show')})});

// === TX ===
function openAddTx(){document.getElementById('tx-amount').value='';document.getElementById('tx-comment').value='';document.getElementById('tx-date').value=new Date().toISOString().split('T')[0];setTxType('expense');populateTxAccounts();openModal('modal-tx')}
function setTxType(type){curTxType=type;document.querySelectorAll('#tx-seg .seg-btn').forEach((b,i)=>b.classList.toggle('active',i===(type==='expense'?0:1)));document.getElementById('tx-income-type-wrap').style.display=type==='income'?'block':'none';populateTxCats()}
function populateTxAccounts(){document.getElementById('tx-account').innerHTML=db.accounts.map(a=>`<option value="${a.id}">${a.name} (${fmt(a.balance)})</option>`).join('')}
function populateTxCats(){const cats=db.categories.filter(c=>c.type===curTxType);selectedCatId=cats.length?cats[0].id:null;renderCatGrid()}
function renderCatGrid(){const cats=db.categories.filter(c=>c.type===curTxType);document.getElementById('tx-cats').innerHTML=cats.map(c=>`<div class="cat-opt${c.id===selectedCatId?' sel':''}" data-cid="${c.id}"><i class="${c.icon}" style="color:${c.color}"></i><span>${c.name}</span></div>`).join('');document.querySelectorAll('#tx-cats .cat-opt').forEach(el=>{el.addEventListener('click',function(){selectedCatId=this.dataset.cid;document.querySelectorAll('#tx-cats .cat-opt').forEach(x=>x.classList.remove('sel'));this.classList.add('sel')})})}
function saveTx(){const amount=parseMoney(document.getElementById('tx-amount'));const accId=document.getElementById('tx-account').value;const date=document.getElementById('tx-date').value;const comment=document.getElementById('tx-comment').value.trim();const incType=document.getElementById('tx-income-type').value;if(!amount||amount<=0){toast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');return}if(!accId){toast('–í—ã–±–µ—Ä–∏—Ç–µ —Å—á—ë—Ç');return}if(!selectedCatId){toast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');return}db.transactions.push({id:'tx_'+Date.now(),user_id:db.user.id,date:date||new Date().toISOString().split('T')[0],amount,type:curTxType,account_id:accId,category_id:selectedCatId,comment,is_waste:'',incomeType:curTxType==='income'?incType:''});const acc=db.accounts.find(a=>a.id===accId);if(acc)acc.balance=Number(acc.balance)+(curTxType==='income'?amount:-amount);saveDB();pushData();closeModal('modal-tx');toast(curTxType==='income'?'–î–æ—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω':'–†–∞—Å—Ö–æ–¥ –∑–∞–ø–∏—Å–∞–Ω');const scr=document.querySelector('.screen.active');if(scr)go(scr.id.replace('scr-',''))}

// === ACCOUNTS ===
function openWalletAdd(){if(curWalletTab==='accounts')openAddAccount('card');if(curWalletTab==='goals')openAddGoal();if(curWalletTab==='debts')openAddDebt()}
function openAddAccount(type){document.getElementById('acc-name').value='';document.getElementById('acc-balance').value='';document.getElementById('acc-percent').value='';document.getElementById('acc-divday').value='';document.getElementById('acc-goal').value='';document.getElementById('acc-type').value=type||'card';document.getElementById('acc-as-income').classList.remove('on');updateAccForm();openModal('modal-acc')}
function updateAccForm(){const t=document.getElementById('acc-type').value;document.getElementById('acc-divday-wrap').style.display=t==='invest'?'block':'none';document.getElementById('acc-goal-wrap').style.display=(t==='jar'||t==='invest')?'block':'none';document.getElementById('acc-income-row').style.display=t==='invest'?'flex':'none';document.getElementById('acc-modal-title').textContent=t==='invest'?'–ù–æ–≤–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è':t==='jar'?'–ù–æ–≤–∞—è –∫–æ–ø–∏–ª–∫–∞':'–ù–æ–≤—ã–π —Å—á—ë—Ç'}
function saveAccount(){const name=document.getElementById('acc-name').value.trim();if(!name){toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return}db.accounts.push({id:'a_'+Date.now(),user_id:db.user.id,name,type:document.getElementById('acc-type').value,balance:parseMoney(document.getElementById('acc-balance')),goal:document.getElementById('acc-goal').value?String(parseMoney(document.getElementById('acc-goal'))):'',percent:Number(document.getElementById('acc-percent').value)||0,divDay:document.getElementById('acc-divday').value||'',currency:'RUB'});saveDB();pushData();closeModal('modal-acc');toast('–°—á—ë—Ç —Å–æ–∑–¥–∞–Ω');renderWallet()}
function editAccount(id){const a=db.accounts.find(x=>x.id===id);if(!a)return;document.getElementById('ea-name').value=a.name;document.getElementById('ea-balance').value=Number(a.balance).toLocaleString('ru-RU');document.getElementById('ea-percent').value=a.percent||'';document.getElementById('ea-divday').value=a.divDay||'';document.getElementById('ea-goal').value=a.goal?Number(a.goal).toLocaleString('ru-RU'):'';document.getElementById('ea-id').value=id;document.getElementById('ea-divday-wrap').style.display=a.type==='invest'?'block':'none';document.getElementById('ea-goal-wrap').style.display=(a.type==='jar'||a.type==='invest')?'block':'none';openModal('modal-edit-acc')}
function saveEditAccount(){const id=document.getElementById('ea-id').value;const a=db.accounts.find(x=>x.id===id);if(!a)return;a.name=document.getElementById('ea-name').value.trim()||a.name;a.balance=parseMoney(document.getElementById('ea-balance'));a.percent=Number(document.getElementById('ea-percent').value)||0;a.divDay=document.getElementById('ea-divday').value||'';const gv=parseMoney(document.getElementById('ea-goal'));a.goal=gv?String(gv):'';saveDB();pushData();closeModal('modal-edit-acc');toast('–°—á—ë—Ç –æ–±–Ω–æ–≤–ª—ë–Ω');const scr=document.querySelector('.screen.active');if(scr)go(scr.id.replace('scr-',''))}
function deleteAccount(){if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å—á—ë—Ç?'))return;db.accounts=db.accounts.filter(a=>a.id!==document.getElementById('ea-id').value);saveDB();pushData();closeModal('modal-edit-acc');toast('–°—á—ë—Ç —É–¥–∞–ª—ë–Ω');renderWallet()}

// === GOALS ===
function openAddGoal(){document.getElementById('goal-name').value='';document.getElementById('goal-target').value='';document.getElementById('goal-current').value='';document.getElementById('goal-account').innerHTML='<option value="">–ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏</option>'+db.accounts.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');openModal('modal-goal')}
function saveGoal(){const name=document.getElementById('goal-name').value.trim();const target=parseMoney(document.getElementById('goal-target'));if(!name||!target){toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—É–º–º—É');return}db.goals.push({id:'g_'+Date.now(),user_id:db.user.id,name,target,current:parseMoney(document.getElementById('goal-current')),color:COLORS[db.goals.length%COLORS.length],accountId:document.getElementById('goal-account').value||''});saveDB();pushData();closeModal('modal-goal');toast('–¶–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞');renderWallet()}
function editGoal(id){const g=db.goals.find(x=>x.id===id);if(!g)return;document.getElementById('goal-name').value=g.name;document.getElementById('goal-target').value=Number(g.target).toLocaleString('ru-RU');document.getElementById('goal-current').value=Number(g.current).toLocaleString('ru-RU');document.getElementById('goal-account').innerHTML='<option value="">–ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏</option>'+db.accounts.map(a=>`<option value="${a.id}"${a.id===g.accountId?' selected':''}>${a.name}</option>`).join('');db.goals=db.goals.filter(x=>x.id!==id);saveDB();openModal('modal-goal')}
function deleteGoal(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å?'))return;db.goals=db.goals.filter(g=>g.id!==id);saveDB();pushData();renderWallet()}

// === DEBTS ===
function openAddDebt(){document.getElementById('debt-name').value='';document.getElementById('debt-amount').value='';document.getElementById('debt-monthly').value='';document.getElementById('debt-percent').value='';document.getElementById('debt-duedate').value='';document.getElementById('debt-affects-cf').classList.remove('on');document.getElementById('debt-edit-id').value='';document.getElementById('debt-modal-title').textContent='–ù–æ–≤—ã–π –¥–æ–ª–≥';openModal('modal-debt')}
function saveDebt(){const name=document.getElementById('debt-name').value.trim();const amount=parseMoney(document.getElementById('debt-amount'));if(!name||!amount){toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—É–º–º—É');return}const editId=document.getElementById('debt-edit-id').value;const obj={id:editId||'d_'+Date.now(),user_id:db.user.id,name,amount,percent:Number(document.getElementById('debt-percent').value)||0,dueDate:document.getElementById('debt-duedate').value||'',paid:0,monthlyPayment:parseMoney(document.getElementById('debt-monthly')),payments:'[]',affectsCashflow:document.getElementById('debt-affects-cf').classList.contains('on')};if(editId){const old=db.debts.find(d=>d.id===editId);if(old){obj.paid=old.paid;obj.payments=old.payments}db.debts=db.debts.filter(d=>d.id!==editId)}db.debts.push(obj);saveDB();pushData();closeModal('modal-debt');toast(editId?'–î–æ–ª–≥ –æ–±–Ω–æ–≤–ª—ë–Ω':'–î–æ–ª–≥ –¥–æ–±–∞–≤–ª–µ–Ω');renderWallet()}
function editDebt(id){const d=db.debts.find(x=>x.id===id);if(!d)return;document.getElementById('debt-name').value=d.name;document.getElementById('debt-amount').value=Number(d.amount).toLocaleString('ru-RU');document.getElementById('debt-monthly').value=Number(d.monthlyPayment).toLocaleString('ru-RU');document.getElementById('debt-percent').value=d.percent;document.getElementById('debt-duedate').value=d.dueDate;document.getElementById('debt-affects-cf').classList.toggle('on',!!d.affectsCashflow);document.getElementById('debt-edit-id').value=id;document.getElementById('debt-modal-title').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ª–≥';openModal('modal-debt')}
function deleteDebt(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–ª–≥?'))return;db.debts=db.debts.filter(d=>d.id!==id);saveDB();pushData();renderWallet();toast('–î–æ–ª–≥ —É–¥–∞–ª—ë–Ω')}

// === DEBT PAY ===
function openDebtPay(id){payingDebtId=id;const d=db.debts.find(x=>x.id===id);if(!d)return;document.getElementById('debt-pay-title').textContent='–ü–ª–∞—Ç—ë–∂: '+d.name;document.getElementById('debt-pay-amount').value=d.monthlyPayment?Number(d.monthlyPayment).toLocaleString('ru-RU'):'';document.getElementById('debt-pay-account').innerHTML=db.accounts.filter(a=>a.type!=='invest').map(a=>`<option value="${a.id}">${a.name} (${fmt(a.balance)})</option>`).join('');curDebtPayType='regular';document.querySelectorAll('#debt-pay-seg .seg-btn').forEach((b,i)=>b.classList.toggle('active',i===0));openModal('modal-debt-pay')}
function setDebtPayType(t){curDebtPayType=t;document.querySelectorAll('#debt-pay-seg .seg-btn').forEach((b,i)=>b.classList.toggle('active',(t==='regular'?0:1)===i))}
function payDebt(){const d=db.debts.find(x=>x.id===payingDebtId);if(!d){toast('–î–æ–ª–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω');return}const amount=parseMoney(document.getElementById('debt-pay-amount'));const accId=document.getElementById('debt-pay-account').value;if(!amount||amount<=0){toast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');return}if(!accId){toast('–í—ã–±–µ—Ä–∏—Ç–µ —Å—á—ë—Ç');return}const acc=db.accounts.find(a=>a.id===accId);if(!acc)return;acc.balance=Number(acc.balance)-amount;d.paid=Number(d.paid||0)+amount;let payments=[];try{payments=JSON.parse(d.payments||'[]')}catch(e){}payments.push({date:new Date().toISOString(),amount,type:curDebtPayType});d.payments=JSON.stringify(payments);let dc=db.categories.find(c=>c.name==='–ü–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞'&&c.type==='expense');if(!dc){dc={id:'c_debt_'+Date.now(),user_id:db.user.id,name:'–ü–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞',type:'expense',icon:'ri-bank-line',color:'#EF4444'};db.categories.push(dc)}db.transactions.push({id:'tx_'+Date.now(),user_id:db.user.id,date:new Date().toISOString().split('T')[0],amount,type:'expense',account_id:accId,category_id:dc.id,comment:(curDebtPayType==='early'?'–î–æ—Å—Ä–æ—á–Ω—ã–π: ':'')+d.name,is_waste:'',incomeType:''});saveDB();pushData();closeModal('modal-debt-pay');toast('–ü–ª–∞—Ç—ë–∂ –≤–Ω–µ—Å—ë–Ω: '+fmt(amount));renderWallet()}

// === CATEGORIES ===
function manageCategories(){curCatManageType='expense';renderCatManage();openModal('modal-cats')}
function setCatManageType(t){curCatManageType=t;document.querySelectorAll('#cat-manage-seg .seg-btn').forEach((b,i)=>b.classList.toggle('active',(t==='expense'?0:1)===i));renderCatManage()}
function renderCatManage(){const cats=db.categories.filter(c=>c.type===curCatManageType);document.getElementById('cat-manage-list').innerHTML=cats.map(c=>`<div class="card" style="display:flex;align-items:center;gap:12px;padding:12px 16px"><div class="tx-icon" style="background:${c.color}22"><i class="${c.icon}" style="color:${c.color}"></i></div><div style="flex:1;font-size:14px;font-weight:500">${c.name}</div><i class="ri-delete-bin-line" style="color:var(--red);cursor:pointer;font-size:18px" onclick="deleteCat('${c.id}')"></i></div>`).join('')}
function deleteCat(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;db.categories=db.categories.filter(c=>c.id!==id);saveDB();pushData();renderCatManage()}
function openAddCat(){document.getElementById('new-cat-name').value='';selectedIcon=ICONS[0];renderIconPicker();openModal('modal-add-cat')}
function renderIconPicker(){document.getElementById('icon-picker').innerHTML=ICONS.map(ic=>`<div class="cat-opt${ic===selectedIcon?' sel':''}" data-icon="${ic}"><i class="${ic}"></i></div>`).join('');document.querySelectorAll('#icon-picker .cat-opt').forEach(el=>{el.addEventListener('click',function(){selectedIcon=this.dataset.icon;document.querySelectorAll('#icon-picker .cat-opt').forEach(x=>x.classList.remove('sel'));this.classList.add('sel')})})}
function saveCat(){const name=document.getElementById('new-cat-name').value.trim();if(!name){toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return}db.categories.push({id:'c_'+Date.now(),user_id:db.user.id,name,type:document.getElementById('new-cat-type').value,icon:selectedIcon||'ri-price-tag-3-line',color:COLORS[db.categories.length%COLORS.length]});saveDB();pushData();closeModal('modal-add-cat');toast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞');renderCatManage()}

// === TRANSFER ===
function openTransfer(){const o=db.accounts.map(a=>`<option value="${a.id}">${a.name} (${fmt(a.balance)})</option>`).join('');document.getElementById('tr-from').innerHTML=o;document.getElementById('tr-to').innerHTML=o;document.getElementById('tr-amount').value='';openModal('modal-transfer')}
function openTransferTo(toId){openTransfer();document.getElementById('tr-to').value=toId}
function doTransfer(){const fid=document.getElementById('tr-from').value,tid=document.getElementById('tr-to').value,a=parseMoney(document.getElementById('tr-amount'));if(fid===tid){toast('–†–∞–∑–Ω—ã–µ —Å—á–µ—Ç–∞');return}if(!a||a<=0){toast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');return}const f=db.accounts.find(x=>x.id===fid),t=db.accounts.find(x=>x.id===tid);if(!f||!t)return;f.balance=Number(f.balance)-a;t.balance=Number(t.balance)+a;saveDB();pushData();closeModal('modal-transfer');toast('–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ '+fmt(a));const scr=document.querySelector('.screen.active');if(scr)go(scr.id.replace('scr-',''))}

// === LIMIT ===
function openEditLimit(){document.getElementById('edit-limit').value=Number(db.user.limit).toLocaleString('ru-RU');openModal('modal-limit')}
function saveLimit(){db.user.limit=parseMoney(document.getElementById('edit-limit'));saveDB();pushData();closeModal('modal-limit');toast('–õ–∏–º–∏—Ç –æ–±–Ω–æ–≤–ª—ë–Ω');renderProfile()}

// === EXPORT ===
function exportData(){const text=JSON.stringify(db,null,2);document.getElementById('export-text').value=text;openModal('modal-export');try{navigator.clipboard.writeText(text);toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä')}catch(e){toast('–î–∞–Ω–Ω—ã–µ –≤ –æ–∫–Ω–µ –Ω–∏–∂–µ')}}
function copyExport(){try{navigator.clipboard.writeText(document.getElementById('export-text').value);toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!')}catch(e){document.getElementById('export-text').select();document.execCommand('copy');toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!')}}

// === SYNC ===
async function pushData(){try{await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'sync_all',user_id:db.user.id,user:db.user,accounts:db.accounts,categories:db.categories,transactions:db.transactions,goals:db.goals,debts:db.debts})})}catch(e){console.warn('Push err',e)}}
async function loadFromServer(){try{const r=await fetch(API_URL+'?action=load&user_id='+encodeURIComponent(db.user.id));const d=await r.json();if(d.status==='success'){if(d.accounts?.length)db.accounts=d.accounts;if(d.categories?.length)db.categories=d.categories;if(d.transactions?.length)db.transactions=d.transactions;if(d.goals?.length)db.goals=d.goals;if(d.debts?.length)db.debts=d.debts;if(d.user?.name){db.user.name=d.user.name;db.user.limit=d.user.limit||db.user.limit}migrate();saveDB();const scr=document.querySelector('.screen.active');if(scr&&scr.id!=='scr-onb')go(scr.id.replace('scr-',''))}}catch(e){console.warn('Load err',e)}}
function syncNow(){toast('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...');pushData().then(()=>loadFromServer()).then(()=>toast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã'))}

// === RESET ===
function resetApp(){if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –ù–µ–æ–±—Ä–∞—Ç–∏–º–æ.'))return;localStorage.removeItem(DB_KEY);location.reload()}

// === TOAST ===
function toast(m){const el=document.getElementById('toast');el.textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2500)}

// === PREVENT iOS SCROLL BOUNCE ON INPUTS ===
document.addEventListener('focusin',e=>{if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'){setTimeout(()=>{e.target.scrollIntoView({behavior:'smooth',block:'center'})},300)}});

// === TELEGRAM ===
try{if(window.Telegram?.WebApp){window.Telegram.WebApp.ready();window.Telegram.WebApp.expand();const isDark=!document.body.classList.contains('light');const c=isDark?'#0A0A0F':'#F8FAFC';window.Telegram.WebApp.setHeaderColor(c);window.Telegram.WebApp.setBackgroundColor(c)}}catch(e){}

// === START ===
init();
</script>
</body>
</html>
