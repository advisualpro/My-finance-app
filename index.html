<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyCosts Platinum</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #F2F4F6; --card: #FFFFFF; --text: #1F2937; --text-sec: #6B7280;
            --primary: #6366F1; --accent: #8B5CF6; --success: #10B981; --danger: #EF4444;
            --glass: rgba(255, 255, 255, 0.9);
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.08);
            --radius: 24px;
        }
        [data-theme="dark"] {
            --bg: #0F1117; --card: #1E232F; --text: #F3F4F6; --text-sec: #9CA3AF;
            --primary: #818CF8; --glass: rgba(30, 35, 47, 0.9);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 110px; transition: 0.3s; user-select: none; }
        
        .container { padding: 20px; max-width: 480px; margin: 0 auto; }
        
        /* Typography */
        h1, h2, h3 { margin: 0; font-weight: 800; letter-spacing: -0.5px; }
        .text-xs { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-sec); letter-spacing: 0.8px; margin-bottom: 8px; }
        
        /* Cards */
        .card { background: var(--card); border-radius: var(--radius); padding: 24px; margin-bottom: 16px; box-shadow: var(--shadow); position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,0.03); }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }

        /* Onboarding Overlay */
        #onboarding { position: fixed; inset: 0; background: var(--bg); z-index: 5000; padding: 40px 20px; display: flex; flex-direction: column; justify-content: center; text-align: center; transition: 0.5s; }
        #onboarding.fade-out { opacity: 0; pointer-events: none; transform: scale(1.1); }
        
        /* Buttons */
        .btn-main {
            width: 100%; padding: 18px; border-radius: 20px; border: none;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; font-size: 16px; font-weight: 700;
            box-shadow: 0 8px 20px -5px rgba(99, 102, 241, 0.4);
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-main:active { transform: scale(0.96); }

        .btn-icon { width: 44px; height: 44px; border-radius: 50%; border: none; background: var(--card); color: var(--text); box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }

        /* Inputs */
        .input-lg { width: 100%; font-size: 40px; font-weight: 800; text-align: center; background: transparent; border: none; color: var(--text); outline: none; padding: 20px 0; }
        .input-std { width: 100%; padding: 16px; border-radius: 16px; background: var(--bg); border: 2px solid transparent; color: var(--text); font-size: 16px; outline: none; margin-bottom: 16px; transition: 0.3s; }
        .input-std:focus { border-color: var(--primary); background: var(--card); }

        /* Sliders */
        .slider-wrap { overflow-x: auto; display: flex; gap: 12px; padding: 5px 20px 20px; margin: 0 -20px; scrollbar-width: none; }
        .slider-wrap::-webkit-scrollbar { display: none; }
        
        .acc-card { 
            min-width: 160px; background: var(--card); border-radius: 20px; padding: 16px; 
            border: 2px solid transparent; transition: 0.2s; position: relative;
        }
        .acc-card.active { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
        
        /* Navigation */
        .nav-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: var(--glass); backdrop-filter: blur(20px);
            border-radius: 28px; padding: 12px 30px; display: flex; justify-content: space-between;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15); z-index: 100; border: 1px solid rgba(255,255,255,0.1);
        }
        .nav-item { background: none; border: none; color: var(--text-sec); font-size: 26px; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }
        .nav-item.active::after { content:''; position:absolute; bottom:-10px; left:50%; transform:translateX(-50%); width:5px; height:5px; background:var(--primary); border-radius:50%; }

        /* Transaction List */
        .tx-row { display: flex; align-items: center; gap: 15px; padding: 14px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .tx-icon { width: 48px; height: 48px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
        
        /* Switcher */
        .seg-control { display: flex; background: var(--bg); padding: 5px; border-radius: 16px; margin-bottom: 20px; }
        .seg-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-sec); font-weight: 600; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        .seg-btn.active { background: var(--card); color: var(--text); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* Modals */
        .modal { position: fixed; inset: 0; background: var(--bg); z-index: 2000; padding: 20px; transform: translateY(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); overflow-y: auto;}
        .modal.show { transform: translateY(0); }
        
        /* Icons Grid */
        .icon-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .icon-tile { aspect-ratio: 1; background: var(--bg); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .icon-tile.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); color: var(--primary); }

        .hidden { display: none !important; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- ONBOARDING (–¢–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —é–∑–µ—Ä–æ–≤) -->
    <div id="onboarding" class="hidden">
        <div style="font-size: 60px; margin-bottom: 20px;">üëã</div>
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
        <p style="color: var(--text-sec); margin-bottom: 40px; line-height: 1.5;">
            –¢–≤–æ–π –ª–∏—á–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä.<br>
            –£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤, –¥–æ—Ö–æ–¥—ã –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏<br>
            –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.
        </p>
        <div class="card" style="text-align: left;">
            <label class="text-xs">–ö–∞–∫ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è?</label>
            <input type="text" id="ob-name" class="std-input" placeholder="–ò–º—è" style="margin-bottom: 0;">
        </div>
        <button class="btn-main" onclick="finishOnboarding()">–ù–∞—á–∞—Ç—å</button>
    </div>

    <!-- APP CONTAINER -->
    <div id="app" class="container">
        
        <!-- HEADER -->
        <header class="flex-between" style="margin-bottom: 24px;">
            <div>
                <div class="text-xs" id="header-id">ID: ...</div>
                <h2 id="header-name">–ü—Ä–∏–≤–µ—Ç!</h2>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn-icon" onclick="syncData()"><i class="ri-refresh-line" id="sync-icon"></i></button>
                <button class="btn-icon" onclick="toggleTheme()"><i class="ri-moon-line"></i></button>
            </div>
        </header>

        <!-- SCREEN: HOME -->
        <div id="scr-home" class="screen">
            <!-- Total Balance Card -->
            <div class="card" style="text-align: center; padding: 32px 20px;">
                <div class="text-xs">–û–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª</div>
                <div style="font-size: 46px; font-weight: 800; margin: 12px 0; letter-spacing: -1px;" id="total-bal">0 ‚ÇΩ</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px;">
                    <button class="btn-main" style="background: var(--bg); color: var(--danger); box-shadow: none;" onclick="openTxModal('expense')">
                        <i class="ri-arrow-down-circle-fill"></i> –†–∞—Å—Ö–æ–¥
                    </button>
                    <button class="btn-main" style="background: var(--bg); color: var(--success); box-shadow: none;" onclick="openTxModal('income')">
                        <i class="ri-arrow-up-circle-fill"></i> –î–æ—Ö–æ–¥
                    </button>
                </div>
            </div>

            <div class="flex-between"><h4>–ú–æ–∏ –°—á–µ—Ç–∞</h4> <span class="text-xs" onclick="nav('wallet')">–í–°–ï</span></div>
            <div class="slider-wrap" id="home-accs"></div>

            <div class="card">
                <div class="flex-between" style="margin-bottom:15px;"><h4>–¢—Ä–µ–Ω–¥ –Ω–µ–¥–µ–ª–∏</h4> <span class="text-xs" id="week-sum">0 ‚ÇΩ</span></div>
                <div style="height: 140px;"><canvas id="chart-week"></canvas></div>
            </div>

            <div class="flex-between"><h4>–ò—Å—Ç–æ—Ä–∏—è</h4> <span class="text-xs" onclick="nav('stats')">–ê–ù–ê–õ–ò–ó</span></div>
            <div id="home-txs" style="padding-bottom: 30px;"></div>
        </div>

        <!-- SCREEN: STATS -->
        <div id="scr-stats" class="screen hidden">
            <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            
            <div class="seg-control" style="margin-top: 20px;">
                <button class="seg-btn active" onclick="setStatMode('expense', this)">–†–∞—Å—Ö–æ–¥—ã</button>
                <button class="seg-btn" onclick="setStatMode('income', this)">–î–æ—Ö–æ–¥—ã</button>
            </div>

            <div class="card">
                <div style="height: 260px; position: relative;"><canvas id="chart-pie"></canvas></div>
            </div>

            <div id="stats-list"></div>
        </div>

        <!-- SCREEN: WALLET -->
        <div id="scr-wallet" class="screen hidden">
            <h2>–ö–æ—à–µ–ª–µ–∫</h2>
            
            <div class="card" style="margin-top: 20px;">
                <div class="flex-between"><h4>–°—á–µ—Ç–∞</h4> <button class="text-xs" style="background:none; border:none; color:var(--primary); font-size:13px;" onclick="openAccModal()">+ –°–û–ó–î–ê–¢–¨</button></div>
                <div id="wallet-accs" style="margin-top: 15px;"></div>
            </div>

            <div class="card">
                <div class="flex-between"><h4>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h4> <button class="text-xs" style="background:none; border:none; color:var(--primary); font-size:13px;" onclick="openCatModal()">+ –°–û–ó–î–ê–¢–¨</button></div>
                <div id="wallet-cats" style="margin-top: 15px;"></div>
            </div>
            
            <button class="btn-main" style="background: #1F2937; margin-top: 30px;" onclick="forceSync()">
                <i class="ri-cloud-line"></i> –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –æ–±–ª–∞–∫–æ
            </button>
        </div>

    </div>

    <!-- NAVBAR -->
    <nav class="nav-bar">
        <button class="nav-item active" onclick="nav('home', this)"><i class="ri-home-4-fill"></i></button>
        <button class="nav-item" onclick="nav('stats', this)"><i class="ri-pie-chart-fill"></i></button>
        <button class="nav-item" onclick="nav('wallet', this)"><i class="ri-wallet-fill"></i></button>
    </nav>

    <!-- MODAL: TRANSACTION -->
    <div id="modal-tx" class="modal">
        <div class="flex-between"><h2 id="mtx-title">–†–∞—Å—Ö–æ–¥</h2> <button class="btn-icon" onclick="closeModal('modal-tx')"><i class="ri-close-line"></i></button></div>
        
        <input type="number" id="mtx-amt" class="input-xl" placeholder="0" inputmode="decimal">
        
        <div class="text-xs">–°—á–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è</div>
        <div class="slider-wrap" id="mtx-accs" style="margin: 0 -20px 20px;"></div>

        <div class="text-xs">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
        <div class="icon-grid" id="mtx-cats"></div>
        
        <!-- Waste Toggle -->
        <div id="mtx-waste-wrap" class="seg-control hidden">
            <button class="seg-btn active" onclick="setWaste(false)" id="btn-waste-no">–ü–æ–ª–µ–∑–Ω–æ–µ ‚úÖ</button>
            <button class="seg-btn" style="color:var(--danger)" onclick="setWaste(true)" id="btn-waste-yes">–ú—É—Å–æ—Ä / –•–æ—Ç–µ–ª–∫–∞ üóëÔ∏è</button>
        </div>

        <input type="text" id="mtx-note" class="input-std" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
        <input type="date" id="mtx-date" class="input-std">
        
        <button class="btn-main" onclick="saveTx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- MODAL: ACCOUNT -->
    <div id="modal-acc" class="modal">
        <div class="flex-between"><h2>–ù–æ–≤—ã–π —Å—á–µ—Ç</h2> <button class="btn-icon" onclick="closeModal('modal-acc')"><i class="ri-close-line"></i></button></div>
        <br>
        <input type="text" id="macc-name" class="input-std" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –¢–∏–Ω—å–∫–æ—Ñ—Ñ)">
        
        <div class="text-xs">–¢–∏–ø —Å—á–µ—Ç–∞</div>
        <div class="seg-control">
            <button class="seg-btn active" onclick="setAccType('card')" id="btn-atype-card">–ö–∞—Ä—Ç–∞</button>
            <button class="seg-btn" onclick="setAccType('deposit')" id="btn-atype-dep">–í–∫–ª–∞–¥</button>
            <button class="seg-btn" onclick="setAccType('invest')" id="btn-atype-inv">–ò–Ω–≤–µ—Å—Ç</button>
        </div>

        <div id="macc-extra" class="hidden">
            <input type="number" id="macc-goal" class="input-std" placeholder="–¶–µ–ª—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è">
            <input type="number" id="macc-percent" class="input-std" placeholder="% –ì–æ–¥–æ–≤—ã—Ö">
        </div>
        
        <input type="number" id="macc-start" class="input-std" placeholder="–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å">
        <button class="btn-main" onclick="saveAcc()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <!-- MODAL: CATEGORY -->
    <div id="modal-cat" class="modal">
        <div class="flex-between"><h2>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2> <button class="btn-icon" onclick="closeModal('modal-cat')"><i class="ri-close-line"></i></button></div>
        <br>
        <input type="text" id="mcat-name" class="input-std" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        
        <div class="seg-control">
            <button class="seg-btn active" onclick="setCatType('expense')" id="btn-ctype-exp">–†–∞—Å—Ö–æ–¥</button>
            <button class="seg-btn" onclick="setCatType('income')" id="btn-ctype-inc">–î–æ—Ö–æ–¥</button>
        </div>
        
        <div class="text-xs">–ò–∫–æ–Ω–∫–∞</div>
        <div class="icon-grid" id="mcat-icons"></div>
        <button class="btn-main" onclick="saveCat()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <script>
        // --- CONFIG ---
        const API_URL = 'https://script.google.com/macros/s/AKfycby_ES9U2-4VYmPhMLbDtNNv_ESnbUEI9nlw0euEHsxZ6eJqu340_LpF_A1pSxyUvRxG/exec';

        // --- INIT ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // Data Store
        const DEFAULT_DATA = {
            user: { name: '–ì–æ—Å—Ç—å', joined: Date.now() },
            accounts: [],
            categories: [
                {id:'c1', name:'–ï–¥–∞', type:'expense', icon:'ri-restaurant-line', color:'#F59E0B'},
                {id:'c2', name:'–¢–∞–∫—Å–∏', type:'expense', icon:'ri-taxi-line', color:'#3B82F6'},
                {id:'c3', name:'–î–æ–º', type:'expense', icon:'ri-home-4-line', color:'#8B5CF6'},
                {id:'c4', name:'–ó–∞—Ä–ø–ª–∞—Ç–∞', type:'income', icon:'ri-briefcase-4-line', color:'#10B981'},
                {id:'c5', name:'–ü—Ä–æ–µ–∫—Ç—ã', type:'income', icon:'ri-lightbulb-flash-line', color:'#6366F1'}
            ],
            transactions: []
        };
        
        let db = JSON.parse(localStorage.getItem('mcp_db')) || DEFAULT_DATA;
        let USER_ID = localStorage.getItem('mcp_uid');
        
        // Setup User ID
        if(!USER_ID) {
            if(tg.initDataUnsafe?.user?.id) USER_ID = 'tg_' + tg.initDataUnsafe.user.id;
            else USER_ID = 'user_' + Date.now().toString().slice(-6);
            localStorage.setItem('mcp_uid', USER_ID);
        }

        // --- ONBOARDING LOGIC ---
        if(db.accounts.length === 0) {
            document.getElementById('onboarding').classList.remove('hidden');
        } else {
            document.getElementById('header-name').innerText = db.user.name;
            document.getElementById('header-id').innerText = 'ID: ' + USER_ID.slice(0,8);
        }

        function finishOnboarding() {
            const name = document.getElementById('ob-name').value || '–£–ø—Ä–∞–≤–ª–µ–Ω–µ—Ü';
            db.user.name = name;
            // Create default account
            db.accounts.push({ id:'a1', name:'–û—Å–Ω–æ–≤–Ω–æ–π', type:'card', balance:0, start:0, goal:0, percent:0, lastCalc:Date.now() });
            
            document.getElementById('header-name').innerText = name;
            document.getElementById('header-id').innerText = 'ID: ' + USER_ID.slice(0,8);
            
            document.getElementById('onboarding').classList.add('fade-out');
            saveLocal();
            syncData(); // First sync to register user
        }

        // --- CORE FUNCTIONS ---
        function saveLocal() { localStorage.setItem('mcp_db', JSON.stringify(db)); renderHome(); }
        function vibe(style='light') { try{ tg.HapticFeedback.impactOccurred(style); }catch(e){} }

        // --- SYNC ENGINE ---
        async function syncData() {
            vibe('medium');
            const icon = document.getElementById('sync-icon'); icon.classList.add('spin');
            try {
                const res = await fetch(`${API_URL}?action=load&user_id=${USER_ID}`);
                const json = await res.json();
                if(json.status === 'success') {
                    if(json.data.accounts.length) db.accounts = json.data.accounts;
                    if(json.data.categories.length) db.categories = json.data.categories;
                    if(json.data.transactions.length) db.transactions = json.data.transactions;
                    
                    // Calc Interest
                    let changed = false;
                    const now = Date.now();
                    db.accounts.forEach(acc => {
                        if(acc.type === 'deposit' && acc.percent > 0) {
                            const last = acc.lastCalc || now;
                            const days = (now - last) / 86400000;
                            if(days >= 1) {
                                const profit = acc.balance * (acc.percent/100/365) * days;
                                if(profit > 0.1) {
                                    db.transactions.push({id:'sys_'+Date.now(), date:new Date().toISOString(), amount:profit, type:'income', accountId:acc.id, categoryId:'sys_int', comment:'% –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ', isWaste:false});
                                    acc.lastCalc = now; changed = true;
                                }
                            }
                        }
                    });
                    
                    if(changed) recalc(); else saveLocal();
                    console.log('Synced');
                }
            } catch(e) { console.error(e); } finally { icon.classList.remove('spin'); }
        }

        async function pushTx(tx) {
            try { fetch(API_URL+'?action=add_tx', {method:'POST', mode:'no-cors', body:JSON.stringify({...tx, user_id:USER_ID})}); } catch(e){}
        }

        async function forceSync() {
            if(!confirm('–ó–∞–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–µ?')) return;
            vibe('heavy');
            try {
                await fetch(API_URL+'?action=sync_all', {method:'POST', mode:'no-cors', body:JSON.stringify({user_id:USER_ID, accounts:db.accounts, categories:db.categories, transactions:db.transactions})});
                alert('–û–±–ª–∞–∫–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
            } catch(e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
        }

        function recalc() {
            db.accounts.forEach(a => a.balance = parseFloat(a.start||0));
            db.transactions.forEach(t => {
                const acc = db.accounts.find(a => a.id == t.accountId);
                if(acc) { t.type==='income' ? acc.balance += t.amount : acc.balance -= t.amount; }
            });
            saveLocal();
        }

        function delItem(type, id) {
            if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
            vibe('heavy');
            if(type=='tx') db.transactions = db.transactions.filter(x=>x.id!=id);
            if(type=='acc') db.accounts = db.accounts.filter(x=>x.id!=id);
            if(type=='cat') db.categories = db.categories.filter(x=>x.id!=id);
            recalc();
        }

        // --- RENDERERS ---
        function renderHome() {
            // Total
            const total = db.accounts.reduce((s,a)=>s+a.balance, 0);
            document.getElementById('total-bal').innerText = Math.floor(total).toLocaleString() + ' ‚ÇΩ';
            
            // Accs Slider
            document.getElementById('home-accs').innerHTML = db.accounts.map(a => `
                <div class="acc-card">
                    ${a.percent ? `<div class="acc-percent">+${a.percent}%</div>` : ''}
                    <div style="font-weight:700">${a.name}</div>
                    <div style="font-size:18px; font-weight:800; margin:5px 0; color:var(--primary)">${Math.floor(a.balance).toLocaleString()}</div>
                    <div class="text-xs" style="margin:0; opacity:0.6">${a.type.toUpperCase()}</div>
                    ${(a.type=='deposit' && a.goal>0) ? `<div class="goal-bar"><div class="goal-fill" style="width:${Math.min(100, a.balance/a.goal*100)}%"></div></div>` : ''}
                </div>
            `).join('');

            // Txs List
            const sorted = db.transactions.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0, 10);
            document.getElementById('home-txs').innerHTML = sorted.map(t => {
                const c = db.categories.find(x=>x.id==t.categoryId) || {name:'–°–∏—Å—Ç–µ–º–∞', icon:'ri-settings-line', color:'#999'};
                return `
                <div class="tx-row" onclick="delItem('tx', '${t.id}')">
                    <div class="tx-icon" style="background:${c.color}20; color:${c.color}"><i class="${c.icon}"></i></div>
                    <div style="flex:1">
                        <div style="font-weight:600; font-size:15px;">${c.name} ${t.isWaste?'üóëÔ∏è':''}</div>
                        <div class="text-xs" style="text-transform:none; margin:0; opacity:0.7">${new Date(t.date).toLocaleDateString()} ‚Ä¢ ${t.comment||''}</div>
                    </div>
                    <div style="font-weight:700; color:${t.type=='expense'?'var(--text)':'var(--success)'}">
                        ${t.type=='expense'?'-':'+'}${Math.floor(t.amount)}
                    </div>
                </div>`;
            }).join('');
            
            renderWeekChart();
            renderWallet();
        }
        
        function renderWallet() {
            document.getElementById('wallet-accs').innerHTML = db.accounts.map(a => 
                `<div class="flex-between" style="padding:10px 0; border-bottom:1px solid rgba(0,0,0,0.05)">
                    <b>${a.name}</b> 
                    <div style="display:flex; gap:10px; align-items:center">
                        <span>${Math.floor(a.balance)}</span> 
                        <i class="ri-delete-bin-line" style="color:var(--danger)" onclick="delItem('acc','${a.id}')"></i>
                    </div>
                </div>`).join('');
            document.getElementById('wallet-cats').innerHTML = db.categories.map(c => 
                `<div style="display:inline-flex; align-items:center; gap:5px; padding:6px 12px; background:var(--bg); border-radius:10px; margin:3px; font-size:13px;">
                    <i class="${c.icon}" style="color:${c.color}"></i> ${c.name} 
                    <i class="ri-close-line" style="margin-left:5px; opacity:0.5" onclick="delItem('cat','${c.id}')"></i>
                </div>`).join('');
        }

        // --- CHARTS & STATS ---
        let statMode = 'expense';
        function setStatMode(m, el) { 
            vibe(); statMode=m; 
            document.querySelectorAll('.seg-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); 
            renderStats(); 
        }

        function renderStats() {
            const ctx = document.getElementById('chart-pie');
            let txs = db.transactions.filter(t => t.type === statMode);
            const cats = {}; 
            txs.forEach(t => cats[t.categoryId] = (cats[t.categoryId]||0) + t.amount);
            
            if(window.pieChart) window.pieChart.destroy();
            window.pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats).map(id=>db.categories.find(c=>c.id==id)?.name || '–ü—Ä–æ—á–µ–µ'),
                    datasets: [{
                        data: Object.values(cats),
                        backgroundColor: Object.keys(cats).map(id=>db.categories.find(c=>c.id==id)?.color || '#999'),
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{boxWidth:12, font:{size:11}}}} }
            });

            document.getElementById('stats-list').innerHTML = Object.entries(cats).sort((a,b)=>b[1]-a[1]).map(([id, val]) => {
                const c = db.categories.find(x=>x.id==id) || {name:'–ü—Ä–æ—á–µ–µ', color:'#999'};
                return `<div class="flex-between" style="padding:12px 0; border-bottom:1px solid rgba(0,0,0,0.05)">
                    <div style="display:flex; gap:10px; align-items:center"><div style="width:12px; height:12px; border-radius:50%; background:${c.color}"></div> <b>${c.name}</b></div>
                    <span>${Math.floor(val).toLocaleString()}</span>
                </div>`;
            }).join('');
        }

        function renderWeekChart() {
            const ctx = document.getElementById('chart-week');
            const data = [0,0,0,0,0,0,0]; const now=new Date(); let sum=0;
            db.transactions.forEach(t => { if(t.type=='expense' && Math.abs(now-new Date(t.date)) < 604800000) { data[new Date(t.date).getDay()] += t.amount; sum+=t.amount; } });
            document.getElementById('week-sum').innerText = sum.toLocaleString() + ' ‚ÇΩ';
            
            if(window.barChart) window.barChart.destroy();
            window.barChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'], datasets: [{ data, backgroundColor: '#6366F1', borderRadius: 6 }] },
                options: { maintainAspectRatio:false, scales:{x:{grid:{display:false}}, y:{display:false}}, plugins:{legend:{display:false}} }
            });
        }

        // --- MODAL LOGIC ---
        let curTxType='expense', curTxAcc='', curTxCat='', curTxWaste=false;
        
        function openTxModal(type) {
            vibe(); curTxType=type;
            document.getElementById('mtx-title').innerText = type=='expense'?'–†–∞—Å—Ö–æ–¥':'–î–æ—Ö–æ–¥';
            document.getElementById('modal-tx').classList.add('show');
            document.getElementById('mtx-waste-wrap').classList.toggle('hidden', type!='expense');
            document.getElementById('mtx-date').valueAsDate = new Date();
            document.getElementById('mtx-amt').value = '';
            
            curTxAcc = db.accounts[0]?.id;
            const accHTML = db.accounts.map(a => `
                <div class="acc-card" onclick="curTxAcc='${a.id}'; document.querySelectorAll('.acc-card').forEach(x=>x.classList.remove('active')); this.classList.add('active')">
                    <b>${a.name}</b><br><small>${Math.floor(a.balance)}</small>
                </div>`).join('');
            document.getElementById('mtx-accs').innerHTML = accHTML;
            if(document.getElementById('mtx-accs').firstChild) document.getElementById('mtx-accs').firstChild.classList.add('active');

            const catHTML = db.categories.filter(c=>c.type==type).map(c => `
                <div class="icon-tile" style="color:${c.color}" onclick="curTxCat='${c.id}'; document.querySelectorAll('.icon-tile').forEach(x=>x.classList.remove('selected')); this.classList.add('selected')">
                    <i class="${c.icon}"></i>
                </div>`).join('');
            document.getElementById('mtx-cats').innerHTML = catHTML;
        }

        function saveTx() {
            const amt = document.getElementById('mtx-amt').value;
            if(!amt || !curTxAcc || !curTxCat) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É, —Å—á–µ—Ç –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
            vibe('success');
            const tx = {
                id: 'tx_'+Date.now(), date: document.getElementById('mtx-date').value || new Date().toISOString(),
                amount: parseFloat(amt), type: curTxType, accountId: curTxAcc, categoryId: curTxCat,
                comment: document.getElementById('mtx-note').value, isWaste: (curTxType=='expense' && curTxWaste)
            };
            db.transactions.push(tx); recalc(); pushTx(tx); closeModal('modal-tx');
        }

        let newAccType='card';
        function setAccType(t) { newAccType=t; document.querySelectorAll('#modal-acc .seg-btn').forEach(b=>b.classList.remove('active')); document.getElementById('btn-atype-'+(t=='deposit'?'dep':(t=='invest'?'inv':'card'))).classList.add('active'); document.getElementById('macc-extra').classList.toggle('hidden', t=='card'); }
        function openAccModal() { vibe(); document.getElementById('modal-acc').classList.add('show'); }
        function saveAcc() {
            const name=document.getElementById('macc-name').value; if(!name) return;
            vibe('success');
            db.accounts.push({
                id:'acc_'+Date.now(), name, type:newAccType,
                balance: parseFloat(document.getElementById('macc-start').value)||0,
                start: parseFloat(document.getElementById('macc-start').value)||0,
                goal: parseFloat(document.getElementById('macc-goal').value)||0,
                percent: parseFloat(document.getElementById('macc-percent').value)||0,
                lastCalc: Date.now()
            });
            saveLocal(); closeModal('modal-acc');
        }

        let newCatType='expense', newCatIcon='ri-star-line';
        function setCatType(t) { newCatType=t; document.getElementById('btn-ctype-exp').classList.toggle('active', t=='expense'); document.getElementById('btn-ctype-inc').classList.toggle('active', t=='income'); }
        function openCatModal() { 
            vibe(); document.getElementById('modal-cat').classList.add('show'); 
            const icons = ['ri-star-line','ri-home-4-line','ri-car-line','ri-shopping-cart-2-line','ri-gift-line','ri-heart-3-line','ri-plane-line','ri-book-open-line','ri-t-shirt-line','ri-cup-line','ri-gamepad-line','ri-scissors-cut-line','ri-first-aid-kit-line','ri-bank-card-line','ri-briefcase-4-line'];
            document.getElementById('mcat-icons').innerHTML = icons.map(i => `<div class="icon-tile" onclick="newCatIcon='${i}'; document.querySelectorAll('.icon-tile').forEach(x=>x.classList.remove('selected')); this.classList.add('selected')"><i class="${i}"></i></div>`).join('');
        }
        function saveCat() {
            const name=document.getElementById('mcat-name').value; if(!name) return;
            vibe('success');
            const clrs=['#EF4444','#F59E0B','#10B981','#3B82F6','#8B5CF6','#EC4899'];
            db.categories.push({id:'cat_'+Date.now(), name, type:newCatType, icon:newCatIcon, color:clrs[Math.floor(Math.random()*clrs.length)]});
            saveLocal(); closeModal('modal-cat');
        }

        function setWaste(w) { curTxWaste=w; document.getElementById('btn-waste-no').classList.toggle('active', !w); document.getElementById('btn-waste-yes').classList.toggle('active', w); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        function nav(scr, btn) { vibe(); document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden')); document.getElementById('scr-'+scr).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active')); if(btn) btn.classList.add('active'); if(scr=='stats') renderStats(); }
        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme')=='dark'?'light':'dark'); }

        // Start
        recalc(); syncData();
    </script>
</body>
</html>
