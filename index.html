<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyCosts Titanium</title>
    
    <!-- === –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –í–ù–ï–®–ù–ò–• –ë–ò–ë–õ–ò–û–¢–ï–ö === -->
    <!-- Telegram Web App SDK –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –±–æ—Ç–æ–º -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Chart.js –¥–ª—è –∫—Ä–∞—Å–∏–≤—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Remix Icons –¥–ª—è –∏–∫–æ–Ω–æ–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <!-- –®—Ä–∏—Ñ—Ç Inter (—Å—Ç–∞–Ω–¥–∞—Ä—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï (THEME VARIABLES) === */
        :root {
            /* –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ (Onyx / Dark Mode –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
            --bg-body: #000000;       /* –ê–±—Å–æ–ª—é—Ç–Ω–æ —á–µ—Ä–Ω—ã–π —Ñ–æ–Ω –¥–ª—è OLED —ç–∫—Ä–∞–Ω–æ–≤ */
            --bg-card: #1c1c1e;       /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ (Apple style) */
            --bg-modal: #2c2c2e;      /* –°–≤–µ—Ç–ª–µ–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
            --bg-input: #2c2c2e;      /* –§–æ–Ω –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
            
            --text-main: #ffffff;     /* –û—Å–Ω–æ–≤–Ω–æ–π –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
            --text-sec: #8e8e93;      /* –í—Ç–æ—Ä–∏—á–Ω—ã–π —Å–µ—Ä—ã–π —Ç–µ–∫—Å—Ç */
            
            /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ */
            --primary: #0a84ff;       /* iOS Blue - –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π */
            --primary-dim: rgba(10, 132, 255, 0.15); /* –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Å–∏–Ω–∏–π –¥–ª—è —Ñ–æ–Ω–æ–≤ */
            
            /* –°—Ç–∞—Ç—É—Å–Ω—ã–µ —Ü–≤–µ—Ç–∞ */
            --success: #30d158;       /* –ó–µ–ª–µ–Ω—ã–π (–î–æ—Ö–æ–¥—ã) */
            --danger: #ff453a;        /* –ö—Ä–∞—Å–Ω—ã–π (–†–∞—Å—Ö–æ–¥—ã) */
            --warning: #ffd60a;       /* –ñ–µ–ª—Ç—ã–π (–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è) */
            
            /* –†–∞–∑–º–µ—Ä—ã —Å–∫—Ä—É–≥–ª–µ–Ω–∏–π */
            --radius-l: 24px;         /* –ë–æ–ª—å—à–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
            --radius-m: 16px;         /* –ö–Ω–æ–ø–∫–∏ –∏ –∏–Ω–ø—É—Ç—ã */
            --radius-s: 12px;         /* –ú–µ–ª–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
            
            /* –®—Ä–∏—Ñ—Ç */
            --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* === –ë–ê–ó–û–í–´–ô –°–ë–†–û–° (RESET) === */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; /* –£–±–∏—Ä–∞–µ—Ç —Å–∏–Ω–∏–π –±–ª–∏–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ iOS */
            outline: none; 
            user-select: none; /* –ó–∞–ø—Ä–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ—â—É—â–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: var(--font); 
            margin: 0; 
            padding: 0; 
            padding-bottom: 140px; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª—Å—è –º–µ–Ω—é */
            overflow-x: hidden; /* –ó–∞–ø—Ä–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
        }

        .container { 
            padding: 16px; 
            max-width: 480px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤/–ü–ö */
            margin: 0 auto; 
            min-height: 100vh; 
        }

        /* === –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê === */
        h1 { font-size: 32px; font-weight: 800; letter-spacing: -0.5px; margin: 0; }
        h2 { font-size: 22px; font-weight: 700; margin: 0; letter-spacing: -0.3px; }
        h3 { font-size: 18px; font-weight: 600; margin: 0; color: var(--text-sec); }
        
        .num-xl { font-size: 44px; font-weight: 800; letter-spacing: -1px; line-height: 1.1; }
        .text-sm { font-size: 13px; color: var(--text-sec); font-weight: 500; }
        .text-btn { font-size: 15px; font-weight: 600; }

        /* === –ö–ê–†–¢–û–ß–ö–ò –ò –ö–û–ù–¢–ï–ô–ù–ï–†–´ === */
        .card { 
            background: var(--bg-card); 
            border-radius: var(--radius-l); 
            padding: 20px; 
            margin-bottom: 16px; 
            border: 1px solid rgba(255,255,255,0.05); /* –¢–æ–Ω–∫–∞—è –æ–±–≤–æ–¥–∫–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
            position: relative; 
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .flex-col { display: flex; flex-direction: column; gap: 6px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        
        .hidden { display: none !important; }

        /* === –ö–ù–û–ü–ö–ò (BUTTONS) === */
        .btn-main {
            width: 100%; 
            padding: 18px; 
            border-radius: var(--radius-m); 
            border: none;
            background: var(--primary); 
            color: white; 
            font-size: 17px; 
            font-weight: 700;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            transition: transform 0.1s ease, opacity 0.2s; 
            cursor: pointer;
        }
        .btn-main:active { transform: scale(0.96); opacity: 0.9; }
        
        .btn-sec {
            width: 100%; 
            padding: 16px; 
            border-radius: var(--radius-m); 
            border: none;
            background: var(--bg-input); 
            color: var(--text-main); 
            font-size: 16px; 
            font-weight: 600;
            transition: transform 0.1s ease, background 0.2s; 
            cursor: pointer;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
        }
        .btn-sec:active { transform: scale(0.96); background: #3a3a3c; }

        .icon-btn {
            width: 40px; height: 40px; 
            border-radius: 50%; 
            background: var(--bg-input);
            display: flex; align-items: center; justify-content: center; 
            font-size: 20px;
            border: none; 
            color: var(--text-main); 
            cursor: pointer;
            transition: 0.2s;
        }
        .icon-btn:active { opacity: 0.6; transform: scale(0.9); }

        /* === –ü–û–õ–Ø –í–í–û–î–ê (INPUTS) === */
        .input-money {
            width: 100%; 
            background: transparent; 
            border: none; 
            color: var(--text-main);
            font-size: 48px; 
            font-weight: 800; 
            text-align: center; 
            padding: 20px 0;
        }
        .input-std {
            width: 100%; 
            background: var(--bg-input); 
            border: 1px solid transparent;
            padding: 16px; 
            border-radius: var(--radius-m); 
            color: var(--text-main);
            font-size: 17px; 
            margin-bottom: 12px; 
            transition: 0.3s border-color;
        }
        .input-std:focus { border-color: var(--primary); background: #3a3a3c; }

        /* === –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ (NAVBAR) === */
        .nav-bar {
            position: fixed; 
            bottom: 20px; 
            left: 16px; 
            right: 16px;
            background: rgba(44, 44, 46, 0.85); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
            backdrop-filter: blur(20px);        /* –≠—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–º—ã—Ç–∏—è (Glassmorphism) */
            -webkit-backdrop-filter: blur(20px);
            border-radius: 32px; 
            padding: 12px 24px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5); 
            z-index: 100; 
            max-width: 460px; 
            margin: 0 auto;
        }
        .nav-item {
            color: var(--text-sec); 
            font-size: 26px; 
            padding: 8px;
            transition: 0.3s color, 0.3s transform; 
            position: relative; 
            cursor: pointer;
        }
        .nav-item.active { color: var(--text-main); transform: translateY(-2px); }
        .nav-item.active::after {
            content: ''; 
            position: absolute; 
            bottom: 0; 
            left: 50%; 
            transform: translateX(-50%);
            width: 4px; 
            height: 4px; 
            background: var(--primary); 
            border-radius: 50%;
        }

        /* === –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–´–ï –°–ü–ò–°–ö–ò (SCROLL) === */
        .h-scroll { 
            display: flex; 
            gap: 12px; 
            overflow-x: auto; 
            padding: 0 4px 10px 4px; 
            scrollbar-width: none; 
        }
        .h-scroll::-webkit-scrollbar { display: none; }
        
        .chip {
            min-width: 130px; 
            background: var(--bg-input); 
            padding: 14px;
            border-radius: var(--radius-m); 
            flex-shrink: 0; 
            border: 1px solid transparent; 
            transition: 0.2s;
            cursor: pointer;
        }
        .chip:active { transform: scale(0.98); }
        .chip.active { border-color: var(--primary); background: var(--primary-dim); }

        /* === –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê (BOTTOM SHEETS) === */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000;
            opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px);
        }
        .overlay.open { opacity: 1; pointer-events: all; }
        
        .sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-modal); 
            border-radius: 32px 32px 0 0;
            padding: 24px; padding-bottom: 40px;
            transform: translateY(100%); 
            transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 1001; 
            max-height: 90vh; 
            overflow-y: auto;
        }
        .sheet.open { transform: translateY(0); }
        .sheet-handle { 
            width: 40px; height: 5px; background: rgba(255,255,255,0.2); 
            border-radius: 100px; margin: 0 auto 20px auto; 
        }

        /* === –ó–ê–ì–†–£–ó–ß–ò–ö (SPLASH SCREEN) === */
        #splash { 
            position: fixed; inset: 0; background: var(--bg-body); z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            transition: opacity 0.5s ease;
        }
        .loader { 
            width: 40px; height: 40px; 
            border: 3px solid #333; border-top-color: var(--primary); 
            border-radius: 50%; animation: spin 1s infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* === –ü–†–û–ì–†–ï–°–° –ë–ê–†–´ === */
        .progress-bg { 
            width: 100%; height: 6px; background: #333; 
            border-radius: 10px; overflow: hidden; margin-top: 8px; 
        }
        .progress-fill { 
            height: 100%; width: 0%; transition: 1s ease; border-radius: 10px; 
        }
        .fill-green { background: var(--success); }
        .fill-red { background: var(--danger); }
        
        /* === –°–¢–ê–¢–£–° (–í –®–ê–ü–ö–ï) === */
        .status { 
            padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; 
            background: rgba(255,255,255,0.1); display: flex; gap: 6px; align-items: center; 
            cursor: pointer; transition: 0.2s;
        }
        .status:active { opacity: 0.7; }
        .dot { width: 6px; height: 6px; border-radius: 50%; }
        .dot.green { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .dot.yellow { background: var(--warning); animation: blink 1s infinite; }
        .dot.red { background: var(--danger); }
        @keyframes blink { 50% { opacity: 0.4; } }

        /* === –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ (SEGMENTED CONTROL) === */
        .segment { 
            background: #1c1c1e; padding: 4px; border-radius: 14px; 
            display: flex; margin-bottom: 20px; 
        }
        .seg-btn { 
            flex: 1; padding: 10px; text-align: center; font-weight: 600; 
            color: var(--text-sec); border-radius: 10px; transition: 0.2s; cursor: pointer;
        }
        .seg-btn.active { 
            background: #3a3a3c; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
        }
        
        /* === –°–ï–¢–ö–ê –ò–ö–û–ù–û–ö === */
        .icon-tile {
            aspect-ratio: 1; background: var(--bg-input); border-radius: 16px;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            border: 2px solid transparent; transition: 0.2s; cursor: pointer;
        }
        .icon-tile.selected { border-color: var(--primary); background: var(--primary-dim); }
    </style>
</head>
<body>
    <!-- ========================================== -->
    <!-- –≠–ö–†–ê–ù 0: –ó–ê–°–¢–ê–í–ö–ê (PRELOADER) -->
    <!-- ========================================== -->
    <div id="splash">
        <div class="loader"></div>
        <div style="margin-top: 20px; font-weight: 600; opacity: 0.6; letter-spacing: 1px;">MyCosts</div>
    </div>

    <!-- ========================================== -->
    <!-- –≠–ö–†–ê–ù 1: –û–ù–ë–û–†–î–ò–ù–ì (–î–õ–Ø –ù–û–í–´–•) -->
    <!-- ========================================== -->
    <div id="screen-onboarding" class="container hidden" style="justify-content: center; display: flex; flex-direction: column; text-align: center;">
        <div style="font-size: 64px; margin-bottom: 20px;">üëã</div>
        <h1>–ü—Ä–∏–≤–µ—Ç!</h1>
        <p class="text-sm" style="margin-bottom: 40px; line-height: 1.6; opacity: 0.7;">
            –≠—Ç–æ —Ç–≤–æ–π –Ω–æ–≤—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä.<br>
            –£–¥–æ–±–Ω—ã–π —É—á–µ—Ç, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏.<br>
            –î–∞–≤–∞–π –Ω–∞—Å—Ç—Ä–æ–∏–º –ø—Ä–æ—Ñ–∏–ª—å –∑–∞ 10 —Å–µ–∫—É–Ω–¥.
        </p>
        
        <label class="text-sm" style="display: block; text-align: left; margin-bottom: 8px; margin-left: 4px;">–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?</label>
        <input type="text" id="setup-name" class="input-std" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞—Ç—è" style="text-align: center;">
        
        <label class="text-sm" style="display: block; text-align: left; margin-bottom: 8px; margin-left: 4px;">–¢–≤–æ–π –±—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü</label>
        <input type="number" id="setup-limit" class="input-std" placeholder="100000" style="text-align: center;">
        
        <button class="btn-main" onclick="finishOnboarding()" style="margin-top: 20px;">
            –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É <i class="ri-arrow-right-line"></i>
        </button>
    </div>

    <!-- ========================================== -->
    <!-- –≠–ö–†–ê–ù 2: –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <!-- ========================================== -->
    <div id="screen-app" class="container hidden">
        
        <!-- –í–ï–†–•–ù–Ø–Ø –®–ê–ü–ö–ê (HEADER) -->
        <div class="flex-between" style="margin-bottom: 20px; padding-top: 10px;">
            <div class="status" onclick="forceSync()">
                <div class="dot" id="sync-dot"></div>
                <span id="sync-text">–í –°–ï–¢–ò</span>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 700; font-size: 16px;" id="user-name">User</div>
            </div>
        </div>

        <!-- >>> –í–ö–õ–ê–î–ö–ê 1: –ì–õ–ê–í–ù–ê–Ø (HOME) <<< -->
        <div id="view-home">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –±–∞–ª–∞–Ω—Å–∞ -->
            <div class="card" style="text-align: center; padding: 32px 20px;">
                <div class="text-sm" style="text-transform: uppercase; letter-spacing: 1px; opacity: 0.7;">–û–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª</div>
                <div class="num-xl" style="margin: 12px 0;" id="total-balance">0 ‚ÇΩ</div>
                
                <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                <div class="grid-2" style="margin-top: 24px;">
                    <button class="btn-sec" style="color: var(--danger); background: rgba(255, 69, 58, 0.1);" onclick="openTxModal('expense')">
                        <i class="ri-arrow-down-line"></i> –†–∞—Å—Ö–æ–¥
                    </button>
                    <button class="btn-sec" style="color: var(--success); background: rgba(48, 209, 88, 0.1);" onclick="openTxModal('income')">
                        <i class="ri-arrow-up-line"></i> –î–æ—Ö–æ–¥
                    </button>
                </div>
            </div>

            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä: –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–±–æ–¥–∞ -->
            <div class="card">
                <div class="flex-between">
                    <span class="text-sm">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–±–æ–¥–∞</span>
                    <span class="text-sm" id="cf-pct" style="font-weight: 700;">0%</span>
                </div>
                <div class="progress-bg">
                    <div class="progress-fill fill-green" id="cf-bar" style="width:0%"></div>
                </div>
                <div class="flex-between" style="margin-top: 12px;">
                    <div class="flex-col">
                        <span class="text-sm" style="font-size: 11px;">–ü–ê–°–°–ò–í–ù–´–ô –î–û–•–û–î</span>
                        <span class="text-btn" style="color:var(--success)" id="cf-passive">0 ‚ÇΩ</span>
                    </div>
                    <div class="flex-col" style="text-align: right;">
                        <span class="text-sm" style="font-size: 11px;">–†–ê–°–•–û–î–´</span>
                        <span class="text-btn" style="color:var(--danger)" id="cf-expense">0 ‚ÇΩ</span>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä: –ë—é–¥–∂–µ—Ç -->
            <div class="card">
                <div class="flex-between">
                    <span class="text-sm">–õ–∏–º–∏—Ç –Ω–∞ –º–µ—Å—è—Ü</span>
                    <span class="text-sm" id="bud-left" style="font-weight: 700;">0 ‚ÇΩ</span>
                </div>
                <div class="progress-bg">
                    <div class="progress-fill fill-red" id="bud-bar" style="width:0%"></div>
                </div>
            </div>

            <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å—á–µ—Ç–æ–≤ -->
            <div class="flex-between" style="margin-bottom: 12px;">
                <h3>–ú–æ–∏ –°—á–µ—Ç–∞</h3> 
                <span class="text-btn" style="color:var(--primary); font-size: 13px; cursor: pointer;" onclick="nav('wallet')">–í–°–ï</span>
            </div>
            <div class="h-scroll" id="list-accs-home">
                <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç —Å—á–µ—Ç–∞ -->
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π -->
            <div class="flex-between" style="margin-top: 24px; margin-bottom: 12px;">
                <h3>–ò—Å—Ç–æ—Ä–∏—è</h3> 
                <span class="text-btn" style="color:var(--primary); font-size: 13px; cursor: pointer;" onclick="nav('stats')">–ê–ù–ê–õ–ò–ó</span>
            </div>
            <div id="list-tx-home" style="padding-bottom: 20px;">
                <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
            </div>
        </div>

        <!-- >>> –í–ö–õ–ê–î–ö–ê 2: –ò–ù–í–ï–°–¢–ò–¶–ò–ò (INVEST) <<< -->
        <div id="view-invest" class="hidden">
            <h2>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h2>
            <p class="text-sm" style="margin-bottom: 20px;">–†–æ—Å—Ç —Ç–≤–æ–µ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏</p>
            
            <div class="card">
                <div class="flex-between">
                    <span class="text-sm">–ü—Ä–æ–≥–Ω–æ–∑ (1 –≥–æ–¥)</span>
                    <span style="color:var(--success); font-weight:700" id="inv-growth">+0%</span>
                </div>
                <div style="height: 220px; margin-top: 15px;">
                    <canvas id="chart-inv"></canvas>
                </div>
            </div>
            
            <h3>–ê–∫—Ç–∏–≤—ã</h3>
            <div id="list-inv" style="margin-top: 12px;"></div>
        </div>

        <!-- >>> –í–ö–õ–ê–î–ö–ê 3: –ê–ù–ê–õ–ò–¢–ò–ö–ê (STATS) <<< -->
        <div id="view-stats" class="hidden">
            <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            <br>
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å -->
            <div class="segment">
                <div class="seg-btn active" onclick="setStatsType('expense', this)">–†–∞—Å—Ö–æ–¥—ã</div>
                <div class="seg-btn" onclick="setStatsType('income', this)">–î–æ—Ö–æ–¥—ã</div>
            </div>
            
            <div class="card">
                <div style="height: 260px; position: relative;">
                    <canvas id="chart-pie"></canvas>
                </div>
            </div>
            
            <div id="list-stats"></div>
        </div>

        <!-- >>> –í–ö–õ–ê–î–ö–ê 4: –ö–û–®–ï–õ–ï–ö (WALLET) <<< -->
        <div id="view-wallet" class="hidden">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            <br>
            
            <!-- –ë–ª–æ–∫ —Å—á–µ—Ç–æ–≤ -->
            <div class="card">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h3>–°—á–µ—Ç–∞</h3> 
                    <button class="icon-btn" onclick="openAccModal()"><i class="ri-add-line"></i></button>
                </div>
                <div id="list-acc-manage"></div>
            </div>

            <!-- –ë–ª–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
            <div class="card">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3> 
                    <button class="icon-btn" onclick="openCatModal()"><i class="ri-add-line"></i></button>
                </div>
                <div id="list-cat-manage"></div>
            </div>
            
            <button class="btn-sec" style="margin-top: 20px; background: #2c2c2e; color: #ff453a;" onclick="resetApp()">
                <i class="ri-error-warning-line"></i> –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫
            </button>
            <div style="text-align: center; margin-top: 10px; opacity: 0.4; font-size: 10px;">MyCosts Titanium v12.0</div>
        </div>

    </div>

    <!-- ========================================== -->
    <!-- –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ –ù–ê–í–ò–ì–ê–¶–ò–ò -->
    <!-- ========================================== -->
    <div class="nav-bar" id="navbar">
        <div class="nav-item active" onclick="nav('home', this)">
            <i class="ri-home-5-fill"></i>
        </div>
        <div class="nav-item" onclick="nav('invest', this)">
            <i class="ri-line-chart-fill"></i>
        </div>
        <div class="nav-item" onclick="nav('stats', this)">
            <i class="ri-pie-chart-2-fill"></i>
        </div>
        <div class="nav-item" onclick="nav('wallet', this)">
            <i class="ri-wallet-3-fill"></i>
        </div>
    </div>
    <!-- ========================================== -->
    <!-- –í–°–ü–õ–´–í–ê–Æ–©–ò–ï –û–ö–ù–ê (SHEETS) -->
    <!-- ========================================== -->
    
    <!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ -->
    <div class="overlay" id="overlay" onclick="closeAll()"></div>

    <!-- 1. –û–ö–ù–û –¢–†–ê–ù–ó–ê–ö–¶–ò–ò -->
    <div class="sheet" id="sheet-tx">
        <div class="sheet-handle"></div>
        
        <div class="flex-between" style="margin-bottom: 20px;">
            <h2 id="tx-title">–†–∞—Å—Ö–æ–¥</h2>
            <div class="icon-btn" onclick="closeAll()"><i class="ri-close-line"></i></div>
        </div>
        
        <!-- –í–≤–æ–¥ —Å—É–º–º—ã -->
        <input type="text" id="tx-amt" class="input-money" placeholder="0" inputmode="decimal">
        
        <!-- –í—ã–±–æ—Ä —Å—á–µ—Ç–∞ -->
        <div class="text-sm" style="margin-bottom: 8px;">–°–ß–ï–¢ –°–ü–ò–°–ê–ù–ò–Ø</div>
        <div class="h-scroll" id="tx-accs-list" style="margin-bottom: 24px;"></div>
        
        <!-- –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div class="text-sm" style="margin-bottom: 8px;">–ö–ê–¢–ï–ì–û–†–ò–Ø</div>
        <div class="grid-4" id="tx-cats-list" style="margin-bottom: 24px;"></div>
        
        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
        <input type="text" id="tx-note" class="input-std" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
        
        <div class="grid-2">
            <button class="btn-main" onclick="saveTx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn-sec hidden" id="tx-del-btn" style="color:var(--danger)" onclick="deleteTx()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>

    <!-- 2. –û–ö–ù–û –°–ß–ï–¢–ê (–°–æ–∑–¥–∞–Ω–∏–µ/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ) -->
    <div class="sheet" id="sheet-acc">
        <div class="sheet-handle"></div>
        <div class="flex-between">
            <h2>–°—á–µ—Ç</h2> 
            <div class="icon-btn" onclick="closeAll()"><i class="ri-close-line"></i></div>
        </div>
        <br>
        
        <label class="text-sm">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞</label>
        <input type="text" id="acc-name" class="input-std" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∫–ª–∞–¥ –≤ –°–±–µ—Ä–µ">
        
        <label class="text-sm">–¢–∏–ø —Å—á–µ—Ç–∞</label>
        <div class="segment" style="margin-bottom: 16px;">
            <div class="seg-btn active" id="type-card" onclick="setAccType('card')">–ö–∞—Ä—Ç–∞</div>
            <div class="seg-btn" id="type-invest" onclick="setAccType('invest')">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</div>
        </div>

        <!-- –ü–æ–ª—è –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π (—Å–∫—Ä—ã—Ç—ã–µ) -->
        <div id="acc-invest-opts" class="hidden">
            <label class="text-sm">–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (% –≥–æ–¥–æ–≤—ã—Ö)</label>
            <input type="number" id="acc-percent" class="input-std" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 15">
        </div>
        
        <label class="text-sm">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</label>
        <input type="number" id="acc-bal" class="input-std" placeholder="0">
        
        <div class="grid-2" style="margin-top: 10px;">
            <button class="btn-main" onclick="saveAcc()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn-sec" style="color:var(--danger)" onclick="delAcc()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>

    <!-- 3. –û–ö–ù–û –ö–ê–¢–ï–ì–û–†–ò–ò -->
    <div class="sheet" id="sheet-cat">
        <div class="sheet-handle"></div>
        <div class="flex-between">
            <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2> 
            <div class="icon-btn" onclick="closeAll()"><i class="ri-close-line"></i></div>
        </div>
        <br>
        
        <label class="text-sm">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" id="cat-name" class="input-std" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        
        <label class="text-sm">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
        <div class="segment" style="margin-bottom: 16px;">
            <div class="seg-btn active" id="ctype-exp" onclick="setCatType('expense')">–†–∞—Å—Ö–æ–¥</div>
            <div class="seg-btn" id="ctype-inc" onclick="setCatType('income')">–î–æ—Ö–æ–¥</div>
        </div>

        <label class="text-sm">–ò–∫–æ–Ω–∫–∞</label>
        <div class="grid-4" id="cat-icons-grid" style="margin-bottom: 24px;"></div>
        
        <div class="grid-2">
            <button class="btn-main" onclick="saveCat()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn-sec" style="color:var(--danger)" onclick="delCat()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
    <script>
        // ==========================================
        // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –°–¢–ê–†–¢
        // ==========================================
        
        // !!! –°–°–´–õ–ö–ê –ù–ê –¢–í–û–ô –°–ö–†–ò–ü–¢ (–í–°–¢–ê–í–¨ –°–Æ–î–ê) !!!
        const API_URL = 'https://script.google.com/macros/s/AKfycby_ES9U2-4VYmPhMLbDtNNv_ESnbUEI9nlw0euEHsxZ6eJqu340_LpF_A1pSxyUvRxG/exec';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–≤ –ø–∞–º—è—Ç–∏)
        let db = { 
            user: { name: '', limit: 100000 }, 
            accounts: [], 
            categories: [], 
            transactions: [] 
        };
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤)
        let USER_ID = localStorage.getItem('onyx_uid');
        if (!USER_ID) {
            USER_ID = tg.initDataUnsafe?.user?.id 
                ? 'tg_' + tg.initDataUnsafe.user.id 
                : 'web_' + Date.now();
            localStorage.setItem('onyx_uid', USER_ID);
        }

        // ==========================================
        // 2. –°–ò–°–¢–ï–ú–ê –ó–ê–ü–£–°–ö–ê –ò –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò
        // ==========================================

        function initApp() {
            // –®–ê–ì 1: –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ)
            const localData = localStorage.getItem('onyx_db');
            let hasData = false;
            
            if (localData) {
                try {
                    db = JSON.parse(localData);
                    // –ê–≤—Ç–æ-—Ñ–∏–∫—Å –∏–∫–æ–Ω–æ–∫ (–µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏)
                    db.categories.forEach(c => {
                        if(c.icon.includes('-')) c.icon = 'üîπ';
                    });
                    hasData = db.accounts.length > 0;
                } catch(e) { console.error('DB Error', e); }
            }

            // –®–ê–ì 2: –£–±–∏—Ä–∞–µ–º –∑–∞—Å—Ç–∞–≤–∫—É
            setTimeout(() => {
                const splash = document.getElementById('splash');
                splash.style.opacity = '0';
                
                setTimeout(() => {
                    splash.style.display = 'none';
                    if (hasData) {
                        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                        document.getElementById('screen-app').classList.remove('hidden');
                        renderAll();
                        syncBackground(); // –¢–∏—Ö–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å –æ–±–ª–∞–∫–∞
                    } else {
                        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –û–Ω–±–æ—Ä–¥–∏–Ω–≥
                        document.getElementById('screen-onboarding').classList.remove('hidden');
                    }
                }, 500);
            }, 1000);
        }

        // –§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —ç–∫—Ä–∞–Ω!)
        async function syncBackground() {
            setSync('yellow', '–ó–∞–≥—Ä—É–∑–∫–∞...');
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –ì—É–≥–ª–∞
                const res = await fetch(`${API_URL}?action=load&user_id=${USER_ID}&t=${Date.now()}`);
                const json = await res.json();
                
                if (json.status === 'success' && json.data.accounts.length > 0) {
                    // –ü—Ä–∏—à–ª–∏ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ -> –û–±–Ω–æ–≤–ª—è–µ–º
                    db.accounts = json.data.accounts;
                    db.categories = json.data.categories;
                    db.transactions = json.data.transactions;
                    if(json.data.user) db.user = json.data.user;
                    
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ –≤–∫–ª–∞–¥–∞–º
                    calcInterest();
                    
                    saveLocal();
                    setSync('green', '–í –°–ï–¢–ò');
                } else {
                    setSync('green', '–õ–û–ö–ê–õ–¨–ù–û');
                }
            } catch (e) {
                // –ï—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ - –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ
                setSync('red', '–û–§–§–õ–ê–ô–ù');
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–æ (POST –∑–∞–ø—Ä–æ—Å, –Ω–∞–¥–µ–∂–Ω—ã–π)
        async function pushData(force = false) {
            if(!force) setSync('yellow', '...');
            try {
                await fetch(API_URL + '?action=sync_all', {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        user_id: USER_ID,
                        accounts: db.accounts,
                        categories: db.categories,
                        transactions: db.transactions,
                        user: db.user // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –∏ –ª–∏–º–∏—Ç—ã
                    })
                });
                if(!force) setSync('green', 'OK');
            } catch (e) { setSync('red', 'ERR'); }
        }

        function saveLocal() {
            localStorage.setItem('onyx_db', JSON.stringify(db));
            renderAll();
        }

        function setSync(col, txt) {
            document.getElementById('sync-dot').className = 'dot ' + col;
            document.getElementById('sync-text').innerText = txt;
        }

        // ==========================================
        // 3. –ë–ò–ó–ù–ï–° –õ–û–ì–ò–ö–ê (–ú–ê–¢–ï–ú–ê–¢–ò–ö–ê)
        // ==========================================

        // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
        function calcInterest() {
            let changed = false;
            const now = Date.now();
            
            db.accounts.forEach(acc => {
                if (acc.type === 'invest' && acc.percent > 0) {
                    const last = acc.lastCalc || now;
                    // –°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø—Ä–æ—à–ª–æ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
                    const days = (now - last) / (1000 * 60 * 60 * 24);
                    
                    if (days >= 1) {
                        // –§–æ—Ä–º—É–ª–∞: –ë–∞–ª–∞–Ω—Å * (% / 100 / 365) * –¥–Ω–µ–π
                        const profit = parseFloat(acc.balance) * (parseFloat(acc.percent)/100/365) * days;
                        
                        if (profit > 0.1) { // –ï—Å–ª–∏ –Ω–∞–∫–∞–ø–∞–ª–æ –±–æ–ª—å—à–µ 10 –∫–æ–ø–µ–µ–∫
                            db.transactions.push({
                                id: 'sys_'+Date.now(),
                                date: new Date().toISOString(),
                                amount: profit,
                                type: 'income',
                                accountId: acc.id,
                                categoryId: 'sys', // –°–∏—Å—Ç–µ–º–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
                                comment: '% –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ',
                                isWaste: false
                            });
                            acc.lastCalc = now;
                            changed = true;
                        }
                    }
                }
            });
            if(changed) saveLocal();
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        function finishOnboarding() {
            const name = document.getElementById('setup-name').value || 'User';
            const limit = parseFloat(document.getElementById('setup-limit').value) || 100000;
            
            db.user.name = name;
            db.user.limit = limit;
            
            // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä, –µ—Å–ª–∏ –ø—É—Å—Ç–æ
            if(db.accounts.length === 0) {
                db.accounts.push({id:'a1', name:'–ö–∞—Ä—Ç–∞', type:'card', balance:0, percent:0});
            }
            if(db.categories.length === 0) {
                db.categories = [
                    {id:'c1', name:'–ï–¥–∞', icon:'üçî', type:'expense'},
                    {id:'c2', name:'–î–æ–º', icon:'üè†', type:'expense'},
                    {id:'c3', name:'–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', icon:'üöï', type:'expense'},
                    {id:'c4', name:'–ó–∞—Ä–ø–ª–∞—Ç–∞', icon:'üí∞', type:'income'}
                ];
            }
            
            saveLocal();
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
            document.getElementById('screen-onboarding').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('screen-onboarding').classList.add('hidden');
                document.getElementById('screen-app').classList.remove('hidden');
                pushData(); // –°—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ–±–ª–∞–∫–æ
            }, 500);
        }

        // ==========================================
        // 4. –û–¢–†–ò–°–û–í–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê (RENDER)
        // ==========================================

        function renderAll() {
            document.getElementById('user-name').innerText = db.user.name;
            
            // 1. –ü–û–î–°–ß–ï–¢ –ë–ê–õ–ê–ù–°–û–í
            // –°–Ω–∞—á–∞–ª–∞ –±–µ—Ä–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å —Å—á–µ—Ç–∞
            const bals = {};
            db.accounts.forEach(a => bals[a.id] = parseFloat(a.balance || 0));
            
            let expenseMonth = 0; // –†–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü
            let passiveMonth = 0; // –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ (—Ä–∞—Å—á–µ—Ç–Ω—ã–π)
            
            const now = new Date();
            const curMonth = now.toISOString().slice(0,7); // "2023-10"

            // –ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –≤—Å–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
            db.transactions.forEach(t => {
                if (bals[t.accountId] !== undefined) {
                    if (t.type === 'income') bals[t.accountId] += parseFloat(t.amount);
                    else bals[t.accountId] -= parseFloat(t.amount);
                }
                
                // –°—á–∏—Ç–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
                if (t.date.startsWith(curMonth) && t.type === 'expense') {
                    expenseMonth += parseFloat(t.amount);
                }
            });

            // –°—á–∏—Ç–∞–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥
            db.accounts.filter(a => a.type === 'invest').forEach(a => {
                // (–ë–∞–ª–∞–Ω—Å * % / 100) / 12 –º–µ—Å—è—Ü–µ–≤
                passiveMonth += (bals[a.id] * (parseFloat(a.percent)/100)) / 12;
            });

            // 2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ì–õ–ê–í–ù–û–ì–û –≠–ö–†–ê–ù–ê
            const total = Object.values(bals).reduce((a,b)=>a+b, 0);
            document.getElementById('total-balance').innerText = Math.floor(total).toLocaleString() + ' ‚ÇΩ';

            // –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä: –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–±–æ–¥–∞
            const ff = expenseMonth > 0 ? (passiveMonth / expenseMonth * 100) : 0;
            document.getElementById('cf-bar').style.width = Math.min(100, ff) + '%';
            document.getElementById('cf-pct').innerText = ff.toFixed(1) + '%';
            document.getElementById('cf-passive').innerText = '+' + Math.floor(passiveMonth).toLocaleString();
            document.getElementById('cf-expense').innerText = '-' + Math.floor(expenseMonth).toLocaleString();

            // –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä: –ë—é–¥–∂–µ—Ç
            const limit = db.user.limit || 100000;
            const left = limit - expenseMonth;
            const budPct = Math.min(100, (expenseMonth / limit * 100));
            document.getElementById('bud-bar').style.width = budPct + '%';
            document.getElementById('bud-left').innerText = left.toLocaleString() + ' ‚ÇΩ';

            // 3. –°–ü–ò–°–ö–ò (–°–ß–ï–¢–ê –ò –ò–°–¢–û–†–ò–Ø)
            const accHTML = db.accounts.map(a => 
                `<div class="chip ${curTx.acc==a.id?'active':''}" onclick="setTxAcc('${a.id}')">
                    <div class="text-sm">${a.name}</div>
                    <div style="font-weight:700; margin-top:4px; font-size:16px;">${Math.floor(bals[a.id]).toLocaleString()}</div>
                </div>`
            ).join('');
            document.getElementById('list-accs-home').innerHTML = accHTML;
            document.getElementById('tx-accs-list').innerHTML = accHTML;

            const txHTML = db.transactions.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,10).map(t => {
                const c = db.categories.find(x=>x.id==t.categoryId) || {name:'–°–∏—Å—Ç–µ–º–∞', icon:'üîπ'};
                const acc = db.accounts.find(a=>a.id==t.accountId);
                return `
                <div class="card flex-between" onclick="editTx('${t.id}')" style="padding:16px; margin-bottom:10px; cursor:pointer;">
                    <div class="flex-center" style="gap:12px;">
                        <span style="font-size:24px">${c.icon}</span>
                        <div>
                            <div style="font-weight:600">${c.name}</div>
                            <div class="text-sm" style="opacity:0.6">${t.comment || new Date(t.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div style="font-weight:700; font-size:16px; color:${t.type=='expense'?'var(--danger)':'var(--success)'}">
                        ${t.type=='expense'?'-':'+'}${Math.floor(t.amount)}
                    </div>
                </div>`
            }).join('');
            document.getElementById('list-tx-home').innerHTML = txHTML;

            // 4. –°–ü–ò–°–ö–ò –í –ù–ê–°–¢–†–û–ô–ö–ê–•
            document.getElementById('list-acc-manage').innerHTML = db.accounts.map(a => 
                `<div class="flex-between" style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1); cursor:pointer;" onclick="editAcc('${a.id}')">
                    <b>${a.name}</b> 
                    <span class="text-sm">${Math.floor(bals[a.id])}</span>
                </div>`
            ).join('');
            document.getElementById('list-cat-manage').innerHTML = db.categories.map(c => 
                `<div class="flex-between" style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1); cursor:pointer;" onclick="editCat('${c.id}')">
                    <div style="display:flex; gap:10px; align-items:center;">${c.icon} ${c.name}</div> 
                    <i class="ri-arrow-right-s-line" style="color:#666"></i>
                </div>`
            ).join('');

            // 5. –ò–ù–í–ï–°–¢–ò–¶–ò–ò
            const invAccs = db.accounts.filter(a => a.type === 'invest');
            document.getElementById('list-inv').innerHTML = invAccs.map(a => 
                `<div class="card flex-between">
                    <div>
                        <b>${a.name}</b><br>
                        <span style="color:var(--success); font-size:12px;">${a.percent}% –≥–æ–¥–æ–≤—ã—Ö</span>
                    </div>
                    <b>${Math.floor(bals[a.id]).toLocaleString()}</b>
                </div>`
            ).join('');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
            renderCharts();
        }

        // ==========================================
        // 5. –ì–†–ê–§–ò–ö–ò (CHART.JS)
        // ==========================================
        function renderCharts() {
            // –ö–†–£–ì–û–í–ê–Ø –î–ò–ê–ì–†–ê–ú–ú–ê (–†–∞—Å—Ö–æ–¥—ã/–î–æ—Ö–æ–¥—ã)
            const ctxPie = document.getElementById('chart-pie');
            const txs = db.transactions.filter(t => t.type === statMode);
            const cats = {}; 
            
            txs.forEach(t => cats[t.categoryId] = (cats[t.categoryId]||0) + parseFloat(t.amount));
            
            if(window.pie) window.pie.destroy();
            window.pie = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats).map(id=>db.categories.find(c=>c.id==id)?.name),
                    datasets: [{ 
                        data: Object.values(cats), 
                        backgroundColor: ['#6366f1','#10b981','#ffd60a','#ff453a','#bf5af2','#30d158'], 
                        borderWidth: 0 
                    }]
                },
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { legend: { position:'right', labels: { color:'#fff', font:{size:11} } } } 
                }
            });
            
            // –°–ø–∏—Å–æ–∫ –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–º
            document.getElementById('list-stats').innerHTML = Object.entries(cats).sort((a,b)=>b[1]-a[1]).map(([id,v])=>{
                const c = db.categories.find(x=>x.id==id)||{name:'?',icon:''};
                return `<div class="flex-between" style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1)">
                    <div style="display:flex; gap:10px; align-items:center;">${c.icon} ${c.name}</div>
                    <b>${Math.floor(v).toLocaleString()}</b>
                </div>`
            }).join('');

            // –õ–ò–ù–ï–ô–ù–´–ô –ì–†–ê–§–ò–ö (–ü—Ä–æ–≥–Ω–æ–∑ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π)
            const ctxInv = document.getElementById('chart-inv');
            const invAccs = db.accounts.filter(a => a.type === 'invest');
            // –°—á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—É–º–º—É –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π —á–µ—Ä–µ–∑ –±–∞–ª–∞–Ω—Å—ã
            const bals = {};
            db.accounts.forEach(a => bals[a.id] = parseFloat(a.balance || 0));
            db.transactions.forEach(t => { if(bals[t.accountId]!==undefined) t.type=='income'?bals[t.accountId]+=t.amount:bals[t.accountId]-=t.amount; });
            
            const current = invAccs.reduce((s,a)=>s+bals[a.id], 0); 
            const growth = current * 1.15; // –ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å +15%
            
            document.getElementById('inv-growth').innerText = `+${Math.floor(growth-current).toLocaleString()}`;
            
            if(window.line) window.line.destroy();
            window.line = new Chart(ctxInv, {
                type: 'line',
                data: {
                    labels: ['–°–µ–π—á–∞—Å', '3 –º–µ—Å', '6 –º–µ—Å', '9 –º–µ—Å', '12 –º–µ—Å'],
                    datasets: [{ 
                        data: [current, current*1.03, current*1.07, current*1.11, growth], 
                        borderColor: '#30d158', 
                        backgroundColor: 'rgba(48,209,88,0.1)', 
                        fill: true,
                        tension: 0.4 
                    }]
                },
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { x: { display: false }, y: { display: false } } 
                }
            });
        }

        // ==========================================
        // 6. –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø–ú–ò
        // ==========================================
        let curTx = { type:'expense', id:null, acc:'', cat:'' };
        let statMode = 'expense';

        function openTxModal(type) {
            vibe();
            curTx = { type, id:null, acc:db.accounts[0]?.id, cat:'' };
            
            document.getElementById('tx-title').innerText = type==='expense'?'–†–∞—Å—Ö–æ–¥':'–î–æ—Ö–æ–¥';
            document.getElementById('tx-amt').value = '';
            document.getElementById('tx-note').value = '';
            document.getElementById('tx-del-btn').classList.add('hidden');
            
            // –†–µ–Ω–¥–µ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞
            document.getElementById('tx-cats-list').innerHTML = db.categories.filter(c=>c.type==type).map(c => 
                `<div class="icon-tile" onclick="curTx.cat='${c.id}'; highlight(this)">${c.icon}</div>`
            ).join('');
            
            openSheet('sheet-tx');
        }

        function editTx(id) {
            const t = db.transactions.find(x=>x.id==id);
            if(!t) return;
            openTxModal(t.type);
            curTx.id = id; curTx.acc = t.accountId; curTx.cat = t.categoryId;
            document.getElementById('tx-amt').value = t.amount;
            document.getElementById('tx-note').value = t.comment;
            document.getElementById('tx-del-btn').classList.remove('hidden');
        }

        function saveTx() {
            const amt = parseFloat(document.getElementById('tx-amt').value);
            if(!amt || !curTx.acc || !curTx.cat) return vibe('error'); // –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏
            
            const tx = {
                id: curTx.id || 'tx_'+Date.now(),
                date: curTx.id ? db.transactions.find(x=>x.id==curTx.id).date : new Date().toISOString(),
                amount: amt,
                type: curTx.type,
                accountId: curTx.acc,
                categoryId: curTx.cat,
                comment: document.getElementById('tx-note').value,
                isWaste: false
            };

            if(curTx.id) {
                const idx = db.transactions.findIndex(t=>t.id==curTx.id);
                db.transactions[idx] = tx;
            } else {
                db.transactions.push(tx);
            }
            
            saveLocal(); closeAll(); pushData(true);
        }

        function deleteTx() {
            if(confirm('–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é?')) {
                db.transactions = db.transactions.filter(t=>t.id!=curTx.id);
                saveLocal(); closeAll(); pushData(true);
            }
        }

        // ==========================================
        // 7. –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ß–ï–¢–ê–ú–ò –ò –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò
        // ==========================================
        let editId = null;
        let accType = 'card';
        
        function openAccModal() { editId=null; document.getElementById('acc-name').value=''; openSheet('sheet-acc'); }
        
        function editAcc(id) { 
            editId=id; const a=db.accounts.find(x=>x.id==id); 
            document.getElementById('acc-name').value=a.name; 
            document.getElementById('acc-bal').value=a.balance; // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
            setAccType(a.type);
            openSheet('sheet-acc');
        }
        
        function setAccType(t) { 
            accType=t; 
            document.getElementById('type-card').className=t=='card'?'seg-btn active':'seg-btn'; 
            document.getElementById('type-invest').className=t=='invest'?'seg-btn active':'seg-btn'; 
            document.getElementById('acc-invest-opts').className=t=='invest'?'':'hidden'; 
        }
        
        function saveAcc() {
            const name = document.getElementById('acc-name').value;
            if(!name) return;
            const data = {
                id: editId || 'acc_'+Date.now(),
                name, type: accType,
                balance: parseFloat(document.getElementById('acc-bal').value)||0,
                percent: parseFloat(document.getElementById('acc-percent').value)||0
            };
            if(editId) { const i=db.accounts.findIndex(x=>x.id==editId); db.accounts[i]=data; } 
            else db.accounts.push(data);
            saveLocal(); closeAll(); pushData(true);
        }
        
        function delAcc() { 
            if(editId && confirm('–£–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç?')) { 
                db.accounts=db.accounts.filter(x=>x.id!=editId); 
                saveLocal(); closeAll(); pushData(true); 
            } 
        }

        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
        function openCatModal() { editId=null; document.getElementById('cat-name').value=''; renderIcons(); openSheet('sheet-cat'); }
        function editCat(id) { editId=id; const c=db.categories.find(x=>x.id==id); document.getElementById('cat-name').value=c.name; renderIcons(); openSheet('sheet-cat'); }
        
        function renderIcons() {
            const icons = ['üçî','üöï','üè†','üíä','üõçÔ∏è','‚úàÔ∏è','üéÅ','‚öΩ','üí∞','üíº','üìà','üéì','üõí','üíÖ','üê∂'];
            document.getElementById('cat-icons-grid').innerHTML = icons.map(i=>
                `<div class="icon-tile" onclick="curTx.icon='${i}'; highlight(this)">${i}</div>`
            ).join('');
        }
        
        function saveCat() {
            const name = document.getElementById('cat-name').value;
            if(!name) return;
            const type = document.getElementById('ctype-exp').classList.contains('active')?'expense':'income';
            const data = { id: editId||'cat_'+Date.now(), name, type, icon: curTx.icon||'üîπ' };
            if(editId) { const i=db.categories.findIndex(x=>x.id==editId); db.categories[i]=data; } 
            else db.categories.push(data);
            saveLocal(); closeAll(); pushData(true);
        }
        
        function delCat() { if(editId && confirm('–£–¥–∞–ª–∏—Ç—å?')) { db.categories=db.categories.filter(x=>x.id!=editId); saveLocal(); closeAll(); pushData(true); } }
        
        function setCatType(t) { 
            document.getElementById('ctype-exp').className=t=='expense'?'seg-btn active':'seg-btn'; 
            document.getElementById('ctype-inc').className=t=='income'?'seg-btn active':'seg-btn'; 
        }

        // ==========================================
        // 8. –£–¢–ò–õ–ò–¢–´ –ò –ù–ê–í–ò–ì–ê–¶–ò–Ø
        // ==========================================
        function setTxAcc(id) { 
            curTx.acc=id; 
            document.querySelectorAll('#tx-accs-list .chip').forEach(c=>c.classList.remove('active')); 
            event.target.closest('.chip').classList.add('active'); 
        }
        
        function highlight(el) { 
            el.parentElement.querySelectorAll('.icon-tile').forEach(c=>c.classList.remove('selected')); 
            el.classList.add('selected'); 
        }
        
        function nav(scr, btn) {
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-invest').classList.add('hidden');
            document.getElementById('view-stats').classList.add('hidden');
            document.getElementById('view-wallet').classList.add('hidden');
            document.getElementById('view-'+scr).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(scr=='stats' || scr=='invest') renderCharts();
            vibe();
        }
        
        function setStatsType(t, el) { 
            statMode=t; 
            document.querySelectorAll('.segment .seg-btn').forEach(b=>b.classList.remove('active')); 
            el.classList.add('active'); 
            renderCharts(); 
            vibe();
        }
        
        function openSheet(id) { 
            document.getElementById('overlay').classList.add('open'); 
            document.getElementById(id).classList.add('open'); 
            vibe(); 
        }
        
        function closeAll() { 
            document.querySelectorAll('.sheet, .overlay').forEach(e=>e.classList.remove('open')); 
        }
        
        async function forceSync() { 
            if(!confirm('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–æ?')) return;
            await pushData(false);
        }
        
        function resetApp() {
            if(!confirm('–°–ë–†–û–°–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å—ë —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞.')) return;
            localStorage.removeItem('onyx_db');
            location.reload();
        }
        
        function vibe(s='light') { 
            try{ tg.HapticFeedback.impactOccurred(s); }catch(e){} 
        }

        // === –ó–ê–ü–£–°–ö ===
        initApp();

    </script>
</body>
</html>