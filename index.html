<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyCosts Cyberpunk</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- PREMIUM DARK THEME --- */
        :root {
            --bg: #09090B; --card: #18181B; --text: #FFFFFF; --text-sec: #A1A1AA;
            --primary: #6366F1; --accent: #8B5CF6;
            --success: #10B981; --danger: #F43F5E; --warning: #F59E0B;
            --gradient: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            --glass: rgba(24, 24, 27, 0.8);
            --radius: 24px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 120px; user-select: none; }
        .container { padding: 20px; max-width: 480px; margin: 0 auto; }

        /* Typography */
        h1, h2 { margin: 0; font-weight: 800; letter-spacing: -0.5px; }
        .text-xs { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-sec); letter-spacing: 1px; }
        .text-sm { font-size: 13px; color: var(--text-sec); }
        .text-gradient { background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Cards */
        .card { background: var(--card); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-col { display: flex; flex-direction: column; gap: 6px; }

        /* Status Bar */
        .status-bar { 
            position: fixed; top: 0; left: 0; right: 0; 
            padding: 8px; text-align: center; font-size: 12px; font-weight: 600; 
            background: var(--bg); color: var(--text-sec); z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: 0.3s; transform: translateY(-100%);
        }
        .status-bar.show { transform: translateY(0); }
        .status-bar.saved { color: var(--success); }
        .status-bar.error { color: var(--danger); }

        /* Balance Card */
        .balance-card { text-align: center; padding: 40px 20px; background: radial-gradient(circle at top right, rgba(99,102,241,0.15), transparent 60%), var(--card); }
        .balance-val { font-size: 48px; font-weight: 800; margin: 10px 0; letter-spacing: -1px; }

        /* Buttons */
        .btn-main { width: 100%; padding: 18px; border-radius: 20px; background: var(--text); color: var(--bg); border: none; font-size: 16px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-main:active { transform: scale(0.97); opacity: 0.9; }
        .btn-icon { width: 44px; height: 44px; border-radius: 14px; background: rgba(255,255,255,0.05); border: none; color: var(--text); font-size: 20px; cursor: pointer; }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px; }
        .btn-act { padding: 16px; border-radius: 18px; border: none; font-size: 16px; font-weight: 700; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-exp { background: rgba(244, 63, 94, 0.15); color: var(--danger); border: 1px solid rgba(244, 63, 94, 0.2); }
        .btn-inc { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }

        /* Inputs */
        .input-money { width: 100%; background: transparent; border: none; color: var(--text); font-size: 40px; font-weight: 700; text-align: center; padding: 20px 0; }
        .input-std { width: 100%; background: var(--bg); border: 1px solid rgba(255,255,255,0.1); padding: 16px; border-radius: 16px; color: var(--text); font-size: 16px; margin-bottom: 12px; }
        
        /* Category Selector */
        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 10px; }
        .cat-item { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 10px 5px; border-radius: 16px; transition: 0.2s; cursor: pointer; }
        .cat-item.active { background: rgba(255,255,255,0.1); }
        .cat-icon { width: 48px; height: 48px; border-radius: 16px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--text-sec); }
        .cat-item.active .cat-icon { background: var(--text); color: var(--bg); }
        .cat-name { font-size: 11px; font-weight: 600; color: var(--text-sec); text-align: center; }

        /* Navigation */
        .nav-bar { position: fixed; bottom: 30px; left: 20px; right: 20px; background: rgba(24, 24, 27, 0.85); backdrop-filter: blur(20px); border-radius: 32px; padding: 12px 30px; display: flex; justify-content: space-between; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5); z-index: 100; }
        .nav-item { background: none; border: none; color: var(--text-sec); font-size: 24px; transition: 0.2s; position: relative; }
        .nav-item.active { color: var(--text); transform: translateY(-4px); }
        .nav-item.active::after { content:''; position:absolute; bottom:-8px; left:50%; transform:translate(-50%); width:4px; height:4px; background:var(--primary); border-radius:50%; }

        /* Modals */
        .modal { position: fixed; inset: 0; background: var(--bg); z-index: 2000; padding: 24px; display: none; overflow-y: auto; }
        .modal.open { display: block; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Lists */
        .list-item { display: flex; align-items: center; gap: 15px; padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .icon-box { width: 44px; height: 44px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: rgba(255,255,255,0.05); }
        
        /* Segmented Control */
        .seg { display: flex; background: var(--bg); padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .seg-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-sec); font-weight: 600; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .seg-btn.active { background: var(--card); color: var(--text); }

        .hidden { display: none !important; }
        .screen { display: none; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    </style>
</head>
<body>

    <!-- STATUS BAR -->
    <div id="status-bar" class="status-bar">–û–±–ª–∞–∫–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>

    <!-- ONBOARDING (Simple) -->
    <div id="onboarding" class="modal" style="z-index:5000; display:flex; flex-direction:column; justify-content:center; text-align:center;">
        <div style="font-size: 60px; margin-bottom: 20px;">üöÄ</div>
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
        <p class="text-sm" style="margin-bottom: 40px; color:var(--text-sec)">–§–∏–Ω–∞–Ω—Å—ã –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è.</p>
        <input type="text" id="ob-name" class="input-std" placeholder="–¢–≤–æ–µ –∏–º—è" style="text-align:center; background:var(--card)">
        <button class="btn-main" onclick="finishOnboarding()">–ù–∞—á–∞—Ç—å</button>
    </div>

    <div class="container">
        <!-- HEADER -->
        <div class="flex-between" style="margin-bottom: 20px;">
            <div>
                <h2 id="head-name">...</h2>
                <div class="text-xs" id="head-id">ID: ...</div>
            </div>
            <button class="btn-icon" onclick="forceSync()"><i class="ri-refresh-line"></i></button>
        </div>

        <!-- 1. HOME SCREEN -->
        <div id="scr-home" class="screen active">
            <div class="card balance-card">
                <div class="text-xs" style="color:var(--text-sec)">–û–ë–©–ò–ô –ö–ê–ü–ò–¢–ê–õ</div>
                <div class="balance-val" id="total-bal">0 ‚ÇΩ</div>
                <div class="action-grid">
                    <button class="btn-act btn-exp" onclick="openTx('expense')"><i class="ri-arrow-down-line"></i> –†–∞—Å—Ö–æ–¥</button>
                    <button class="btn-act btn-inc" onclick="openTx('income')"><i class="ri-arrow-up-line"></i> –î–æ—Ö–æ–¥</button>
                </div>
            </div>

            <div class="flex-between"><h4>–°—á–µ—Ç–∞</h4> <span class="text-xs" onclick="nav('wallet')">–í–°–ï</span></div>
            <div style="display:flex; gap:10px; overflow-x:auto; padding:10px 0 20px; scrollbar-width:none" id="home-accs"></div>

            <div class="flex-between"><h4>–ò—Å—Ç–æ—Ä–∏—è</h4> <span class="text-xs" onclick="nav('stats')">–û–¢–ß–ï–¢</span></div>
            <div id="home-txs"></div>
        </div>

        <!-- 2. ANALYTICS SCREEN -->
        <div id="scr-stats" class="screen">
            <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            <br>
            <div class="seg">
                <button class="seg-btn active" onclick="setStatPeriod('month', this)">–ú–µ—Å—è—Ü</button>
                <button class="seg-btn" onclick="setStatPeriod('year', this)">–ì–æ–¥</button>
                <button class="seg-btn" onclick="setStatPeriod('all', this)">–í—Å–µ</button>
            </div>
            <div class="card">
                <div style="height: 250px; position:relative;"><canvas id="chart-pie"></canvas></div>
            </div>
            <div id="stats-list"></div>
        </div>

        <!-- 3. GOALS / INVEST SCREEN -->
        <div id="scr-goals" class="screen">
            <h2>–¶–µ–ª–∏ & –ò–Ω–≤–µ—Å—Ç üéØ</h2>
            <br>
            <div id="goals-list"></div>
            <button class="btn-main" style="background:var(--card); color:var(--text); margin-top:20px;" onclick="openAcc('target')">+ –ù–æ–≤–∞—è —Ü–µ–ª—å</button>
        </div>

        <!-- 4. WALLET SCREEN -->
        <div id="scr-wallet" class="screen">
            <h2>–ö–æ—à–µ–ª–µ–∫</h2>
            <br>
            <div class="card">
                <div class="flex-between"><h4>–°—á–µ—Ç–∞</h4> <button class="text-xs" style="color:var(--primary)" onclick="openAcc('card')">–î–û–ë–ê–í–ò–¢–¨</button></div>
                <div id="set-accs"></div>
            </div>
            <div class="card">
                <div class="flex-between"><h4>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h4> <button class="text-xs" style="color:var(--primary)" onclick="openCat()">–î–û–ë–ê–í–ò–¢–¨</button></div>
                <div id="set-cats"></div>
            </div>
        </div>
    </div>

    <!-- NAVBAR -->
    <nav class="nav-bar">
        <button class="nav-item active" onclick="nav('home', this)"><i class="ri-home-5-fill"></i></button>
        <button class="nav-item" onclick="nav('stats', this)"><i class="ri-pie-chart-2-fill"></i></button>
        <button class="nav-item" onclick="nav('goals', this)"><i class="ri-flag-2-fill"></i></button>
        <button class="nav-item" onclick="nav('wallet', this)"><i class="ri-wallet-3-fill"></i></button>
    </nav>

    <!-- MODAL: TRANSACTION -->
    <div id="modal-tx" class="modal">
        <div class="flex-between"><h2 id="mtx-title">–†–∞—Å—Ö–æ–¥</h2> <button class="btn-icon" onclick="closeModal('modal-tx')"><i class="ri-close-line"></i></button></div>
        
        <input type="number" id="mtx-amt" class="input-money" placeholder="0" inputmode="decimal">
        
        <div class="text-xs" style="margin-bottom:10px">–°—á–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è</div>
        <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:15px;" id="mtx-accs"></div>

        <div class="text-xs">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
        <div class="cat-grid" id="mtx-cats"></div>

        <div style="margin-top:20px;">
            <div class="text-xs">–î–∞—Ç–∞</div>
            <input type="date" id="mtx-date" class="input-std" style="color-scheme: dark;">
            <input type="text" id="mtx-note" class="input-std" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
        </div>

        <button class="btn-main" onclick="saveTx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- MODAL: ACCOUNT / GOAL -->
    <div id="modal-acc" class="modal">
        <div class="flex-between"><h2 id="macc-title">–°—á–µ—Ç</h2> <button class="btn-icon" onclick="closeModal('modal-acc')"><i class="ri-close-line"></i></button></div>
        <br>
        <input type="text" id="macc-name" class="input-std" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        
        <div class="seg">
            <button class="seg-btn active" onclick="setAccType('card')" id="bt-card">–ö–∞—Ä—Ç–∞</button>
            <button class="seg-btn" onclick="setAccType('target')" id="bt-target">–¶–µ–ª—å</button>
        </div>

        <div id="macc-extra" class="hidden">
            <div class="flex-between" style="gap:10px">
                <input type="number" id="macc-goal" class="input-std" placeholder="–¶–µ–ª—å (—Å—É–º–º–∞)">
                <input type="number" id="macc-pct" class="input-std" placeholder="% –°—Ç–∞–≤–∫–∞">
            </div>
            <p class="text-xs" style="color:var(--success); margin-bottom:15px;" id="macc-hint"></p>
        </div>

        <input type="number" id="macc-bal" class="input-std" placeholder="–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å">
        <button class="btn-main" onclick="saveAcc()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn-ghost" style="color:var(--danger); width:100%; margin-top:10px;" onclick="delAcc()">–£–¥–∞–ª–∏—Ç—å</button>
    </div>

    <!-- MODAL: CATEGORY -->
    <div id="modal-cat" class="modal">
        <div class="flex-between"><h2>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2> <button class="btn-icon" onclick="closeModal('modal-cat')"><i class="ri-close-line"></i></button></div>
        <br>
        <input type="text" id="mcat-name" class="input-std" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <div class="seg">
            <button class="seg-btn active" onclick="setCatType('expense')" id="bct-exp">–†–∞—Å—Ö–æ–¥</button>
            <button class="seg-btn" onclick="setCatType('income')" id="bct-inc">–î–æ—Ö–æ–¥</button>
        </div>
        <div class="cat-grid" id="mcat-icons"></div>
        <button class="btn-main" onclick="saveCat()" style="margin-top:20px">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn-ghost" style="color:var(--danger); width:100%; margin-top:10px;" onclick="delCat()">–£–¥–∞–ª–∏—Ç—å</button>
    </div>

    <script>
        // --- CONFIG ---
        // !!! –í–°–¢–ê–í–¨ –°–í–û–Æ –°–°–´–õ–ö–£ !!!
        const API_URL = 'https://script.google.com/macros/s/AKfycby_ES9U2-4VYmPhMLbDtNNv_ESnbUEI9nlw0euEHsxZ6eJqu340_LpF_A1pSxyUvRxG/exec';

        // --- INIT ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let db = JSON.parse(localStorage.getItem('my_db_v12')) || { user:{name:''}, accounts:[], categories:[], transactions:[] };
        let uid = localStorage.getItem('my_uid');
        if(!uid) { uid = 'u_'+Date.now(); localStorage.setItem('my_uid', uid); }

        // Default Categories (Rich set)
        if(db.categories.length === 0) {
            db.categories = [
                {id:'c1', name:'–ï–¥–∞', type:'expense', icon:'ri-restaurant-line', color:'#F59E0B'},
                {id:'c2', name:'–¢–∞–∫—Å–∏', type:'expense', icon:'ri-taxi-fill', color:'#3B82F6'},
                {id:'c3', name:'–î–æ–º', type:'expense', icon:'ri-home-4-line', color:'#8B5CF6'},
                {id:'c4', name:'–®–æ–ø–ø–∏–Ω–≥', type:'expense', icon:'ri-shopping-bag-line', color:'#EC4899'},
                {id:'c5', name:'–ó–¥–æ—Ä–æ–≤—å–µ', type:'expense', icon:'ri-heart-pulse-line', color:'#EF4444'},
                {id:'c6', name:'–ó–ü', type:'income', icon:'ri-briefcase-4-line', color:'#10B981'},
                {id:'c7', name:'–§—Ä–∏–ª–∞–Ω—Å', type:'income', icon:'ri-macbook-line', color:'#6366F1'}
            ];
        }

        // --- ONBOARDING ---
        if(!db.user.name) document.getElementById('onboarding').style.display='flex';
        else { updateUI(); autoSync(); }

        function finishOnboarding() {
            const name = document.getElementById('ob-name').value || '–ë–æ—Å—Å';
            db.user = { name };
            if(db.accounts.length===0) db.accounts.push({id:'a1', name:'–û—Å–Ω–æ–≤–Ω–æ–π', type:'card', balance:0});
            saveDB();
            document.getElementById('onboarding').style.display='none';
            updateUI(); autoSync();
        }

        // --- CORE ---
        function saveDB() {
            localStorage.setItem('my_db_v12', JSON.stringify(db));
            renderAll();
            status('saving');
            clearTimeout(window.syncTimer);
            window.syncTimer = setTimeout(autoSync, 2000); // Debounce sync
        }

        function status(s) {
            const el = document.getElementById('status-bar');
            el.className = 'status-bar show ' + (s=='saved'?'saved':(s=='error'?'error':''));
            el.innerText = s=='saved' ? '‚òÅÔ∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ' : (s=='error' ? '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' : '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
            if(s=='saved' || s=='error') setTimeout(()=>el.classList.remove('show'), 2000);
        }

        async function autoSync() {
            try {
                await fetch(API_URL + '?action=sync_all', {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ user_id: uid, accounts: db.accounts, categories: db.categories, transactions: db.transactions })
                });
                status('saved');
            } catch(e) { status('error'); }
        }
        
        async function forceSync() {
            if(!confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞? –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.')) return;
            status('saving');
            try {
                const res = await fetch(`${API_URL}?action=load&user_id=${uid}`);
                const j = await res.json();
                if(j.status=='success' && j.data.accounts.length) {
                    db.accounts = j.data.accounts; db.categories = j.data.categories; db.transactions = j.data.transactions;
                    saveDB(); status('saved');
                }
            } catch(e) { status('error'); }
        }

        // --- RENDER ---
        function fmt(n) { return Math.floor(n).toLocaleString('ru-RU') + ' ‚ÇΩ'; }
        
        function updateUI() {
            document.getElementById('head-name').innerText = db.user.name;
            document.getElementById('head-id').innerText = 'ID: ' + uid.slice(-4);
            renderAll();
        }

        function renderAll() {
            // Balance
            const total = db.accounts.reduce((s,a)=>s+(a.type=='card'?a.balance:0), 0);
            document.getElementById('total-bal').innerText = fmt(total);

            // Home Accounts
            document.getElementById('home-accs').innerHTML = db.accounts.filter(a=>a.type=='card').map(a => `
                <div class="card" style="min-width:140px; padding:15px; margin:0;" onclick="editAcc('${a.id}')">
                    <div style="font-weight:700">${a.name}</div>
                    <div style="margin-top:5px; color:var(--primary); font-weight:800">${fmt(a.balance)}</div>
                </div>`).join('');

            // Home Transactions
            const txs = db.transactions.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0, 10);
            document.getElementById('home-txs').innerHTML = txs.map(t => renderTx(t)).join('');

            // Goals
            const goals = db.accounts.filter(a=>a.type=='target');
            document.getElementById('goals-list').innerHTML = goals.map(a => {
                const pct = a.goal>0 ? Math.min(100, (a.balance/a.goal)*100) : 0;
                return `<div class="card" onclick="editAcc('${a.id}')">
                    <div class="flex-between"><b>${a.name}</b> <b>${fmt(a.balance)}</b></div>
                    <div class="flex-between text-xs" style="margin-top:8px;"><span>–¶–µ–ª—å: ${fmt(a.goal)}</span> <span>${Math.floor(pct)}%</span></div>
                    <div style="height:6px; background:#333; border-radius:3px; margin-top:5px; overflow:hidden"><div style="height:100%; width:${pct}%; background:var(--primary)"></div></div>
                    ${a.percent ? `<div class="text-xs" style="color:var(--success); margin-top:8px;">+${a.percent}% –≥–æ–¥–æ–≤—ã—Ö</div>` : ''}
                </div>`;
            }).join('');

            // Settings Lists
            document.getElementById('set-accs').innerHTML = db.accounts.map(a=>`<div class="list-item" onclick="editAcc('${a.id}')"><b>${a.name}</b> <span style="margin-left:auto">${fmt(a.balance)}</span></div>`).join('');
            document.getElementById('set-cats').innerHTML = db.categories.map(c=>`<div class="list-item" onclick="editCat('${c.id}')"><div class="icon-box"><i class="${c.icon}"></i></div> ${c.name}</div>`).join('');
            
            renderStats();
        }

        function renderTx(t) {
            const c = db.categories.find(x=>x.id==t.catId) || {name:'?', icon:'ri-question-line'};
            return `<div class="list-item">
                <div class="icon-box" style="color:${c.color}"><i class="${c.icon}"></i></div>
                <div><b>${c.name}</b><br><span class="text-xs" style="text-transform:none; margin:0">${new Date(t.date).toLocaleDateString()} ${t.note?'‚Ä¢ '+t.note:''}</span></div>
                <div style="margin-left:auto; font-weight:700; color:${t.type=='expense'?'var(--text)':'var(--success)'}">${t.type=='expense'?'-':'+'}${fmt(t.amount)}</div>
            </div>`;
        }

        // --- STATS ---
        let statPeriod = 'month';
        function setStatPeriod(p, el) { 
            statPeriod = p; 
            document.querySelectorAll('.seg-btn').forEach(b=>b.classList.remove('active')); 
            el.classList.add('active'); 
            renderStats(); 
        }

        function renderStats() {
            const ctx = document.getElementById('chart-pie');
            const now = new Date();
            let txs = db.transactions.filter(t => t.type === 'expense');
            
            // Time Filter
            if (statPeriod === 'month') txs = txs.filter(t => new Date(t.date).getMonth() === now.getMonth() && new Date(t.date).getFullYear() === now.getFullYear());
            if (statPeriod === 'year') txs = txs.filter(t => new Date(t.date).getFullYear() === now.getFullYear());

            const cats = {}; txs.forEach(t => cats[t.catId] = (cats[t.catId]||0) + t.amount);
            
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats).map(id=>db.categories.find(c=>c.id==id)?.name),
                    datasets: [{ data: Object.values(cats), backgroundColor: ['#6366F1','#8B5CF6','#EC4899','#F43F5E','#F59E0B','#10B981'], borderWidth:0 }]
                }, options: { maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{color:'#9CA3AF', font:{size:11}}}} }
            });

            document.getElementById('stats-list').innerHTML = Object.entries(cats).sort((a,b)=>b[1]-a[1]).map(([id,v])=>{
                const c = db.categories.find(x=>x.id==id);
                const pct = (v / txs.reduce((s,t)=>s+t.amount,0) * 100).toFixed(1);
                return `<div class="list-item"><div class="icon-box"><i class="${c.icon}"></i></div> <div style="flex:1"><b>${c.name}</b></div> <b>${fmt(v)}</b> <span class="text-xs" style="margin:0 0 0 10px">${pct}%</span></div>`;
            }).join('');
        }

        // --- MODAL LOGIC ---
        let cur = {type:'expense', acc:'', cat:''};
        
        function openTx(type) {
            cur.type = type;
            document.getElementById('mtx-title').innerText = type=='expense'?'–†–∞—Å—Ö–æ–¥':'–î–æ—Ö–æ–¥';
            document.getElementById('mtx-amt').value = ''; 
            document.getElementById('mtx-note').value = '';
            document.getElementById('mtx-date').valueAsDate = new Date();
            
            // Filter Categories
            const validCats = db.categories.filter(c => c.type === type);
            document.getElementById('mtx-cats').innerHTML = validCats.map(c => `
                <div class="cat-item" onclick="cur.cat='${c.id}'; highlight(this, 'cat-item')">
                    <div class="cat-icon"><i class="${c.icon}"></i></div>
                    <div class="cat-name">${c.name}</div>
                </div>`).join('');
            
            // Accounts
            document.getElementById('mtx-accs').innerHTML = db.accounts.map(a => `
                <div class="acc-chip" onclick="cur.acc='${a.id}'; highlight(this, 'acc-chip')">
                    <b>${a.name}</b><br><span class="text-xs" style="margin:0">${fmt(a.balance)}</span>
                </div>`).join('');
            
            openModal('modal-tx');
        }

        function saveTx() {
            const amt = parseFloat(document.getElementById('mtx-amt').value);
            if(!amt || !cur.acc || !cur.cat) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Å—É–º–º—É, —Å—á–µ—Ç –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
            
            const tx = {
                id: 'tx_'+Date.now(), date: document.getElementById('mtx-date').value,
                amount: amt, type: cur.type, accountId: cur.acc, catId: cur.cat,
                note: document.getElementById('mtx-note').value
            };
            db.transactions.push(tx);
            
            const acc = db.accounts.find(a=>a.id==cur.acc);
            if(acc) cur.type=='income' ? acc.balance+=amt : acc.balance-=amt;
            
            saveDB(); closeModal('modal-tx');
        }

        // --- ACCOUNT EDIT ---
        let editId = null; let accType = 'card';
        function openAcc(type) { editId=null; accType=type||'card'; setupAccModal(); openModal('modal-acc'); }
        function editAcc(id) { editId=id; const a=db.accounts.find(x=>x.id==id); accType=a.type; setupAccModal(a); openModal('modal-acc'); }
        
        function setupAccModal(a) {
            document.getElementById('macc-name').value = a ? a.name : '';
            document.getElementById('macc-bal').value = a ? a.balance : '';
            document.getElementById('macc-goal').value = a ? a.goal : '';
            document.getElementById('macc-pct').value = a ? a.percent : '';
            setAccType(a ? a.type : accType);
        }
        function setAccType(t) {
            accType=t; 
            ['card','target'].forEach(x=>document.getElementById('bt-'+x).className = t==x ? 'seg-btn active' : 'seg-btn');
            document.getElementById('macc-extra').style.display = t=='target'?'block':'none';
        }
        function saveAcc() {
            const name = document.getElementById('macc-name').value;
            const bal = parseFloat(document.getElementById('macc-bal').value)||0;
            if(!name) return;
            const data = { 
                id: editId||'a_'+Date.now(), name, type: accType, balance: bal, 
                goal: parseFloat(document.getElementById('macc-goal').value)||0,
                percent: parseFloat(document.getElementById('macc-pct').value)||0
            };
            if(editId) { const i=db.accounts.findIndex(x=>x.id==editId); db.accounts[i]=data; }
            else db.accounts.push(data);
            saveDB(); closeModal('modal-acc');
        }
        function delAcc() { if(editId && confirm('–£–¥–∞–ª–∏—Ç—å?')) { db.accounts=db.accounts.filter(x=>x.id!=editId); saveDB(); closeModal('modal-acc'); } }

        // --- CAT EDIT ---
        let catType = 'expense';
        function openCat() { editId=null; setupCatModal(); openModal('modal-cat'); }
        function editCat(id) { editId=id; setupCatModal(db.categories.find(x=>x.id==id)); openModal('modal-cat'); }
        function setupCatModal(c) {
            document.getElementById('mcat-name').value = c ? c.name : '';
            setCatType(c ? c.type : 'expense');
            // Icons
            const icons = ['ri-home-4-line','ri-restaurant-line','ri-taxi-line','ri-shopping-cart-line','ri-heart-pulse-line','ri-plane-line','ri-gamepad-line','ri-book-open-line','ri-gift-line','ri-briefcase-4-line','ri-money-dollar-circle-line','ri-bank-card-line'];
            document.getElementById('mcat-icons').innerHTML = icons.map(i => `<div class="icon-box" onclick="cur.icon='${i}'; highlight(this,'icon-box')"><i class="${i}"></i></div>`).join('');
        }
        function setCatType(t) {
            catType=t; 
            document.getElementById('bct-exp').className = t=='expense'?'seg-btn active':'seg-btn';
            document.getElementById('bct-inc').className = t=='income'?'seg-btn active':'seg-btn';
        }
        function saveCat() {
            const name=document.getElementById('mcat-name').value; if(!name) return;
            const data = {id:editId||'c_'+Date.now(), name, type:catType, icon:cur.icon||'ri-star-line', color:catType=='expense'?'#F43F5E':'#10B981'};
            if(editId) { const i=db.categories.findIndex(x=>x.id==editId); db.categories[i]=data; }
            else db.categories.push(data);
            saveDB(); closeModal('modal-cat');
        }
        function delCat() { if(editId && confirm('–£–¥–∞–ª–∏—Ç—å?')) { db.categories=db.categories.filter(x=>x.id!=editId); saveDB(); closeModal('modal-cat'); } }

        // --- UTILS ---
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function highlight(el, cls) { document.querySelectorAll('.'+cls).forEach(x=>x.classList.remove('active')); el.classList.add('active'); }
        function nav(s,b) { document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active')); document.getElementById('scr-'+s).classList.add('active'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); if(b) b.classList.add('active'); }
        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme')=='dark'?'light':'dark'); }

        renderAll();
    </script>
</body>
</html>
