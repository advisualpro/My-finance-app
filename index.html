<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>MyCosts Enterprise v19</title>
    
    <!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –í–ù–ï–®–ù–ò–• –ë–ò–ë–õ–ò–û–¢–ï–ö -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- –°–¢–ò–õ–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø -->
    <style>
        /* ========================================= */
        /* 1. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï (THEME ENGINE)   */
        /* ========================================= */
        :root {
            /* –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ (Onyx Dark) */
            --color-bg-base: #000000;
            --color-bg-card: #1c1c1e;
            --color-bg-modal: #2c2c2e;
            --color-bg-input: #2c2c2e;
            --color-bg-hover: #3a3a3c;
            
            /* –¢–µ–∫—Å—Ç */
            --color-text-primary: #ffffff;
            --color-text-secondary: #8e8e93;
            --color-text-tertiary: #636366;
            
            /* –ë—Ä–µ–Ω–¥–∏–Ω–≥ (Indigo Blue) */
            --color-brand: #0a84ff;
            --color-brand-rgb: 10, 132, 255;
            --color-brand-dim: rgba(10, 132, 255, 0.15);
            
            /* –°–µ–º–∞–Ω—Ç–∏–∫–∞ */
            --color-success: #30d158;
            --color-danger: #ff453a;
            --color-warning: #ffd60a;
            
            /* –†–∞–∑–º–µ—Ä—ã */
            --radius-card: 24px;
            --radius-button: 16px;
            --radius-input: 14px;
            --radius-pill: 100px;
            
            /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            
            /* –®—Ä–∏—Ñ—Ç */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            
            /* –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–æ–Ω—ã (–¥–ª—è iPhone —Å —á–µ–ª–∫–æ–π) */
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* ========================================= */
        /* 2. –ë–ê–ó–û–í–´–ô –°–ë–†–û–° (RESET)                  */
        /* ========================================= */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            user-select: none;
        }

        body {
            background-color: var(--color-bg-base);
            color: var(--color-text-primary);
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            padding-bottom: calc(100px + var(--safe-area-bottom));
            overflow-x: hidden;
            font-size: 16px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            padding: 16px;
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* ========================================= */
        /* 3. –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê                            */
        /* ========================================= */
        h1 {
            font-size: 34px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin: 0 0 8px 0;
            color: var(--color-text-primary);
        }

        h2 {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.3px;
            margin: 0;
            color: var(--color-text-primary);
        }

        h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin: 0;
            letter-spacing: 0.2px;
        }

        .text-hero {
            font-size: 42px;
            font-weight: 800;
            letter-spacing: -1.5px;
            line-height: 1.1;
            background: linear-gradient(180deg, #fff 0%, #a1a1aa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .text-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--color-text-secondary);
            display: block;
            margin-bottom: 6px;
        }

        .text-value {
            font-family: var(--font-family);
            font-variant-numeric: tabular-nums;
        }

        /* ========================================= */
        /* 4. –ö–û–ú–ü–û–ù–ï–ù–¢–´ UI: –ö–ê–†–¢–û–ß–ö–ò                */
        /* ========================================= */
        .card-panel {
            background-color: var(--color-bg-card);
            border-radius: var(--radius-card);
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s var(--ease-smooth);
        }
        
        .card-panel:active {
            transform: scale(0.99);
        }

        .layout-flex-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .layout-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .layout-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        /* ========================================= */
        /* 5. –ö–û–ú–ü–û–ù–ï–ù–¢–´ UI: –ö–ù–û–ü–ö–ò                  */
        /* ========================================= */
        .btn {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius-button);
            border: none;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            transition: all 0.2s var(--ease-smooth);
        }

        .btn:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        .btn-primary {
            background-color: var(--color-brand);
            color: #ffffff;
            box-shadow: 0 8px 20px rgba(var(--color-brand-rgb), 0.3);
        }

        .btn-secondary {
            background-color: var(--color-bg-input);
            color: var(--color-text-primary);
        }
        .btn-secondary:active {
            background-color: var(--color-bg-hover);
        }

        .btn-danger {
            background-color: rgba(255, 69, 58, 0.15);
            color: var(--color-danger);
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: var(--color-bg-input);
            color: var(--color-text-primary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-icon:active {
            background-color: var(--color-bg-hover);
        }

        /* ========================================= */
        /* 6. –ö–û–ú–ü–û–ù–ï–ù–¢–´ UI: –ü–û–õ–Ø –í–í–û–î–ê              */
        /* ========================================= */
        .input-hero {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--color-text-primary);
            font-size: 48px;
            font-weight: 800;
            text-align: center;
            padding: 24px 0;
            font-family: var(--font-family);
        }

        .input-field {
            width: 100%;
            background-color: var(--color-bg-input);
            border: 1px solid transparent;
            padding: 16px;
            border-radius: var(--radius-button);
            color: var(--color-text-primary);
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        .input-field:focus {
            border-color: var(--color-brand);
            background-color: #000;
        }

        /* ========================================= */
        /* 7. –ö–û–ú–ü–û–ù–ï–ù–¢–´ UI: –ù–ê–í–ò–ì–ê–¶–ò–Ø               */
        /* ========================================= */
        .bottom-nav {
            position: fixed;
            bottom: 24px;
            left: 20px;
            right: 20px;
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 32px;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 1000;
            max-width: 460px;
            margin: auto;
        }
        
        .nav-item {
            color: var(--color-text-secondary);
            font-size: 26px;
            padding: 10px;
            transition: 0.3s;
            position: relative;
            cursor: pointer;
        }
        .nav-item.active {
            color: var(--color-text-primary);
            transform: translateY(-4px);
        }
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--color-brand);
        }

        /* ========================================= */
        /* 8. –ö–û–ú–ü–û–ù–ï–ù–¢–´ UI: –°–ü–ò–°–ö–ò –ò –°–ö–†–û–õ–õ–´        */
        /* ========================================= */
        .scroll-horizontal {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none;
        }
        .scroll-horizontal::-webkit-scrollbar { display: none; }

        .chip-card {
            min-width: 130px;
            background-color: var(--color-bg-input);
            padding: 14px;
            border-radius: var(--radius-button);
            border: 1px solid transparent;
            cursor: pointer;
            transition: 0.2s;
            flex-shrink: 0;
        }
        .chip-card.active {
            border-color: var(--color-brand);
            background-color: var(--color-brand-dim);
        }

        .icon-tile {
            aspect-ratio: 1;
            background-color: var(--color-bg-input);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: 0.2s;
        }
        .icon-tile.selected {
            border-color: var(--color-brand);
            background-color: var(--color-brand-dim);
        }

        /* ========================================= */
        /* 9. –ö–û–ú–ü–û–ù–ï–ù–¢–´ UI: –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê          */
        /* ========================================= */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            backdrop-filter: blur(5px);
        }
        .modal-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-bg-card);
            border-radius: 32px 32px 0 0;
            padding: 24px;
            padding-bottom: 50px;
            transform: translateY(100%);
            transition: 0.4s var(--ease-spring);
            z-index: 2001;
            max-height: 90vh;
            overflow-y: auto;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .modal-sheet.active {
            transform: translateY(0);
        }
        .sheet-handle {
            width: 40px;
            height: 5px;
            background: rgba(255,255,255,0.2);
            border-radius: 100px;
            margin: 0 auto 24px auto;
        }

        /* ========================================= */
        /* 10. –£–¢–ò–õ–ò–¢–´ –ò –õ–û–ê–î–ï–†–´                     */
        /* ========================================= */
        .hidden { display: none !important; }
        
        #loading-screen {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top-color: var(--color-brand);
            border-radius: 50%;
            animation: spin 1s infinite linear;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ */
        .sync-badge {
            padding: 6px 12px;
            background: var(--color-bg-input);
            border-radius: 20px;
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
        }
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }
        .dot-green { background: var(--color-success); box-shadow: 0 0 8px var(--color-success); }
        .dot-yellow { background: var(--color-warning); animation: pulse 1s infinite; }
        .dot-red { background: var(--color-danger); }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä—ã */
        .bar-track {
            width: 100%;
            height: 8px;
            background: var(--color-bg-input);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .bar-fill {
            height: 100%;
            transition: width 1s ease;
            border-radius: 4px;
        }
        .fill-green { background: var(--color-success); }
        .fill-red { background: var(--color-danger); }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º */
        .month-picker {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--color-bg-input);
            padding: 6px 10px;
            border-radius: 100px;
            margin-bottom: 20px;
        }
        .month-btn {
            background: none; border: none;
            color: var(--color-text-secondary);
            font-size: 24px; padding: 0 10px; cursor: pointer;
        }
        .month-label { font-weight: 700; font-size: 15px; }
    </style>
</head>
<body>
    <!-- ========================================== -->
    <!-- 1. –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò (PRELOADER)              -->
    <!-- ========================================== -->
    <div id="loading-screen">
        <div class="spinner"></div>
    </div>

    <!-- ========================================== -->
    <!-- 2. –≠–ö–†–ê–ù –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø (ONBOARDING)          -->
    <!-- ========================================== -->
    <div id="view-onboarding" class="container hidden" style="display:flex; flex-direction:column; justify-content:center; text-align:center;">
        <div style="font-size: 64px; margin-bottom: 20px;">üëã</div>
        <h1>–ü—Ä–∏–≤–µ—Ç!</h1>
        <p class="text-label" style="text-transform: none; font-size: 15px; margin-bottom: 40px; opacity: 0.7;">
            MyCosts Enterprise ‚Äî —Ç–≤–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä.<br>–î–∞–≤–∞–π –Ω–∞—Å—Ç—Ä–æ–∏–º –ø—Ä–æ—Ñ–∏–ª—å.
        </p>
        
        <div class="card-panel" style="text-align:left;">
            <span class="text-label">–ö–ê–ö –¢–ï–ë–Ø –ó–û–í–£–¢?</span>
            <input type="text" id="setup-name" class="input-field" placeholder="–ò–º—è">
            
            <span class="text-label">–ë–Æ–î–ñ–ï–¢ –ù–ê –ú–ï–°–Ø–¶ (‚ÇΩ)</span>
            <input type="number" id="setup-limit" class="input-field" placeholder="100 000">
        </div>
        
        <button class="btn btn-primary" onclick="Core.finishOnboarding()">
            –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
        </button>
    </div>

    <!-- ========================================== -->
    <!-- 3. –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï (MAIN APP)          -->
    <!-- ========================================== -->
    <div id="view-app" class="container hidden">
        
        <!-- –í–ï–†–•–ù–Ø–Ø –®–ê–ü–ö–ê -->
        <div class="layout-flex-row" style="margin-bottom: 20px; padding-top: 10px;">
            <div class="sync-badge" onclick="Sync.force()">
                <div class="sync-dot" id="ui-sync-dot"></div>
                <span id="ui-sync-text">CONNECTING</span>
            </div>
            <div style="font-weight: 700; font-size: 16px;" id="ui-user-name">User</div>
        </div>

        <!-- >>> –≠–ö–†–ê–ù: –ì–õ–ê–í–ù–ê–Ø (HOME) <<< -->
        <div id="tab-home">
            
            <!-- –ú–ê–®–ò–ù–ê –í–†–ï–ú–ï–ù–ò -->
            <div class="month-picker">
                <button class="month-btn" onclick="Time.prev()"><i class="ri-arrow-left-s-line"></i></button>
                <div class="month-label" id="ui-month-label">...</div>
                <button class="month-btn" onclick="Time.next()"><i class="ri-arrow-right-s-line"></i></button>
            </div>

            <!-- –ì–õ–ê–í–ù–´–ô –ë–ê–õ–ê–ù–° -->
            <div class="card-panel" style="text-align: center; padding: 32px 20px;">
                <span class="text-label">–û–ë–©–ò–ô –ö–ê–ü–ò–¢–ê–õ</span>
                <div class="text-hero" id="ui-total-balance">0 ‚ÇΩ</div>
                
                <div class="layout-grid-2" style="margin-top: 24px;">
                    <button class="btn btn-danger" onclick="Modal.openTx('expense')">
                        <i class="ri-arrow-down-line"></i> –†–∞—Å—Ö–æ–¥
                    </button>
                    <button class="btn" style="background: rgba(48, 209, 88, 0.15); color: var(--color-success);" onclick="Modal.openTx('income')">
                        <i class="ri-arrow-up-line"></i> –î–æ—Ö–æ–¥
                    </button>
                </div>
            </div>

            <!-- CASHFLOW (–§–ò–ù–ê–ù–°–û–í–ê–Ø –°–í–û–ë–û–î–ê) -->
            <div class="card-panel">
                <div class="layout-flex-row">
                    <span class="text-label" style="margin:0">–°–í–û–ë–û–î–ê</span>
                    <span style="font-weight: 800;" id="ui-freedom-rate">0%</span>
                </div>
                <div class="bar-track">
                    <div class="bar-fill bg-green" id="ui-freedom-bar" style="width: 0%"></div>
                </div>
                <div class="layout-flex-row" style="margin-top: 12px;">
                    <div>
                        <span class="text-label" style="font-size: 10px;">–ü–ê–°–°–ò–í–ù–´–ô</span>
                        <div style="font-weight: 700; color: var(--color-success);" id="ui-val-passive">0 ‚ÇΩ</div>
                    </div>
                    <div style="text-align: right;">
                        <span class="text-label" style="font-size: 10px;">–†–ê–°–•–û–î–´ (–ú–ï–°)</span>
                        <div style="font-weight: 700; color: var(--color-danger);" id="ui-val-expense">0 ‚ÇΩ</div>
                    </div>
                </div>
            </div>

            <!-- –ë–Æ–î–ñ–ï–¢ -->
            <div class="card-panel">
                <div class="layout-flex-row">
                    <span class="text-label" style="margin:0">–û–°–¢–ê–¢–û–ö –ë–Æ–î–ñ–ï–¢–ê</span>
                    <span style="font-weight: 700;" id="ui-budget-left">0 ‚ÇΩ</span>
                </div>
                <div class="bar-track">
                    <div class="bar-fill bg-red" id="ui-budget-bar" style="width: 0%"></div>
                </div>
            </div>

            <!-- –°–ü–ò–°–û–ö –°–ß–ï–¢–û–í -->
            <div class="layout-flex-row" style="margin-bottom: 12px;">
                <h3>–ú–æ–∏ –°—á–µ—Ç–∞</h3>
                <span class="text-label" style="color: var(--color-brand); cursor: pointer;" onclick="Nav.to('wallet')">–í–°–ï</span>
            </div>
            <div class="scroll-horizontal" id="list-accs-home"></div>

            <!-- –ò–°–¢–û–†–ò–Ø –û–ü–ï–†–ê–¶–ò–ô -->
            <div class="layout-flex-row" style="margin-top: 24px; margin-bottom: 12px;">
                <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
                <span class="text-label" style="color: var(--color-brand); cursor: pointer;" onclick="Nav.to('stats')">–ê–ù–ê–õ–ò–ó</span>
            </div>
            <div id="list-tx-home" style="padding-bottom: 20px;"></div>
        </div>

        <!-- >>> –≠–ö–†–ê–ù 2: –ò–ù–í–ï–°–¢–ò–¶–ò–ò (INVEST) <<< -->
        <div id="tab-invest" class="hidden">
            <h2>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h2>
            <p class="text-label" style="text-transform: none; font-size: 14px; opacity: 0.7;">–†–æ—Å—Ç –∫–∞–ø–∏—Ç–∞–ª–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏</p>
            <br>
            
            <div class="card-panel">
                <div class="layout-flex-row">
                    <span class="text-label">–ü–†–û–ì–ù–û–ó (1 –ì–û–î)</span>
                    <span style="color: var(--color-success); font-weight: 700;" id="ui-inv-forecast">+0 ‚ÇΩ</span>
                </div>
                <div style="height: 220px; margin-top: 15px;">
                    <canvas id="chart-invest"></canvas>
                </div>
            </div>
            
            <h3>–ü–æ—Ä—Ç—Ñ–µ–ª—å</h3>
            <div id="list-inv" style="margin-top: 12px;"></div>
        </div>

        <!-- >>> –≠–ö–†–ê–ù 3: –ê–ù–ê–õ–ò–¢–ò–ö–ê (STATS) <<< -->
        <div id="tab-stats" class="hidden">
            <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            <br>
            <div class="layout-grid-2" style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="Stats.setMode('expense')">–†–∞—Å—Ö–æ–¥—ã</button>
                <button class="btn btn-secondary" onclick="Stats.setMode('income')">–î–æ—Ö–æ–¥—ã</button>
            </div>
            
            <div class="card-panel">
                <div style="height: 260px; position: relative;">
                    <canvas id="chart-pie"></canvas>
                </div>
            </div>
            
            <div id="list-stats"></div>
        </div>

        <!-- >>> –≠–ö–†–ê–ù 4: –£–ü–†–ê–í–õ–ï–ù–ò–ï (WALLET) <<< -->
        <div id="tab-wallet" class="hidden">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            <br>
            
            <div class="card-panel">
                <div class="layout-flex-row" style="margin-bottom: 16px;">
                    <h3>–°—á–µ—Ç–∞</h3>
                    <button class="btn-icon" onclick="Modal.openAcc()"><i class="ri-add-line"></i></button>
                </div>
                <div id="list-acc-manage"></div>
            </div>

            <div class="card-panel">
                <div class="layout-flex-row" style="margin-bottom: 16px;">
                    <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                    <button class="btn-icon" onclick="Modal.openCat()"><i class="ri-add-line"></i></button>
                </div>
                <div id="list-cat-manage"></div>
            </div>
            
            <button class="btn btn-secondary" style="margin-top: 20px; color: var(--color-danger);" onclick="Core.reset()">
                <i class="ri-delete-bin-line"></i> –°–±—Ä–æ—Å –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
            </button>
        </div>

    </div>

    <!-- –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ -->
    <div class="bottom-nav">
        <i class="ri-home-5-fill nav-item active" onclick="Nav.to('home', this)"></i>
        <i class="ri-line-chart-fill nav-item" onclick="Nav.to('invest', this)"></i>
        <i class="ri-pie-chart-2-fill nav-item" onclick="Nav.to('stats', this)"></i>
        <i class="ri-wallet-3-fill nav-item" onclick="Nav.to('wallet', this)"></i>
    </div>
    <!-- ========================================== -->
    <!-- –í–°–ü–õ–´–í–ê–Æ–©–ò–ï –û–ö–ù–ê (MODAL SHEETS)            -->
    <!-- ========================================== -->
    
    <!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ -->
    <div class="modal-backdrop" id="backdrop" onclick="Modal.closeAll()"></div>

    <!-- 1. –û–ö–ù–û –¢–†–ê–ù–ó–ê–ö–¶–ò–ò (TRANSACTION FORM) -->
    <div class="modal-sheet" id="sheet-tx">
        <div class="sheet-handle"></div>
        
        <div class="layout-flex-row" style="margin-bottom: 20px;">
            <h2 id="tx-title">–†–∞—Å—Ö–æ–¥</h2>
            <div class="btn-icon" onclick="Modal.closeAll()"><i class="ri-close-line"></i></div>
        </div>
        
        <!-- –í–≤–æ–¥ —Å—É–º–º—ã -->
        <div class="input-wrapper">
            <input type="text" id="tx-amt" class="input-money" placeholder="0" inputmode="decimal">
        </div>
        
        <!-- –í—ã–±–æ—Ä —Å—á–µ—Ç–∞ -->
        <span class="text-label">–°–ß–ï–¢ –°–ü–ò–°–ê–ù–ò–Ø</span>
        <div class="scroll-horizontal" id="tx-accs-list" style="margin-bottom: 24px;"></div>
        
        <!-- –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <span class="text-label">–ö–ê–¢–ï–ì–û–†–ò–Ø</span>
        <div class="layout-grid-4" id="tx-cats-list" style="margin-bottom: 24px;"></div>
        
        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
        <input type="text" id="tx-note" class="input-field" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
        
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="layout-grid-2">
            <button class="btn btn-primary" onclick="Actions.saveTx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary hidden" id="tx-del-btn" style="color:var(--color-danger)" onclick="Actions.deleteTx()">
                –£–¥–∞–ª–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- 2. –û–ö–ù–û –°–ß–ï–¢–ê (ACCOUNT FORM) -->
    <div class="modal-sheet" id="sheet-acc">
        <div class="sheet-handle"></div>
        
        <div class="layout-flex-row" style="margin-bottom: 20px;">
            <h2>–°—á–µ—Ç</h2> 
            <div class="btn-icon" onclick="Modal.closeAll()"><i class="ri-close-line"></i></div>
        </div>
        
        <label class="text-label">–ù–ê–ó–í–ê–ù–ò–ï –°–ß–ï–¢–ê</label>
        <input type="text" id="acc-name" class="input-field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∫–ª–∞–¥ –≤ –°–±–µ—Ä–µ">
        
        <label class="text-label">–¢–ò–ü –°–ß–ï–¢–ê</label>
        <div class="layout-grid-2" style="margin-bottom: 16px;">
            <button class="btn btn-secondary" id="type-card" onclick="Actions.setAccType('card')">–ö–∞—Ä—Ç–∞</button>
            <button class="btn btn-secondary" id="type-invest" onclick="Actions.setAccType('invest')">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</button>
        </div>
        
        <!-- –ü–æ–ª—è –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π (—Å–∫—Ä—ã—Ç—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="acc-invest-opts" class="hidden">
            <label class="text-label">–ü–†–û–¶–ï–ù–¢–ù–ê–Ø –°–¢–ê–í–ö–ê (% –ì–û–î–û–í–´–•)</label>
            <input type="number" id="acc-percent" class="input-field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 15">
        </div>
        
        <label class="text-label">–¢–ï–ö–£–©–ò–ô –ë–ê–õ–ê–ù–°</label>
        <input type="number" id="acc-bal" class="input-field" placeholder="0">
        
        <div class="layout-grid-2" style="margin-top: 10px;">
            <button class="btn btn-primary" onclick="Actions.saveAcc()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" style="color:var(--color-danger)" onclick="Actions.delAcc()">
                –£–¥–∞–ª–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- 3. –û–ö–ù–û –ö–ê–¢–ï–ì–û–†–ò–ò (CATEGORY FORM) -->
    <div class="modal-sheet" id="sheet-cat">
        <div class="sheet-handle"></div>
        
        <div class="layout-flex-row" style="margin-bottom: 20px;">
            <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2> 
            <div class="btn-icon" onclick="Modal.closeAll()"><i class="ri-close-line"></i></div>
        </div>
        
        <label class="text-label">–ù–ê–ó–í–ê–ù–ò–ï</label>
        <input type="text" id="cat-name" class="input-field" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        
        <label class="text-label">–¢–ò–ü –û–ü–ï–†–ê–¶–ò–ò</label>
        <div class="layout-grid-2" style="margin-bottom: 16px;">
            <button class="btn btn-secondary" id="ctype-exp" onclick="Actions.setCatType('expense')">–†–∞—Å—Ö–æ–¥</button>
            <button class="btn btn-secondary" id="ctype-inc" onclick="Actions.setCatType('income')">–î–æ—Ö–æ–¥</button>
        </div>
        
        <span class="text-label">–ò–ö–û–ù–ö–ê</span>
        <div class="layout-grid-4" id="cat-icons-grid" style="margin-bottom: 24px;"></div>
        
        <div class="layout-grid-2">
            <button class="btn btn-primary" onclick="Actions.saveCat()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" style="color:var(--color-danger)" onclick="Actions.delCat()">
                –£–¥–∞–ª–∏—Ç—å
            </button>
        </div>
    </div>
    <script>
        /**
         * ====================================================================
         * MYCOSTS ONYX v19.0 - ENTERPRISE CORE ENGINE
         * ====================================================================
         */

        // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–ï–†–í–ï–†–ê
        // ------------------------------------------
        // –°—Å—ã–ª–∫–∞ –Ω–∞ Google Apps Script (API)
        // !!! –ù–ï –ó–ê–ë–£–î–¨ –í–°–¢–ê–í–ò–¢–¨ –°–í–û–Æ –°–°–´–õ–ö–£ –ù–ò–ñ–ï !!!
        const API_URL = 'https://script.google.com/macros/s/AKfycby_ES9U2-4VYmPhMLbDtNNv_ESnbUEI9nlw0euEHsxZ6eJqu340_LpF_A1pSxyUvRxG/exec';

        // 2. –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï (STATE STORE)
        // ------------------------------------------
        const State = {
            // –û—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–≤ –ø–∞–º—è—Ç–∏)
            db: { 
                user: { name: 'User', limit: 100000 }, 
                accounts: [], 
                categories: [], 
                transactions: [] 
            },
            
            // –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            userId: null,           // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            viewDate: new Date(),   // –¢–µ–∫—É—â–∏–π –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã–π –º–µ—Å—è—Ü
            
            // –í—Ä–µ–º–µ–Ω–Ω—ã–π –±—É—Ñ–µ—Ä –¥–ª—è —Ñ–æ—Ä–º (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
            temp: { 
                editId: null,       // ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (–µ—Å–ª–∏ null - –Ω–æ–≤—ã–π)
                type: 'expense',    // –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏
                accId: null,        // –í—ã–±—Ä–∞–Ω–Ω—ã–π —Å—á–µ—Ç
                catId: null,        // –í—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
                icon: null,         // –í—ã–±—Ä–∞–Ω–Ω–∞—è –∏–∫–æ–Ω–∫–∞
                statMode: 'expense' // –†–µ–∂–∏–º –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞—Å–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        tg.enableClosingConfirmation(); // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        // –õ–æ–≥–∏–∫–∞: –ï—Å–ª–∏ –µ—Å—Ç—å TG ID -> –±–µ—Ä–µ–º –µ–≥–æ. –ï—Å–ª–∏ –Ω–µ—Ç -> –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π.
        let uid = localStorage.getItem('onyx_uid');
        if (!uid) {
            uid = tg.initDataUnsafe?.user?.id 
                ? 'tg_' + tg.initDataUnsafe.user.id 
                : 'web_' + Date.now().toString().slice(-8);
            localStorage.setItem('onyx_uid', uid);
        }
        State.userId = uid;

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º
        function safeGet(id) {
            const el = document.getElementById(id);
            if (!el) console.warn(`Element not found: ${id}`);
            return el;
        }

        // ====================================================================
        // 3. –Ø–î–†–û –ó–ê–ü–£–°–ö–ê (BOOTSTRAP)
        // ====================================================================
        const App = {
            // –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
            init: () => {
                // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ "null is not an object"
                window.onload = () => {
                    // 1. –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                    const local = localStorage.getItem('onyx_db');
                    let hasData = false;
                    
                    if (local) {
                        try {
                            const parsed = JSON.parse(local);
                            
                            // === –ê–í–¢–û-–õ–ï–ß–ï–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–• (DATA REPAIR) ===
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã. –ï—Å–ª–∏ –ø–æ–ª–µ–π –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º –∏—Ö.
                            if (!parsed.user) parsed.user = { name: 'User', limit: 100000 };
                            if (!parsed.accounts) parsed.accounts = [];
                            if (!parsed.categories) parsed.categories = [];
                            if (!parsed.transactions) parsed.transactions = [];
                            
                            State.db = parsed;
                            
                            // –°—á–∏—Ç–∞–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å, –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 1 —Å—á–µ—Ç
                            hasData = State.db.accounts.length > 0;
                            
                        } catch(e) { 
                            console.error('Local Data Corrupted:', e); 
                            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –±–∏—Ç—ã–µ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Ö
                            localStorage.removeItem('onyx_db');
                        }
                    }

                    // 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞–º–∏ –∑–∞–ø—É—Å–∫–∞
                    // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É 800–º—Å –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
                    setTimeout(() => {
                        const splash = safeGet('loading-screen');
                        if (splash) splash.style.opacity = '0';
                        
                        setTimeout(() => {
                            if (splash) splash.style.display = 'none';
                            
                            if (hasData) {
                                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –±—ã–ª -> –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
                                safeGet('view-app').classList.remove('hidden');
                                Render.all(); // –†–∏—Å—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                                Sync.pull();  // –§–æ–Ω–æ–≤–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å –æ–±–ª–∞–∫–∞
                            } else {
                                // –ï—Å–ª–∏ –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -> –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
                                safeGet('view-onboarding').classList.remove('hidden');
                            }
                        }, 500);
                    }, 800);
                };
            },

            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
            finishOnboarding: () => {
                const nameInput = safeGet('setup-name');
                const limitInput = safeGet('setup-limit');
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!nameInput.value) {
                    tg.HapticFeedback.notificationOccurred('error');
                    nameInput.style.borderColor = 'red';
                    setTimeout(() => nameInput.style.borderColor = 'transparent', 1000);
                    return;
                }

                const name = nameInput.value;
                const limit = parseFloat(limitInput.value) || 100000;
                
                State.db.user = { name: name, limit: limit };
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç–æ)
                State.db.accounts = [{id: 'a1', name: '–ö–∞—Ä—Ç–∞', type: 'card', balance: 0, percent: 0}];
                State.db.categories = [
                    {id: 'c1', name: '–ï–¥–∞', icon: 'üçî', type: 'expense'},
                    {id: 'c2', name: '–î–æ–º', icon: 'üè†', type: 'expense'},
                    {id: 'c3', name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', icon: 'üöï', type: 'expense'},
                    {id: 'c4', name: '–ó–∞—Ä–ø–ª–∞—Ç–∞', icon: 'üí∞', type: 'income'}
                ];
                
                App.save();
                
                // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                safeGet('view-onboarding').classList.add('hidden');
                safeGet('view-app').classList.remove('hidden');
                Render.all();
                Sync.push(true); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –æ–±–ª–∞–∫–æ
            },

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ LocalStorage
            save: () => {
                localStorage.setItem('onyx_db', JSON.stringify(State.db));
                Render.all(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            },

            // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            reset: () => {
                if(confirm('–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                    localStorage.removeItem('onyx_db');
                    location.reload();
                }
            }
        };

        // ====================================================================
        // 4. –ú–û–î–£–õ–¨ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò (SYNC ENGINE)
        // ====================================================================
        const Sync = {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤ —à–∞–ø–∫–µ
            status: (color, text) => {
                const dot = safeGet('ui-sync-dot');
                if (dot) {
                    dot.className = 'sync-dot'; // –°–±—Ä–æ—Å –∫–ª–∞—Å—Å–æ–≤
                    if (color === 'green') dot.classList.add('dot-green');
                    if (color === 'yellow') dot.classList.add('dot-yellow');
                    if (color === 'red') dot.classList.add('dot-red');
                }
                const txtEl = safeGet('ui-sync-text');
                if (txtEl) txtEl.innerText = text;
            },

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –° —Å–µ—Ä–≤–µ—Ä–∞ (PULL)
            pull: async () => {
                Sync.status('yellow', '–ó–ê–ì–†–£–ó–ö–ê...');
                try {
                    // –î–æ–±–∞–≤–ª—è–µ–º timestamp, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ –∫—ç—à–∏—Ä–æ–≤–∞–ª –∑–∞–ø—Ä–æ—Å
                    const res = await fetch(`${API_URL}?action=load&user_id=${State.userId}&t=${Date.now()}`);
                    const json = await res.json();
                    
                    if (json.status === 'success' && json.data.accounts && json.data.accounts.length > 0) {
                        // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏—à–ª–∏ —É—Å–ø–µ—à–Ω–æ -> –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É
                        State.db.accounts = json.data.accounts;
                        State.db.categories = json.data.categories;
                        State.db.transactions = json.data.transactions;
                        
                        // –ê–∫–∫—É—Ä–∞—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —é–∑–µ—Ä–∞ (–Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º –∏–º—è, –µ—Å–ª–∏ –æ–Ω–æ –ø—Ä–∏—à–ª–æ –ø—É—Å—Ç—ã–º)
                        if (json.data.user && json.data.user.name) {
                            State.db.user = json.data.user;
                        }
                        
                        // –ï—Å–ª–∏ —é–∑–µ—Ä–∞ –Ω–µ—Ç –≤ –æ–±–ª–∞–∫–µ - —á–∏–Ω–∏–º –ª–æ–∫–∞–ª—å–Ω–æ
                        if (!State.db.user) State.db.user = { name: 'User', limit: 100000 };
                        
                        Logic.calcInterest(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
                        App.save();
                        Sync.status('green', '–í –°–ï–¢–ò');
                    } else {
                        // –î–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–µ –Ω–µ—Ç -> –†–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                        Sync.status('green', '–õ–û–ö–ê–õ–¨–ù–û');
                    }
                } catch(e) {
                    console.warn('Sync Failed:', e);
                    Sync.status('red', '–û–§–§–õ–ê–ô–ù');
                }
            },

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ù–ê —Å–µ—Ä–≤–µ—Ä (PUSH)
            push: async (force = false) => {
                if (!force) Sync.status('yellow', '...');
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º POST no-cors –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
                    await fetch(API_URL + '?action=sync_all', {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({
                            user_id: State.userId,
                            accounts: State.db.accounts,
                            categories: State.db.categories,
                            transactions: State.db.transactions,
                            user: State.db.user
                        })
                    });
                    if (!force) Sync.status('green', '–û–ö');
                } catch(e) {
                    Sync.status('red', '–û–®–ò–ë–ö–ê');
                }
            },
            
            // –†—É—á–Ω–∞—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
            force: async () => {
                if (confirm('–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞ —Å–µ–π—á–∞—Å?')) {
                    await Sync.push(true);
                }
            }
        };
        // ====================================================================
        // 5. –ë–ò–ó–ù–ï–° –õ–û–ì–ò–ö–ê (MATH & TIME)
        // ====================================================================
        const TimeMachine = {
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞ (+1 –∏–ª–∏ -1)
            change: (step) => {
                State.viewDate.setMonth(State.viewDate.getMonth() + step);
                Render.all();
            },
            next: () => TimeMachine.change(1),
            prev: () => TimeMachine.change(-1),
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞ "YYYY-MM"
            getKey: () => {
                const y = State.viewDate.getFullYear();
                const m = String(State.viewDate.getMonth() + 1).padStart(2, '0');
                return `${y}-${m}`;
            },
            
            // –ö—Ä–∞—Å–∏–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞
            getString: () => {
                const months = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
                return `${months[State.viewDate.getMonth()]} ${State.viewDate.getFullYear()}`;
            }
        };

        const Logic = {
            // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ (–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ)
            calcInterest: () => {
                let changed = false;
                const now = Date.now();
                
                State.db.accounts.forEach(acc => {
                    if (acc.type === 'invest' && acc.percent > 0) {
                        const last = acc.lastCalc || now;
                        // –°—á–∏—Ç–∞–µ–º –¥–Ω–∏
                        const days = (now - last) / (1000 * 60 * 60 * 24);
                        
                        if (days >= 1) {
                            // –§–æ—Ä–º—É–ª–∞: –ë–∞–ª–∞–Ω—Å * (% / 100 / 365) * –¥–Ω–µ–π
                            const profit = parseFloat(acc.balance) * (parseFloat(acc.percent) / 100 / 365) * days;
                            
                            // –ï—Å–ª–∏ –Ω–∞–±–µ–∂–∞–ª–æ –±–æ–ª—å—à–µ 10 –∫–æ–ø–µ–µ–∫ - –Ω–∞—á–∏—Å–ª—è–µ–º
                            if (profit > 0.1) {
                                State.db.transactions.push({
                                    id: 'sys_' + Date.now(),
                                    date: new Date().toISOString(),
                                    amount: profit,
                                    type: 'income',
                                    accountId: acc.id,
                                    categoryId: 'sys', // –°–∏—Å—Ç–µ–º–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
                                    comment: '% –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ',
                                    isWaste: false
                                });
                                acc.lastCalc = now;
                                changed = true;
                            }
                        }
                    }
                });
                if (changed) App.save();
            }
        };

        // ====================================================================
        // 6. –û–¢–†–ò–°–û–í–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê (RENDER ENGINE)
        // ====================================================================
        const Render = {
            all: () => {
                // –ó–ê–©–ò–¢–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–æ–º
                if (!State.db.user) State.db.user = { name: 'User', limit: 100000 };
                
                // 1. –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                const elUserName = safeGet('ui-user-name');
                if (elUserName) elUserName.innerText = State.db.user.name;
                
                const elMonthLabel = safeGet('ui-month-label');
                if (elMonthLabel) elMonthLabel.innerText = TimeMachine.getString();
                
                // –ö–ª—é—á –º–µ—Å—è—Ü–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                const monthKey = TimeMachine.getKey();

                // 2. –†–ê–°–ß–ï–¢ –ë–ê–õ–ê–ù–°–û–í
                const balances = {}; // { accId: 15000 }
                let expenseMonth = 0; // –†–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü
                let passiveMonth = 0; // –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ (—Ä–∞—Å—á–µ—Ç–Ω—ã–π)

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ä—Ç–æ–≤—ã–º–∏ –±–∞–ª–∞–Ω—Å–∞–º–∏
                State.db.accounts.forEach(a => balances[a.id] = parseFloat(a.balance || 0));
                
                // –ü—Ä–æ—Ö–æ–¥ –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
                State.db.transactions.forEach(t => {
                    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–∞ —Å–µ–≥–æ–¥–Ω—è)
                    if (balances[t.accountId] !== undefined) {
                        if (t.type === 'income') balances[t.accountId] += parseFloat(t.amount);
                        else balances[t.accountId] -= parseFloat(t.amount);
                    }
                    
                    // –ú–µ—Å—è—á–Ω—ã–π —Å—Ä–µ–∑ (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
                    if (t.date.startsWith(monthKey)) {
                        if (t.type === 'expense') expenseMonth += parseFloat(t.amount);
                    }
                });

                // –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥
                State.db.accounts.filter(a => a.type === 'invest').forEach(a => {
                    passiveMonth += (balances[a.id] * (parseFloat(a.percent) / 100)) / 12;
                });

                // 3. –û–ë–ù–û–í–õ–ï–ù–ò–ï UI (DASHBOARD)
                const totalCapital = Object.values(balances).reduce((a, b) => a + b, 0);
                const elTotal = safeGet('ui-total-balance');
                if (elTotal) elTotal.innerText = Math.floor(totalCapital).toLocaleString() + ' ‚ÇΩ';

                // Cashflow Bar
                const freedomRate = expenseMonth > 0 ? (passiveMonth / expenseMonth * 100) : 0;
                
                safeGet('ui-freedom-rate').innerText = freedomRate.toFixed(1) + '%';
                safeGet('ui-freedom-bar').style.width = Math.min(100, freedomRate) + '%';
                
                safeGet('ui-val-passive').innerText = '+' + Math.floor(passiveMonth).toLocaleString();
                safeGet('ui-val-expense').innerText = '-' + Math.floor(expenseMonth).toLocaleString();

                // Budget Bar
                const limit = State.db.user.limit || 100000;
                const budgetLeft = limit - expenseMonth;
                const budgetPct = Math.min(100, (expenseMonth / limit * 100));
                
                safeGet('ui-budget-bar').style.width = budgetPct + '%';
                safeGet('ui-budget-left').innerText = budgetLeft.toLocaleString() + ' ‚ÇΩ';

                // 4. –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–ü–ò–°–ö–û–í
                // –°—á–µ—Ç–∞ (–ì–ª–∞–≤–Ω–∞—è)
                const accHTML = State.db.accounts.map(a => 
                    `<div class="chip-card ${State.temp.accId == a.id ? 'active' : ''}" onclick="Actions.setTxAcc('${a.id}', this)">
                        <span class="text-label" style="text-transform:none; margin-bottom:4px;">${a.name}</span>
                        <div style="font-weight:800; font-size:16px;">${Math.floor(balances[a.id]).toLocaleString()}</div>
                    </div>`
                ).join('');
                
                if (safeGet('list-accs-home')) safeGet('list-accs-home').innerHTML = accHTML;
                if (safeGet('tx-accs-list')) safeGet('tx-accs-list').innerHTML = accHTML;

                // –ò—Å—Ç–æ—Ä–∏—è (–ì–ª–∞–≤–Ω–∞—è)
                const monthTxs = State.db.transactions
                    .filter(t => t.date.startsWith(monthKey))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (safeGet('list-tx-home')) {
                    safeGet('list-tx-home').innerHTML = monthTxs.map(t => {
                        const cat = State.db.categories.find(x => x.id == t.categoryId) || {name:'?', icon:'üîπ'};
                        return `
                        <div class="card-panel card-compact" onclick="Modal.editTx('${t.id}')" style="margin-bottom:10px; cursor:pointer;">
                            <div class="layout-flex-row">
                                <div style="display:flex; gap:12px; align-items:center;">
                                    <span style="font-size:24px">${cat.icon}</span>
                                    <div>
                                        <div style="font-weight:600">${cat.name}</div>
                                        <div class="text-label" style="margin:0; opacity:0.6; text-transform:none;">${t.comment || new Date(t.date).toLocaleDateString()}</div>
                                    </div>
                                </div>
                                <div style="font-weight:700; font-size:16px; color:${t.type == 'expense' ? 'var(--color-danger)' : 'var(--color-success)'}">
                                    ${t.type == 'expense' ? '-' : '+'}${Math.floor(t.amount)}
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                }

                // –°–ø–∏—Å–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                safeGet('list-acc-manage').innerHTML = State.db.accounts.map(a => 
                    `<div class="layout-flex-row" style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1); cursor:pointer;" onclick="Modal.openAcc('${a.id}')">
                        <b>${a.name}</b> <span>${Math.floor(balances[a.id])}</span>
                    </div>`
                ).join('');
                
                safeGet('list-cat-manage').innerHTML = State.db.categories.map(c => 
                    `<div class="layout-flex-row" style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1); cursor:pointer;" onclick="Modal.openCat('${c.id}')">
                        <div style="display:flex; gap:10px; align-items:center;">${c.icon} ${c.name}</div> 
                        <i class="ri-arrow-right-s-line" style="color:#666"></i>
                    </div>`
                ).join('');

                // –°–ø–∏—Å–æ–∫ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
                safeGet('list-inv').innerHTML = State.db.accounts.filter(a => a.type === 'invest').map(a => 
                    `<div class="card-panel card-compact" style="margin-bottom:10px;">
                        <div class="layout-flex-row">
                            <div>
                                <b>${a.name}</b><br>
                                <span style="color:var(--color-success); font-size:12px;">${a.percent}% –≥–æ–¥.</span>
                            </div>
                            <b>${Math.floor(balances[a.id]).toLocaleString()}</b>
                        </div>
                    </div>`
                ).join('');

                // –ó–∞–ø—É—Å–∫ –≥—Ä–∞—Ñ–∏–∫–æ–≤
                Render.charts(monthTxs, balances);
            },

            // 7. –û–¢–†–ò–°–û–í–ö–ê –ì–†–ê–§–ò–ö–û–í (CHART.JS)
            // ------------------------------------------
            charts: (txs, balances) => {
                const elPie = document.getElementById('chart-pie');
                if (elPie) {
                    const dataTx = txs.filter(t => t.type === (State.temp.statMode || 'expense'));
                    const catsAgg = {};
                    dataTx.forEach(t => catsAgg[t.categoryId] = (catsAgg[t.categoryId] || 0) + parseFloat(t.amount));
                    
                    if (window.pieChart) window.pieChart.destroy();
                    window.pieChart = new Chart(elPie, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(catsAgg).map(id => State.db.categories.find(c => c.id == id)?.name),
                            datasets: [{
                                data: Object.values(catsAgg),
                                backgroundColor: ['#0a84ff', '#30d158', '#ffd60a', '#ff453a', '#bf5af2'], borderWidth: 0
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#fff' } } } }
                    });
                    
                    // –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–º
                    safeGet('list-stats').innerHTML = Object.entries(catsAgg).sort((a, b) => b[1] - a[1]).map(([id, val]) => {
                        const c = State.db.categories.find(x => x.id == id) || {name:'?', icon:''};
                        return `<div class="layout-flex-row" style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1)">
                            <div style="display:flex; gap:10px; align-items:center;">${c.icon} ${c.name}</div>
                            <b>${Math.floor(val).toLocaleString()}</b>
                        </div>`;
                    }).join('');
                }

                // –ì—Ä–∞—Ñ–∏–∫ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
                const elInv = document.getElementById('chart-invest');
                if (elInv) {
                    const invAccs = State.db.accounts.filter(a => a.type === 'invest');
                    const currentSum = invAccs.reduce((s, a) => s + (balances[a.id] || 0), 0);
                    const projectedSum = currentSum * 1.15;
                    
                    safeGet('ui-inv-forecast').innerText = `+${Math.floor(projectedSum - currentSum).toLocaleString()} ‚ÇΩ`;
                    
                    if (window.lineChart) window.lineChart.destroy();
                    window.lineChart = new Chart(elInv, {
                        type: 'line',
                        data: {
                            labels: ['–°–µ–π—á–∞—Å', '3 –º–µ—Å', '6 –º–µ—Å', '9 –º–µ—Å', '1 –≥–æ–¥'],
                            datasets: [{
                                data: [currentSum, currentSum * 1.04, currentSum * 1.08, currentSum * 1.12, projectedSum],
                                borderColor: '#30d158', backgroundColor: 'rgba(48, 209, 88, 0.1)', fill: true, tension: 0.4
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, elements: { point: { radius: 0 } } }
                    });
                }
            }
        };
        // ==========================================
        // 8. –î–ï–ô–°–¢–í–ò–Ø (USER ACTIONS)
        // ==========================================
        const Actions = {
            // --- –¢–†–ê–ù–ó–ê–ö–¶–ò–ò ---
            setTxAcc: (id, el) => {
                State.temp.accId = id;
                document.querySelectorAll('#tx-accs-list .chip-card').forEach(c => c.classList.remove('active'));
                if (el) el.classList.add('active');
            },
            
            saveTx: () => {
                const amtInput = safeGet('tx-amt');
                const amt = parseFloat(amtInput.value);
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è: –µ—Å–ª–∏ –Ω–µ—Ç —Å—É–º–º—ã –∏–ª–∏ —Å—á–µ—Ç–∞
                if (!amt || !State.temp.accId || !State.temp.catId) {
                    tg.HapticFeedback.notificationOccurred('error');
                    if(!amt) amtInput.style.color = 'var(--color-danger)';
                    setTimeout(() => amtInput.style.color = 'white', 500);
                    return;
                }
                
                const tx = {
                    id: State.temp.editId || 'tx_' + Date.now(),
                    // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º - –¥–∞—Ç–∞ —Å—Ç–∞—Ä–∞—è, –µ—Å–ª–∏ –Ω–æ–≤–∞—è - —Ç–µ–∫—É—â–∞—è
                    date: State.temp.editId ? State.db.transactions.find(t => t.id == State.temp.editId).date : new Date().toISOString(),
                    amount: amt,
                    type: State.temp.type,
                    accountId: State.temp.accId,
                    categoryId: State.temp.catId,
                    comment: safeGet('tx-note').value,
                    isWaste: false
                };

                if (State.temp.editId) {
                    const idx = State.db.transactions.findIndex(t => t.id == State.temp.editId);
                    State.db.transactions[idx] = tx;
                } else {
                    State.db.transactions.push(tx);
                }
                
                tg.HapticFeedback.notificationOccurred('success');
                App.save();
                Modal.closeAll();
                Sync.push(true);
            },
            
            deleteTx: () => {
                if (confirm('–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –Ω–∞–≤—Å–µ–≥–¥–∞?')) {
                    State.db.transactions = State.db.transactions.filter(t => t.id != State.temp.editId);
                    tg.HapticFeedback.notificationOccurred('success');
                    App.save();
                    Modal.closeAll();
                    Sync.push(true);
                }
            },

            // --- –°–ß–ï–¢–ê ---
            setAccType: (t) => {
                State.temp.type = t;
                safeGet('type-card').className = t === 'card' ? 'btn btn-primary' : 'btn btn-secondary';
                safeGet('type-invest').className = t === 'invest' ? 'btn btn-primary' : 'btn btn-secondary';
                safeGet('acc-invest-opts').classList.toggle('hidden', t !== 'invest');
            },
            
            saveAcc: () => {
                const nameInput = safeGet('acc-name');
                const name = nameInput.value;
                if (!name) {
                    tg.HapticFeedback.notificationOccurred('error');
                    nameInput.style.borderColor = 'red';
                    return;
                }
                
                const acc = {
                    id: State.temp.editId || 'acc_' + Date.now(),
                    name: name,
                    type: State.temp.type,
                    balance: parseFloat(safeGet('acc-bal').value) || 0,
                    percent: parseFloat(safeGet('acc-percent').value) || 0
                };
                
                if (State.temp.editId) {
                    const idx = State.db.accounts.findIndex(a => a.id == State.temp.editId);
                    State.db.accounts[idx] = acc;
                } else {
                    State.db.accounts.push(acc);
                }
                App.save(); Modal.closeAll(); Sync.push(true);
            },
            
            delAcc: () => {
                if (State.temp.editId && confirm('–£–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏?')) {
                    State.db.accounts = State.db.accounts.filter(a => a.id != State.temp.editId);
                    App.save(); Modal.closeAll(); Sync.push(true);
                }
            },

            // --- –ö–ê–¢–ï–ì–û–†–ò–ò ---
            setCatType: (t) => {
                State.temp.type = t;
                safeGet('ctype-exp').className = t === 'expense' ? 'btn btn-primary' : 'btn btn-secondary';
                safeGet('ctype-inc').className = t === 'income' ? 'btn btn-primary' : 'btn btn-secondary';
            },
            
            saveCat: () => {
                const name = safeGet('cat-name').value;
                if (!name) return;
                
                const cat = {
                    id: State.temp.editId || 'cat_' + Date.now(),
                    name: name,
                    type: State.temp.type,
                    icon: State.temp.icon || 'üîπ'
                };
                
                if (State.temp.editId) {
                    const idx = State.db.categories.findIndex(c => c.id == State.temp.editId);
                    State.db.categories[idx] = cat;
                } else {
                    State.db.categories.push(cat);
                }
                App.save(); Modal.closeAll(); Sync.push(true);
            },
            
            delCat: () => {
                if (State.temp.editId && confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) {
                    State.db.categories = State.db.categories.filter(c => c.id != State.temp.editId);
                    App.save(); Modal.closeAll(); Sync.push(true);
                }
            }
        };
        // ==========================================
        // 9. –£–ü–†–ê–í–õ–ï–ù–ò–ï –û–ö–ù–ê–ú–ò (MODAL MANAGER)
        // ==========================================
        const Modal = {
            // –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            openTx: (type) => {
                State.temp = { type, accId: State.db.accounts[0]?.id, catId: null, editId: null };
                
                safeGet('tx-title').innerText = type === 'expense' ? '–†–∞—Å—Ö–æ–¥' : '–î–æ—Ö–æ–¥';
                safeGet('tx-amt').value = '';
                safeGet('tx-note').value = '';
                safeGet('tx-del-btn').classList.add('hidden');
                
                // –†–µ–Ω–¥–µ—Ä –∏–∫–æ–Ω–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                safeGet('tx-cats-list').innerHTML = State.db.categories
                    .filter(c => c.type == type)
                    .map(c => 
                        `<div class="icon-tile" onclick="State.temp.catId='${c.id}'; Modal.highlight(this)">${c.icon}</div>`
                    ).join('');
                
                Modal.open('sheet-tx');
                Actions.setTxAcc(State.temp.accId);
            },

            // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            editTx: (id) => {
                const t = State.db.transactions.find(x => x.id == id);
                if (!t) return;
                
                Modal.openTx(t.type);
                State.temp.editId = id;
                State.temp.accId = t.accountId;
                State.temp.catId = t.categoryId;
                
                safeGet('tx-amt').value = t.amount;
                safeGet('tx-note').value = t.comment;
                safeGet('tx-del-btn').classList.remove('hidden');
            },

            // –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ —Å—á–µ—Ç–∞
            openAcc: (id = null) => {
                State.temp.editId = id;
                safeGet('acc-name').value = '';
                safeGet('acc-bal').value = '';
                Actions.setAccType('card');
                
                if (id) {
                    const a = State.db.accounts.find(x => x.id == id);
                    safeGet('acc-name').value = a.name;
                    safeGet('acc-bal').value = a.balance;
                    Actions.setAccType(a.type);
                    if (a.type == 'invest') safeGet('acc-percent').value = a.percent;
                }
                Modal.open('sheet-acc');
            },

            // –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            openCat: (id = null) => {
                State.temp.editId = id;
                State.temp.icon = 'üçî';
                safeGet('cat-name').value = '';
                Actions.setCatType('expense');
                
                const icons = ['üçî','üöï','üè†','üíä','üõçÔ∏è','‚úàÔ∏è','üéÅ','‚öΩ','üí∞','üíº','üìà','üéì','üõí','üíÖ','üê∂','‚òï','üçø','üé¨','üè•','‚õΩ'];
                safeGet('cat-icons-grid').innerHTML = icons.map(i => 
                    `<div class="icon-tile" onclick="State.temp.icon='${i}'; Modal.highlight(this)">${i}</div>`
                ).join('');
                
                if (id) {
                    const c = State.db.categories.find(x => x.id == id);
                    safeGet('cat-name').value = c.name;
                    Actions.setCatType(c.type);
                }
                Modal.open('sheet-cat');
            },

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∏–∫–æ–Ω–∫–∏
            highlight: (el) => {
                el.parentElement.querySelectorAll('.icon-tile').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                tg.HapticFeedback.selectionChanged();
            },

            // –û–±—â–∏–µ –º–µ—Ç–æ–¥—ã –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è
            open: (id) => {
                safeGet('backdrop').classList.add('active');
                safeGet(id).classList.add('active');
                tg.HapticFeedback.impactOccurred('medium');
            },
            
            closeAll: () => {
                document.querySelectorAll('.modal-sheet').forEach(e => e.classList.remove('active'));
                safeGet('backdrop').classList.remove('active');
            }
        };

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–∞–±–∞–º (–ú–µ–Ω—é)
        const Nav = {
            to: (scr, btn) => {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∏–¥—ã
                document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
                safeGet('view-' + scr).classList.remove('hidden');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                if (btn) btn.classList.add('active');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ
                if (scr == 'stats' || scr == 'invest' || scr == 'home') Render.all();
                
                tg.HapticFeedback.impactOccurred('light');
            }
        };
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ
        const Stats = {
            setMode: (m) => {
                State.temp.statMode = m;
                Render.all();
                tg.HapticFeedback.selectionChanged();
            }
        };

        // ==========================================
        // 10. –§–ò–ù–ê–õ–¨–ù–´–ô –ó–ê–ü–£–°–ö
        // ==========================================
        App.init();

    </script>
</body>
</html>
