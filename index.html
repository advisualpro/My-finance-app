<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MyCosts v21</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
    :root{--bg:#000;--card:#1c1c1e;--input:#2c2c2e;--text:#fff;--sec:#8e8e93;--p:#0a84ff;--g:#30d158;--r:#ff453a;--font:'Manrope',sans-serif}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
    body{background:var(--bg);color:var(--text);font-family:var(--font);margin:0;padding-bottom:120px;overflow-x:hidden}
    .container{padding:16px;max-width:500px;margin:0 auto;min-height:100vh}
    .card{background:var(--card);border-radius:20px;padding:20px;margin-bottom:16px;border:1px solid rgba(255,255,255,0.05)}
    .flex{display:flex;justify-content:space-between;align-items:center}
    .btn{width:100%;padding:16px;border-radius:16px;border:none;font-weight:700;font-size:16px;cursor:pointer;display:flex;justify-content:center;gap:8px}
    .btn-p{background:var(--p);color:#fff} .btn-s{background:var(--input);color:#fff}
    .icon-btn{width:40px;height:40px;border-radius:50%;background:var(--input);color:#fff;border:none;font-size:20px;display:flex;justify-content:center;align-items:center}
    .inp-money{width:100%;background:0 0;border:none;color:#fff;font-size:40px;font-weight:800;text-align:center;padding:20px 0}
    .inp{width:100%;background:var(--input);border:1px solid transparent;padding:14px;border-radius:14px;color:#fff;margin-bottom:12px;font-size:16px}
    .date-nav{display:flex;justify-content:space-between;align-items:center;background:var(--input);padding:8px;border-radius:100px;margin-bottom:20px}
    .h-scroll{display:flex;gap:10px;overflow-x:auto;padding-bottom:5px} .chip{min-width:120px;background:var(--input);padding:12px;border-radius:16px;flex-shrink:0} .chip.active{border:1px solid var(--p);background:rgba(10,132,255,0.1)}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px} .icon-box{aspect-ratio:1;background:var(--input);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px} .icon-box.sel{border:1px solid var(--p)}
    .bar-bg{width:100%;height:6px;background:#333;border-radius:10px;overflow:hidden;margin-top:8px} .bar-fill{height:100%;transition:0.5s}
    .nav{position:fixed;bottom:20px;left:20px;right:20px;background:rgba(30,30,35,0.9);backdrop-filter:blur(15px);border-radius:30px;padding:12px 30px;display:flex;justify-content:space-between;z-index:100;border:1px solid rgba(255,255,255,0.1)}
    .nav i{font-size:26px;color:var(--sec);transition:0.2s} .nav i.active{color:var(--text);transform:translateY(-3px)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;display:none} .modal.show{display:block}
    .sheet{position:fixed;bottom:0;left:0;right:0;background:#1c1c1e;border-radius:24px 24px 0 0;padding:24px;transform:translateY(100%);transition:0.3s;z-index:1001} .sheet.show{transform:translateY(0)}
    .hidden{display:none!important}
</style>
</head>
<body>
    <div id="splash" style="position:fixed;inset:0;background:#000;z-index:9999;display:flex;align-items:center;justify-content:center"><h1 style="animation:pulse 1s infinite">üíé</h1></div>

    <!-- ONBOARDING -->
    <div id="scr-onboard" class="container hidden" style="text-align:center;padding-top:100px">
        <h1>–ü—Ä–∏–≤–µ—Ç!</h1><p style="color:#888;margin-bottom:40px">–ù–∞—Å—Ç—Ä–æ–∏–º –∫–æ—à–µ–ª–µ–∫</p>
        <input id="setup-name" class="inp" placeholder="–ò–º—è" style="text-align:center">
        <button class="btn btn-p" onclick="App.setup()">–ù–∞—á–∞—Ç—å</button>
    </div>

    <!-- APP -->
    <div id="scr-app" class="container hidden">
        <div class="flex" style="margin-bottom:20px">
            <div style="font-size:12px;background:#333;padding:4px 8px;border-radius:10px" id="sync-st">OFFLINE</div>
            <b id="head-name">User</b>
        </div>

        <!-- HOME -->
        <div id="tab-home">
            <div class="date-nav">
                <i class="ri-arrow-left-s-line" style="font-size:24px;padding:0 10px" onclick="Time.move(-1)"></i>
                <b id="date-label">...</b>
                <i class="ri-arrow-right-s-line" style="font-size:24px;padding:0 10px" onclick="Time.move(1)"></i>
            </div>

            <div class="card" style="text-align:center">
                <div style="font-size:11px;color:#888;text-transform:uppercase">–ö–∞–ø–∏—Ç–∞–ª</div>
                <div class="num-xl" id="total-bal">0 ‚ÇΩ</div>
                <div class="flex" style="gap:10px;margin-top:20px">
                    <button class="btn btn-s" style="color:var(--r)" onclick="Modal.tx('expense')">–†–∞—Å—Ö–æ–¥</button>
                    <button class="btn btn-s" style="color:var(--g)" onclick="Modal.tx('income')">–î–æ—Ö–æ–¥</button>
                </div>
            </div>

            <!-- STATS PREVIEW -->
            <div class="card">
                <div class="flex"><span>–î–æ—Ö–æ–¥—ã</span><span style="color:var(--g)" id="stat-inc">0</span></div>
                <div class="flex" style="margin-top:10px"><span>–†–∞—Å—Ö–æ–¥—ã</span><span style="color:var(--r)" id="stat-exp">0</span></div>
                <div class="flex" style="margin-top:10px;border-top:1px solid #333;padding-top:10px"><span>–ü–∞—Å—Å–∏–≤–Ω—ã–π</span><span style="color:var(--p)" id="stat-pass">0</span></div>
            </div>

            <div class="flex" style="margin:20px 0 10px"><b>–°—á–µ—Ç–∞</b></div>
            <div class="h-scroll" id="list-acc"></div>

            <div class="flex" style="margin:20px 0 10px"><b>–ò—Å—Ç–æ—Ä–∏—è</b></div>
            <div id="list-tx"></div>
        </div>

        <!-- WALLET -->
        <div id="tab-wallet" class="hidden">
            <h2>–ö–æ—à–µ–ª–µ–∫</h2><br>
            <div class="card"><div class="flex"><h3>–°—á–µ—Ç–∞</h3><button class="icon-btn" onclick="Modal.acc()">+</button></div><div id="list-acc-m"></div></div>
            <div class="card"><div class="flex"><h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3><button class="icon-btn" onclick="Modal.cat()">+</button></div><div id="list-cat-m"></div></div>
            <button class="btn btn-s" style="margin-top:20px;color:var(--r)" onclick="App.reset()">–°–±—Ä–æ—Å</button>
        </div>

        <!-- STATS -->
        <div id="tab-stats" class="hidden">
            <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2><br>
            <div class="card"><div style="height:250px"><canvas id="chart-pie"></canvas></div></div>
            <div id="list-stats-det"></div>
        </div>
    </div>

    <div class="nav">
        <i class="ri-home-5-fill active" onclick="Nav.go('home',this)"></i>
        <i class="ri-pie-chart-2-fill" onclick="Nav.go('stats',this)"></i>
        <i class="ri-wallet-3-fill" onclick="Nav.go('wallet',this)"></i>
    </div>

    <!-- MODALS -->
    <div id="overlay" class="modal" onclick="Modal.close()"></div>
    
    <div id="sheet-tx" class="sheet">
        <div class="flex"><h2 id="tx-tit">...</h2><i class="ri-close-line" style="font-size:24px" onclick="Modal.close()"></i></div>
        <input id="tx-sum" class="inp-money" placeholder="0" type="number">
        <div style="font-size:11px;color:#888;margin-bottom:5px">–°–ß–ï–¢</div> <div class="h-scroll" id="tx-accs"></div><br>
        <div style="font-size:11px;color:#888;margin-bottom:5px">–ö–ê–¢–ï–ì–û–†–ò–Ø</div> <div class="grid-4" id="tx-cats"></div><br>
        <button class="btn btn-p" onclick="Act.saveTx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div id="sheet-acc" class="sheet">
        <h2>–°—á–µ—Ç</h2><br><input id="acc-name" class="inp" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <div class="flex" style="gap:10px;margin-bottom:10px">
            <button class="btn btn-s" id="t-card" onclick="Act.setT('card')">–ö–∞—Ä—Ç–∞</button>
            <button class="btn btn-s" id="t-invest" onclick="Act.setT('invest')">–ò–Ω–≤–µ—Å—Ç</button>
        </div>
        <div id="inv-opts" class="hidden"><input id="acc-pct" class="inp" type="number" placeholder="% –ì–æ–¥–æ–≤—ã—Ö"></div>
        <input id="acc-bal" class="inp" type="number" placeholder="–ë–∞–ª–∞–Ω—Å"><button class="btn btn-p" onclick="Act.saveAcc()">–û–ö</button>
    </div>

    <div id="sheet-cat" class="sheet">
        <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2><br><input id="cat-name" class="inp" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <div class="flex" style="gap:10px;margin-bottom:10px">
            <button class="btn btn-s" id="ct-exp" onclick="Act.setCT('expense')">–†–∞—Å—Ö–æ–¥</button>
            <button class="btn btn-s" id="ct-inc" onclick="Act.setCT('income')">–î–æ—Ö–æ–¥</button>
        </div>
        <div class="grid-4" id="cat-ico"></div><br><button class="btn btn-p" onclick="Act.saveCat()">–û–ö</button>
    </div>

<script>
// --- –ö–û–ù–§–ò–ì ---
const API_URL = 'https://script.google.com/macros/s/AKfycby_ES9U2-4VYmPhMLbDtNNv_ESnbUEI9nlw0euEHsxZ6eJqu340_LpF_A1pSxyUvRxG/exec';

// --- –î–ê–ù–ù–´–ï ---
let DB = { user:{name:''}, accounts:[], categories:[], transactions:[] };
let USER_ID = localStorage.getItem('uid') || 'u_'+Date.now(); localStorage.setItem('uid',USER_ID);
let CUR_DATE = new Date();
let TEMP = { txType:'expense', acc:null, cat:null, accType:'card', catType:'expense', icon:'üçî' };

const App = {
    init: () => {
        const local = localStorage.getItem('db');
        if(local) {
            try { DB = JSON.parse(local); if(!DB.user) DB.user={name:'User'}; } catch(e){}
        }
        setTimeout(()=>{
            document.getElementById('splash').style.display='none';
            if(DB.accounts.length>0) {
                document.getElementById('scr-app').classList.remove('hidden');
                Render.all(); Sync.pull();
            } else {
                document.getElementById('scr-onboard').classList.remove('hidden');
            }
        }, 500);
    },
    setup: () => {
        DB.user.name = document.getElementById('setup-name').value || 'User';
        DB.accounts = [{id:'a1',name:'–ö–∞—Ä—Ç–∞',type:'card',bal:0,pct:0}];
        DB.categories = [{id:'c1',name:'–ï–¥–∞',icon:'üçî',type:'expense'},{id:'c2',name:'–ó–ü',icon:'üí∞',type:'income'}];
        App.save();
        document.getElementById('scr-onboard').classList.add('hidden');
        document.getElementById('scr-app').classList.remove('hidden');
        Render.all(); Sync.push();
    },
    save: () => { localStorage.setItem('db', JSON.stringify(DB)); Render.all(); },
    reset: () => { if(confirm('–°–±—Ä–æ—Å?')){ localStorage.clear(); location.reload(); } }
};

const Render = {
    all: () => {
        document.getElementById('head-name').innerText = DB.user.name;
        // Date
        const m = ['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
        const mKey = `${CUR_DATE.getFullYear()}-${String(CUR_DATE.getMonth()+1).padStart(2,'0')}`;
        document.getElementById('date-label').innerText = `${m[CUR_DATE.getMonth()]} ${CUR_DATE.getFullYear()}`;

        // Calc
        let total = 0, inc = 0, exp = 0, pass = 0;
        const bals = {};
        
        DB.accounts.forEach(a => bals[a.id] = parseFloat(a.bal)); // Start bal
        
        DB.transactions.forEach(t => {
            // Global Bal
            if(bals[t.acc]!==undefined) t.type=='income'?bals[t.acc]+=t.sum:bals[t.acc]-=t.sum;
            
            // Month Filter
            if(t.date.startsWith(mKey)) {
                if(t.type=='income') inc+=t.sum; else exp+=t.sum;
            }
        });
        
        // Passive
        DB.accounts.filter(a=>a.type=='invest').forEach(a=>{ pass += (bals[a.id]*(a.pct/100))/12; });
        total = Object.values(bals).reduce((a,b)=>a+b,0);

        // UI
        document.getElementById('total-bal').innerText = Math.floor(total).toLocaleString()+' ‚ÇΩ';
        document.getElementById('stat-inc').innerText = '+'+Math.floor(inc);
        document.getElementById('stat-exp').innerText = '-'+Math.floor(exp);
        document.getElementById('stat-pass').innerText = '+'+Math.floor(pass);

        // Lists
        document.getElementById('list-acc').innerHTML = DB.accounts.map(a=>
            `<div class="chip ${TEMP.acc==a.id?'active':''}" onclick="TEMP.acc='${a.id}';Render.all()">
                <small>${a.name}</small><br><b>${Math.floor(bals[a.id])}</b>
            </div>`
        ).join('');
        document.getElementById('tx-accs').innerHTML = document.getElementById('list-acc').innerHTML;

        const txs = DB.transactions.filter(t=>t.date.startsWith(mKey)).reverse();
        document.getElementById('list-tx').innerHTML = txs.map(t=>{
            const c = DB.categories.find(x=>x.id==t.cat)||{name:'?',icon:''};
            return `<div class="card flex" style="padding:15px;margin-bottom:8px">
                <div class="flex" style="gap:10px"><span>${c.icon}</span><b>${c.name}</b></div>
                <b style="color:${t.type=='expense'?'var(--r)':'var(--g)'}">${t.sum}</b>
            </div>`
        }).join('');

        // Manage
        document.getElementById('list-acc-m').innerHTML = DB.accounts.map(a=>`<div class="flex" style="padding:10px;border-bottom:1px solid #333"><b>${a.name}</b><span>${Math.floor(bals[a.id])}</span></div>`).join('');
        document.getElementById('list-cat-m').innerHTML = DB.categories.map(c=>`<div class="flex" style="padding:10px;border-bottom:1px solid #333"><span>${c.icon} ${c.name}</span></div>`).join('');
        
        Render.chart(txs);
    },
    chart: (txs) => {
        const ctx = document.getElementById('chart-pie');
        const data = {}; 
        txs.filter(t=>t.type=='expense').forEach(t=> data[t.cat]=(data[t.cat]||0)+t.sum );
        if(window.myPie) window.myPie.destroy();
        window.myPie = new Chart(ctx, { type:'doughnut', data:{ labels:Object.keys(data).map(id=>DB.categories.find(c=>c.id==id)?.name), datasets:[{data:Object.values(data), backgroundColor:['#0a84ff','#30d158','#ff453a','#ffd60a'],borderWidth:0}] }, options:{plugins:{legend:{position:'right',labels:{color:'#fff'}}}} });
    }
};

const Act = {
    saveTx: () => {
        const sum = parseFloat(document.getElementById('tx-sum').value);
        if(!sum || !TEMP.acc || !TEMP.cat) return alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ!');
        DB.transactions.push({ id:'t'+Date.now(), date:new Date().toISOString(), sum, acc:TEMP.acc, cat:TEMP.cat, type:TEMP.txType });
        App.save(); Modal.close(); Sync.push(true);
    },
    setT: (t) => { TEMP.accType=t; document.getElementById('inv-opts').className = t=='invest'?'':'hidden'; },
    saveAcc: () => {
        const name = document.getElementById('acc-name').value; if(!name)return;
        DB.accounts.push({ id:'a'+Date.now(), name, type:TEMP.accType, bal:parseFloat(document.getElementById('acc-bal').value)||0, pct:parseFloat(document.getElementById('acc-pct').value)||0 });
        App.save(); Modal.close();
    },
    setCT: (t) => { TEMP.catType=t; },
    saveCat: () => {
        const name = document.getElementById('cat-name').value; if(!name)return;
        DB.categories.push({ id:'c'+Date.now(), name, type:TEMP.catType, icon:TEMP.icon });
        App.save(); Modal.close();
    }
};

const Modal = {
    tx: (type) => { 
        TEMP.txType = type; 
        document.getElementById('tx-tit').innerText = type=='expense'?'–†–∞—Å—Ö–æ–¥':'–î–æ—Ö–æ–¥';
        document.getElementById('tx-cats').innerHTML = DB.categories.filter(c=>c.type==type).map(c=>`<div class="icon-box" onclick="TEMP.cat='${c.id}';this.style.border='1px solid blue'">${c.icon}</div>`).join('');
        open('sheet-tx'); 
    },
    acc: () => open('sheet-acc'),
    cat: () => {
        const icons = ['üçî','üöï','üè†','üíä','üõçÔ∏è','üí∞','üéì'];
        document.getElementById('cat-ico').innerHTML = icons.map(i=>`<div class="icon-box" onclick="TEMP.icon='${i}';this.style.border='1px solid blue'">${i}</div>`).join('');
        open('sheet-cat');
    },
    close: () => { document.querySelectorAll('.sheet, .modal').forEach(e=>e.classList.remove('show')); }
};
function open(id) { document.getElementById('overlay').classList.add('show'); document.getElementById(id).classList.add('show'); }

const Time = { move: (d) => { CUR_DATE.setMonth(CUR_DATE.getMonth()+d); Render.all(); } };
const Nav = { go: (tab,el) => { document.querySelectorAll('[id^="tab-"]').forEach(e=>e.classList.add('hidden')); document.getElementById('tab-'+tab).classList.remove('hidden'); document.querySelectorAll('.nav i').forEach(i=>i.classList.remove('active')); el.classList.add('active'); } };

const Sync = {
    pull: async () => {
        try {
            const r = await fetch(API_URL+`?action=load&user_id=${USER_ID}&t=${Date.now()}`);
            const j = await r.json();
            if(j.status=='success' && j.data.accounts.length){ DB=j.data; Render.all(); document.getElementById('sync-st').innerText='ONLINE'; document.getElementById('sync-st').style.color='#30d158'; }
        } catch(e){}
    },
    push: async () => {
        fetch(API_URL+'?action=sync_all', { method:'POST', mode:'no-cors', body:JSON.stringify({...DB, user_id:USER_ID}) });
    }
};

window.onload = App.init;
</script>
</body>
</html>
