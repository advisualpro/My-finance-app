<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyCosts Onyx</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* ONYX THEME PALETTE */
            --bg-body: #09090b;
            --bg-card: #18181b;
            --bg-input: #27272a;
            --text-main: #ffffff;
            --text-sec: #a1a1aa;
            
            --primary: #6366f1; /* Indigo */
            --primary-glow: rgba(99, 102, 241, 0.4);
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            
            --radius: 20px;
            --font: 'Manrope', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font);
            margin: 0; padding: 0;
            padding-bottom: 120px; /* Space for nav */
            overflow-x: hidden;
        }

        .container { padding: 20px; max-width: 500px; margin: 0 auto; }

        /* TYPOGRAPHY */
        h1 { font-size: 32px; font-weight: 800; letter-spacing: -1px; margin: 0 0 10px 0; }
        h2 { font-size: 24px; font-weight: 700; margin: 0 0 15px 0; }
        h3 { font-size: 18px; font-weight: 700; margin: 0; }
        .text-sm { font-size: 13px; color: var(--text-sec); }
        .text-mono { font-family: monospace; letter-spacing: -0.5px; }

        /* CARDS */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-col { display: flex; flex-direction: column; gap: 5px; }

        /* VISUAL FEEDBACK (Highlighting) */
        .interactive { transition: transform 0.1s, background 0.2s, border-color 0.2s; cursor: pointer; }
        .interactive:active { transform: scale(0.96); opacity: 0.8; }
        .selected-border { border: 2px solid var(--primary) !important; background: rgba(99, 102, 241, 0.1) !important; }

        /* BUTTONS */
        .btn-main {
            width: 100%; padding: 18px; border-radius: 18px;
            background: var(--primary); color: white; border: none;
            font-size: 16px; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 20px var(--primary-glow);
            transition: 0.2s;
        }
        .btn-main:active { transform: scale(0.98); }
        
        .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .btn-danger:active { background: rgba(239, 68, 68, 0.3); }

        /* INPUTS */
        .input-lg {
            width: 100%; background: transparent; border: none;
            font-size: 42px; font-weight: 800; color: white;
            text-align: center; padding: 20px 0;
        }
        .input-std {
            width: 100%; background: var(--bg-input); border: 1px solid transparent;
            padding: 16px; border-radius: 16px; color: white; font-size: 16px;
            margin-bottom: 12px; transition: 0.2s;
        }
        .input-std:focus { border-color: var(--primary); background: #000; }

        /* PROGRESS BARS (Cashflow & Budget) */
        .progress-track { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; transition: width 0.5s ease; border-radius: 4px; }
        .fill-green { background: var(--success); }
        .fill-red { background: var(--danger); }
        .fill-primary { background: var(--primary); }

        /* NAVIGATION */
        .nav-bar {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: rgba(30, 30, 35, 0.9); backdrop-filter: blur(15px);
            border-radius: 24px; padding: 12px 20px;
            display: flex; justify-content: space-between;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            z-index: 100; max-width: 460px; margin: 0 auto 20px;
        }
        .nav-item {
            background: none; border: none; color: var(--text-sec);
            font-size: 24px; padding: 8px 16px; border-radius: 12px;
            transition: 0.2s;
        }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 15px var(--primary-glow); }

        /* MODALS */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 999;
            opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #1c1c1f; border-radius: 24px 24px 0 0;
            padding: 24px; transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1000; max-height: 90vh; overflow-y: auto; border-top: 1px solid rgba(255,255,255,0.1);
        }
        .bottom-sheet.open { transform: translateY(0); }

        /* UTILS */
        .hidden { display: none !important; }
        .text-gradient { background: linear-gradient(to right, #818cf8, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* CATEGORY GRID */
        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .cat-item { 
            aspect-ratio: 1; background: var(--bg-input); border-radius: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 2px solid transparent; gap: 5px;
        }
        .cat-emoji { font-size: 24px; }
        .cat-name { font-size: 10px; text-align: center; color: var(--text-sec); }

        /* LOADERS */
        .loader-overlay { position: fixed; inset: 0; background: var(--bg-body); z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; margin-bottom: 20px;}
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <div style="font-weight:700">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>
        <div class="text-sm" style="margin-top:10px; opacity:0.5">MyCosts Onyx</div>
    </div>

    <!-- ONBOARDING (–¢–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö) -->
    <div id="screen-onboarding" class="screen hidden container" style="text-align:center; padding-top: 100px;">
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
        <p class="text-sm" style="margin-bottom: 40px;">–¢–≤–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä</p>
        
        <input type="text" id="setup-name" class="input-std" placeholder="–¢–≤–æ–µ –∏–º—è" style="text-align:center">
        <input type="number" id="setup-limit" class="input-std" placeholder="–õ–∏–º–∏—Ç —Ç—Ä–∞—Ç –≤ –º–µ—Å—è—Ü (‚ÇΩ)" style="text-align:center">
        
        <button class="btn-main interactive" onclick="completeSetup()">–ù–∞—á–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</button>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="screen-app" class="screen hidden container">
        
        <!-- HEADER -->
        <header class="flex-between" style="margin-bottom: 20px;">
            <div>
                <div class="text-sm" id="user-greeting">–ü—Ä–∏–≤–µ—Ç</div>
                <div class="text-xs text-mono" style="opacity:0.5" id="sync-status">SYNC: OK</div>
            </div>
            <button class="interactive" onclick="forceSync()" style="background:var(--bg-input); border:none; width:40px; height:40px; border-radius:50%; color:white;">
                <i class="ri-refresh-line"></i>
            </button>
        </header>

        <!-- DASHBOARD (Cashflow & Budget) -->
        <div id="view-home" class="view">
            
            <!-- Cashflow Card -->
            <div class="card">
                <div class="flex-between">
                    <span class="text-sm">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–±–æ–¥–∞</span>
                    <span class="text-sm text-mono" id="cf-percent">0%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill fill-success" id="cf-bar" style="width: 0%"></div>
                </div>
                <div class="flex-between" style="margin-top: 15px;">
                    <div>
                        <div class="text-xs">–ü–ê–°–°–ò–í–ù–´–ô</div>
                        <div class="text-mono" style="color:var(--success)" id="cf-passive">0 ‚ÇΩ</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="text-xs">–†–ê–°–•–û–î–´</div>
                        <div class="text-mono" style="color:var(--danger)" id="cf-expense">0 ‚ÇΩ</div>
                    </div>
                </div>
            </div>

            <!-- Budget Card -->
            <div class="card">
                <div class="flex-between">
                    <span class="text-sm">–õ–∏–º–∏—Ç –Ω–∞ –º–µ—Å—è—Ü</span>
                    <span class="text-sm" id="budget-left">–û—Å—Ç–∞–ª–æ—Å—å: 0 ‚ÇΩ</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="budget-bar" style="width: 0%; background: var(--primary);"></div>
                </div>
                <div style="margin-top: 5px; text-align: right; font-size: 10px; color: var(--text-sec);" id="budget-total">–∏–∑ 100 000 ‚ÇΩ</div>
            </div>

            <!-- Main Actions -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                <button class="btn-main interactive" style="background: var(--bg-input); color: var(--danger);" onclick="openTxModal('expense')">
                    <i class="ri-arrow-down-line"></i> –†–∞—Å—Ö–æ–¥
                </button>
                <button class="btn-main interactive" style="background: var(--bg-input); color: var(--success);" onclick="openTxModal('income')">
                    <i class="ri-arrow-up-line"></i> –î–æ—Ö–æ–¥
                </button>
            </div>

            <!-- Recent Transactions -->
            <div class="flex-between" style="margin-bottom: 10px;">
                <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
                <span class="text-sm interactive" onclick="switchView('analytics')">–í—Å–µ</span>
            </div>
            <div id="tx-list"></div>
        </div>

        <!-- ANALYTICS VIEW -->
        <div id="view-analytics" class="view hidden">
            <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            <div class="card">
                <canvas id="chart-main"></canvas>
            </div>
            <div id="analytics-list"></div>
        </div>

        <!-- INVEST VIEW -->
        <div id="view-invest" class="view hidden">
            <h2>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h2>
            <p class="text-sm" style="margin-bottom:20px;">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–ª–æ–∂–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞</p>
            
            <div class="card">
                <label class="text-xs">–°—É–º–º–∞ –≤–ª–æ–∂–µ–Ω–∏–π</label>
                <input type="number" id="calc-amount" class="input-std" placeholder="0">
                
                <label class="text-xs">–û–∂–∏–¥–∞–µ–º—ã–π % –≥–æ–¥–æ–≤—ã—Ö</label>
                <input type="number" id="calc-percent" class="input-std" placeholder="15">
                
                <div style="background:rgba(16, 185, 129, 0.1); padding:15px; border-radius:12px; margin-top:10px;">
                    <div class="flex-between">
                        <span>–ß–µ—Ä–µ–∑ –≥–æ–¥:</span>
                        <b id="calc-res-year" style="color:var(--success)">0 ‚ÇΩ</b>
                    </div>
                    <div class="flex-between" style="margin-top:10px;">
                        <span>–ü–∞—Å—Å–∏–≤–Ω—ã–π/–º–µ—Å:</span>
                        <b id="calc-res-month" style="color:var(--success)">0 ‚ÇΩ</b>
                    </div>
                </div>
                <button class="btn-main interactive" style="margin-top:15px;" onclick="runCalc()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            </div>

            <h3>–ú–æ–∏ –ê–∫—Ç–∏–≤—ã</h3>
            <div id="invest-accounts-list" style="margin-top:10px;"></div>
        </div>

        <!-- WALLET VIEW (Settings) -->
        <div id="view-wallet" class="view hidden">
            <h2>–ö–æ—à–µ–ª–µ–∫</h2>
            
            <div class="card">
                <div class="flex-between">
                    <h3>–°—á–µ—Ç–∞</h3>
                    <button class="text-sm interactive" style="background:none; border:none; color:var(--primary);" onclick="openAccountModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div id="settings-acc-list" style="margin-top:15px;"></div>
            </div>

            <div class="card">
                <div class="flex-between">
                    <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                    <button class="text-sm interactive" style="background:none; border:none; color:var(--primary);" onclick="openCatModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div id="settings-cat-list" style="margin-top:15px;"></div>
            </div>

            <div class="card">
                <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <label class="text-xs" style="margin-top:10px;">–õ–∏–º–∏—Ç —Ç—Ä–∞—Ç (–ë—é–¥–∂–µ—Ç)</label>
                <input type="number" id="settings-limit" class="input-std" onchange="saveSettingsLimit()">
            </div>
        </div>

    </div>

    <!-- NAVBAR -->
    <nav class="nav-bar">
        <button class="nav-item active interactive" onclick="switchView('home')"><i class="ri-home-5-fill"></i></button>
        <button class="nav-item interactive" onclick="switchView('analytics')"><i class="ri-pie-chart-2-fill"></i></button>
        <button class="nav-item interactive" onclick="switchView('invest')"><i class="ri-line-chart-fill"></i></button>
        <button class="nav-item interactive" onclick="switchView('wallet')"><i class="ri-wallet-3-fill"></i></button>
    </nav>

<!-- –ö–û–ù–ï–¶ –ß–ê–°–¢–ò 1 -->
    <!-- MODAL: TRANSACTION -->
    <div id="modal-tx" class="modal-overlay">
        <div class="bottom-sheet">
            <div class="flex-between" style="margin-bottom:20px;">
                <h2 id="mtx-title">–†–∞—Å—Ö–æ–¥</h2>
                <button class="interactive" onclick="closeModals()" style="background:none; border:none; color:white; font-size:24px;"><i class="ri-close-circle-fill"></i></button>
            </div>

            <input type="number" id="mtx-amount" class="input-lg" placeholder="0" inputmode="decimal">
            
            <div class="text-xs">–°—á–µ—Ç</div>
            <div class="cat-grid" id="mtx-accs" style="grid-template-columns: repeat(3, 1fr);"></div>

            <div class="text-xs">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
            <div class="cat-grid" id="mtx-cats"></div>

            <input type="text" id="mtx-note" class="input-std" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
            
            <button class="btn-main interactive" onclick="saveTx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="mtx-del-btn" class="btn-main btn-danger interactive hidden" style="margin-top:10px;" onclick="deleteCurrentTx()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>

    <!-- MODAL: ACCOUNT -->
    <div id="modal-acc" class="modal-overlay">
        <div class="bottom-sheet">
            <div class="flex-between"><h2>–°—á–µ—Ç</h2> <i class="ri-close-line interactive" onclick="closeModals()"></i></div>
            <br>
            <input type="text" id="macc-name" class="input-std" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –í–∫–ª–∞–¥)">
            
            <div class="flex-between" style="margin-bottom:10px;">
                <button class="btn-main interactive" style="flex:1; margin-right:5px; background:var(--bg-input);" id="btn-type-card" onclick="setAccType('card')">–ö–∞—Ä—Ç–∞</button>
                <button class="btn-main interactive" style="flex:1; margin-left:5px; background:var(--bg-input);" id="btn-type-invest" onclick="setAccType('invest')">–ò–Ω–≤–µ—Å—Ç</button>
            </div>

            <div id="macc-invest-fields" class="hidden">
                <input type="number" id="macc-percent" class="input-std" placeholder="% –î–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏">
            </div>

            <input type="number" id="macc-balance" class="input-std" placeholder="–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å">
            
            <button class="btn-main interactive" onclick="saveAccount()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn-main btn-danger interactive" style="margin-top:10px;" onclick="deleteAccount()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>

    <!-- MODAL: CATEGORY -->
    <div id="modal-cat" class="modal-overlay">
        <div class="bottom-sheet">
            <div class="flex-between"><h2>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2> <i class="ri-close-line interactive" onclick="closeModals()"></i></div>
            <br>
            <input type="text" id="mcat-name" class="input-std" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            <input type="text" id="mcat-icon" class="input-std" placeholder="–°–º–∞–π–ª–∏–∫ (üòé)">
            
            <div class="flex-between" style="margin-bottom:10px;">
                <button class="btn-main interactive" style="flex:1; margin-right:5px; background:var(--bg-input);" id="btn-cat-exp" onclick="setCatType('expense')">–†–∞—Å—Ö–æ–¥</button>
                <button class="btn-main interactive" style="flex:1; margin-left:5px; background:var(--bg-input);" id="btn-cat-inc" onclick="setCatType('income')">–î–æ—Ö–æ–¥</button>
            </div>

            <button class="btn-main interactive" onclick="saveCategory()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn-main btn-danger interactive" style="margin-top:10px;" onclick="deleteCategory()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
<!-- –ö–û–ù–ï–¶ –ß–ê–°–¢–ò 2 -->
        <script>
        // --- 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        // –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ—é —Å—Å—ã–ª–∫—É!
        const API_URL = 'https://script.google.com/macros/s/AKfycby_ES9U2-4VYmPhMLbDtNNv_ESnbUEI9nlw0euEHsxZ6eJqu340_LpF_A1pSxyUvRxG/exec';

        // --- 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        // –í–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è, —á—Ç–æ–±—ã —Å–ª—É—á–∞–π–Ω–æ –Ω–µ –≤—ã–π—Ç–∏
        tg.enableClosingConfirmation();

        // –î–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Ä–∞–∑)
        let db = {
            user: { name: 'User', limit: 100000 },
            accounts: [],
            categories: [
                {id: 'c1', name: '–ï–¥–∞', icon: 'üçî', type: 'expense'},
                {id: 'c2', name: '–î–æ–º', icon: 'üè†', type: 'expense'},
                {id: 'c3', name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', icon: 'üöï', type: 'expense'},
                {id: 'c4', name: '–ó–∞—Ä–ø–ª–∞—Ç–∞', icon: 'üí∞', type: 'income'},
                {id: 'c5', name: '–ë–∏–∑–Ω–µ—Å', icon: 'üíº', type: 'income'}
            ],
            transactions: []
        };

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let USER_ID = localStorage.getItem('onyx_uid');
        if(!USER_ID) {
            // –ï—Å–ª–∏ –≤ –¢–µ–ª–µ–≥—Ä–∞–º - –±–µ—Ä–µ–º ID –æ—Ç—Ç—É–¥–∞, –∏–Ω–∞—á–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
            USER_ID = tg.initDataUnsafe?.user?.id ? 'tg_' + tg.initDataUnsafe.user.id : 'web_' + Date.now();
            localStorage.setItem('onyx_uid', USER_ID);
        }

        // --- 3. –°–¢–ê–†–¢ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        async function initApp() {
            // –°–Ω–∞—á–∞–ª–∞ –≥—Ä—É–∑–∏–º —Ç–æ, —á—Ç–æ –µ—Å—Ç—å –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ (—á—Ç–æ–±—ã –±—ã–ª–æ –±—ã—Å—Ç—Ä–æ)
            const localData = localStorage.getItem('onyx_db');
            if(localData) {
                db = JSON.parse(localData);
                renderAll(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
            }
            
            // –ü–æ—Ç–æ–º —Å—Ç—É—á–∏–º—Å—è –≤ –æ–±–ª–∞–∫–æ –∑–∞ —Å–≤–µ–∂–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            syncData();
        }

        // --- 4. –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ---
        async function syncData() {
            updateSyncUI('loading'); // –ñ–µ–ª—Ç–∞—è —Ç–æ—á–∫–∞
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è —Å–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                const res = await fetch(`${API_URL}?action=load&user_id=${USER_ID}`);
                const json = await res.json();
                
                if(json.status === 'success') {
                    // –ï—Å–ª–∏ –≤ –æ–±–ª–∞–∫–µ —á—Ç–æ-—Ç–æ –µ—Å—Ç—å - –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
                    if(json.data.accounts && json.data.accounts.length > 0) {
                        db.accounts = json.data.accounts;
                        db.categories = json.data.categories;
                        db.transactions = json.data.transactions;
                        
                        document.getElementById('screen-onboarding').classList.add('hidden');
                        document.getElementById('screen-app').classList.remove('hidden');
                        document.getElementById('loader').style.display = 'none';
                        
                        saveLocal(false); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ (–æ–Ω–∞ –±—É–¥–µ—Ç –Ω–∏–∂–µ)
                        renderAll();
                        updateSyncUI('online'); // –ó–µ–ª–µ–Ω–∞—è —Ç–æ—á–∫–∞
                    } else {
                        // –ï—Å–ª–∏ –≤ –æ–±–ª–∞–∫–µ –ü–£–°–¢–û
                        if(db.accounts.length === 0) {
                            // –ò –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –ü–£–°–¢–û -> –ù–æ–≤—ã–π —é–∑–µ—Ä
                            document.getElementById('loader').style.display = 'none';
                            document.getElementById('screen-onboarding').classList.remove('hidden');
                        } else {
                            // –í —Ç–µ–ª–µ—Ñ–æ–Ω–µ –ï–°–¢–¨ –¥–∞–Ω–Ω—ã–µ -> –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö –≤ –æ–±–ª–∞–∫–æ
                            forceSync();
                            document.getElementById('loader').style.display = 'none';
                            document.getElementById('screen-app').classList.remove('hidden');
                        }
                    }
                }
            } catch(e) {
                console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", e);
                updateSyncUI('offline'); // –°–µ—Ä–∞—è —Ç–æ—á–∫–∞
                document.getElementById('loader').style.display = 'none';
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å - –ø—É—Å–∫–∞–µ–º –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                if(db.accounts.length > 0) document.getElementById('screen-app').classList.remove('hidden');
                else document.getElementById('screen-onboarding').classList.remove('hidden');
            }
        }

        async function forceSync() {
            updateSyncUI('loading');
            try {
                await fetch(API_URL + '?action=sync_all', {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        user_id: USER_ID,
                        accounts: db.accounts,
                        categories: db.categories,
                        transactions: db.transactions
                    })
                });
                updateSyncUI('online');
            } catch(e) {
                updateSyncUI('error');
            }
        }

        function saveLocal(render = true) {
            localStorage.setItem('onyx_db', JSON.stringify(db));
            if(render) renderAll();
        }

        function updateSyncUI(status) {
            const dot = document.getElementById('sync-dot');
            const txt = document.getElementById('sync-text');
            if(status === 'loading') { dot.className = 'status-dot syncing'; txt.innerText = '–ó–∞–≥—Ä—É–∑–∫–∞...'; }
            if(status === 'online') { dot.className = 'status-dot online'; txt.innerText = '–í —Å–µ—Ç–∏'; }
            if(status === 'offline') { dot.className = 'status-dot offline'; txt.innerText = '–û—Ñ—Ñ–ª–∞–π–Ω'; }
            if(status === 'error') { dot.className = 'status-dot error'; txt.innerText = '–û—à–∏–±–∫–∞'; }
        }

        // --- 5. –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´ (–¢–†–ê–ù–ó–ê–ö–¶–ò–ò) ---
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Å–æ–∑–¥–∞–≤–∞–µ–º–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        let curTx = { type: 'expense', acc: '', cat: '', waste: false };

        function openTxModal(type) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            curTx = { type: type, acc: '', cat: '', waste: false };
            
            // –ï—Å–ª–∏ —Å—á–µ—Ç–æ–≤ –Ω–µ—Ç - —Ä—É–≥–∞–µ–º—Å—è
            if(db.accounts.length === 0) return alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å—á–µ—Ç –≤ –ö–æ—à–µ–ª—å–∫–µ!');
            
            // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Å—á–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            curTx.acc = db.accounts[0].id;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('mtx-title').innerText = type === 'expense' ? '–†–∞—Å—Ö–æ–¥' : '–î–æ—Ö–æ–¥';
            document.getElementById('mtx-amount').value = '';
            document.getElementById('mtx-note').value = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å "–ú—É—Å–æ—Ä"
            document.getElementById('mtx-waste-wrap').style.display = type === 'expense' ? 'block' : 'none';

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è —Å—á–µ—Ç–æ–≤ (–° –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ú ONCLICK)
            document.getElementById('mtx-accs').innerHTML = db.accounts.map(a => `
                <div class="acc-chip interactive ${curTx.acc === a.id ? 'selected-border' : ''}" 
                     onclick="selectTxAcc('${a.id}', this)">
                    <div style="font-weight:700">${a.name}</div>
                    <div class="text-sm" style="opacity:0.7">${Math.floor(a.balance)}</div>
                </div>
            `).join('');

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–° –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ú ONCLICK)
            const cats = db.categories.filter(c => c.type === type);
            document.getElementById('mtx-cats').innerHTML = cats.map(c => `
                <div class="cat-item interactive" onclick="selectTxCat('${c.id}', this)">
                    <div class="cat-emoji">${c.icon}</div>
                    <div class="cat-name">${c.name}</div>
                </div>
            `).join('');

            openModal('modal-tx');
        }

        // –í–û–¢ –≠–¢–ò–• –§–£–ù–ö–¶–ò–ô –ù–ï –•–í–ê–¢–ê–õ–û!
        window.selectTxAcc = function(id, el) {
            curTx.acc = id;
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö
            document.querySelectorAll('#mtx-accs .acc-chip').forEach(x => x.classList.remove('selected-border'));
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–º—É
            el.classList.add('selected-border');
            try { tg.HapticFeedback.selectionChanged(); } catch(e){}
        }

        window.selectTxCat = function(id, el) {
            curTx.cat = id;
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö
            document.querySelectorAll('#mtx-cats .cat-item').forEach(x => x.classList.remove('selected-border'));
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–º—É
            el.classList.add('selected-border');
            try { tg.HapticFeedback.selectionChanged(); } catch(e){}
        }

        function setWaste(isWaste) {
            curTx.waste = isWaste;
            document.getElementById('bw-no').classList.toggle('active', !isWaste);
            document.getElementById('bw-yes').classList.toggle('active', isWaste);
            try { tg.HapticFeedback.impactOccurred('light'); } catch(e){}
        }

        function saveTx() {
            const amt = parseFloat(document.getElementById('mtx-amt').value);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏
            if(!amt || amt <= 0) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É!');
            if(!curTx.acc) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç!');
            if(!curTx.cat) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é!');

            const tx = {
                id: 'tx_' + Date.now(),
                date: new Date().toISOString(),
                amount: amt,
                type: curTx.type,
                accountId: curTx.acc,
                categoryId: curTx.cat,
                comment: document.getElementById('mtx-note').value,
                isWaste: curTx.waste
            };

            db.transactions.push(tx);
            saveLocal(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —Ñ–æ–Ω –≤ –æ–±–ª–∞–∫–æ
            fetch(API_URL + '?action=add_tx', {
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({...tx, user_id: USER_ID})
            });

            closeAllModals();
            try { tg.HapticFeedback.notificationOccurred('success'); } catch(e){}
        }

        // --- 6. –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ß–ï–¢–ê–ú–ò –ò –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò ---
        
        let newAccType = 'card';
        let newCatType = 'expense';

        function openAccountModal() { 
            document.getElementById('macc-name').value = ''; 
            document.getElementById('macc-balance').value = ''; 
            openModal('modal-acc'); 
        }
        
        function setAccType(t) {
            newAccType = t;
            ['card','dep','inv'].forEach(x => document.getElementById('bat-'+x).classList.remove('active'));
            document.getElementById('bat-'+(t=='card'?'card':(t=='deposit'?'dep':'inv'))).classList.add('active');
        }

        function saveAccount() {
            const name = document.getElementById('macc-name').value;
            if(!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
            
            db.accounts.push({
                id: 'acc_' + Date.now(),
                name: name,
                type: newAccType,
                balance: parseFloat(document.getElementById('macc-balance').value) || 0,
                percent: parseFloat(document.getElementById('macc-percent')?.value) || 0
            });
            
            saveLocal();
            forceSync(); // –°—á–µ—Ç–∞ –≤–∞–∂–Ω—ã, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å—Ä–∞–∑—É
            closeAllModals();
        }

        function openCatModal() { 
            document.getElementById('mcat-name').value = ''; 
            document.getElementById('mcat-icon').value = ''; 
            openModal('modal-cat'); 
        }

        function setCatType(t) {
            newCatType = t;
            document.getElementById('bct-exp').classList.toggle('active', t=='expense');
            document.getElementById('bct-inc').classList.toggle('active', t=='income');
        }

        function saveCategory() {
            const name = document.getElementById('mcat-name').value;
            if(!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
            
            db.categories.push({
                id: 'cat_' + Date.now(),
                name: name,
                icon: document.getElementById('mcat-icon').value || '‚è∫Ô∏è',
                type: newCatType
            });
            
            saveLocal();
            forceSync();
            closeAllModals();
        }

        // --- 7. –†–ï–ù–î–ï–†–ò–ù–ì (–û–¢–†–ò–°–û–í–ö–ê –≠–ö–†–ê–ù–ê) ---
        function renderAll() {
            // –†–∞—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–æ–≤
            let totalBalance = 0;
            let totalExpense = 0;
            let totalPassiveMonth = 0;
            
            const realBalances = {};
            
            // 1. –°—Ç–∞–≤–∏–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã
            db.accounts.forEach(a => {
                realBalances[a.id] = parseFloat(a.balance || 0); // –í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ balance —ç—Ç–æ —Å—Ç–∞—Ä—Ç
            });

            // 2. –ü—Ä–æ–≥–æ–Ω—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            db.transactions.forEach(t => {
                if(realBalances[t.accountId] !== undefined) {
                    if(t.type === 'income') realBalances[t.accountId] += parseFloat(t.amount);
                    else realBalances[t.accountId] -= parseFloat(t.amount);
                }
                if(t.type === 'expense') totalExpense += parseFloat(t.amount);
            });

            // 3. –°—á–∏—Ç–∞–µ–º –∏—Ç–æ–≥–∏ –∏ –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥
            db.accounts.forEach(a => {
                const bal = realBalances[a.id];
                totalBalance += bal;
                
                if(a.type !== 'card' && a.percent > 0) {
                    // (–°—É–º–º–∞ * –ü—Ä–æ—Ü–µ–Ω—Ç / 100) / 12 –º–µ—Å
                    totalPassiveMonth += (bal * (a.percent / 100)) / 12;
                }
            });

            // –û–ë–ù–û–í–õ–Ø–ï–ú UI: –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù
            document.getElementById('total-bal').innerText = Math.floor(totalBalance).toLocaleString();
            
            // –î–∞—à–±–æ—Ä–¥ –°–≤–æ–±–æ–¥—ã (Cashflow)
            const ffPercent = totalExpense > 0 ? Math.min(100, (totalPassiveMonth / totalExpense) * 100) : 0;
            document.getElementById('cf-bar').style.width = ffPercent + '%';
            document.getElementById('cf-percent').innerText = ffPercent.toFixed(1) + '%';
            document.getElementById('cf-passive').innerText = Math.floor(totalPassiveMonth).toLocaleString();
            document.getElementById('cf-expense').innerText = Math.floor(totalExpense).toLocaleString();

            // –ë—é–¥–∂–µ—Ç
            const limit = db.user.limit || 100000;
            const left = limit - totalExpense;
            const budgetPct = Math.min(100, (totalExpense / limit) * 100);
            document.getElementById('budget-bar').style.width = budgetPct + '%';
            if(budgetPct > 90) document.getElementById('budget-bar').style.backgroundColor = 'var(--danger)';
            else document.getElementById('budget-bar').style.backgroundColor = 'var(--primary)';
            
            document.getElementById('budget-left').innerText = (left > 0 ? '–û—Å—Ç–∞–ª–æ—Å—å: ' : '–ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥: ') + Math.floor(Math.abs(left)).toLocaleString();
            document.getElementById('budget-total').innerText = '–∏–∑ ' + limit.toLocaleString();

            // –°–ø–∏—Å–∫–∏ (–°—á–µ—Ç–∞ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π)
            document.getElementById('home-accs').innerHTML = db.accounts.map(a => `
                <div class="acc-chip">
                    <div class="flex-between">
                        <div style="font-weight:700">${a.name}</div>
                    </div>
                    <div style="font-size:18px; font-weight:700; color:var(--primary); margin-top:5px;">
                        ${Math.floor(realBalances[a.id]).toLocaleString()}
                    </div>
                </div>
            `).join('');

            // –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
            const sortedTx = db.transactions.slice().sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            document.getElementById('tx-list').innerHTML = sortedTx.map(t => {
                const cat = db.categories.find(c => c.id == t.categoryId) || {name: '?', icon: '‚ùì'};
                return `
                <div class="card" style="padding: 15px; display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 24px;">${cat.icon}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${cat.name} ${t.isWaste ? 'üóëÔ∏è' : ''}</div>
                        <div class="text-sm" style="opacity:0.6">${new Date(t.date).toLocaleDateString()}</div>
                    </div>
                    <div style="font-weight: 700; color: ${t.type==='expense' ? 'var(--text-main)' : 'var(--success)'}">
                        ${t.type==='expense' ? '-' : '+'}${parseFloat(t.amount).toLocaleString()}
                    </div>
                </div>`;
            }).join('');

            // –°–ø–∏—Å–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–ö–æ—à–µ–ª–µ–∫)
            document.getElementById('settings-acc-list').innerHTML = db.accounts.map(a => 
                `<div class="card flex-between"><div><b>${a.name}</b><br><small>${a.type}</small></div><b>${Math.floor(realBalances[a.id])}</b></div>`
            ).join('');
            document.getElementById('settings-cat-list').innerHTML = db.categories.map(c => 
                `<div style="display:inline-block; background:var(--bg-input); padding:8px 12px; border-radius:12px; margin:4px;">${c.icon} ${c.name}</div>`
            ).join('');
            
            // –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ —Å–ø–∏—Å–æ–∫
            const invAccs = db.accounts.filter(a => a.type !== 'card');
            document.getElementById('invest-accounts-list').innerHTML = invAccs.map(a => `
                <div class="card flex-between">
                    <div><b>${a.name}</b><br><small style="color:var(--success)">${a.percent}% –≥–æ–¥–æ–≤—ã—Ö</small></div>
                    <b>${Math.floor(realBalances[a.id]).toLocaleString()}</b>
                </div>
            `).join('');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
            renderCharts();
        }

        // --- 8. –ì–†–ê–§–ò–ö–ò ---
        function renderCharts() {
            // Chart Main (Bar - –†–∞—Å—Ö–æ–¥—ã –ø–æ –¥–Ω—è–º)
            const ctxMain = document.getElementById('chart-main');
            if(ctxMain) {
                // ... —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ ...
                const data = {};
                db.transactions.filter(t => t.type==='expense').forEach(t => {
                    const d = t.date.slice(5, 10);
                    data[d] = (data[d]||0) + parseFloat(t.amount);
                });
                const labels = Object.keys(data).sort().slice(-7);
                
                if(window.chartMainInst) window.chartMainInst.destroy();
                window.chartMainInst = new Chart(ctxMain, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{ label: '–¢—Ä–∞—Ç—ã', data: labels.map(l=>data[l]), backgroundColor: '#6366f1', borderRadius: 6 }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } } } }
                });
            }
        }

        // --- 9. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function openModal(id) {
            document.getElementById('overlay').classList.add('open');
            document.getElementById(id).classList.add('open');
            try { tg.HapticFeedback.impactOccurred('medium'); } catch(e){}
        }
        function closeModals() {
            document.getElementById('overlay').classList.remove('open');
            document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('open'));
        }
        function switchView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –º–µ–Ω—é (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø–æ ID –∫–Ω–æ–ø–æ–∫)
            try { tg.HapticFeedback.selectionChanged(); } catch(e){}
        }
        
        // --- Onboarding Complete ---
        function completeSetup() {
            const name = document.getElementById('setup-name').value || 'User';
            const limit = parseFloat(document.getElementById('setup-limit').value) || 100000;
            db.user.name = name;
            db.user.limit = limit;
            // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Å—á–µ—Ç–∞
            db.accounts.push({id: 'a1', name: '–ù–∞–ª–∏—á–Ω—ã–µ', type: 'card', balance: 0, percent: 0});
            saveLocal();
            forceSync();
            document.getElementById('screen-onboarding').classList.add('hidden');
            document.getElementById('screen-app').classList.remove('hidden');
        }

        // –ó–ê–ü–£–°–ö
        initApp();

    </script>
</body>
</html>
