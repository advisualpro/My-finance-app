          <button class="icon-btn" onclick="Modal.openCat()"><i class="ri-add-line"></i></button>
        </div>
        <div id="list-cat-manage"></div>
      </div>
      <button class="btn btn-secondary" style="margin-top:20px; color:var(--color-danger);" onclick="Core.reset()">
        <i class="ri-delete-bin-line"></i> –°–±—Ä–æ—Å –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
      </button>
    </div>

    <!-- BOTTOM NAV -->
    <div class="tab-bar">
      <i class="ri-home-5-fill tab-item active" onclick="Nav.to('home', this)"></i>
      <i class="ri-line-chart-fill tab-item" onclick="Nav.to('invest', this)"></i>
      <i class="ri-pie-chart-2-fill tab-item" onclick="Nav.to('stats', this)"></i>
      <i class="ri-wallet-3-fill tab-item" onclick="Nav.to('wallet', this)"></i>
    </div>

    <!-- MODALS -->
    <!-- TX MODAL -->
    <div class="modal-backdrop" id="overlay" onclick="Modal.closeAll()"></div>
    <div class="modal-sheet" id="sheet-tx">
      <h3 id="tx-title">–ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥</h3>
      <input type="number" id="tx-amt" class="input-hero" placeholder="0">
      <span class="text-label">–°—á–µ—Ç</span>
      <div class="scroll-h" id="tx-accs-list"></div>
      <span class="text-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
      <div class="scroll-h" id="tx-cats-list"></div>
      <input type="text" id="tx-note" class="input-std" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
      <div class="flex-row">
        <button class="btn btn-primary" onclick="Actions.saveTx()" style="flex:1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-secondary" onclick="Modal.closeAll()" style="flex:0.6;">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <button id="tx-del-btn" class="btn btn-secondary" style="color:var(--color-danger); margin-top:12px;" onclick="Actions.deleteTx()">
        –£–¥–∞–ª–∏—Ç—å
      </button>
    </div>

    <!-- ACC MODAL -->
    <div class="modal-sheet" id="sheet-acc">
      <h3>–°—á–µ—Ç</h3>
      <input type="text" id="acc-name" class="input-std" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
      <div class="flex-row">
        <button class="btn btn-primary" id="type-card" onclick="Actions.setAccType('card')">–ö–∞—Ä—Ç–∞</button>
        <button class="btn btn-secondary" id="type-invest" onclick="Actions.setAccType('invest')">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è</button>
      </div>
      <div id="acc-invest-opts" class="hidden">
        <span class="text-label">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å % –≥–æ–¥–æ–≤—ã—Ö</span>
        <input type="number" id="acc-percent" class="input-std" placeholder="5.5">
      </div>
      <input type="number" id="acc-bal" class="input-std" placeholder="–ë–∞–ª–∞–Ω—Å">
      <div class="flex-row" style="margin-top:20px;">
        <button class="btn btn-primary" onclick="Actions.saveAcc()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-secondary" onclick="Modal.closeAll()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>

    <!-- CAT MODAL -->
    <div class="modal-sheet" id="sheet-cat">
      <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
      <input type="text" id="cat-name" class="input-std" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
      <div class="flex-row">
        <button class="btn btn-primary" id="ctype-exp" onclick="Actions.setCatType('expense')">–†–∞—Å—Ö–æ–¥</button>
        <button class="btn btn-secondary" id="ctype-inc" onclick="Actions.setCatType('income')">–î–æ—Ö–æ–¥</button>
      </div>
      <span class="text-label">–ò–∫–æ–Ω–∫–∞</span>
      <div class="grid-4" id="cat-icons-grid" style="margin-bottom:20px;"></div>
      <div class="flex-row">
        <button class="btn btn-primary" onclick="Actions.saveCat()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-secondary" onclick="Modal.closeAll()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // MYCOSTS ONYX v16.0 - ENTERPRISE (FIXED)
    // ========================================

    // 1. CORE API (Google Apps Script)
    const API_URL = 'https://script.google.com/macros/s/AKfycbyES9U2-4VYmPhMLbDtNNvESnbUEI9nlw0euEHsxZ6eJqu340LpFA1pSxyUvRxG/exec';

    // 2. STATE MANAGEMENT
    const State = {
      db: {
        user: { name: '', limit: 100000 },
        accounts: [],
        categories: [],
        transactions: []
      },
      userId: null,
      viewDate: new Date(),
      temp: { editId: null, type: 'expense', accId: null, catId: null, icon: null, statMode: 'expense' }
    };

    // Telegram SDK
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      tg.enableClosingConfirmation();
    }

    // Init ID
    let uid = localStorage.getItem('onyx:uid');
    if (!uid) {
      uid = tg?.initDataUnsafe?.user?.id || 'web' + Date.now().toString().slice(-8);
      localStorage.setItem('onyx:uid', uid);
    }
    State.userId = uid;

    // 3. BOOTSTRAP
    const Core = {
      init: async () => {
        // 1. Load local DB
        const local = localStorage.getItem('onyx:db');
        let hasData = false;
        if (local) {
          try {
            State.db = JSON.parse(local);
            State.db.categories.forEach(c => {
              if (c.icon && c.icon.length > 4) hasData = true;
            });
            hasData = State.db.accounts.length > 0;
          } catch (e) {
            console.error('DB Error', e);
          }
        }

        // 2. Show app
        setTimeout(() => {
          const splash = document.getElementById('splash');
          splash.style.opacity = '0';
          setTimeout(() => splash.style.display = 'none', 500);
          if (hasData) {
            document.getElementById('screen-app').classList.remove('hidden');
            Render.all();
            Sync.pull();
          } else {
            document.getElementById('screen-onboarding').classList.remove('hidden');
          }
        }, 800);
      },

      finishOnboarding: () => {
        const name = document.getElementById('setup-name').value;
        const limit = parseFloat(document.getElementById('setup-limit').value) || 100000;
        State.db.user.name = name;
        State.db.user.limit = limit;

        // Default data
        State.db.accounts = [{ id: 'a1', name: '–ù–∞–ª–∏—á–Ω—ã–µ', type: 'card', balance: 0, percent: 0 }];
        State.db.categories = [
          { id: 'c1', name: '–ó–∞—Ä–ø–ª–∞—Ç–∞', icon: 'üí∞', type: 'income' },
          { id: 'c2', name: '–ï–¥–∞', icon: 'üçî', type: 'expense' },
          { id: 'c3', name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', icon: 'üöó', type: 'expense' },
          { id: 'c4', name: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', icon: 'üéâ', type: 'expense' }
        ];

        Core.save();
        document.getElementById('screen-onboarding').classList.add('hidden');
        document.getElementById('screen-app').classList.remove('hidden');
        Render.all();
        Sync.push(true);
      },

      save: () => {
        localStorage.setItem('onyx:db', JSON.stringify(State.db));
        Render.all();
      },

      reset: () => {
        if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) {
          localStorage.removeItem('onyx:db');
          location.reload();
        }
      }
    };

    // 4. SYNC ENGINE
    const Sync = {
      status: (color, text) => {
        const dot = document.getElementById('sync-dot');
        dot.className = `status-dot dot-${color}`;
        document.getElementById('sync-text').innerText = text;
      },

      pull: async () => {
        Sync.status('yellow', 'LOAD...');
        try {
          const res = await fetch(`${API_URL}?action=load&userId=${State.userId}&t=${Date.now()}`);
          const json = await res.json();
          if (json.status === 'success' && json.data.accounts.length > 0) {
            State.db.accounts = json.data.accounts;
            State.db.categories = json.data.categories;
            State.db.transactions = json.data.transactions;
            if (json.data.user) State.db.user = json.data.user;
            Logic.calcInterest();
            Core.save();
            Sync.status('green', 'OK');
          } else {
            Sync.status('green', 'LOCAL');
          }
        } catch (e) {
          console.warn('Offline mode');
          Sync.status('red', 'ERR');
        }
      },

      push: async (force = false) => {
        if (!force) Sync.status('yellow', 'SYNC...');
        try {
          await fetch(API_URL + '?action=sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId: State.userId,
              accounts: State.db.accounts,
              categories: State.db.categories,
              transactions: State.db.transactions,
              user: State.db.user
            })
          });
          if (!force) Sync.status('green', 'OK');
        } catch (e) {
          Sync.status('red', 'ERR');
        }
      },

      force: async () => {
        if (confirm('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–∏–Ω–∫?')) {
          await Sync.push(true);
        }
      }
    };

    // 5. TIME MACHINE
    const Time = {
      next: () => { State.viewDate.setMonth(State.viewDate.getMonth() + 1); Render.all(); },
      prev: () => { State.viewDate.setMonth(State.viewDate.getMonth() - 1); Render.all(); },
      getKey: () => {
        const y = State.viewDate.getFullYear();
        const m = String(State.viewDate.getMonth() + 1).padStart(2, '0');
        return `${y}-${m}`;
      },
      getString: () => {
        const months = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
        return `${months[State.viewDate.getMonth()]} ${State.viewDate.getFullYear()}`;
      }
    };

    // 6. BUSINESS LOGIC
    const Logic = {
      calcInterest: () => {
        let changed = false;
        const now = Date.now();
        State.db.accounts.forEach(acc => {
          if (acc.type === 'invest' && acc.percent > 0) {
            const last = acc.lastCalc || 0;
            const days = Math.floor((now - last) / (1000 * 60 * 60 * 24));
            if (days >= 1) {
              const profit = parseFloat(acc.balance) * (parseFloat(acc.percent) / 100) / 365 * days;
              if (profit > 0.1) {
                State.db.transactions.push({
                  id: 'sys' + Date.now(),
                  date: new Date().toISOString(),
                  amount: profit,
                  type: 'income',
                  accountId: acc.id,
                  categoryId: 'sys',
                  comment: '–ü—Ä–æ—Ü–µ–Ω—Ç—ã',
                  isWaste: false
                });
                acc.lastCalc = now;
                changed = true;
              }
            }
          }
        });
        if (changed) Core.save();
      }
    };

    // 7. RENDER ENGINE
    const Render = {
      all: () => {
        document.getElementById('user-display').innerText = State.db.user.name;
        document.getElementById('month-display').innerText = Time.getString();

        const monthKey = Time.getKey();

        // 1. BALANCES & TOTALS
        let expenseMonth = 0, passiveMonth = 0;
        const balances = {};
        State.db.accounts.forEach(a => balances[a.id] = parseFloat(a.balance) || 0);

        State.db.transactions.forEach(t => {
          if (balances[t.accountId] !== undefined) {
            if (t.type === 'income') {
              balances[t.accountId] += parseFloat(t.amount);
            } else {
              balances[t.accountId] -= parseFloat(t.amount);
            }
          }
          if (t.date.startsWith(monthKey)) {
            if (t.type === 'expense') expenseMonth += parseFloat(t.amount);
          }
        });

        State.db.accounts.filter(a => a.type === 'invest').forEach(a => {
          passiveMonth += (balances[a.id] * (parseFloat(a.percent) / 100 / 12));
        });

        // Total
        const totalCapital = Object.values(balances).reduce((a, b) => a + b, 0);
        document.getElementById('val-total').innerText = Math.floor(totalCapital).toLocaleString() + ' ‚ÇΩ';

        // Cashflow Freedom
        const freedomRate = expenseMonth === 0 ? 100 : Math.min(100, (passiveMonth / expenseMonth) * 100);
        document.getElementById('val-freedom').innerText = freedomRate.toFixed(1) + '%';
        document.getElementById('bar-freedom').style.width = freedomRate + '%';
        document.getElementById('val-passive').innerText = Math.floor(passiveMonth).toLocaleString() + ' ‚ÇΩ';
        document.getElementById('val-expense').innerText = Math.floor(expenseMonth).toLocaleString() + ' ‚ÇΩ';

        // Budget
        const limit = State.db.user.limit || 100000;
        const budgetLeft = limit - expenseMonth;
        const budgetPct = Math.min(100, (expenseMonth / limit) * 100);
        document.getElementById('val-budget').innerText = budgetLeft.toLocaleString() + ' ‚ÇΩ';
        document.getElementById('bar-budget').style.width = budgetPct + '%';

        // 2. ACCOUNTS CHIPS
        const accHTML = State.db.accounts.map(a => 
          `<div class="chip ${State.temp.accId === a.id ? 'active' : ''}" onclick="Actions.setTxAcc('${a.id}', this)">
            <div class="text-label" style="text-transform:none; margin-bottom:4px;">${a.name}</div>
            <div style="font-weight:700; font-size:16px;">${Math.floor(balances[a.id]).toLocaleString()}</div>
          </div>`
        ).join('');
        document.getElementById('list-acc-home').innerHTML = accHTML;
        document.getElementById('tx-accs-list').innerHTML = accHTML;

        // 3. RECENT TX
        const monthTxs = State.db.transactions
          .filter(t => t.date.startsWith(monthKey))
          .sort((a, b) => new Date(b.date) - new Date(a.date));

        document.getElementById('list-tx-home').innerHTML = monthTxs.map(t => {
          const cat = State.db.categories.find(x => x.id === t.categoryId) || { name: '?', icon: '' };
          const acc = State.db.accounts.find(a => a.id === t.accountId);
          return `
            <div class="card flex-row" onclick="Modal.editTx('${t.id}')" style="padding:16px; margin-bottom:10px; cursor:pointer;">
              <div class="flex-row" style="gap:12px;">
                <span style="font-size:24px;">${cat.icon}</span>
                <div>
                  <div style="font-weight:600;">${cat.name}</div>
                  <div class="text-label" style="margin:0; opacity:0.6; text-transform:none;">${t.comment || ''} ‚Ä¢ ${new Date(t.date).toLocaleDateString()}</div>
                </div>
              </div>
              <div style="font-weight:700; font-size:16px; color:${t.type === 'expense' ? 'var(--color-danger)' : 'var(--color-success)'}">
                ${t.type === 'expense' ? '-' : ''}${Math.floor(t.amount).toLocaleString()}
              </div>
            </div>`;
        }).join('');

        // 4. MANAGE LISTS
        document.getElementById('list-acc-manage').innerHTML = State.db.accounts.map(a => {
          const bal = balances[a.id];
          return `<div class="flex-row" style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1); cursor:pointer;" onclick="Modal.openAcc('${a.id}')">
            <div>${a.name}</div>
            <span class="text-sm">${Math.floor(bal).toLocaleString()}</span>
          </div>`;
        }).join('');

        document.getElementById('list-cat-manage').innerHTML = State.db.categories.map(c =>
          `<div class="flex-row" style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1); cursor:pointer;" onclick="Modal.openCat('${c.id}')">
            <div style="display:flex; gap:10px; align-items:center;">${c.icon} ${c.name}</div>
            <i class="ri-arrow-right-s-line" style="color:#666;"></i>
          </div>`
        ).join('');

        document.getElementById('list-inv').innerHTML = State.db.accounts.filter(a => a.type === 'invest').map(a =>
          `<div class="card flex-row">
            <div>${a.name}<br><span style="color:var(--color-success); font-size:12px;">${a.percent}%</span></div>
            <div>${Math.floor(balances[a.id]).toLocaleString()} ‚ÇΩ</div>
          </div>`
        ).join('');

        Render.charts(monthTxs, balances);
      },

      charts: (txs, balances) => {
        // 1. PIE CHART (Stats)
        const ctxPie = document.getElementById('chart-pie');
        const statMode = State.temp.statMode;
        const dataTx = txs.filter(t => t.type === statMode);
        const catsAgg = {};
        dataTx.forEach(t => {
          catsAgg[t.categoryId] = (catsAgg[t.categoryId] || 0) + parseFloat(t.amount);
        });

        if (window.pieChart) window.pieChart.destroy();
        window.pieChart = new Chart(ctxPie, {
          type: 'doughnut',
          data: {
            labels: Object.keys(catsAgg).map(id => State.db.categories.find(c => c.id === id)?.name || '?'),
            datasets: [{
              data: Object.values(catsAgg),
              backgroundColor: ['#0a84ff', '#30d158', '#ffd60a', '#ff453a', '#bf5af2', '#64d2ff'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { color: '#fff', font: { size: 11, family: 'Inter' } } }
            }
          }
        });

        // Stats list
        document.getElementById('list-stats').innerHTML = Object.entries(catsAgg)
          .sort((a, b) => b[1] - a[1])
          .map(([id, val]) => {
            const c = State.db.categories.find(x => x.id === id) || { name: '?', icon: '' };
            return `<div class="flex-row" style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
              <div style="display:flex; gap:10px; align-items:center;">${c.icon} ${c.name}</div>
              <div>${Math.floor(val).toLocaleString()}</div>
            </div>`;
          }).join('');

        // 2. LINE CHART (Invest)
        const ctxInv = document.getElementById('chart-invest');
        const invAccs = State.db.accounts.filter(a => a.type === 'invest');
        const currentSum = invAccs.reduce((s, a) => s + (balances[a.id] || 0), 0);
        const projectedSum = currentSum * 1.15; // 15% –≥–æ–¥
        document.getElementById('val-forecast').innerText = '+' + Math.floor(projectedSum - currentSum).toLocaleString() + ' ‚ÇΩ';

        if (window.lineChart) window.lineChart.destroy();
        window.lineChart = new Chart(ctxInv, {
          type: 'line',
          data: {
            labels: ['', '3–º', '6–º', '9–º', '1–≥'],
            datasets: [{
              data: [currentSum, currentSum * 1.04, currentSum * 1.08, currentSum * 1.12, projectedSum],
              borderColor: '#30d158',
              backgroundColor: 'rgba(48, 209, 88, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { display: false }, y: { display: false } },
            elements: { point: { radius: 0 } }
          }
        });
      }
    };

    // 8. ACTIONS
    const Actions = {
      setTxAcc: (id, el) => {
        State.temp.accId = id;
        document.querySelectorAll('#tx-accs-list .chip').forEach(c => c.classList.remove('active'));
        if (el) el.classList.add('active');
      },

      saveTx: () => {
        const amt = parseFloat(document.getElementById('tx-amt').value);
        if (!amt || !State.temp.accId || !State.temp.catId) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');

        const tx = {
          id: State.temp.editId || 'tx' + Date.now(),
          date: new Date().toISOString(),
          amount: amt,
          type: State.temp.type,
          accountId: State.temp.accId,
          categoryId: State.temp.catId,
          comment: document.getElementById('tx-note').value,
          isWaste: false
        };

        if (State.temp.editId) {
          const idx = State.db.transactions.findIndex(t => t.id === State.temp.editId);
          State.db.transactions[idx] = tx;
        } else {
          State.db.transactions.push(tx);
        }
        Core.save();
        Modal.closeAll();
        Sync.push(true);
      },

      deleteTx: () => {
        if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
          State.db.transactions = State.db.transactions.filter(t => t.id !== State.temp.editId);
          Core.save();
          Modal.closeAll();
          Sync.push(true);
        }
      },

      setAccType: (t) => {
        State.temp.type = t;
        document.getElementById('type-card').className = t === 'card' ? 'btn btn-primary' : 'btn btn-secondary';
        document.getElementById('type-invest').className = t === 'invest' ? 'btn btn-primary' : 'btn btn-secondary';
        document.getElementById('acc-invest-opts').classList.toggle('hidden', t !== 'invest');
      },

      saveAcc: () => {
        const name = document.getElementById('acc-name').value;
        if (!name) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');

        const acc = {
          id: State.temp.editId || 'a' + Date.now(),
          name,
          type: State.temp.type,
          balance: parseFloat(document.getElementById('acc-bal').value) || 0,
          percent: parseFloat(document.getElementById('acc-percent').value) || 0
        };

        if (State.temp.editId) {
          const idx = State.db.accounts.findIndex(a => a.id === State.temp.editId);
          State.db.accounts[idx] = acc;
        } else {
          State.db.accounts.push(acc);
        }
        Core.save();
        Modal.closeAll();
        Sync.push(true);
      },

      deleteAcc: () => {
        if (State.temp.editId && confirm('–£–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç?')) {
          State.db.accounts = State.db.accounts.filter(a => a.id !== State.temp.editId);
          Core.save();
          Modal.closeAll();
          Sync.push(true);
        }
      },

      setCatType: (t) => {
        State.temp.type = t;
        document.getElementById('ctype-exp').className = t === 'expense' ? 'btn btn-primary' : 'btn btn-secondary';
        document.getElementById('ctype-inc').className = t === 'income' ? 'btn btn-primary' : 'btn btn-secondary';
      },

      saveCat: () => {
        const name = document.getElementById('cat-name').value;
        if (!name || !State.temp.icon) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∏–∫–æ–Ω–∫—É');

        const cat = {
          id: State.temp.editId || 'c' + Date.now(),
          name,
          type: State.temp.type,
          icon: State.temp.icon
        };

        if (State.temp.editId) {
          const idx = State.db.categories.findIndex(c => c.id === State.temp.editId);
          State.db.categories[idx] = cat;
        } else {
          State.db.categories.push(cat);
        }
        Core.save();
        Modal.closeAll();
        Sync.push(true);
      },

      deleteCat: () => {
        if (State.temp.editId && confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) {
          State.db.categories = State.db.categories.filter(c => c.id !== State.temp.editId);
          Core.save();
          Modal.closeAll();
          Sync.push(true);
        }
      }
    };

    // 9. MODALS
    const Modal = {
      openTx: (type) => {
        State.temp.type = type;
        State.temp.accId = State.db.accounts[0]?.id;
        State.temp.catId = null;
        State.temp.editId = null;
        document.getElementById('tx-title').innerText = `–ù–æ–≤—ã–π ${type === 'expense' ? '—Ä–∞—Å—Ö–æ–¥' : '–¥–æ—Ö–æ–¥'}`;
        document.getElementById('tx-amt').value = '';
        document.getElementById('tx-note').value = '';
        document.getElementById('tx-del-btn').classList.add('hidden');
        document.getElementById('tx-cats-list').innerHTML = State.db.categories
          .filter(c => c.type === type)
          .map(c => `<div class="icon-box" onclick="State.temp.catId='${c.id}'; Modal.highlight(this);">${c.icon}</div>`)
          .join('');
        Modal.open('sheet-tx');
        Actions.setTxAcc(State.temp.accId);
      },

      editTx: (id) => {
        const t = State.db.transactions.find(x => x.id === id);
        if (!t) return;
        State.temp.editId = id;
        Modal.openTx(t.type);
        State.temp.accId = t.accountId;
        State.temp.catId = t.categoryId;
        document.getElementById('tx-amt').value = t.amount;
        document.getElementById('tx-note').value = t.comment;
        document.getElementById('tx-del-btn').classList.remove('hidden');
      },

      openAcc: (id = null) => {
        State.temp.editId = id;
        document.getElementById('acc-name').value = '';
        document.getElementById('acc-bal').value = '';
        Actions.setAccType('card');
        if (id) {
          const a = State.db.accounts.find(x => x.id === id);
          document.getElementById('acc-name').value = a.name;
          document.getElementById('acc-bal').value = a.balance;
          Actions.setAccType(a.type);
          if (a.type === 'invest') document.getElementById('acc-percent').value = a.percent;
        }
        Modal.open('sheet-acc');
      },

      openCat: (id = null) => {
        State.temp.editId = id;
        State.temp.icon = '';
        document.getElementById('cat-name').value = '';
        Actions.setCatType('expense');
        const icons = ['üí∞','üçî','üöó','üéâ','üè†','üí≥','üì±','üëï','üíä','üéì','‚úàÔ∏è','üéÅ'];
        document.getElementById('cat-icons-grid').innerHTML = icons.map((i, idx) =>
          `<div class="icon-box" onclick="State.temp.icon='${i}'; Modal.highlight(this, ${idx});" style="font-size:28px; cursor:pointer;">${i}</div>`
        ).join('');
        if (id) {
          const c = State.db.categories.find(x => x.id === id);
          document.getElementById('cat-name').value = c.name;
          Actions.setCatType(c.type);
        }
        Modal.open('sheet-cat');
      },

      highlight: (el) => {
        el.parentElement.querySelectorAll('.icon-box').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
      },

      open: (id) => {
        document.getElementById('overlay').classList.add('active');
        document.getElementById(id).classList.add('active');
      },

      closeAll: () => {
        document.querySelectorAll('.sheet, .overlay').forEach(e => e.classList.remove('active'));
        State.temp = { editId: null, type: 'expense', accId: null, catId: null, icon: null, statMode: 'expense' };
      }
    };

    // 10. NAVIGATION
    const Nav = {
      to: (scr, btn) => {
        document.querySelectorAll('#view-*').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-${scr}`).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if (btn) btn.classList.add('active');

        if (scr === 'stats' || scr === 'invest' || scr === 'home') Render.all();
      }
    };

    const Stats = {
      setMode: (m) => {
        State.temp.statMode = m;
        Render.all();
      }
    };

    // GLOBAL ERROR HANDLER
    window.onerror = function(msg, url, line, col, error) {
      document.getElementById('error-box').style.display = 'block';
      document.getElementById('error-box').innerHTML = `CRITICAL ERROR\n${msg}\n${url}:${line}:${col}`;
      return false;
    };

    // INIT
    Core.init();
  </script>
</body>
</html>
